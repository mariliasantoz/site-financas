<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
        <link rel="icon" type="image/png" href="favicon.png">

    <style>
      /* CONFIGURAÇÃO GERAL */
      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        color: black; /* Texto padrão em preto */
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      .form-sections-wrapper, /* Aplicar ao wrapper dos forms */
      .form-section, /* Aplicar a cada form individual */
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box,
      .cartao-box {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
        margin-bottom: 20px; /* Espaçamento entre seções */
        padding: 15px;
      }

      /* BOTÕES */
      button {
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #45a049;
      }
      button.delete-button {
        background-color: #f44336;
        margin-left: 5px;
      }
      button.delete-button:hover {
        background-color: #da190b;
      }
      button.edit-button {
        background-color: #ff9800;
        margin-left: 5px;
      }
      button.edit-button:hover {
        background-color: #e68a00;
      }

      /* CABEÇALHO */
      header {
        text-align: center;
        margin-bottom: 20px;
        position: relative;
      }
      header h1 {
        color: #333;
        margin-bottom: 10px;
      }
      header h2 {
        color: #555;
        margin-top: 0;
        /* Adicionado para centralizar melhor com botões */
        display: inline-block;
        position: relative;
        padding: 0 120px; /* Espaço para os botões não sobreporem */
      }
      .nav-buttons {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          width: 100%;
          display: flex;
          justify-content: space-between;
          padding: 0 20px;
          box-sizing: border-box;
          /* Ajuste para alinhar com o H2 */
          left: 0;
      }
      .nav-buttons button {
          background-color: #007bff;
          color: white;
          padding: 5px 10px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 1em;
      }
      .nav-buttons button:hover {
          background-color: #0056b3;
      }

      /* SEÇÃO DE TOTAIS */
      .totals-section {
        /* padding: 15px; */ /* Removido pois já está na regra geral */
        /* margin-bottom: 20px; */ /* Removido pois já está na regra geral */
      }
      .totals-wrapper {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
      }
      .saldo-bar-container {
        background-color: #ddd;
        border-radius: 5px;
        height: 25px;
        margin-top: 10px;
        overflow: hidden; /* Garante que a barra não vaze */
        position: relative;
      }
      .saldo-bar {
        height: 100%;
        width: 0%; /* Inicia em 0, será ajustada via JS */
        background-color: green; /* Cor padrão inicial */
        border-radius: 5px;
        transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
      }
      /* Remover classe negative se não for mais usada diretamente */
      /* .saldo-bar.negative { background-color: red; } */
      .saldo-label {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        font-size: 0.9em; /* Ajustar tamanho se necessário */
      }

      /* SEÇÃO DE CATEGORIAS (Receitas, Contas Fixas, Variáveis) */
      .categorias-section {
        /* padding: 15px; */
        /* margin-bottom: 20px; */
      }
      .categorias-columns {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
      .categoria-box {
        /* padding: 15px; */
        text-align: center;
        display: flex;
        flex-direction: column;
      }
      .categoria-box h3 {
        margin-top: 0;
        color: #333;
      }
      .categoria-list {
        text-align: left;
        margin-bottom: 10px;
        flex-grow: 1; /* Permite que a lista ocupe o espaço disponível */
        min-height: 50px; /* Altura mínima para evitar colapso */
      }
      .categoria-list p {
        margin: 5px 0;
        color: #555;
      }
      .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px dashed #c0c0c0;
      }
      .list-item:last-child {
        border-bottom: none;
      }
      .list-item span {
        flex-grow: 1;
        text-align: left;
        margin-right: 10px; /* Espaço antes dos botões */
      }
      .list-item-controls {
          display: flex;
          justify-content: flex-end;
          align-items: center;
          flex-shrink: 0; /* Impede que os controles encolham */
      }
      .list-item-controls button {
          margin-left: 5px;
          padding: 4px 8px;
          font-size: 0.8em;
      }
      .list-item-controls input[type="checkbox"] {
          margin-left: 5px;
          width: 16px;
          height: 16px;
      }
      .categoria-box .total-categoria {
        font-weight: bold;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #c0c0c0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* Checkbox de pago para o total da categoria */
      .total-categoria .checkbox-pago-total {
          margin-left: 10px;
          width: 20px; /* Ajuste o tamanho conforme necessário */
          height: 20px;
          cursor: pointer;
      }

      /* SEÇÃO DE CARTÕES */
      .cartoes-section {
        /* padding: 15px; */
        /* margin-bottom: 20px; */
      }
      .cartoes-grid {
        display: grid;
        /* Ajuste para garantir 4 colunas quando possível */
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
        gap: 20px;
      }
      .cartao-box {
        border-radius: 5px;
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
      }
      /* Cores específicas por cartão */
      .cartao-box.nubank { background-color: #f3e5f5; border: 1px solid #ce93d8; }
      .cartao-box.santander { background-color: #ffebee; border: 1px solid #ef9a9a; }
      .cartao-box.mercadopago { background-color: #e3f2fd; border: 1px solid #90caf9; } /* M.Pago */
      .cartao-box.amazon { background-color: #fff3e0; border: 1px solid #ffcc80; }

      .cartao-box h3 {
        margin-top: 0;
        color: #333;
      }
      .cartao-list {
        text-align: left;
        margin-bottom: 10px;
        flex-grow: 1;
        min-height: 50px; /* Altura mínima */
      }
      .cartao-list p {
        margin: 5px 0;
        color: #555;
      }
      .cartao-box .total-cartao {
        font-weight: bold;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #a7d9f7; /* Manter uma cor neutra para a linha */
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .cartao-box .total-cartao .checkbox-pago-total {
          margin-left: 10px;
          width: 20px;
          height: 20px;
          cursor: pointer;
      }
      .compra {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px;
        border-bottom: 1px dashed #c0c0c0;
        border-radius: 3px; /* Leve arredondamento */
        margin-bottom: 3px; /* Pequeno espaço entre compras */
      }
      .compra:last-child {
        border-bottom: none;
      }
      .compra .list-item-content {
          flex-grow: 1;
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-right: 5px; /* Espaço antes dos controles */
      }
      .compra .list-item-content span {
          flex-grow: 1;
          text-align: left;
          font-size: 0.9em;
      }
      .compra .list-item-controls {
          flex-shrink: 0;
      }

      /* SEÇÃO DE FORMULÁRIOS */
      .form-sections-wrapper {
        display: flex;
        gap: 20px;
      }
      .form-section {
        flex: 1;
        text-align: center;
        padding: 0; 
        margin-bottom: 0;
        border: none; 
        background-color: transparent; 
      }
      .form-section h2 {
        margin-top: 0;
        margin-bottom: 15px; 
        color: #333;
      }
      .form-section label { 
        display: block;
        margin-bottom: 5px;
        text-align: left;
        font-weight: bold;
        font-size: 0.9em;
      }
      .form-section input[type="text"],
      .form-section input[type="number"],
      .form-section select {
        width: 100%; 
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .form-section .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center; 
      }
      .form-section .row input,
      .form-section .row select {
        flex-grow: 1;
        margin-bottom: 0; 
      }
      .form-section button {
        width: 100%; 
        margin-top: 10px; 
      }

      /* SEÇÃO DE COMPRAS POR RESPONSÁVEL */
      .compras-responsaveis {
        text-align: center;
      }
      .compras-responsaveis h2 {
        margin-top: 0;
        color: #333;
      }
      .responsaveis-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
        gap: 20px;
        margin-top: 15px;
      }
      .responsavel-box {
        text-align: center;
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em;
        padding: 5px;
        border-radius: 3px;
        display: inline-block; 
      }
      .responsavel-box p.total-responsavel {
        margin: 10px 0 5px 0;
        font-size: 1em;
        font-weight: bold;
        border-top: 1px solid #ccc;
        padding-top: 10px;
      }
      .responsavel-list {
          text-align: left;
          font-size: 0.9em;
          max-height: 150px; 
          overflow-y: auto; 
          padding-right: 5px; 
          margin-top: 10px; 
      }
       .responsavel-list .compra-item {
          display: flex;
          justify-content: space-between;
          padding: 3px 0;
          border-bottom: 1px dotted #eee;
       }
       .responsavel-list .compra-item:last-child {
           border-bottom: none;
       }
       .responsavel-list .compra-nome {
           flex-grow: 1;
           margin-right: 10px;
           white-space: nowrap;
           overflow: hidden;
           text-overflow: ellipsis;
       }
       .responsavel-list .compra-detalhes {
           flex-shrink: 0;
           white-space: nowrap;
       }

      /* Cores para Responsáveis */
      .responsavel-liana { background-color: #add8e6; } 
      .responsavel-stefany { background-color: #ffb347; }
      .responsavel-marilia { background-color: #dda0dd; }
      .responsavel-nosso { background-color: #ffc0cb; }

      /* Cores para background de itens de compra */
      .compra-bg-liana { background-color: rgba(173, 216, 230, 0.3); } 
      .compra-bg-stefany { background-color: rgba(255, 179, 71, 0.3); } 
      .compra-bg-marilia { background-color: rgba(221, 160, 221, 0.3); } 
      .compra-bg-nosso { background-color: rgba(255, 192, 203, 0.3); } 

      /* RODAPÉ */
      footer {
        text-align: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #ccc;
      }
      footer p span {
        margin: 0 5px;
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 3px;
      }
      /* Aplicar cores da legenda diretamente */
      footer .liana { background-color: #add8e6; }
      footer .stefany { background-color: #ffb347; }
      footer .marilia { background-color: #dda0dd; }
      footer .nosso { background-color: #ffc0cb; }

      /* Estilo para item pago */
      .item-pago {
          text-decoration: line-through;
          color: grey;
          opacity: 0.7;
      }

      /* Modal Styles */
      .modal {
          display: none; 
          position: fixed; 
          z-index: 1000; 
          left: 0;
          top: 0;
          width: 100%; 
          height: 100%; 
          overflow: auto; 
          background-color: rgba(0,0,0,0.4); 
      }
      .modal-content {
          background-color: #fefefe;
          margin: 15% auto; 
          padding: 20px;
          border: 1px solid #888;
          width: 80%; 
          max-width: 500px;
          border-radius: 8px;
          position: relative;
      }
      .close-button {
          color: #aaa;
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 28px;
          font-weight: bold;
      }
      .close-button:hover,
      .close-button:focus {
          color: black;
          text-decoration: none;
          cursor: pointer;
      }
      .modal h2 {
          margin-top: 0;
      }
      .modal label {
          display: block;
          margin-bottom: 5px;
      }
      .modal input[type="text"],
      .modal input[type="number"],
      .modal select {
          width: 100%;
          padding: 8px;
          margin-bottom: 15px;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-sizing: border-box;
      }
      .modal button {
          width: 100%;
          padding: 10px;
      }

    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Painel Financeiro</h1>
        <h2>Carregando...</h2>
        <div class="nav-buttons">
          <button id="prevMonthBtn">&laquo; Mês Anterior</button>
          <button id="nextMonthBtn">Mês Seguinte &raquo;</button>
        </div>
      </header>

      <!-- Seção de Totais e Saldo -->
      <div class="totals-section">
        <div class="totals-wrapper">
          <span id="totalReceitas">Total de Receitas: R$ 0.00</span>
          <!-- **AJUSTE TERMÔMETRO v4**: ID alterado para refletir o total de despesas do mês -->
          <span id="totalDespesasMes">Total de Despesas: R$ 0.00</span> 
        </div>
        <div class="saldo-bar-container">
          <div class="saldo-bar" id="saldoBar"></div>
          <div class="saldo-label" id="saldoLabel">Saldo: R$ 0.00</div>
        </div>
      </div>

      <!-- Seção de Resumo do Mês (Receitas, Contas Fixas, Variáveis) -->
      <div class="categorias-section">
        <h2>Resumo do Mês</h2>
        <div class="categorias-columns">
          <!-- Receitas -->
          <div class="categoria-box receitas">
            <h3>Receitas</h3>
            <div class="categoria-list" id="listaReceitas">
              <p>Carregando...</p>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ccc;">
              <input type="text" id="nomeReceita" placeholder="Nome da Receita" style="width: calc(100% - 22px); margin-bottom: 5px;">
              <input type="number" id="valorReceita" placeholder="Valor" style="width: calc(100% - 22px); margin-bottom: 5px;">
              <button onclick="submitReceita()">Adicionar Receita</button>
            </div>
          </div>

          <!-- Contas Fixas -->
          <div class="categoria-box contas-fixas">
            <h3>Contas Fixas</h3>
            <div class="categoria-list" id="listaContasFixas">
              <p>Carregando...</p>
            </div>
            <div class="total-categoria">
              <span id="totalContasFixas">Total Aberto: R$ 0.00</span>
              <input type="checkbox" class="checkbox-pago-total" id="checkAllContasFixas" title="Marcar/Desmarcar todas as contas fixas como pagas">
            </div>
          </div>

          <!-- Contas Variáveis -->
          <div class="categoria-box contas-variaveis">
            <h3>Contas Variáveis</h3>
            <div class="categoria-list" id="listaContasVariaveis">
              <p>Carregando...</p>
            </div>
            <div class="total-categoria">
              <span id="totalContasVariaveis">Total Aberto: R$ 0.00</span>
              <input type="checkbox" class="checkbox-pago-total" id="checkAllContasVariaveis" title="Marcar/Desmarcar todas as contas variáveis como pagas">
            </div>
          </div>
        </div>
      </div>

      <!-- Seção de Cartões -->
      <div class="cartoes-section">
        <h2>Cartões</h2>
        <div class="cartoes-grid" id="cartoesGrid">
          <!-- Cartões serão adicionados aqui dinamicamente -->
          <p>Carregando...</p>
        </div>
      </div>

      <!-- Seção de Formulários -->
      <div class="form-sections-wrapper">
        <!-- Adicionar Compra no Cartão -->
        <div class="form-section add-compra">
          <h2>Adicionar Compra no Cartão</h2>
          <div class="row">
            <select id="responsavelCompra">
              <option value="Liana">Liana</option>
              <option value="Stefany">Stefany</option>
              <option value="Marília">Marília</option>
              <option value="Nosso ❤️">Nosso ❤️</option>
            </select>
            <select id="cartaoCompra">
              <option value="Nubank">Nubank</option>
              <option value="Santander">Santander</option>
              <option value="Mercado Pago">Mercado Pago</option>
              <option value="Amazon">Amazon</option>
            </select>
          </div>
          <input type="text" id="nomeCompra" placeholder="Nome da Compra">
          <div class="row">
            <input type="number" id="valorCompra" placeholder="Valor da Parcela">
            <input type="number" id="parcelasCompra" placeholder="Parcelas (ex: 1)" value="1">
          </div>
          <button onclick="submitCompra()">Adicionar Compra</button>
        </div>

        <!-- Adicionar Conta -->
        <div class="form-section add-conta">
          <h2>Adicionar Conta</h2>
          <select id="tipoConta">
            <option value="Fixa">Fixa</option>
            <option value="Variável">Variável</option>
          </select>
          <input type="text" id="nomeConta" placeholder="Nome da Conta">
          <div class="row">
            <input type="number" id="valorConta" placeholder="Valor da Parcela">
            <input type="number" id="parcelasConta" placeholder="Parcelas (ex: 1)" value="1">
          </div>
          <button onclick="submitConta()">Adicionar Conta</button>
        </div>
      </div>

      <!-- Seção de Compras por Responsável -->
      <div class="compras-responsaveis">
        <h2>Total de Compras por Responsável (Mês)</h2>
        <div class="responsaveis-container" id="responsaveisContainer">
          <!-- Responsáveis serão adicionados aqui -->
          <p>Carregando...</p>
        </div>
      </div>

      <!-- Rodapé com Legenda -->
      <footer>
        <p>Legenda Responsáveis: 
          <span class="liana">Liana</span> 
          <span class="stefany">Stefany</span> 
          <span class="marilia">Marília</span> 
          <span class="nosso">Nosso ❤️</span>
        </p>
      </footer>
    </div>

    <!-- Modal de Edição -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Editar Item</h2>
        <input type="hidden" id="editItemId">
        <input type="hidden" id="editItemType">
        
        <label for="editNome">Nome:</label>
        <input type="text" id="editNome">
        
        <label for="editValor">Valor:</label>
        <input type="number" id="editValor">
        
        <!-- Campos específicos para Compras -->
        <div id="editCompraFields" style="display: none;">
          <label for="editParcelasCompra">Parcelas (ex: 1/12):</label>
          <input type="text" id="editParcelasCompra" disabled> <!-- Parcelas não editáveis por simplicidade -->
          
          <label for="editResponsavelCompra">Responsável:</label>
          <select id="editResponsavelCompra">
            <option value="Liana">Liana</option>
            <option value="Stefany">Stefany</option>
            <option value="Marília">Marília</option>
            <option value="Nosso ❤️">Nosso ❤️</option>
          </select>
          
          <label for="editCartaoCompra">Cartão:</label>
          <select id="editCartaoCompra">
            <option value="Nubank">Nubank</option>
            <option value="Santander">Santander</option>
            <option value="Mercado Pago">Mercado Pago</option>
            <option value="Amazon">Amazon</option>
          </select>
        </div>
        
        <!-- Campos específicos para Contas -->
        <div id="editContaFields" style="display: none;">
          <label for="editParcelasConta">Parcelas (ex: 1/12):</label>
          <input type="text" id="editParcelasConta" disabled> <!-- Parcelas não editáveis -->
          
          <label for="editTipoConta">Tipo:</label>
          <select id="editTipoConta">
            <option value="Fixa">Fixa</option>
            <option value="Variável">Variável</option>
          </select>
        </div>
        
        <button onclick="submitEdit()">Salvar Alterações</button>
      </div>
    </div>

    <script>
      // URL do seu Cloudflare Worker (Proxy)
      const API_URL = "https://painel-financas-proxy.mariliaedua.workers.dev/";

      // Mês e ano atuais (começa com o mês atual)
      let currentMonth = new Date().getMonth(); // 0-11
      let currentYear = new Date().getFullYear();

      // Mapeamento de meses para nomes em português
      const monthNames = [
        "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
      ];

      // Mapeamento de responsáveis para classes CSS
      const responsavelClasses = {
        "Liana": "responsavel-liana",
        "Stefany": "responsavel-stefany",
        "Marília": "responsavel-marilia",
        "Nosso ❤️": "responsavel-nosso"
      };
      const compraBgClasses = {
        "Liana": "compra-bg-liana",
        "Stefany": "compra-bg-stefany",
        "Marília": "compra-bg-marilia",
        "Nosso ❤️": "compra-bg-nosso"
      };

      // Função para formatar valores como moeda brasileira
      function formatCurrency(value) {
        return `R$ ${Number(value).toFixed(2).replace(".", ",")}`;
      }

      // Função genérica para fazer requisições à API via Cloudflare Worker
      async function fetchData(action, data = {}, recordId = null, method = "POST") {
        console.log(`Enviando payload:`, { action, data, recordId, month: currentMonth + 1, year: currentYear });
        try {
          const payload = {
            action: action,
            data: data,
            recordId: recordId,
            month: currentMonth + 1, // Envia 1-12 para o backend
            year: currentYear
          };

          const response = await fetch(API_URL, {
            method: method,
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error(`Erro HTTP (${response.status}) para ${action}:`, errorText);
            throw new Error(`Erro na requisição (${action}): ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          console.log(`Resposta recebida (${action}):`, result);

          if (result.status === "error") {
            console.error(`Erro retornado pela API (${action}):`, result.message);
            throw new Error(result.message);
          }
          
          // Retorna os dados principais, seja diretamente ou dentro de um objeto { data: ... }
          return result.data !== undefined ? result.data : result;

        } catch (error) {
          console.error(`Falha na requisição (${action}):`, error);
          alert(`Erro ao comunicar com o servidor para a ação '${action}'. Verifique o console para detalhes.`);
          throw error; // Re-lança o erro para que a chamada saiba que falhou
        }
      }

      // --- Funções de Exibição ---

      // Atualiza o título do mês/ano
      function updateMonthDisplay() {
        const headerTitle = document.querySelector("header h2");
        headerTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;
      }

      // **AJUSTE TERMÔMETRO v4**: Atualiza os totais e a barra de saldo
      function updateTotalsDisplay(data) {
        const totalReceitasEl = document.getElementById("totalReceitas");
        const totalDespesasMesEl = document.getElementById("totalDespesasMes"); // ID ajustado
        const saldoBarEl = document.getElementById("saldoBar");
        const saldoLabelEl = document.getElementById("saldoLabel");

        const totalReceitas = data.totalReceitas || 0;
        const totalDespesasMes = data.totalDespesasMes || 0;
        const totalPago = data.totalPago || 0;

        // Exibe os totais fixos
        totalReceitasEl.textContent = `Total de Receitas: ${formatCurrency(totalReceitas)}`;
        totalDespesasMesEl.textContent = `Total de Despesas: ${formatCurrency(totalDespesasMes)}`;

        // Calcula o saldo atual
        const saldoAtual = totalReceitas - totalPago;
        saldoLabelEl.textContent = `Saldo: ${formatCurrency(saldoAtual)}`;

        // Calcula a porcentagem paga das despesas totais
        const percentPago = totalDespesasMes > 0 ? (totalPago / totalDespesasMes) * 100 : 0;
        saldoBarEl.style.width = `${Math.min(100, Math.max(0, percentPago))}%`; // Garante que fique entre 0 e 100

        // Define a cor da barra com base no saldo atual
        if (saldoAtual < 0) {
          saldoBarEl.style.backgroundColor = "red";
        } else {
          saldoBarEl.style.backgroundColor = "green";
        }
      }

      // Exibe a lista de receitas
      function displayReceitas(receitas) {
        const listaReceitasEl = document.getElementById("listaReceitas");
        listaReceitasEl.innerHTML = ""; // Limpa a lista

        if (!receitas || receitas.length === 0) {
          listaReceitasEl.innerHTML = "<p>Nenhuma receita para este mês.</p>";
          return;
        }

        receitas.forEach((receita) => {
          const itemEl = document.createElement("div");
          itemEl.classList.add("list-item");
          itemEl.innerHTML = `
            <span>${receita.nome} - ${formatCurrency(receita.valor)}</span>
            <div class="list-item-controls">
              <button class="edit-button" onclick="openEditModal(\'receita\', \'${receita.id}\')">Edit</button>
              <button class="delete-button" onclick="deleteItem(\'receita\', \'${receita.id}\')">X</button>
            </div>
          `;
          listaReceitasEl.appendChild(itemEl);
        });
      }

      // Exibe a lista de contas (Fixas ou Variáveis)
      function displayContas(contas, tipo) {
        const listaElId = tipo === "Fixa" ? "listaContasFixas" : "listaContasVariaveis";
        const totalElId = tipo === "Fixa" ? "totalContasFixas" : "totalContasVariaveis";
        const checkAllElId = tipo === "Fixa" ? "checkAllContasFixas" : "checkAllContasVariaveis";

        const listaEl = document.getElementById(listaElId);
        const totalEl = document.getElementById(totalElId);
        const checkAllEl = document.getElementById(checkAllElId);
        listaEl.innerHTML = ""; // Limpa a lista

        let totalAberto = 0;
        let todasPagas = true;

        const contasFiltradas = contas.filter(conta => conta.tipo === tipo);

        if (contasFiltradas.length === 0) {
          listaEl.innerHTML = `<p>Nenhuma conta ${tipo.toLowerCase()} para este mês.</p>`;
          totalEl.textContent = `Total Aberto: ${formatCurrency(0)}`;
          checkAllEl.checked = false;
          checkAllEl.disabled = true;
          return;
        }

        contasFiltradas.forEach((conta) => {
          const itemEl = document.createElement("div");
          itemEl.classList.add("list-item");
          const isPago = String(conta.pago).toLowerCase() === "sim";
          if (isPago) {
            itemEl.classList.add("item-pago");
          } else {
            totalAberto += parseFloat(conta.valor || 0);
            todasPagas = false;
          }

          itemEl.innerHTML = `
            <span>${conta.nome} (${conta.parcelas}) - ${formatCurrency(conta.valor)}</span>
            <div class="list-item-controls">
              <button class="edit-button" onclick="openEditModal(\'conta\', \'${conta.originalId || conta.id}\')">Edit</button>
              <button class="delete-button" onclick="deleteItem(\'conta\', \'${conta.originalId || conta.id}\')">X</button>
              <input type="checkbox" ${isPago ? "checked" : ""} onchange="markAsPaid(\'conta\', \'${conta.originalId || conta.id}\', this.checked)">
            </div>
          `;
          listaEl.appendChild(itemEl);
        });

        totalEl.textContent = `Total Aberto: ${formatCurrency(totalAberto)}`;
        checkAllEl.checked = todasPagas;
        checkAllEl.disabled = false;
        // Adiciona listener para marcar/desmarcar todos
        checkAllEl.onchange = () => markAllCategoriaAsPaid(tipo, checkAllEl.checked);
      }

      // Exibe os cartões e suas compras
      function displayCartoes(cartoesData) {
        const cartoesGridEl = document.getElementById("cartoesGrid");
        cartoesGridEl.innerHTML = ""; // Limpa o grid

        const cartoesOrdenados = ["Nubank", "Santander", "Mercado Pago", "Amazon"];

        cartoesOrdenados.forEach(nomeCartao => {
          const cartao = cartoesData[nomeCartao] || { total: 0, compras: [] }; // Garante que o cartão exista
          const cartaoBoxEl = document.createElement("div");
          const cartaoClass = nomeCartao.toLowerCase().replace(" ", ""); // Classe CSS (nubank, santander, mercadopago, amazon)
          cartaoBoxEl.classList.add("cartao-box", cartaoClass);

          const listaComprasEl = document.createElement("div");
          listaComprasEl.classList.add("cartao-list");

          let totalAbertoCartao = 0;
          let todasComprasPagas = true;

          if (cartao.compras.length === 0) {
            listaComprasEl.innerHTML = "<p>Nenhuma compra neste cartão para este mês.</p>";
            todasComprasPagas = false; // Se não há compras, não estão todas pagas
          } else {
            cartao.compras.forEach(compra => {
              const compraEl = document.createElement("div");
              compraEl.classList.add("compra");
              const isPago = String(compra.pago).toLowerCase() === "sim";
              if (isPago) {
                compraEl.classList.add("item-pago");
              } else {
                totalAbertoCartao += parseFloat(compra.valor || 0);
                todasComprasPagas = false;
              }
              // Aplica cor de fundo do responsável
              const bgClass = compraBgClasses[compra.responsavel] || ",";
              compraEl.classList.add(bgClass);

              compraEl.innerHTML = `
                <div class="list-item-content">
                  <span>${compra.nome} (${compra.parcelas}) - ${formatCurrency(compra.valor)}</span>
                </div>
                <div class="list-item-controls">
                   <button class="edit-button" onclick="openEditModal(\'compra\', \'${compra.originalId || compra.id}\')">Edit</button>
                   <button class="delete-button" onclick="deleteItem(\'compra\', \'${compra.originalId || compra.id}\')">X</button>
                   <!-- Checkbox individual removido -->
                </div>
              `;
              listaComprasEl.appendChild(compraEl);
            });
          }

          cartaoBoxEl.innerHTML = `
            <h3>${nomeCartao.toUpperCase()}</h3>
            <div class="total-cartao">
              <span>Total Fatura: ${formatCurrency(cartao.total)}</span>
              <input type="checkbox" class="checkbox-pago-total" id="checkAll${cartaoClass}" title="Marcar/Desmarcar todas as compras do ${nomeCartao}" ${todasComprasPagas && cartao.compras.length > 0 ? "checked" : ""} ${cartao.compras.length === 0 ? "disabled" : ""}>
            </div>
          `;
          cartaoBoxEl.appendChild(listaComprasEl); // Adiciona a lista depois do total
          cartoesGridEl.appendChild(cartaoBoxEl);

          // Adiciona listener para o checkbox total do cartão
          const checkAllCartaoEl = document.getElementById(`checkAll${cartaoClass}`);
          if (checkAllCartaoEl) {
            checkAllCartaoEl.onchange = () => markAllCartaoAsPaidFront(nomeCartao, checkAllCartaoEl.checked);
          }
        });
      }

      // Exibe o total de compras por responsável
      function displayComprasPorResponsavel(responsaveisData) {
        const containerEl = document.getElementById("responsaveisContainer");
        containerEl.innerHTML = ""; // Limpa

        const responsaveisOrdenados = ["Liana", "Stefany", "Marília", "Nosso ❤️"];

        responsaveisOrdenados.forEach(nomeResponsavel => {
          const responsavel = responsaveisData[nomeResponsavel] || { total: 0, compras: [] };
          const responsavelBoxEl = document.createElement("div");
          responsavelBoxEl.classList.add("responsavel-box");

          const responsavelListEl = document.createElement("div");
          responsavelListEl.classList.add("responsavel-list");

          if (responsavel.compras.length > 0) {
              responsavel.compras.forEach(compra => {
                  const itemEl = document.createElement("div");
                  itemEl.classList.add("compra-item");
                  itemEl.innerHTML = `
                      <span class="compra-nome">${compra.nome}</span>
                      <span class="compra-detalhes">(${compra.parcelas}) - ${formatCurrency(compra.valor)}</span>
                  `;
                  responsavelListEl.appendChild(itemEl);
              });
          } else {
              responsavelListEl.innerHTML = "<p>Nenhuma compra este mês.</p>";
          }

          responsavelBoxEl.innerHTML = `
            <h3 class="${responsaveisClasses[nomeResponsavel] || ""}">${nomeResponsavel}</h3>
          `;
          responsavelBoxEl.appendChild(responsavelListEl); // Adiciona a lista
          responsavelBoxEl.innerHTML += `
            <p class="total-responsavel">Total (Mês): ${formatCurrency(responsavel.total)}</p>
          `;

          containerEl.appendChild(responsavelBoxEl);
        });
      }

      // --- Funções de Ação ---

      // Adiciona Receita
      async function submitReceita() {
        const nome = document.getElementById("nomeReceita").value.trim();
        const valor = document.getElementById("valorReceita").value;
        if (!nome || !valor || parseFloat(valor) <= 0) {
          alert("Por favor, preencha o nome e um valor válido para a receita.");
          return;
        }
        try {
          await fetchData("addReceita", { nome, valor: parseFloat(valor) });
          document.getElementById("nomeReceita").value = "";
          document.getElementById("valorReceita").value = "";
          fetchAllData(); // Recarrega todos os dados
        } catch (error) {
          // Erro já tratado em fetchData
        }
      }

      // Adiciona Compra
      async function submitCompra() {
        const nome = document.getElementById("nomeCompra").value.trim();
        const valor = document.getElementById("valorCompra").value;
        const parcelas = document.getElementById("parcelasCompra").value || "1";
        const responsavel = document.getElementById("responsavelCompra").value;
        const cartao = document.getElementById("cartaoCompra").value;

        if (!nome || !valor || parseFloat(valor) <= 0 || parseInt(parcelas) <= 0) {
          alert("Preencha nome, valor da parcela (>0) e número de parcelas (>0) válidos.");
          return;
        }

        try {
          await fetchData("addCompraCartao", {
            nome,
            valor: parseFloat(valor),
            parcelas: parseInt(parcelas),
            responsavel,
            cartao
          });
          // Limpa campos
          document.getElementById("nomeCompra").value = "";
          document.getElementById("valorCompra").value = "";
          document.getElementById("parcelasCompra").value = "1";
          fetchAllData();
        } catch (error) {
          // Erro tratado em fetchData
        }
      }

      // Adiciona Conta
      async function submitConta() {
        const nome = document.getElementById("nomeConta").value.trim();
        const valor = document.getElementById("valorConta").value;
        const parcelas = document.getElementById("parcelasConta").value || "1";
        const tipo = document.getElementById("tipoConta").value;

        if (!nome || !valor || parseFloat(valor) <= 0 || parseInt(parcelas) <= 0) {
          alert("Preencha nome, valor da parcela (>0) e número de parcelas (>0) válidos.");
          return;
        }

        try {
          await fetchData("addConta", {
            nome,
            valor: parseFloat(valor),
            parcelas: parseInt(parcelas),
            tipo
          });
          // Limpa campos
          document.getElementById("nomeConta").value = "";
          document.getElementById("valorConta").value = "";
          document.getElementById("parcelasConta").value = "1";
          fetchAllData();
        } catch (error) {
          // Erro tratado em fetchData
        }
      }

      // Marca um item (conta ou compra) como pago/não pago
      async function markAsPaid(type, id, isChecked) {
        const action = type === "conta" ? "markContaAsPaid" : "markCompraAsPaid";
        const pagoStatus = isChecked ? "Sim" : "Não";
        try {
          await fetchData(action, { pago: pagoStatus }, id);
          fetchAllData(); // Recarrega tudo para atualizar totais e barra
        } catch (error) {
          // Erro tratado em fetchData
        }
      }

      // Marca todas as contas de uma categoria (Fixa/Variável) como pagas/não pagas
      async function markAllCategoriaAsPaid(tipo, isChecked) {
        const pagoStatus = isChecked ? "Sim" : "Não";
        try {
          // 1. Buscar todas as contas do mês atual
          const todasContas = await fetchData("getContas");
          const contasDaCategoria = todasContas.filter(c => c.tipo === tipo);
          
          // 2. Criar promessas para atualizar cada conta da categoria
          const updatePromises = contasDaCategoria.map(conta => 
            fetchData("markContaAsPaid", { pago: pagoStatus }, conta.originalId || conta.id)
          );
          
          // 3. Aguardar todas as atualizações
          await Promise.all(updatePromises);
          
          // 4. Recarregar todos os dados
          fetchAllData();
        } catch (error) {
          alert(`Erro ao marcar todas as contas ${tipo.toLowerCase()}s. Verifique o console.`);
        }
      }

      // Marca todas as compras de um cartão como pagas/não pagas (Ação no Frontend)
      async function markAllCartaoAsPaidFront(nomeCartao, isChecked) {
          const pagoStatus = isChecked ? "Sim" : "Não";
          try {
              // 1. Buscar os dados atuais das compras por cartão
              const cartoesData = await fetchData("getComprasPorCartao");
              const cartao = cartoesData[nomeCartao];

              if (!cartao || !cartao.compras || cartao.compras.length === 0) {
                  console.log(`Nenhuma compra encontrada para o cartão ${nomeCartao} para marcar.`);
                  return; // Nada a fazer
              }

              // 2. Criar promessas para atualizar cada compra do cartão
              const updatePromises = cartao.compras.map(compra =>
                  fetchData("markCompraAsPaid", { pago: pagoStatus }, compra.originalId || compra.id)
              );

              // 3. Aguardar todas as atualizações
              await Promise.all(updatePromises);

              // 4. Recarregar todos os dados para refletir as mudanças
              fetchAllData();
          } catch (error) {
              alert(`Erro ao marcar todas as compras do cartão ${nomeCartao}. Verifique o console.`);
          }
      }

      // Abre o modal de edição
      async function openEditModal(type, id) {
        const modal = document.getElementById("editModal");
        const titleEl = document.getElementById("modalTitle");
        const idInput = document.getElementById("editItemId");
        const typeInput = document.getElementById("editItemType");
        const nomeInput = document.getElementById("editNome");
        const valorInput = document.getElementById("editValor");
        const compraFields = document.getElementById("editCompraFields");
        const contaFields = document.getElementById("editContaFields");

        // Limpa e esconde campos específicos
        compraFields.style.display = "none";
        contaFields.style.display = "none";

        idInput.value = id;
        typeInput.value = type;

        try {
          let itemData;
          if (type === "receita") {
            titleEl.textContent = "Editar Receita";
            const todasReceitas = await fetchData("getReceitas");
            itemData = todasReceitas.find(r => r.id === id);
          } else if (type === "compra") {
            titleEl.textContent = "Editar Compra";
            compraFields.style.display = "block";
            const todasCompras = await fetchData("getCompras"); 
            itemData = todasCompras.find(c => (c.originalId || c.id) === id);
          } else if (type === "conta") {
            titleEl.textContent = "Editar Conta";
            contaFields.style.display = "block";
            const todasContas = await fetchData("getContas");
            itemData = todasContas.find(c => (c.originalId || c.id) === id);
          }

          if (!itemData) {
            alert("Item não encontrado para edição.");
            return;
          }

          // Preenche campos comuns
          nomeInput.value = itemData.nome || "";
          valorInput.value = itemData.valor || "";

          // Preenche campos específicos
          if (type === "compra") {
            document.getElementById("editParcelasCompra").value = itemData.parcelas || "1/1";
            document.getElementById("editResponsavelCompra").value = itemData.responsavel || "Liana";
            document.getElementById("editCartaoCompra").value = itemData.cartao || "Nubank";
          } else if (type === "conta") {
            document.getElementById("editParcelasConta").value = itemData.parcelas || "1/1";
            document.getElementById("editTipoConta").value = itemData.tipo || "Fixa";
          }

          modal.style.display = "block";

        } catch (error) {
          alert("Erro ao buscar dados para edição. Verifique o console.");
        }
      }

      // Fecha o modal
      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      // Envia os dados editados
      async function submitEdit() {
        const id = document.getElementById("editItemId").value;
        const type = document.getElementById("editItemType").value;
        const nome = document.getElementById("editNome").value.trim();
        const valor = document.getElementById("editValor").value;

        if (!nome || !valor || parseFloat(valor) <= 0) {
          alert("Nome e valor válido são obrigatórios.");
          return;
        }

        let action = "";
        let dataToUpdate = { nome, valor: parseFloat(valor) };

        if (type === "receita") {
          action = "updateReceita";
        } else if (type === "compra") {
          action = "updateCompra";
          dataToUpdate.responsavel = document.getElementById("editResponsavelCompra").value;
          dataToUpdate.cartao = document.getElementById("editCartaoCompra").value;
          // Não atualizamos parcelas aqui
        } else if (type === "conta") {
          action = "updateConta";
          dataToUpdate.tipo = document.getElementById("editTipoConta").value;
          // Não atualizamos parcelas aqui
        }

        try {
          await fetchData(action, dataToUpdate, id);
          closeModal();
          fetchAllData(); // Recarrega tudo
        } catch (error) {
          // Erro tratado em fetchData
        }
      }

      // Deleta um item
      async function deleteItem(type, id) {
        if (!confirm("Tem certeza que deseja excluir este item?")) {
          return;
        }
        let action = "";
        if (type === "receita") action = "deleteReceita";
        else if (type === "compra") action = "deleteCompra";
        else if (type === "conta") action = "deleteConta";

        try {
          await fetchData(action, {}, id);
          fetchAllData(); // Recarrega tudo
        } catch (error) {
          // Erro tratado em fetchData
        }
      }

      // Busca todos os dados necessários para o painel
      async function fetchAllData() {
        console.log(`Atualizando dados para ${currentMonth + 1}/${currentYear}`);
        try {
          // Mostra indicador de carregamento (opcional)
          document.querySelector("header h2").textContent = "Carregando...";
          document.getElementById("listaReceitas").innerHTML = "<p>Carregando...</p>";
          document.getElementById("listaContasFixas").innerHTML = "<p>Carregando...</p>";
          document.getElementById("listaContasVariaveis").innerHTML = "<p>Carregando...</p>";
          document.getElementById("cartoesGrid").innerHTML = "<p>Carregando...</p>";
          document.getElementById("responsaveisContainer").innerHTML = "<p>Carregando...</p>";

          // Faz todas as requisições em paralelo
          const [receitas, contas, comprasCartao, comprasResp, totais] = await Promise.all([
            fetchData("getReceitas"),
            fetchData("getContas"),
            fetchData("getComprasPorCartao"),
            fetchData("getComprasPorResponsavel"),
            fetchData("getTotais")
          ]);

          // Atualiza a exibição com os dados recebidos
          updateMonthDisplay();
          updateTotalsDisplay(totais); // Passa o objeto de totais
          displayReceitas(receitas);
          displayContas(contas, "Fixa");
          displayContas(contas, "Variável");
          displayCartoes(comprasCartao);
          displayComprasPorResponsavel(comprasResp);

          console.log("Todos os dados atualizados com sucesso.");

        } catch (error) {
          console.error("Erro ao buscar todos os dados:", error);
          // Poderia mostrar uma mensagem de erro mais persistente aqui
          document.querySelector("header h2").textContent = "Erro ao carregar";
        } finally {
          // Esconde indicador de carregamento (se houver)
        }
      }

      // --- Inicialização e Event Listeners ---
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM carregado. Iniciando painel...");
        fetchAllData(); // Busca os dados iniciais

        // Botões de navegação de mês
        document.getElementById("prevMonthBtn").addEventListener("click", () => {
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
          }
          fetchAllData();
        });

        document.getElementById("nextMonthBtn").addEventListener("click", () => {
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
          }
          fetchAllData();
        });

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
          const modal = document.getElementById("editModal");
          if (event.target == modal) {
            closeModal();
          }
        }
        console.log("Painel inicializado e listeners adicionados.");
      });

    </script>
  </body>
</html>

