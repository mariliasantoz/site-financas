<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
    <style>
      /* CONFIGURAÇÃO GERAL */
      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        color: black; /* Texto padrão em preto */
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      .form-section,
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box {
        background-color: #e3f2fd; /* Azul claro */
        border: 1px solid #90caf9; /* Azul um pouco mais escuro */
        border-radius: 5px;
        margin-bottom: 20px;
        padding: 15px;
      }
      /* BOTÕES */
      button {
        background-color: #4caf50; /* Verde */
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 1em;
        margin-right: 5px; /* Espaço entre botões */
      }
      button:hover {
        background-color: #45a049;
      }
      button:active {
        background-color: #3e8e41;
      }
      /* Campos de Formulário */
      input[type="text"],
      input[type="number"],
      select {
        width: calc(100% - 22px); /* Ajuste para padding e border */
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box; /* Inclui padding e border no width */
      }

      /* CABEÇALHO */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      header h1 {
        color: #333;
        margin: 0;
      }
      header h2 {
        color: #555;
        margin: 0;
      }
      .nav-buttons button {
        background-color: #007bff; /* Azul padrão para navegação */
      }
      .nav-buttons button:hover {
        background-color: #0056b3;
      }

      /* SEÇÃO DE TOTAIS */
      .totals-section {
        padding: 20px;
        text-align: center;
        background-color: #f0f8ff; /* Azul muito claro */
      }
      .totals-wrapper {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        font-size: 1.1em;
        font-weight: bold;
      }
      .saldo-bar-container {
        width: 100%;
        height: 20px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
      }
      .saldo-bar {
        height: 100%;
        background-color: #64dd17; /* Verde para saldo positivo */
        width: 0%; /* Será preenchido por JS */
        transition: width 0.5s ease-in-out;
      }
      .saldo-bar.negative {
        background-color: #ff1744; /* Vermelho para saldo negativo */
      }
      .saldo-label {
        position: absolute;
        width: 100%;
        text-align: center;
        line-height: 20px;
        color: #333;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
      }

      /* SEÇÃO DE CATEGORIAS (Receitas, Contas, Cartões) */
      .categorias-section {
        display: flex;
        flex-wrap: wrap; /* Permite quebrar em linhas menores */
        gap: 20px;
        margin-top: 20px;
      }
      .categorias-columns {
          display: flex;
          flex-wrap: wrap; /* Para responsividade */
          gap: 20px;
          width: 100%; /* Ocupa a largura total da seção */
      }
      .categoria-box {
        flex: 1; /* Cresce para preencher espaço */
        min-width: 280px; /* Largura mínima para evitar quebras ruins */
      }
      .categoria-box h3 {
        text-align: center;
        color: #333;
        margin-top: 0;
      }
      .categoria-list {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        min-height: 100px; /* Garante altura mínima para listas */
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .list-item:last-child {
        border-bottom: none;
      }
      .list-item-content {
          display: flex;
          flex-grow: 1; /* Ocupa o máximo de espaço */
          align-items: center;
          gap: 8px; /* Espaço entre span, checkbox, e controles */
      }
      .list-item-content span {
          flex-grow: 1; /* Permite que o texto cresça */
      }
      .list-item-controls button {
          padding: 5px 8px;
          font-size: 0.8em;
          margin-left: 5px;
          background-color: #f44336; /* Vermelho para X */
      }
      .list-item-controls button:first-child {
          background-color: #ff9800; /* Laranja para Edit */
      }
      .list-item-controls button:hover {
          opacity: 0.9;
      }
      .list-item-content .checkbox-pago {
        width: auto; /* Não ocupa a largura total */
        margin: 0;
        cursor: pointer;
      }
      .list-item.pago span {
        text-decoration: line-through;
        color: #888;
      }

      /* Formulários */
      .form-section {
        background-color: #e8f5e9; /* Verde claro para formulários */
        border-color: #a5d6a7;
        padding: 20px;
      }
      .form-section h2 {
        text-align: center;
        color: #333;
        margin-top: 0;
      }
      .form-section .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .form-section .row input {
        flex: 1;
        margin-bottom: 0; /* Remove margin-bottom extra */
      }
      .form-section button {
        width: 100%;
        margin-top: 10px;
      }

      /* Seção de Cartões */
      .cartoes-section {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
      .cartao-box {
        background-color: #e0f2f7; /* Azul mais claro para cartões */
        border: 1px solid #b3e5fc;
        border-radius: 5px;
        padding: 15px;
        flex: 1;
        min-width: 250px;
      }
      .cartao-box h3 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }
      .cartao-total {
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
      }
      .cartao-list {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        min-height: 80px;
        max-height: 250px;
        overflow-y: auto;
      }
      .cartao-paid-checkbox {
        width: auto;
        margin-left: auto; /* Empurra para a direita */
        cursor: pointer;
      }

      /* Compras por Responsável */
      .compras-responsaveis {
        margin-top: 20px;
        text-align: center;
      }
      .responsaveis-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }
      .responsavel-box {
        flex: 1;
        min-width: 200px;
        max-width: 280px;
        text-align: center;
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em;
      }
      .responsavel-box p {
        margin: 5px 0;
        font-size: 0.9em;
      }
      /* Cores para Responsáveis (background) */
      .liana {
        background-color: #add8e6; /* Light Blue */
        padding: 4px 8px;
        border-radius: 3px;
      }
      .stefany {
        background-color: #ffb347; /* Orange */
        padding: 4px 8px;
        border-radius: 3px;
      }
      .marilia {
        background-color: #dda0dd; /* Plum */
        padding: 4px 8px;
        border-radius: 3px;
      }
      .nosso { /* Para "Nosso ❤️" */
        background-color: #ffc0cb; /* Pink */
        padding: 4px 8px;
        border-radius: 3px;
      }
      /* RODAPÉ */
      footer {
        text-align: center;
        margin-top: 20px;
        color: #666;
      }
      footer p span {
        margin: 0 5px;
        font-weight: bold;
      }
      .list-item-controls {
          display: flex;
          justify-content: flex-end; /* Alinha botões à direita */
          gap: 5px;
      }

      /* Estilização para o texto de "Carregando..." e "Nenhum item..." */
      .categoria-list p, .cartao-list p, .responsaveis-container p {
          text-align: center;
          color: #777;
          font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Painel Financeiro</h1>
        <h2>Carregando Mês...</h2> 
        <div class="nav-buttons">
          <button>&laquo; Mês Anterior</button>
          <button>Mês Seguinte &raquo;</button>
        </div>
      </header>
      
      <div class="totals-section">
        <div class="totals-wrapper">
          <span id="totalReceitas">Total de Receitas: R$ 0.00</span>
          <span id="totalDespesas">Total de Despesas: R$ 0.00</span>
        </div>
        <div class="saldo-bar-container">
          <div class="saldo-bar" id="saldoBar"></div>
          <div class="saldo-label" id="saldoLabel">Saldo: R$ 0.00</div>
        </div>
      </div>
      
      <div class="categorias-section">
        <h2>Resumo do Mês</h2>
        <div class="categorias-columns">
          <div class="categoria-box receitas">
            <h3>Receitas</h3>
            <div class="categoria-list" id="listaReceitas">
              <p>Carregando receitas...</p>
            </div>
            <button onclick="showAddReceitaForm()">Adicionar Receita</button>
          </div>
          
          <div class="categoria-box contas">
            <h3>Contas Fixas</h3>
            <div class="categoria-list" id="listaContasFixas">
              <p>Carregando contas fixas...</p>
            </div>
            <div class="conta-fixa-controls">
                <button onclick="showAddContaForm('Fixa')">Adicionar Conta Fixa</button>
            </div>
          </div>

          <div class="categoria-box contas">
            <h3>Contas Variáveis</h3>
            <div class="categoria-list" id="listaContasVariaveis">
              <p>Carregando contas variáveis...</p>
            </div>
            <div class="conta-variavel-controls">
                <button onclick="showAddContaForm('Variável')">Adicionar Conta Variável</button>
            </div>
          </div>
        </div>

        <div class="cartoes-section">
          <h2>Compras por Cartão</h2>
          <div class="cartoes-container" id="cartoesContainer">
            <p>Carregando compras por cartão...</p>
            </div>
          <button onclick="showAddCompraForm()">Adicionar Compra no Cartão</button>
        </div>
      </div>
      
      <div class="forms-container" style="display: none;"> <div class="form-section" id="formAdicionarReceita">
          <h2>Adicionar Nova Receita</h2>
          <input type="text" id="receitaNome" placeholder="Nome da Receita" />
          <input type="number" id="receitaValor" placeholder="Valor" />
          <button onclick="submitReceita()">Adicionar Receita</button>
        </div>

        <div class="form-section" id="formAdicionarCompra">
          <h2>Adicionar Compra no Cartão</h2>
          <div class="row">
            <select id="compraCartao">
              <option value="Credicard">Credicard</option>
              <option value="Itaucard">Itaucard</option>
              <option value="C6">C6</option>
              <option value="NuConta">NuConta</option>
              <option value="Amazon">AMAZON</option>
            </select>
            <select id="compraResponsavel">
                <option value="Liana">Liana</option>
                <option value="Stefany">Stefany</option>
                <option value="Marília">Marília</option>
                <option value="Nosso ❤️">Nosso ❤️</option>
            </select>
          </div>
          <div class="row">
            <input type="text" id="compraNome" placeholder="Nome da Compra" />
          </div>
          <div class="row">
            <input type="number" id="compraValor" placeholder="Valor" />
            <input type="text" id="compraParcelas" placeholder="Parcelas (ex: 2/6)" />
          </div>
          <button onclick="submitCompraCartao()">Adicionar Compra no Cartão</button>
        </div>
        
        <div class="form-section" id="formAdicionarConta">
          <h2>Adicionar Conta</h2>
          <select id="tipoConta">
            <option value="Fixa">Fixa</option>
            <option value="Variável">Variável</option>
          </select>
          <input type="text" id="contaNome" placeholder="Nome da Conta" />
          <input type="text" id="contaParcelas" placeholder="Parcelas (ex: 2/3)" />
          <input type="number" id="contaValor" placeholder="Valor" />
          <button onclick="submitConta()">Adicionar Conta</button>
        </div>
      </div>
      
      <div class="compras-responsaveis">
        <h2>Total de Compras por Responsável</h2>
        <div class="responsaveis-container" id="responsaveisContainer">
          <p>Carregando totais por responsável...</p>
        </div>
      </div>
      
      <footer>
        <p>
          Feito com <span class="liana">Liana</span>,
          <span class="stefany">Stefany</span>,
          <span class="marilia">Marília</span> e
          <span class="nosso">Nosso ❤️</span>
        </p>
      </footer>
    </div>

    <script>
      // *** AQUI É ONDE A URL DO SEU CLOUDFLARE WORKER DEVE ENTRAR ***
      const webAppUrl = "https://painel-financas-proxy.mariliaedua.workers.dev/"; 
      // ***************************************************************
      
      let currentMonth = new Date().getMonth(); // 0-Janeiro, 1-Fevereiro, etc.
      let currentYear = new Date().getFullYear();

      const monthNames = [
        "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
      ];

      // Funções para mostrar/esconder formulários
      function hideAllForms() {
        document.querySelectorAll('.form-section').forEach(form => {
          form.style.display = 'none';
        });
        document.querySelector('.forms-container').style.display = 'none';
      }

      function showAddReceitaForm() {
        hideAllForms();
        document.getElementById('formAdicionarReceita').style.display = 'block';
        document.querySelector('.forms-container').style.display = 'block';
      }

      function showAddCompraForm() {
        hideAllForms();
        document.getElementById('formAdicionarCompra').style.display = 'block';
        document.querySelector('.forms-container').style.display = 'block';
      }

      function showAddContaForm(tipo) {
        hideAllForms();
        document.getElementById('formAdicionarConta').style.display = 'block';
        document.getElementById('tipoConta').value = tipo; // Define o tipo de conta
        document.querySelector('.forms-container').style.display = 'block';
      }


      function updateMonthDisplay() {
        document.querySelector("header h2").textContent = `${monthNames[currentMonth]} ${currentYear}`;
      }

      function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        } else if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        updateMonthDisplay();
        // Recarrega todos os dados para o novo mês/ano
        fetchAllData(); 
      }

      // Função principal para carregar todos os dados
      async function fetchAllData() {
          // Limpa as listas enquanto carrega
          document.getElementById("listaReceitas").innerHTML = "<p>Carregando receitas...</p>";
          document.getElementById("listaContasFixas").innerHTML = "<p>Carregando contas fixas...</p>";
          document.getElementById("listaContasVariaveis").innerHTML = "<p>Carregando contas variáveis...</p>";
          document.getElementById("cartoesContainer").innerHTML = "<p>Carregando compras por cartão...</p>";
          document.getElementById("responsaveisContainer").innerHTML = "<p>Carregando totais por responsável...</p>";
          document.getElementById("totalReceitas").textContent = "Total de Receitas: R$ 0.00";
          document.getElementById("totalDespesas").textContent = "Total de Despesas: R$ 0.00";
          document.getElementById("saldoLabel").textContent = "Saldo: R$ 0.00";
          document.getElementById("saldoBar").style.width = '0%';
          document.getElementById("saldoBar").classList.remove('negative');


          // Paraleliza as chamadas para otimizar o carregamento
          await Promise.all([
              atualizarReceitas(),
              atualizarContas(), 
              atualizarCartoes(), 
              atualizarComprasPorResponsavel(), 
              atualizarTotais() 
          ]);
      }

      // -------------------------------------------------------------------
      // Funções de atualização (GET data)
      // -------------------------------------------------------------------
      async function atualizarReceitas() {
        const listaReceitasElem = document.getElementById("listaReceitas");
        listaReceitasElem.innerHTML = "<p>Carregando receitas...</p>"; // Reset
        try {
          const payload = { action: "getReceitas", month: currentMonth + 1, year: currentYear };
          const response = await fetch(webAppUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await response.json();

          listaReceitasElem.innerHTML = ""; // Limpa antes de adicionar
          if (data && data.length > 0) {
            data.forEach(item => {
              const div = document.createElement("div");
              div.classList.add("list-item");
              div.innerHTML = `
                <div class="list-item-content">
                  <span>${item.nome} | R$ ${parseFloat(item.valor).toFixed(2)}</span>
                  <div class="list-item-controls">
                    <button onclick='editReceitaFront(\"${item.id}\", \"${item.nome}\", ${item.valor})'>Edit</button>
                    <button onclick='deleteReceitaFront(\"${item.id}\")'>X</button>
                  </div>
                </div>
              `;
              listaReceitasElem.appendChild(div);
            });
          } else {
            listaReceitasElem.innerHTML = "<p>Nenhuma receita encontrada.</p>";
          }
        } catch (error) {
          console.error("Erro ao carregar receitas:", error);
          listaReceitasElem.innerHTML = "<p>Erro ao carregar receitas.</p>";
        }
      }

      async function atualizarContas() {
        const listaContasFixasElem = document.getElementById("listaContasFixas");
        const listaContasVariaveisElem = document.getElementById("listaContasVariaveis");
        listaContasFixasElem.innerHTML = "<p>Carregando contas fixas...</p>"; // Reset
        listaContasVariaveisElem.innerHTML = "<p>Carregando contas variáveis...</p>"; // Reset
        try {
          const payload = { action: "getContas", month: currentMonth + 1, year: currentYear };
          const response = await fetch(webAppUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await response.json();

          listaContasFixasElem.innerHTML = "";
          listaContasVariaveisElem.innerHTML = "";

          if (data && data.length > 0) {
            const contasFixas = data.filter(item => item.tipo === 'Fixa');
            const contasVariaveis = data.filter(item => item.tipo === 'Variável');

            if (contasFixas.length > 0) {
                contasFixas.forEach(item => {
                    const div = document.createElement("div");
                    div.classList.add("list-item");
                    if (item.pago === 'Sim') div.classList.add('pago');
                    div.innerHTML = `
                      <div class="list-item-content">
                        <span>${item.nome} | ${item.parcelaAtual}/${item.parcelasTotais} | R$ ${parseFloat(item.valor).toFixed(2)}</span>
                        <input type="checkbox" class="checkbox-pago" ${item.pago === 'Sim' ? 'checked' : ''} onchange="markContaAsPaidFront('${item.id}', this.checked)">
                        <div class="list-item-controls">
                          <button onclick='editContaFront(\"${item.id}\", \"${item.tipo}\", \"${item.nome}\", \"${item.parcelaAtual}/${item.parcelasTotais}\", ${item.valor})'>Edit</button>
                          <button onclick='deleteContaFront(\"${item.id}\")'>X</button>
                        </div>
                      </div>
                    `;
                    listaContasFixasElem.appendChild(div);
                });
            } else {
                listaContasFixasElem.innerHTML = "<p>Nenhuma conta fixa encontrada.</p>";
            }

            if (contasVariaveis.length > 0) {
                contasVariaveis.forEach(item => {
                    const div = document.createElement("div");
                    div.classList.add("list-item");
                    if (item.pago === 'Sim') div.classList.add('pago');
                    div.innerHTML = `
                      <div class="list-item-content">
                        <span>${item.nome} | ${item.parcelaAtual}/${item.parcelasTotais} | R$ ${parseFloat(item.valor).toFixed(2)}</span>
                        <input type="checkbox" class="checkbox-pago" ${item.pago === 'Sim' ? 'checked' : ''} onchange="markContaAsPaidFront('${item.id}', this.checked)">
                        <div class="list-item-controls">
                          <button onclick='editContaFront(\"${item.id}\", \"${item.tipo}\", \"${item.nome}\", \"${item.parcelaAtual}/${item.parcelasTotais}\", ${item.valor})'>Edit</button>
                          <button onclick='deleteContaFront(\"${item.id}\")'>X</button>
                        </div>
                      </div>
                    `;
                    listaContasVariaveisElem.appendChild(div);
                });
            } else {
                listaContasVariaveisElem.innerHTML = "<p>Nenhuma conta variável encontrada.</p>";
            }

          } else {
            listaContasFixasElem.innerHTML = "<p>Nenhuma conta fixa encontrada.</p>";
            listaContasVariaveisElem.innerHTML = "<p>Nenhuma conta variável encontrada.</p>";
          }
        } catch (error) {
          console.error("Erro ao carregar contas:", error);
          listaContasFixasElem.innerHTML = "<p>Erro ao carregar contas fixas.</p>";
          listaContasVariaveisElem.innerHTML = "<p>Erro ao carregar contas variáveis.</p>";
        }
      }

      async function atualizarCartoes() {
        const cartoesContainer = document.getElementById("cartoesContainer");
        cartoesContainer.innerHTML = "<p>Carregando compras por cartão...</p>"; // Reset
        try {
          const payload = { action: "getCompras", month: currentMonth + 1, year: currentYear };
          const response = await fetch(webAppUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await response.json();

          cartoesContainer.innerHTML = ""; // Limpa antes de adicionar

          if (data && data.length > 0) {
            // Agrupar compras por cartão
            const comprasPorCartao = data.reduce((acc, item) => {
              const cartaoNome = item.cartao || 'Outros';
              if (!acc[cartaoNome]) {
                acc[cartaoNome] = [];
              }
              acc[cartaoNome].push(item);
              return acc;
            }, {});

            // Criar e popular as caixas de cartão
            for (const cardNome in comprasPorCartao) {
              const cardBox = document.createElement("div");
              cardBox.classList.add("cartao-box");
              
              const cardListElem = document.createElement("div");
              cardListElem.classList.add("cartao-list");
              
              let totalCartao = 0;
              const comprasDoCartao = comprasPorCartao[cardNome];

              // Verificar se todas as compras do cartão estão pagas
              const allPaid = comprasDoCartao.length > 0 && comprasDoCartao.every(item => item.pago === 'Sim');
              
              // Adiciona cabeçalho com checkbox para "Marcar todas"
              cardBox.innerHTML = `
                <h3>
                    ${cardNome} 
                    <input type="checkbox" class="cartao-paid-checkbox" ${allPaid ? 'checked' : ''} onchange="markAllComprasOfCardAsPaidFront('${cardNome}', this.checked)">
                </h3>
                <div class="cartao-total" id="total-${cardNome.replace(/[^a-zA-Z0-9]/g, '')}">Total: R$ 0.00</div>
              `;
              cardBox.appendChild(cardListElem);

              comprasDoCartao.forEach(item => {
                const div = document.createElement("div");
                div.classList.add("list-item");
                // Adiciona a classe do responsável para estilização
                const responsavelClass = item.responsavel ? item.responsavel.toLowerCase().replace(/á/g, 'a').replace(/ /g, '') : '';
                div.classList.add(responsavelClass); 
                if (item.pago === 'Sim') div.classList.add('pago'); // Aplica a classe 'pago' para riscados

                div.innerHTML = `
                  <div class="list-item-content">
                    <span>${item.nome} | ${item.parcelaAtual}/${item.parcelasTotais} | R$ ${parseFloat(item.valor).toFixed(2)} (${item.responsavel})</span>
                    <input type="checkbox" class="checkbox-pago" ${item.pago === 'Sim' ? 'checked' : ''} onchange="markCompraAsPaidFront('${item.id}', this.checked)">
                    <div class="list-item-controls">
                      <button onclick='editCompraFront(\"${item.id}\", \"${item.cartao}\", \"${item.responsavel}\", \"${item.nome}\", ${item.valor}, \"${item.parcelaAtual}/${item.parcelasTotais}\")'>Edit</button>
                      <button onclick='deleteCompraFront(\"${item.id}\")'>X</button>
                    </div>
                  </div>
                `;
                cardListElem.appendChild(div);
                if (item.pago !== 'Sim') { // Somar apenas se não estiver pago
                  totalCartao += parseFloat(item.valor);
                }
              });
              document.getElementById(`total-${cardNome.replace(/[^a-zA-Z0-9]/g, '')}`).textContent = `Total: R$ ${totalCartao.toFixed(2)}`;
              cartoesContainer.appendChild(cardBox);
            }
          } else {
            cartoesContainer.innerHTML = "<p>Nenhuma compra encontrada.</p>";
          }
        } catch (error) {
          console.error("Erro ao carregar compras por cartão:", error);
          cartoesContainer.innerHTML = "<p>Erro ao carregar compras por cartão.</p>";
        }
      }

      async function atualizarTotais() {
        const totalReceitasElem = document.getElementById("totalReceitas");
        const totalDespesasElem = document.getElementById("totalDespesas");
        const saldoLabelElem = document.getElementById("saldoLabel");
        const saldoBarElem = document.getElementById("saldoBar");

        totalReceitasElem.textContent = "Total de Receitas: R$ 0.00";
        totalDespesasElem.textContent = "Total de Despesas: R$ 0.00";
        saldoLabelElem.textContent = "Saldo: R$ 0.00";
        saldoBarElem.style.width = '0%';
        saldoBarElem.classList.remove('negative');

        try {
          const payload = { action: "getTotais", month: currentMonth + 1, year: currentYear };
          const response = await fetch(webAppUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await response.json();

          if (data) {
            const totalReceitas = parseFloat(data.receitas || 0);
            const totalDespesas = parseFloat(data.despesas || 0);
            const saldo = parseFloat(data.saldo || 0);

            totalReceitasElem.textContent = `Total de Receitas: R$ ${totalReceitas.toFixed(2)}`;
            totalDespesasElem.textContent = `Total de Despesas: R$ ${totalDespesas.toFixed(2)}`;
            saldoLabelElem.textContent = `Saldo: R$ ${saldo.toFixed(2)}`;

            const maxTotal = Math.max(totalReceitas, totalDespesas, Math.abs(saldo));
            if (maxTotal > 0) {
                let saldoPercent = (saldo / maxTotal) * 100;
                // Ajustar para que a barra não seja negativa e apenas mude de cor
                if (saldo < 0) {
                    saldoBarElem.classList.add('negative');
                    saldoPercent = Math.abs(saldo / maxTotal) * 100; // Usa o valor absoluto para preencher a barra
                } else {
                    saldoBarElem.classList.remove('negative');
                }
                saldoBarElem.style.width = `${Math.min(100, Math.max(0, saldoPercent))}%`;
            } else {
                saldoBarElem.style.width = '0%';
                saldoBarElem.classList.remove('negative');
            }
          }
        } catch (error) {
          console.error("Erro ao carregar totais:", error);
          totalReceitasElem.textContent = "Erro ao carregar receitas.";
          totalDespesasElem.textContent = "Erro ao carregar despesas.";
          saldoLabelElem.textContent = "Erro ao carregar saldo.";
        }
      }

      async function atualizarComprasPorResponsavel() {
        const responsaveisContainer = document.getElementById("responsaveisContainer");
        responsaveisContainer.innerHTML = "<p>Carregando totais por responsável...</p>"; // Reset
        try {
          const payload = { action: "getComprasPorResponsavel", month: currentMonth + 1, year: currentYear };
          const response = await fetch(webAppUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await response.json();

          responsaveisContainer.innerHTML = ""; // Limpa antes de adicionar

          if (data) {
            for (const responsavelNome in data) {
              const info = data[responsavelNome];
              const responsavelBox = document.createElement("div");
              const className = responsavelNome.toLowerCase().replace(/[^a-zA-Z0-9]/g, ''); // Para cores CSS
              responsavelBox.classList.add("responsavel-box", className);
              
              let comprasListHtml = "";
              if (info.compras && info.compras.length > 0) {
                info.compras.forEach(compra => {
                  comprasListHtml += `<p>${compra.nome} (R$ ${parseFloat(compra.valor).toFixed(2)}) - ${compra.cartao}</p>`;
                });
              } else {
                comprasListHtml += "<p>Nenhuma compra pendente.</p>";
              }

              responsavelBox.innerHTML = `
                <h3>${responsavelNome}</h3>
                <p>Total Pendente: R$ ${parseFloat(info.total).toFixed(2)}</p>
                <div class="compras-detalhe">
                    ${comprasListHtml}
                </div>
              `;
              responsaveisContainer.appendChild(responsavelBox);
            }
          } else {
            responsaveisContainer.innerHTML = "<p>Nenhum total por responsável encontrado.</p>";
          }
        } catch (error) {
          console.error("Erro ao carregar compras por responsável:", error);
          responsaveisContainer.innerHTML = "<p>Erro ao carregar totais por responsável.</p>";
        }
      }


      // -------------------------------------------------------------------
      // Funções de Submissão (ADD data)
      // -------------------------------------------------------------------
      async function submitReceita() {
        const nome = document.getElementById("receitaNome").value;
        const valor = document.getElementById("receitaValor").value;

        if (!nome || !valor) {
          alert("Por favor, preencha todos os campos da receita.");
          return;
        }

        const payload = {
          action: "addReceita",
          data: { nome: nome, valor: valor }
        };

        try {
          const response = await fetch(webAppUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await response.json();
          alert(data.message);
          document.getElementById("receitaNome").value = "";
          document.getElementById("receitaValor").value = "";
          hideAllForms(); // Esconde o formulário após a submissão
          fetchAllData(); // Recarrega todos os dados
        } catch (error) {
          console.error("Erro ao adicionar receita:", error);
          alert("Erro ao adicionar receita. Verifique o console para mais detalhes.");
        }
      }

      async function submitCompraCartao() {
        const cartao = document.getElementById("compraCartao").value;
        const responsavel = document.getElementById("compraResponsavel").value;
        const nome = document.getElementById("compraNome").value;
        const valor = document.getElementById("compraValor").value;
        const parcelas = document.getElementById("compraParcelas").value;

        if (!cartao || !responsavel || !nome || !valor || !parcelas) {
          alert("Por favor, preencha todos os campos da compra no cartão.");
          return;
        }
        
        // Validação simples de parcelas (ex: "1/6")
        if (!/^\d+\/\d+$/.test(parcelas)) {
            alert("Formato de parcelas inválido. Use 'parcelaAtual/totalDeParcelas' (ex: 1/6).");
            return;
        }

        const payload = {
          action: "addCompraCartao",
          data: { 
            cartao: cartao, 
            responsavel: responsavel, 
            nome: nome, 
            valor: valor, 
            parcelas: parcelas 
          }
        };

        try {
          const response = await fetch(webAppUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await response.json();
          alert(data.message);
          document.getElementById("compraCartao").value = "Credicard"; // Reset
          document.getElementById("compraResponsavel").value = "Liana"; // Reset
          document.getElementById("compraNome").value = "";
          document.getElementById("compraValor").value = "";
          document.getElementById("compraParcelas").value = "";
          hideAllForms();
          fetchAllData(); // Recarrega todos os dados
        } catch (error) {
          console.error("Erro ao adicionar compra no cartão:", error);
          alert("Erro ao adicionar compra no cartão. Verifique o console para mais detalhes.");
        }
      }

      async function submitConta() {
        const tipo = document.getElementById("tipoConta").value;
        const nome = document.getElementById("contaNome").value;
        const parcelas = document.getElementById("contaParcelas").value;
        const valor = document.getElementById("contaValor").value;

        if (!tipo || !nome || !parcelas || !valor) {
          alert("Por favor, preencha todos os campos da conta.");
          return;
        }

        // Validação simples de parcelas (ex: "1/3")
        if (!/^\d+\/\d+$/.test(parcelas)) {
            alert("Formato de parcelas inválido. Use 'parcelaAtual/totalDeParcelas' (ex: 1/3).");
            return;
        }

        const payload = {
          action: "addConta",
          data: { tipo: tipo, nome: nome, parcelas: parcelas, valor: valor }
        };

        try {
          const response = await fetch(webAppUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await response.json();
          alert(data.message);
          document.getElementById("tipoConta").value = "Fixa"; // Reset
          document.getElementById("contaNome").value = "";
          document.getElementById("contaParcelas").value = "";
          document.getElementById("contaValor").value = "";
          hideAllForms();
          fetchAllData(); // Recarrega todos os dados
        } catch (error) {
          console.error("Erro ao adicionar conta:", error);
          alert("Erro ao adicionar conta. Verifique o console para mais detalhes.");
        }
      }

      // -------------------------------------------------------------------
      // Funções de Edição (UPDATE data) - Simplificadas para prompt
      // -------------------------------------------------------------------
      function editReceitaFront(recordId, currentNome, currentValor) {
        const newNome = prompt("Editar nome da receita:", currentNome);
        if (newNome === null) return; // Cancelado
        const newValor = prompt("Editar valor da receita:", currentValor);
        if (newValor === null || isNaN(newValor)) return; // Cancelado ou inválido

        const payload = { 
          action: "updateReceita", 
          recordId: recordId, 
          data: { nome: newNome, valor: parseFloat(newValor) } 
        };
        
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllData(); 
        })
        .catch(error => {
          console.error("Erro ao editar receita:", error);
          alert("Erro ao editar receita. Verifique o console.");
        });
      }

      function editContaFront(recordId, currentTipo, currentNome, currentParcelas, currentValor) {
        const newTipo = prompt("Editar tipo da conta (Fixa/Variável):", currentTipo);
        if (newTipo === null) return;
        const newNome = prompt("Editar nome da conta:", currentNome);
        if (newNome === null) return;
        const newParcelas = prompt("Editar parcelas (ex: 2/3):", currentParcelas);
        if (newParcelas === null || !/^\d+\/\d+$/.test(newParcelas)) return;
        const newValor = prompt("Editar valor da conta:", currentValor);
        if (newValor === null || isNaN(newValor)) return;

        const payload = { 
          action: "updateConta", 
          recordId: recordId, 
          data: { tipo: newTipo, nome: newNome, parcelas: newParcelas, valor: parseFloat(newValor) } 
        };
        
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllData(); 
        })
        .catch(error => {
          console.error("Erro ao editar conta:", error);
          alert("Erro ao editar conta. Verifique o console.");
        });
      }

      function editCompraFront(recordId, currentCartao, currentResponsavel, currentNome, currentValor, currentParcelas) {
        const newCartao = prompt("Editar cartão:", currentCartao);
        if (newCartao === null) return;
        const newResponsavel = prompt("Editar responsável:", currentResponsavel);
        if (newResponsavel === null) return;
        const newNome = prompt("Editar nome da compra:", currentNome);
        if (newNome === null) return;
        const newValor = prompt("Editar valor da compra:", currentValor);
        if (newValor === null || isNaN(newValor)) return;
        const newParcelas = prompt("Editar parcelas (ex: 2/6):", currentParcelas);
        if (newParcelas === null || !/^\d+\/\d+$/.test(newParcelas)) return;

        const payload = { 
          action: "updateCompra", 
          recordId: recordId, 
          data: { cartao: newCartao, responsavel: newResponsavel, nome: newNome, valor: parseFloat(newValor), parcelas: newParcelas } 
        };
        
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllData(); 
        })
        .catch(error => {
          console.error("Erro ao editar compra:", error);
          alert("Erro ao editar compra. Verifique o console.");
        });
      }

      // -------------------------------------------------------------------
      // Funções de Exclusão (DELETE data)
      // -------------------------------------------------------------------
      function deleteReceitaFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta receita?")) return;
        const payload = { action: "deleteReceita", recordId: recordId };
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllData(); 
        })
        .catch(error => {
          console.error("Erro ao excluir receita:", error);
          alert("Erro ao excluir receita. Verifique o console.");
        });
      }

      function deleteContaFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta conta?")) return;
        const payload = { action: "deleteConta", recordId: recordId };
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllData(); 
        })
        .catch(error => {
          console.error("Erro ao excluir conta:", error);
          alert("Erro ao excluir conta. Verifique o console.");
        });
      }

      function deleteCompraFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta compra?")) return;
        const payload = { action: "deleteCompra", recordId: recordId };
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllData(); 
        })
        .catch(error => {
          console.error("Erro ao excluir compra:", error);
          alert("Erro ao excluir compra. Verifique o console.");
        });
      }

      // -------------------------------------------------------------------
      // Funções de Marcação como PAGO
      // -------------------------------------------------------------------
      function markContaAsPaidFront(recordId, isChecked) {
          const pagoStatus = isChecked ? 'Sim' : 'Não';
          const payload = {
              action: "markContaAsPaid",
              recordId: recordId,
              data: { pago: pagoStatus }
          };

          fetch(webAppUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
          })
          .then(response => response.json())
          .then(data => {
              // alert(data.message); // Opcional: feedback para cada marcação
              fetchAllData(); // Recarrega para atualizar totais e estados
          })
          .catch(error => {
              console.error("Erro ao marcar conta como paga/não paga:", error);
              alert("Erro ao atualizar status da conta. Verifique o console.");
          });
      }

      function markCompraAsPaidFront(recordId, isChecked) {
          const pagoStatus = isChecked ? 'Sim' : 'Não';
          const payload = {
              action: "markCompraAsPaid",
              recordId: recordId,
              data: { pago: pagoStatus }
          };

          fetch(webAppUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
          })
          .then(response => response.json())
          .then(data => {
              // alert(data.message); // Opcional: feedback para cada marcação
              fetchAllData(); // Recarrega para atualizar totais e estados
          })
          .catch(error => {
              console.error("Erro ao marcar compra como paga/não paga:", error);
              alert("Erro ao atualizar status da compra. Verifique o console.");
          });
      }

      async function markAllComprasOfCardAsPaidFront(cardName, isChecked) {
          if (!confirm(`Tem certeza que deseja marcar TODAS as compras do cartão "${cardName}" como ${isChecked ? 'PAGAS' : 'NÃO PAGAS'} neste mês?`)) {
              // Reverter o estado do checkbox se o usuário cancelar
              document.querySelector(`#total-${cardName.replace(/[^a-zA-Z0-9]/g, '')}`).parentNode.querySelector('.cartao-paid-checkbox').checked = !isChecked;
              return;
          }

          const pagoStatus = isChecked ? 'Sim' : 'Não';
          const payload = {
              action: "markAllComprasOfCardAsPaid",
              data: { card: cardName, pago: pagoStatus },
              month: currentMonth + 1, // Envia o mês e ano para o backend filtrar
              year: currentYear
          };

          try {
              const response = await fetch(webAppUrl, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload)
              });
              const data = await response.json();
              alert(data.message);
              fetchAllData(); // Recarrega todos os dados para refletir as mudanças
          } catch (error) {
              console.error("Erro ao marcar todas as compras do cartão:", error);
              alert("Erro ao marcar todas as compras do cartão. Verifique o console.");
          }
      }


      // -------------------------------------------------------------------
      // Event Listeners e Inicialização
      // -------------------------------------------------------------------
      document.addEventListener("DOMContentLoaded", function() {
        updateMonthDisplay(); // Define o mês e ano iniciais
        fetchAllData(); // Carrega todos os dados ao iniciar

        // Event listeners para navegação de mês
        document.querySelector(".nav-buttons button:first-child").addEventListener("click", function(){
          changeMonth(-1);
        });
        document.querySelector(".nav-buttons button:last-child").addEventListener("click", function(){
          changeMonth(1);
        });
      });
    </script>
  </body>
</html>
