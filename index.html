<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
    <style>
      /* CONFIGURAÇÃO GERAL */
      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        color: black; /* Texto padrão em preto */
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      .form-section,
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
      }
      /* BOTÕES */
      button {
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
        margin-top: 10px;
      }
      button:hover {
        background-color: #45a049;
      }
      button.delete {
        background-color: #f44336;
      }
      button.delete:hover {
        background-color: #da190b;
      }
      button.edit {
        background-color: #008cba;
      }
      button.edit:hover {
        background-color: #007bb5;
      }
      /* HEADER */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      header h1 {
        color: #333;
        margin: 0;
      }
      header h2 {
        color: #555;
        margin: 0;
      }
      .nav-buttons button {
        background-color: #007bff;
        margin: 0 5px;
      }
      .nav-buttons button:hover {
        background-color: #0056b3;
      }
      /* SEÇÃO DE TOTAIS */
      .totals-section {
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
      }
      .totals-wrapper {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
      }
      .totals-wrapper span {
        font-size: 1.1em;
        font-weight: bold;
      }
      /* Termômetro de Saldo */
      .saldo-bar-container {
        width: 100%;
        background-color: #ddd;
        border-radius: 5px;
        height: 25px;
        overflow: hidden;
        position: relative;
        margin-top: 10px;
      }
      .saldo-bar {
        height: 100%;
        width: 0%; /* Será preenchido por JS */
        background-color: green; /* Cor padrão */
        border-radius: 5px;
        transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
      }
      .saldo-bar.positive {
        background-color: #28a745; /* Verde para saldo positivo */
      }
      .saldo-bar.negative {
        background-color: #dc3545; /* Vermelho para saldo negativo */
      }
      .saldo-label {
        position: absolute;
        width: 100%;
        text-align: center;
        line-height: 25px;
        color: #333;
        font-weight: bold;
      }
      /* SEÇÃO DE CATEGORIAS (Receitas, Contas Fixas, Contas Variáveis) */
      .categorias-section {
        padding: 15px;
        margin-bottom: 20px;
      }
      .categorias-columns {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
      .categoria-box {
        padding: 15px;
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Empurra o botão para baixo */
      }
      .categoria-box h3 {
        margin-top: 0;
        color: #333;
      }
      .categoria-list {
        margin-top: 10px;
        flex-grow: 1; /* Permite que a lista cresça e ocupe o espaço */
      }
      .categoria-list p {
        margin: 5px 0;
      }
      .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px solid #eee;
      }
      .list-item:last-child {
        border-bottom: none;
      }
      .list-item-content {
        display: flex;
        align-items: center;
        flex-grow: 1;
      }
      .list-item-content span {
        flex-grow: 1;
      }
      .checkbox-pago {
        margin-left: 10px;
        margin-right: 10px;
        transform: scale(1.2); /* Aumenta o tamanho do checkbox */
      }
      .total-pago-box {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #90caf9;
      }
      .total-pago-box span {
        font-weight: bold;
      }
      .total-pago-box input[type="checkbox"] {
        transform: scale(1.3);
      }
      /* SEÇÃO DE CARTÕES */
      .cartoes-section {
        padding: 15px;
        margin-bottom: 20px;
      }
      .cartoes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }
      .cartao-box {
        background-color: #f0f8ff;
        border: 1px solid #a7d9ff;
        border-radius: 5px;
        padding: 15px;
        display: flex;
        flex-direction: column;
      }
      .cartao-box h3 {
        margin-top: 0;
        color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .cartao-box ul {
        list-style: none;
        padding: 0;
        margin: 10px 0;
        flex-grow: 1;
      }
      .cartao-box ul li {
        margin-bottom: 5px;
      }
      .cartao-box p {
        font-weight: bold;
        margin-top: 10px;
        border-top: 1px solid #a7d9ff;
        padding-top: 10px;
      }
      .compra {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px solid #eee;
      }
      .compra:last-child {
        border-bottom: none;
      }
      /* SEÇÃO DE FORMULÁRIOS */
      .forms-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }
      .form-section {
        padding: 15px;
      }
      .form-section h2 {
        margin-top: 0;
        color: #333;
      }
      .form-section input[type="text"],
      .form-section input[type="number"],
      .form-section select {
        width: calc(100% - 20px);
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .form-section .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .form-section .row input {
        flex: 1;
      }
      /* SEÇÃO DE COMPRAS POR RESPONSÁVEL */
      .compras-responsaveis {
        padding: 15px;
        margin-bottom: 20px;
      }
      .responsaveis-container {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 15px;
      }
      .responsavel-box {
        padding: 10px;
        min-width: 150px;
        text-align: center;
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em;
      }
      .responsavel-box p {
        margin: 5px 0;
        font-size: 0.9em;
      }
      /* Cores para Responsáveis (background) */
      .liana {
        background-color: #add8e6;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .stefany {
        background-color: #ffb347;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .marilia {
        background-color: #dda0dd;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .nosso {
        background-color: #ffc0cb;
        padding: 4px 8px;
        border-radius: 3px;
      }
      /* RODAPÉ */
      footer {
        text-align: center;
        margin-top: 20px;
      }
      footer p span {
        margin: 0 5px;
        font-weight: bold;
      }
      .list-item-controls {
          display: flex;
          justify-content: flex-end;
          gap: 5px;
          margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Painel Financeiro</h1>
        <h2>Maio 2025</h2> <div class="nav-buttons">
          <button>&laquo; Mês Anterior</button>
          <button>Mês Seguinte &raquo;</button>
        </div>
      </header>

      <div class="totals-section">
        <div class="totals-wrapper">
          <span>Total de Receitas: R$ 0.00</span>
          <span>Total de Despesas: R$ 0.00</span>
        </div>
        <div class="saldo-bar-container">
          <div class="saldo-bar"></div>
          <div class="saldo-label">Saldo: R$ 0.00</div>
        </div>
      </div>

      <div class="categorias-section">
        <h2>Resumo do Mês</h2>
        <div class="categorias-columns">
          <div class="categoria-box receitas">
            <h3>Receitas</h3>
            <div class="categoria-list" id="listaReceitas">
              <p>Carregando receitas...</p>
            </div>
            <button>Adicionar Receita</button>
          </div>

          <div class="categoria-box contas">
            <h3>Contas Fixas</h3>
            <div class="categoria-list" id="listaContasFixas">
              <p>Carregando contas fixas...</p>
            </div>
            <div class="total-pago-box">
                <span id="totalContasFixas">Total: R$ 0.00</span>
                <div>
                    <label for="pagoContasFixas">Tudo Pago:</label>
                    <input type="checkbox" id="pagoContasFixas" class="checkbox-pago" onchange="markAllContasAsPaidFront('Fixa', this.checked)">
                </div>
            </div>
          </div>

          <div class="categoria-box contas">
            <h3>Contas Variáveis</h3>
            <div class="categoria-list" id="listaContasVariaveis">
              <p>Carregando contas variáveis...</p>
            </div>
            <div class="total-pago-box">
                <span id="totalContasVariaveis">Total: R$ 0.00</span>
                <div>
                    <label for="pagoContasVariaveis">Tudo Pago:</label>
                    <input type="checkbox" id="pagoContasVariaveis" class="checkbox-pago" onchange="markAllContasAsPaidFront('Variável', this.checked)">
                </div>
            </div>
          </div>
        </div>
      </div>

      <div class="cartoes-section">
        <h2>Compras por Cartão</h2>
        <div class="cartoes-grid">
          <p>Carregando compras por cartão...</p>
          </div>
      </div>

      <div class="forms-container">
        <div class="form-section" id="formAdicionarCompra">
          <h2>Adicionar Compra</h2>
          <div class="row">
            <select id="responsavelCompra">
              <option value="Liana">Liana</option>
              <option value="Stefany">Stefany</option>
              <option value="Marília">Marília</option>
              <option value="Nosso ❤️">Nosso ❤️</option>
            </select>
            <select id="cartaoCompra">
              <option value="Liana">LIANA</option>
              <option value="Stefany">STEFANY</option>
              <option value="Marília">MARÍLIA</option>
              <option value="Nubank">NUBANK</option>
              <option value="Amazon">AMAZON</option>
              <option value="M. Pago">M. PAGO</option>
            </select>
          </div>
          <div class="row">
            <input type="text" id="nomeCompra" placeholder="Nome da Compra" />
          </div>
          <div class="row">
            <input type="number" id="valorCompra" placeholder="Valor" />
            <input type="text" id="parcelasCompra" placeholder="Parcelas (ex: 2/6)" />
          </div>
          <button>Adicionar Compra no Cartão</button>
          </div>

        <div class="form-section" id="formAdicionarConta">
          <h2>Adicionar Conta</h2>
          <select id="tipoConta">
            <option value="Fixa">Fixa</option>
            <option value="Variável">Variável</option>
          </select>
          <input type="text" id="nomeConta" placeholder="Nome da Conta" />
          <input type="text" id="parcelasConta" placeholder="Parcelas (ex: 2/3)" />
          <input type="number" id="valorConta" placeholder="Valor" />
          <button>Adicionar Conta</button>
          </div>
      </div>

      <div class="compras-responsaveis">
        <h2>Total de Compras por Responsável</h2>
        <div class="responsaveis-container">
          <p>Carregando totais por responsável...</p>
        </div>
      </div>

      <footer>
        <p>
          <span class="liana">Liana</span>,
          <span class="stefany">Stefany</span>,
          <span class="marilia">Marília</span>,
          <span class="nosso">Nosso ❤️</span>
        </p>
      </footer>
    </div>

    <script>
      // *** AQUI É ONDE A URL DO SEU CLOUDFLARE WORKER DEVE ENTRAR ***
      const webAppUrl = "https://painel-financas-proxy.mariliaedua.workers.dev/";
      // ***************************************************************

      let currentMonth = new Date().getMonth(); // 0-Janeiro, 1-Fevereiro, etc.
      let currentYear = new Date().getFullYear();

      const monthNames = [
        "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
      ];

      function updateMonthDisplay() {
        document.querySelector("header h2").textContent = `${monthNames[currentMonth]} ${currentYear}`;
      }

      function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        } else if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        updateMonthDisplay();
        // Recarrega todos os dados para o novo mês/ano
        atualizarReceitas(); // Receitas não são por mês, mas mantenha para consistência se no futuro filtrar.
        atualizarContas();
        atualizarCartoes();
        atualizarComprasPorResponsavel();
        atualizarTotais();
      }

      async function fetchData(action, payload = {}) {
        const fullPayload = { ...payload, action, month: currentMonth + 1, year: currentYear }; // Envia mês e ano
        try {
          const response = await fetch(webAppUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(fullPayload)
          });
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          console.error(`Erro ao buscar dados para ${action}:`, error);
          alert(`Erro ao carregar dados. Verifique o console para mais detalhes. (${action})`);
          return { data: [] }; // Retorna um array vazio para evitar erros em loops
        }
      }

      async function atualizarReceitas() {
        const listaReceitas = document.getElementById("listaReceitas");
        listaReceitas.innerHTML = "<p>Carregando receitas...</p>";
        const data = await fetchData("getReceitas");
        listaReceitas.innerHTML = ""; // Limpa a mensagem de carregamento

        if (data.data && data.data.length > 0) {
            let totalReceitas = 0;
            data.data.forEach(receita => {
                const div = document.createElement("div");
                div.classList.add("list-item");
                const valor = parseFloat(receita.valor || 0);
                totalReceitas += valor;
                div.innerHTML = `
                    <div class="list-item-content">
                        <span>${receita.nome} | R$ ${valor.toFixed(2)}</span>
                        <div class="list-item-controls">
                            <button class="edit" onclick='editReceitaFront("${receita.id}")'>Edit</button>
                            <button class="delete" onclick='deleteReceitaFront("${receita.id}")'>X</button>
                        </div>
                    </div>
                `;
                listaReceitas.appendChild(div);
            });
            document.querySelector(".totals-wrapper span:first-child").textContent = `Total de Receitas: R$ ${totalReceitas.toFixed(2)}`;
        } else {
            listaReceitas.innerHTML = "<p>Nenhuma receita adicionada.</p>";
            document.querySelector(".totals-wrapper span:first-child").textContent = `Total de Receitas: R$ 0.00`;
        }
        atualizarTotais();
      }


      async function atualizarContas() {
          const listaContasFixas = document.getElementById("listaContasFixas");
          const listaContasVariaveis = document.getElementById("listaContasVariaveis");
          const totalContasFixasElem = document.getElementById("totalContasFixas");
          const totalContasVariaveisElem = document.getElementById("totalContasVariaveis");
          const pagoContasFixasCheckbox = document.getElementById("pagoContasFixas");
          const pagoContasVariaveisCheckbox = document.getElementById("pagoContasVariaveis");

          listaContasFixas.innerHTML = "<p>Carregando contas fixas...</p>";
          listaContasVariaveis.innerHTML = "<p>Carregando contas variáveis...</p>";

          const data = await fetchData("getContas"); // O Apps Script deve filtrar por mês/ano

          let totalFixas = 0;
          let totalVariaveis = 0;
          let allFixedPaid = true;
          let allVariablePaid = true;
          let hasFixed = false;
          let hasVariable = false;

          listaContasFixas.innerHTML = "";
          listaContasVariaveis.innerHTML = "";

          if (data.data && data.data.length > 0) {
              data.data.forEach(conta => {
                  const valor = parseFloat(conta.valor || 0);
                  const parcelas = conta.parcelas || "1/1"; // Garante "1/1" se vazio

                  const div = document.createElement("div");
                  div.classList.add("list-item");
                  div.innerHTML = `
                      <div class="list-item-content">
                          <span>${conta.nome} | ${parcelas} | R$ ${valor.toFixed(2)}</span>
                          <div class="list-item-controls">
                              <button class="edit" onclick='editContaFront("${conta.id}")'>Edit</button>
                              <button class="delete" onclick='deleteContaFront("${conta.id}")'>X</button>
                          </div>
                      </div>
                  `;

                  if (conta.tipo === 'Fixa') {
                      listaContasFixas.appendChild(div);
                      totalFixas += valor;
                      hasFixed = true;
                      if (conta.pago !== 'Sim') {
                          allFixedPaid = false;
                      }
                  } else if (conta.tipo === 'Variável') {
                      listaContasVariaveis.appendChild(div);
                      totalVariaveis += valor;
                      hasVariable = true;
                      if (conta.pago !== 'Sim') {
                          allVariablePaid = false;
                      }
                  }
              });
          }

          if (!hasFixed) {
              listaContasFixas.innerHTML = "<p>Nenhuma conta fixa adicionada.</p>";
          }
          if (!hasVariable) {
              listaContasVariaveis.innerHTML = "<p>Nenhuma conta variável adicionada.</p>";
          }

          totalContasFixasElem.textContent = `Total: R$ ${totalFixas.toFixed(2)}`;
          totalContasVariaveisElem.textContent = `Total: R$ ${totalVariaveis.toFixed(2)}`;

          pagoContasFixasCheckbox.checked = hasFixed && allFixedPaid;
          pagoContasVariaveisCheckbox.checked = hasVariable && allVariablePaid;

          atualizarTotais();
      }

      async function atualizarCartoes() {
        const cartoesGrid = document.querySelector(".cartoes-grid");
        cartoesGrid.innerHTML = "<p>Carregando compras por cartão...</p>";

        const data = await fetchData("getComprasPorCartao");

        cartoesGrid.innerHTML = ""; // Limpa a mensagem de carregamento

        if (data.data && Object.keys(data.data).length > 0) {
            const cardNames = Object.keys(data.data);
            const orderedCardNames = ["Liana", "Stefany", "Marília", "Nubank", "Amazon", "M. Pago"].filter(name => cardNames.includes(name));
            const remainingCardNames = cardNames.filter(name => !orderedCardNames.includes(name));
            const finalCardOrder = [...orderedCardNames, ...remainingCardNames];


            finalCardOrder.forEach(cardNome => {
                const comprasDoCartao = data.data[cardNome];
                let totalCartao = 0;
                let allComprasPaid = true;
                let hasCompras = false;

                const cardBox = document.createElement("div");
                cardBox.classList.add("cartao-box");
                cardBox.innerHTML = `
                    <h3>${cardNome}</h3>
                    <div class="cartao-list"></div>
                    <div class="total-pago-box">
                        <p class="cartao-total">Total: R$ 0.00</p>
                        <div>
                            <label for="pago-${cardNome.replace(/\s/g, '-')}-cartao">Tudo Pago:</label>
                            <input type="checkbox" id="pago-${cardNome.replace(/\s/g, '-')}-cartao" class="checkbox-pago cartao-paid" onchange="markAllComprasOfCardAsPaid('${cardNome}', this.checked)">
                        </div>
                    </div>
                `;
                const cardListElem = cardBox.querySelector(".cartao-list");
                const cardTotalElem = cardBox.querySelector(".cartao-total");
                const checkboxCardPago = cardBox.querySelector(".cartao-paid");


                if (comprasDoCartao && comprasDoCartao.length > 0) {
                    hasCompras = true;
                    comprasDoCartao.forEach(item => {
                        const div = document.createElement("div");
                        const responsavelClass = item.responsavel ? item.responsavel.toLowerCase().replace(/á/g, 'a').replace(/ /g, '') : '';
                        div.classList.add("compra", responsavelClass);

                        const parcelasDisplay = item.parcelas ? `${item.parcelaAtual}/${item.parcelasTotais}` : '1/1';
                        const valorParcela = parseFloat(item.valor || 0); // Já é o valor da parcela

                        div.innerHTML = `
                            <div class="list-item-content">
                                <span>${item.nome} | ${parcelasDisplay} | R$ ${valorParcela.toFixed(2)} (${item.responsavel})</span>
                                <div class="list-item-controls">
                                    <button class="edit" onclick='editCompraFront(\"${item.id}\")'>Edit</button>
                                    <button class="delete" onclick='deleteCompraFront(\"${item.id}\")'>X</button>
                                </div>
                            </div>
                        `;
                        cardListElem.appendChild(div);
                        if (item.pago !== 'Sim') {
                            totalCartao += valorParcela;
                            allComprasPaid = false;
                        }
                    });
                } else {
                    cardListElem.innerHTML = "<p>Nenhuma compra neste cartão.</p>";
                }
                cardTotalElem.textContent = `Total: R$ ${totalCartao.toFixed(2)}`;
                checkboxCardPago.checked = hasCompras && allComprasPaid;
                cartoesGrid.appendChild(cardBox);
            });
        } else {
            cartoesGrid.innerHTML = "<p>Nenhuma compra por cartão.</p>";
        }
        atualizarTotais();
      }


      async function atualizarComprasPorResponsavel() {
        const responsaveisContainer = document.querySelector(".responsaveis-container");
        responsaveisContainer.innerHTML = "<p>Carregando totais por responsável...</p>";

        const data = await fetchData("getComprasPorResponsavel");
        responsaveisContainer.innerHTML = ""; // Limpa a mensagem de carregamento

        if (data.data && Object.keys(data.data).length > 0) {
            // Ordenar para garantir que Liana, Stefany, Marília, Nosso ❤️ apareçam primeiro
            const orderedResponsibles = ['Liana', 'Stefany', 'Marília', 'Nosso ❤️'].filter(r => data.data[r]);
            const otherResponsibles = Object.keys(data.data).filter(r => !orderedResponsibles.includes(r));
            const finalOrder = [...orderedResponsibles, ...otherResponsibles];

            finalOrder.forEach(responsavelNome => {
                const info = data.data[responsavelNome];
                if (info) {
                    const responsavelClass = responsavelNome.toLowerCase().replace(/á/g, 'a').replace(/ /g, '');
                    const div = document.createElement("div");
                    div.classList.add("responsavel-box", responsavelClass);
                    div.innerHTML = `
                        <h3>${responsavelNome}</h3>
                        <p>Total: R$ ${info.total.toFixed(2)}</p>
                    `;
                    responsaveisContainer.appendChild(div);
                }
            });
        } else {
            responsaveisContainer.innerHTML = "<p>Nenhum total por responsável disponível.</p>";
        }
      }

      async function atualizarTotais() {
        const totalReceitasElem = document.querySelector(".totals-wrapper span:first-child");
        const totalDespesasElem = document.querySelector(".totals-wrapper span:last-child");
        const saldoLabel = document.querySelector(".saldo-label");
        const saldoBar = document.querySelector(".saldo-bar");

        const receitasData = await fetchData("getReceitas");
        const comprasData = await fetchData("getComprasPorCartao"); // Pega compras para calcular despesas de compras
        const contasData = await fetchData("getContas"); // Pega contas para calcular despesas de contas

        let totalReceitas = 0;
        if (receitasData.data) {
            receitasData.data.forEach(receita => {
                totalReceitas += parseFloat(receita.valor || 0);
            });
        }

        let totalDespesas = 0;
        if (comprasData.data) {
            Object.values(comprasData.data).forEach(comprasDoCartao => {
                comprasDoCartao.forEach(compra => {
                    if (compra.pago !== 'Sim') { // Somar apenas se não estiver pago
                        totalDespesas += parseFloat(compra.valor || 0);
                    }
                });
            });
        }
        if (contasData.data) {
            contasData.data.forEach(conta => {
                if (conta.pago !== 'Sim') { // Somar apenas se não estiver pago
                    totalDespesas += parseFloat(conta.valor || 0);
                }
            });
        }

        totalReceitasElem.textContent = `Total de Receitas: R$ ${totalReceitas.toFixed(2)}`;
        totalDespesasElem.textContent = `Total de Despesas: R$ ${totalDespesas.toFixed(2)}`;

        const saldo = totalReceitas - totalDespesas;
        saldoLabel.textContent = `Saldo: R$ ${saldo.toFixed(2)}`;

        // Atualizar o termômetro
        const maxDisplayValue = Math.max(totalReceitas, totalDespesas, Math.abs(saldo)); // Garante que a barra seja escalada corretamente
        let percentage = 0;
        if (maxDisplayValue > 0) {
            percentage = (Math.abs(saldo) / maxDisplayValue) * 100;
        }

        saldoBar.style.width = `${percentage}%`;
        saldoBar.classList.remove('positive', 'negative');
        if (saldo >= 0) {
            saldoBar.classList.add('positive');
        } else {
            saldoBar.classList.add('negative');
        }
      }


      async function submitReceita() {
        const nome = prompt("Nome da Receita:");
        const valorStr = prompt("Valor da Receita:");
        if (!nome || !valorStr) {
            alert("Nome e Valor da receita são obrigatórios.");
            return;
        }
        const valor = parseFloat(valorStr);
        if (isNaN(valor) || valor <= 0) {
            alert("Valor da receita deve ser um número positivo.");
            return;
        }
        const payload = {
            action: "addReceita",
            data: { nome, valor }
        };
        const data = await fetchData("addReceita", payload);
        alert(data.message);
        atualizarReceitas();
      }

      async function editReceitaFront(recordId) {
        const nomeAtual = prompt("Novo Nome da Receita:");
        const valorAtualStr = prompt("Novo Valor da Receita:");
        if (!nomeAtual || !valorAtualStr) {
            alert("Nome e Valor da receita são obrigatórios.");
            return;
        }
        const valorAtual = parseFloat(valorAtualStr);
        if (isNaN(valorAtual) || valorAtual <= 0) {
            alert("Valor da receita deve ser um número positivo.");
            return;
        }

        const payload = {
            action: "updateReceita",
            recordId: recordId,
            data: { nome: nomeAtual, valor: valorAtual }
        };
        const data = await fetchData("updateReceita", payload);
        alert(data.message);
        atualizarReceitas();
      }

      async function deleteReceitaFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta receita?")) return;
        const payload = { action: "deleteReceita", recordId: recordId };
        const data = await fetchData("deleteReceita", payload);
        alert(data.message);
        atualizarReceitas();
      }

      async function submitCompraCartao() {
        const responsavel = document.getElementById("responsavelCompra").value;
        const cartao = document.getElementById("cartaoCompra").value;
        const nome = document.getElementById("nomeCompra").value;
        const valorStr = document.getElementById("valorCompra").value;
        const parcelas = document.getElementById("parcelasCompra").value;

        if (!nome || !valorStr || !parcelas || !responsavel || !cartao) {
            alert("Todos os campos de compra são obrigatórios.");
            return;
        }
        const valor = parseFloat(valorStr);
        if (isNaN(valor) || valor <= 0) {
            alert("Valor da compra deve ser um número positivo.");
            return;
        }

        const payload = {
            action: "addCompra",
            data: { nome, valor, parcelas, responsavel, cartao }
        };
        const data = await fetchData("addCompra", payload);
        alert(data.message);
        document.getElementById("nomeCompra").value = "";
        document.getElementById("valorCompra").value = "";
        document.getElementById("parcelasCompra").value = "";
        atualizarCartoes();
        atualizarComprasPorResponsavel();
        atualizarTotais();
      }

      function deleteCompraFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta compra?")) return;
        const payload = { action: "deleteCompra", recordId: recordId };
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          atualizarCartoes();
          atualizarComprasPorResponsavel();
          atualizarTotais();
        })
        .catch(error => {
          console.error("Erro ao excluir compra:", error);
          alert("Erro ao excluir compra. Verifique o console.");
        });
      }

      async function editCompraFront(recordId) {
        const currentData = await fetchData("getCompra", { recordId: recordId });
        if (!currentData.data) {
            alert("Dados da compra não encontrados.");
            return;
        }

        const currentCompra = currentData.data;

        const novoNome = prompt("Novo Nome da Compra:", currentCompra.nome);
        const novoValorStr = prompt("Novo Valor da Compra:", currentCompra.valor);
        const novasParcelas = prompt("Novas Parcelas (ex: 2/6):", currentCompra.parcelas);
        const novoResponsavel = prompt("Novo Responsável:", currentCompra.responsavel);
        const novoCartao = prompt("Novo Cartão:", currentCompra.cartao);

        if (!novoNome || !novoValorStr || !novasParcelas || !novoResponsavel || !novoCartao) {
            alert("Todos os campos de compra são obrigatórios.");
            return;
        }
        const novoValor = parseFloat(novoValorStr);
        if (isNaN(novoValor) || novoValor <= 0) {
            alert("Valor da compra deve ser um número positivo.");
            return;
        }

        const payload = {
            action: "updateCompra",
            recordId: recordId,
            data: {
                nome: novoNome,
                valor: novoValor,
                parcelas: novasParcelas,
                responsavel: novoResponsavel,
                cartao: novoCartao
            }
        };
        const data = await fetchData("updateCompra", payload);
        alert(data.message);
        atualizarCartoes();
        atualizarComprasPorResponsavel();
        atualizarTotais();
      }

      async function markAllComprasOfCardAsPaid(cardName, isPaid) {
          const payload = {
              action: "markComprasByCardAsPaid",
              cardName: cardName,
              pago: isPaid ? "Sim" : "Não"
          };
          const data = await fetchData("markComprasByCardAsPaid", payload);
          alert(data.message);
          atualizarCartoes();
          atualizarTotais();
      }

      async function submitConta() {
        const tipo = document.getElementById("tipoConta").value;
        const nome = document.getElementById("nomeConta").value;
        const parcelas = document.getElementById("parcelasConta").value;
        const valorStr = document.getElementById("valorConta").value;

        if (!nome || !valorStr || !parcelas) {
            alert("Todos os campos de conta são obrigatórios.");
            return;
        }
        const valor = parseFloat(valorStr);
        if (isNaN(valor) || valor <= 0) {
            alert("Valor da conta deve ser um número positivo.");
            return;
        }

        const payload = {
            action: "addConta",
            data: { tipo, nome, parcelas, valor }
        };
        const data = await fetchData("addConta", payload);
        alert(data.message);
        document.getElementById("nomeConta").value = "";
        document.getElementById("parcelasConta").value = "";
        document.getElementById("valorConta").value = "";
        atualizarContas();
        atualizarTotais();
      }

      async function deleteContaFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta conta?")) return;
        const payload = { action: "deleteConta", recordId: recordId };
        const data = await fetchData("deleteConta", payload);
        alert(data.message);
        atualizarContas();
        atualizarTotais();
      }

      async function editContaFront(recordId) {
          const currentData = await fetchData("getConta", { recordId: recordId });
          if (!currentData.data) {
              alert("Dados da conta não encontrados.");
              return;
          }
          const currentConta = currentData.data;

          const novoTipo = prompt("Novo Tipo (Fixa/Variável):", currentConta.tipo);
          const novoNome = prompt("Novo Nome da Conta:", currentConta.nome);
          const novasParcelas = prompt("Novas Parcelas (ex: 2/3):", currentConta.parcelas);
          const novoValorStr = prompt("Novo Valor da Conta:", currentConta.valor);

          if (!novoTipo || !novoNome || !novasParcelas || !novoValorStr) {
              alert("Todos os campos de conta são obrigatórios.");
              return;
          }
          const novoValor = parseFloat(novoValorStr);
          if (isNaN(novoValor) || novoValor <= 0) {
              alert("Valor da conta deve ser um número positivo.");
              return;
          }

          const payload = {
              action: "updateConta",
              recordId: recordId,
              data: {
                  tipo: novoTipo,
                  nome: novoNome,
                  parcelas: novasParcelas,
                  valor: novoValor
              }
          };
          const data = await fetchData("updateConta", payload);
          alert(data.message);
          atualizarContas();
          atualizarTotais();
      }

      async function markAllContasAsPaidFront(tipoConta, isPaid) {
          const payload = {
              action: "markContasAsPaid",
              tipo: tipoConta,
              pago: isPaid ? "Sim" : "Não"
          };
          const data = await fetchData("markContasAsPaid", payload);
          alert(data.message);
          atualizarContas();
          atualizarTotais();
      }

      document.addEventListener("DOMContentLoaded", function(){
        updateMonthDisplay(); // Define o mês e ano iniciais
        atualizarReceitas();
        atualizarContas(); // Atualiza contas fixas e variáveis
        atualizarCartoes(); // Atualiza a seção de cartões
        atualizarComprasPorResponsavel(); // Atualiza a seção de totais por responsável
        atualizarTotais(); // Atualiza os totais gerais

        // Event listeners para navegação de mês
        document.querySelector(".nav-buttons button:first-child").addEventListener("click", function(){
          changeMonth(-1);
        });
        document.querySelector(".nav-buttons button:last-child").addEventListener("click", function(){
          changeMonth(1);
        });

        // Event listener para o botão de "Salvar Receitas" (agora um prompt)
        document.querySelector(".categoria-box.receitas button").addEventListener("click", function(e){
            e.preventDefault(); // Evita o comportamento padrão do botão se estiver dentro de um form
            submitReceita();
        });

        // Event listeners para os formulários de Compra e Conta
        document.querySelector("#formAdicionarCompra button").addEventListener("click", function(e){
          e.preventDefault();
          submitCompraCartao();
        });
        document.querySelector("#formAdicionarConta button").addEventListener("click", function(e){
          e.preventDefault();
          submitConta();
        });
      });
    </script>
  </body>
</html>
