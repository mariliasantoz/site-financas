<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
    <style>
      /* CONFIGURAÇÃO GERAL */
      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        color: black; /* Texto padrão em preto */
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      .form-section,
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
      }
      /* BOTÕES */
      button {
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #45a049;
      }
      button.delete-button {
        background-color: #f44336;
        margin-left: 5px;
      }
      button.delete-button:hover {
        background-color: #da190b;
      }
      button.edit-button {
        background-color: #ff9800;
        margin-left: 5px;
      }
      button.edit-button:hover {
        background-color: #e68a00;
      }

      /* CABEÇALHO */
      header {
        text-align: center;
        margin-bottom: 20px;
        position: relative;
      }
      header h1 {
        color: #333;
        margin-bottom: 10px;
      }
      header h2 {
        color: #555;
        margin-top: 0;
      }
      .nav-buttons {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          width: 100%;
          display: flex;
          justify-content: space-between;
          padding: 0 20px;
          box-sizing: border-box;
      }
      .nav-buttons button {
          background-color: #007bff;
          color: white;
          padding: 5px 10px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 1em;
      }
      .nav-buttons button:hover {
          background-color: #0056b3;
      }

      /* SEÇÃO DE TOTAIS */
      .totals-section {
        padding: 15px;
        margin-bottom: 20px;
      }
      .totals-wrapper {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
      }
      .saldo-bar-container {
        background-color: #ddd;
        border-radius: 5px;
        height: 25px;
        margin-top: 10px;
        overflow: hidden; /* Garante que a barra não vaze */
        position: relative;
      }
      .saldo-bar {
        height: 100%;
        width: 50%; /* Largura inicial, será ajustada via JS */
        background-color: green; /* Cor para saldo positivo */
        border-radius: 5px;
        transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
      }
      .saldo-bar.negative {
        background-color: red; /* Cor para saldo negativo */
      }
      .saldo-label {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      }

      /* SEÇÃO DE CATEGORIAS (Receitas, Contas Fixas, Variáveis) */
      .categorias-section {
        padding: 15px;
        margin-bottom: 20px;
      }
      .categorias-columns {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
      .categoria-box {
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
      }
      .categoria-box h3 {
        margin-top: 0;
        color: #333;
      }
      .categoria-list {
        text-align: left;
        margin-bottom: 10px;
        flex-grow: 1; /* Permite que a lista ocupe o espaço disponível */
      }
      .categoria-list p {
        margin: 5px 0;
        color: #555;
      }
      .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px dashed #c0c0c0;
      }
      .list-item:last-child {
        border-bottom: none;
      }
      .list-item span {
        flex-grow: 1;
        text-align: left;
      }
      .list-item-controls {
          display: flex;
          justify-content: flex-end;
          align-items: center;
      }
      .list-item-controls button {
          margin-left: 5px;
          padding: 4px 8px;
          font-size: 0.8em;
      }
      .categoria-box .total-categoria {
        font-weight: bold;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #c0c0c0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* Checkbox de pago para o total da categoria */
      .total-categoria .checkbox-pago-total {
          margin-left: 10px;
          width: 20px; /* Ajuste o tamanho conforme necessário */
          height: 20px;
          cursor: pointer;
      }

      /* SEÇÃO DE CARTÕES */
      .cartoes-section {
        padding: 15px;
        margin-bottom: 20px;
      }
      .cartoes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }
      .cartao-box {
        background-color: #f0f8ff;
        border: 1px solid #a7d9f7;
        border-radius: 5px;
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
      }
      .cartao-box h3 {
        margin-top: 0;
        color: #333;
      }
      .cartao-list {
        text-align: left;
        margin-bottom: 10px;
        flex-grow: 1;
      }
      .cartao-list p {
        margin: 5px 0;
        color: #555;
      }
      .cartao-box .total-cartao {
        font-weight: bold;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #a7d9f7;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .cartao-box .total-cartao .checkbox-pago-total {
          margin-left: 10px;
          width: 20px;
          height: 20px;
          cursor: pointer;
      }
      .compra {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px dashed #c0c0c0;
      }
      .compra:last-child {
        border-bottom: none;
      }
      .compra .list-item-content {
          flex-grow: 1;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .compra .list-item-content span {
          flex-grow: 1;
          text-align: left;
      }


      /* SEÇÃO DE FORMULÁRIOS */
      .form-section {
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
      }
      .form-section h2 {
        margin-top: 0;
        color: #333;
      }
      .form-section input[type="text"],
      .form-section input[type="number"],
      .form-section select {
        width: calc(100% - 20px);
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .form-section .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .form-section .row input {
        flex-grow: 1;
      }

      /* SEÇÃO DE COMPRAS POR RESPONSÁVEL */
      .compras-responsaveis {
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
      }
      .compras-responsaveis h2 {
        margin-top: 0;
        color: #333;
      }
      .responsaveis-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 15px;
      }
      .responsavel-box {
        padding: 15px;
        text-align: center;
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em;
      }
      .responsavel-box p {
        margin: 5px 0;
        font-size: 0.9em;
      }
      /* Cores para Responsáveis (background) */
      .liana {
        background-color: #add8e6;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .stefany {
        background-color: #ffb347;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .marilia {
        background-color: #dda0dd;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .nosso {
        background-color: #ffc0cb;
        padding: 4px 8px;
        border-radius: 3px;
      }
      /* RODAPÉ */
      footer {
        text-align: center;
        margin-top: 20px;
      }
      footer p span {
        margin: 0 5px;
        font-weight: bold;
      }
      .list-item-controls {
          display: flex;
          justify-content: flex-end;
          align-items: center;
      }

    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Painel Financeiro</h1>
        <h2>Maio 2025</h2> <div class="nav-buttons">
          <button>&laquo; Mês Anterior</button>
          <button>Mês Seguinte &raquo;</button>
        </div>
      </header>

      <div class="totals-section">
        <div class="totals-wrapper">
          <span>Total de Receitas: R$ 0.00</span>
          <span>Total de Despesas: R$ 0.00</span>
        </div>
        <div class="saldo-bar-container">
          <div class="saldo-bar"></div>
          <div class="saldo-label">Saldo: R$ 0.00</div>
        </div>
      </div>

      <div class="categorias-section">
        <h2>Resumo do Mês</h2>
        <div class="categorias-columns">
          <div class="categoria-box receitas">
            <h3>Receitas</h3>
            <div class="categoria-list" id="listaReceitas">
              <p>Carregando receitas...</p>
            </div>
            <button>Adicionar Receita</button>
          </div>

          <div class="categoria-box contas">
            <h3>Contas Fixas</h3>
            <div class="categoria-list" id="listaContasFixas">
              <p>Carregando contas fixas...</p>
            </div>
            <div class="total-categoria">
              <span>Total Fixas: R$ 0.00</span>
              <input type="checkbox" class="checkbox-pago-total" onchange="markAllContasAsPaidFront('Fixa', this.checked)">
            </div>
          </div>

          <div class="categoria-box contas">
            <h3>Contas Variáveis</h3>
            <div class="categoria-list" id="listaContasVariaveis">
              <p>Carregando contas variáveis...</p>
            </div>
            <div class="total-categoria">
              <span>Total Variáveis: R$ 0.00</span>
              <input type="checkbox" class="checkbox-pago-total" onchange="markAllContasAsPaidFront('Variável', this.checked)">
            </div>
          </div>
        </div>
      </div>

      <div class="cartoes-section">
        <h2>Cartões</h2>
        <div class="cartoes-grid" id="cartoesGrid">
          <p>Carregando cartões...</p>
        </div>
      </div>

      <div class="form-sections-wrapper" style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div class="form-section" id="formAdicionarCompra" style="flex: 1;">
          <h2>Adicionar Compra</h2>
          <div class="row">
            <select id="responsavelCompra">
              <option value="">Selecione o Responsável</option>
              <option value="Liana">Liana</option>
              <option value="Stefany">Stefany</option>
              <option value="Marília">Marília</option>
              <option value="Nosso ❤️">Nosso ❤️</option>
            </select>
            <select id="cartaoCompra">
              <option value="">Selecione o Cartão</option>
              <option value="Nubank">NUBANK</option>
              <option value="C6">C6</option>
              <option value="Itaú">ITAÚ</option>
              <option value="Bradesco">BRADESCO</option>
              <option value="Inter">INTER</option>
              <option value="M.Pago">M.PAGO</option>
              <option value="Amazon">AMAZON</option>
            </select>
          </div>
          <div class="row">
            <input type="text" id="nomeCompra" placeholder="Nome da Compra" />
          </div>
          <div class="row">
            <input type="number" id="valorCompra" placeholder="Valor" />
            <input type="text" id="parcelasCompra" placeholder="Parcelas (ex: 2/6)" />
          </div>
          <button>Adicionar Compra no Cartão</button>
          </div>

        <div class="form-section" id="formAdicionarConta" style="flex: 1;">
          <h2>Adicionar Conta</h2>
          <select id="tipoConta">
            <option value="Fixa">Fixa</option>
            <option value="Variável">Variável</option>
          </select>
          <input type="text" id="nomeConta" placeholder="Nome da Conta" />
          <input type="text" id="parcelasConta" placeholder="Parcelas (ex: 2/3)" />
          <input type="number" id="valorConta" placeholder="Valor" />
          <button>Adicionar Conta</button>
          </div>
      </div>

      <div class="compras-responsaveis">
        <h2>Total de Compras por Responsável</h2>
        <div class="responsaveis-container" id="responsaveisContainer">
          <p>Carregando totais por responsável...</p>
        </div>
      </div>

      <footer>
        <p>
          Cores dos Responsáveis:
          <span class="liana">Liana</span>,
          <span class="stefany">Stefany</span>,
          <span class="marilia">Marília</span>,
          <span class="nosso">Nosso ❤️</span>
        </p>
      </footer>
    </div>

    <script>
      // *** AQUI É ONDE A URL DO SEU CLOUDFLARE WORKER DEVE ENTRAR ***
      const webAppUrl = "https://painel-financas-proxy.mariliaedua.workers.dev/";
      // ***************************************************************

      let currentMonth = new Date().getMonth(); // 0-Janeiro, 1-Fevereiro, etc.
      let currentYear = new Date().getFullYear();

      const monthNames = [
        "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
      ];

      function updateMonthDisplay() {
        document.querySelector("header h2").textContent = `${monthNames[currentMonth]} ${currentYear}`;
      }

      function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        } else if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        updateMonthDisplay();
        // Recarrega todos os dados para o novo mês/ano
        fetchAllData();
      }

      async function fetchBackend(action, data = {}, recordId = null) {
          const payload = {
              action: action,
              data: data,
              recordId: recordId,
              month: currentMonth + 1, // Mês ajustado para 1-12
              year: currentYear
          };
          try {
              const response = await fetch(webAppUrl, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload)
              });
              if (!response.ok) {
                  const errorText = await response.text();
                  throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
              }
              return await response.json();
          } catch (error) {
              console.error(`Erro na requisição para o backend (${action}):`, error);
              alert(`Erro: ${error.message}. Verifique o console para mais detalhes.`);
              throw error; // Propaga o erro para quem chamou
          }
      }

      function atualizarReceitas() {
        fetchBackend("getReceitas", {}, null)
          .then(data => {
            const listaReceitas = document.getElementById("listaReceitas");
            listaReceitas.innerHTML = "";
            let totalReceitas = 0;
            if (data.data && data.data.length > 0) {
              data.data.forEach(item => {
                const div = document.createElement("div");
                div.classList.add("list-item");
                div.innerHTML = `
                  <span>${item.nome} | R$ ${parseFloat(item.valor).toFixed(2)}</span>
                  <div class="list-item-controls">
                    <button onclick='editReceitaFront(\"${item.id}\")'>Edit</button>
                    <button onclick='deleteReceitaFront(\"${item.id}\")'>X</button>
                  </div>
                `;
                listaReceitas.appendChild(div);
                totalReceitas += parseFloat(item.valor);
              });
            } else {
              listaReceitas.innerHTML = "<p>Nenhuma receita cadastrada.</p>";
            }
            document.querySelector(".totals-wrapper span:first-child").textContent = `Total de Receitas: R$ ${totalReceitas.toFixed(2)}`;
            atualizarTotais();
          })
          .catch(error => {
            console.error("Erro ao carregar receitas:", error);
            document.getElementById("listaReceitas").innerHTML = "<p>Erro ao carregar receitas.</p>";
          });
      }

      function submitReceita() {
        const nome = prompt("Nome da Receita:");
        if (!nome) return;
        const valor = prompt("Valor da Receita:");
        if (!valor || isNaN(parseFloat(valor))) {
          alert("Valor inválido.");
          return;
        }

        const payload = {
          nome: nome,
          valor: parseFloat(valor),
          mes: currentMonth + 1, // Mês atual
          ano: currentYear // Ano atual
        };
        fetchBackend("addReceita", payload)
          .then(data => {
            alert(data.message);
            atualizarReceitas();
          })
          .catch(error => console.error("Erro ao adicionar receita:", error));
      }

      function editReceitaFront(recordId) {
          fetchBackend("getReceita", {}, recordId)
              .then(data => {
                  const receita = data.data;
                  if (!receita) {
                      alert("Receita não encontrada.");
                      return;
                  }
                  const novoNome = prompt("Novo nome da Receita:", receita.nome);
                  if (novoNome === null) return; // Cancelado
                  const novoValor = prompt("Novo valor da Receita:", receita.valor);
                  if (novoValor === null || isNaN(parseFloat(novoValor))) {
                      alert("Valor inválido.");
                      return;
                  }

                  const payload = {
                      nome: novoNome,
                      valor: parseFloat(novoValor),
                      mes: currentMonth + 1,
                      ano: currentYear
                  };
                  fetchBackend("updateReceita", payload, recordId)
                      .then(updateData => {
                          alert(updateData.message);
                          atualizarReceitas();
                      })
                      .catch(error => console.error("Erro ao atualizar receita:", error));
              })
              .catch(error => console.error("Erro ao buscar receita para edição:", error));
      }

      function deleteReceitaFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta receita?")) return;
        fetchBackend("deleteReceita", {}, recordId)
          .then(data => {
            alert(data.message);
            atualizarReceitas();
          })
          .catch(error => console.error("Erro ao excluir receita:", error));
      }

      function atualizarContas() {
        fetchBackend("getContasFiltradas", {}, null)
          .then(data => {
            const listaContasFixas = document.getElementById("listaContasFixas");
            const listaContasVariaveis = document.getElementById("listaContasVariaveis");
            listaContasFixas.innerHTML = "";
            listaContasVariaveis.innerHTML = "";

            let totalFixas = 0;
            let totalVariaveis = 0;
            let allFixasPaid = true;
            let allVariaveisPaid = true;
            let hasFixas = false;
            let hasVariaveis = false;

            if (data.data && data.data.length > 0) {
              data.data.forEach(item => {
                const div = document.createElement("div");
                div.classList.add("list-item");

                const parcelasInfo = item.parcelaAtual && item.parcelasTotais ? `${item.parcelaAtual}/${item.parcelasTotais}` : '1/1';

                div.innerHTML = `
                  <span>${item.nome} | ${parcelasInfo} | R$ ${parseFloat(item.valor).toFixed(2)}</span>
                  <div class="list-item-controls">
                    <button onclick='editContaFront(\"${item.id}\")'>Edit</button>
                    <button onclick='deleteContaFront(\"${item.id}\")'>X</button>
                  </div>
                `;

                if (item.tipo === "Fixa") {
                  listaContasFixas.appendChild(div);
                  totalFixas += parseFloat(item.valor);
                  if (item.pago !== 'Sim') allFixasPaid = false;
                  hasFixas = true;
                } else if (item.tipo === "Variável") {
                  listaContasVariaveis.appendChild(div);
                  totalVariaveis += parseFloat(item.valor);
                  if (item.pago !== 'Sim') allVariaveisPaid = false;
                  hasVariaveis = true;
                }
              });
            }

            if (!hasFixas) {
                listaContasFixas.innerHTML = "<p>Nenhuma conta fixa cadastrada.</p>";
            }
            if (!hasVariaveis) {
                listaContasVariaveis.innerHTML = "<p>Nenhuma conta variável cadastrada.</p>";
            }

            document.querySelector(".categoria-box.contas:nth-of-type(1) .total-categoria span").textContent = `Total Fixas: R$ ${totalFixas.toFixed(2)}`;
            document.querySelector(".categoria-box.contas:nth-of-type(1) .checkbox-pago-total").checked = allFixasPaid && hasFixas;

            document.querySelector(".categoria-box.contas:nth-of-type(2) .total-categoria span").textContent = `Total Variáveis: R$ ${totalVariaveis.toFixed(2)}`;
            document.querySelector(".categoria-box.contas:nth-of-type(2) .checkbox-pago-total").checked = allVariaveisPaid && hasVariaveis;

            atualizarTotais();
          })
          .catch(error => {
            console.error("Erro ao carregar contas:", error);
            document.getElementById("listaContasFixas").innerHTML = "<p>Erro ao carregar contas fixas.</p>";
            document.getElementById("listaContasVariaveis").innerHTML = "<p>Erro ao carregar contas variáveis.</p>";
          });
      }

      function submitConta() {
        const tipo = document.getElementById("tipoConta").value;
        const nome = document.getElementById("nomeConta").value;
        const parcelas = document.getElementById("parcelasConta").value; // Ex: "2/6"
        const valor = document.getElementById("valorConta").value;

        if (!nome || !valor || isNaN(parseFloat(valor))) {
          alert("Por favor, preencha nome e valor da conta corretamente.");
          return;
        }

        const payload = {
          tipo: tipo,
          nome: nome,
          parcelas: parcelas || "1/1", // Garante que sempre tenha um valor
          valor: parseFloat(valor)
        };

        fetchBackend("addConta", payload)
          .then(data => {
            alert(data.message);
            document.getElementById("nomeConta").value = "";
            document.getElementById("parcelasConta").value = "";
            document.getElementById("valorConta").value = "";
            atualizarContas();
          })
          .catch(error => console.error("Erro ao adicionar conta:", error));
      }

      function editContaFront(recordId) {
          fetchBackend("getConta", {}, recordId)
              .then(data => {
                  const conta = data.data;
                  if (!conta) {
                      alert("Conta não encontrada.");
                      return;
                  }
                  const novoTipo = prompt("Novo tipo da Conta (Fixa/Variável):", conta.tipo);
                  if (novoTipo === null) return;
                  const novoNome = prompt("Novo nome da Conta:", conta.nome);
                  if (novoNome === null) return;
                  const novasParcelas = prompt("Novas parcelas (ex: 2/6):", conta.parcelaAtual + '/' + conta.parcelasTotais);
                  if (novasParcelas === null) return;
                  const novoValor = prompt("Novo valor da Conta:", conta.valor);
                  if (novoValor === null || isNaN(parseFloat(novoValor))) {
                      alert("Valor inválido.");
                      return;
                  }

                  const payload = {
                      tipo: novoTipo,
                      nome: novoNome,
                      parcelas: novasParcelas,
                      valor: parseFloat(novoValor),
                  };
                  fetchBackend("updateConta", payload, recordId)
                      .then(updateData => {
                          alert(updateData.message);
                          atualizarContas();
                      })
                      .catch(error => console.error("Erro ao atualizar conta:", error));
              })
              .catch(error => console.error("Erro ao buscar conta para edição:", error));
      }

      function deleteContaFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta conta?")) return;
        fetchBackend("deleteConta", {}, recordId)
          .then(data => {
            alert(data.message);
            atualizarContas();
          })
          .catch(error => console.error("Erro ao excluir conta:", error));
      }

      function markAllContasAsPaidFront(tipoConta, isChecked) {
          const pagoStatus = isChecked ? 'Sim' : 'Não';
          fetchBackend("markAllContasAsPaid", { tipo: tipoConta, pago: pagoStatus })
              .then(data => {
                  alert(data.message);
                  atualizarContas(); // Recarrega para refletir o status de pago
              })
              .catch(error => console.error(`Erro ao marcar todas as contas ${tipoConta} como pagas:`, error));
      }


      async function atualizarCartoes() {
        const cartoesGrid = document.getElementById("cartoesGrid");
        cartoesGrid.innerHTML = "<p>Carregando compras...</p>"; // Mensagem de carregamento única

        try {
            const data = await fetchBackend("getComprasPorCartao", {}, null);
            cartoesGrid.innerHTML = ""; // Limpa a mensagem de carregamento

            if (data.data && Object.keys(data.data).length > 0) {
                const responsavelColors = {
                    'Liana': 'liana',
                    'Stefany': 'stefany',
                    'Marília': 'marilia',
                    'Nosso ❤️': 'nosso'
                };

                // Ordem dos cartões
                const cardOrder = ["NUBANK", "C6", "ITAÚ", "BRADESCO", "INTER", "M.PAGO", "AMAZON"];
                const sortedCardNames = Object.keys(data.data).sort((a, b) => {
                    const indexA = cardOrder.indexOf(a.toUpperCase());
                    const indexB = cardOrder.indexOf(b.toUpperCase());
                    return indexA - indexB;
                });

                sortedCardNames.forEach(cardNome => {
                    const comprasDoCartao = data.data[cardNome];
                    let totalCartao = 0;
                    let allComprasPaid = true;

                    const cardBox = document.createElement("div");
                    cardBox.classList.add("cartao-box");

                    const cardListElem = document.createElement("div");
                    cardListElem.classList.add("cartao-list");

                    // Verifica se há compras para o cartão e se todas estão pagas para o checkbox principal
                    if (comprasDoCartao && comprasDoCartao.length > 0) {
                        comprasDoCartao.forEach(item => {
                            const div = document.createElement("div");
                            const responsavelClass = item.responsavel ? responsavelColors[item.responsavel] || '' : '';
                            div.classList.add("compra", responsavelClass);

                            // Ajusta a exibição das parcelas
                            const parcelaDisplay = (item.parcelaAtual && item.parcelasTotais) ?
                                `${item.parcelaAtual}/${item.parcelasTotais}` : '1/1';

                            div.innerHTML = `
                                <div class="list-item-content">
                                    <span>${item.nome} | ${parcelaDisplay} | R$ ${parseFloat(item.valor).toFixed(2)} (${item.responsavel})</span>
                                    <div class="list-item-controls">
                                        <button onclick='editCompraFront(\"${item.id}\")'>Edit</button>
                                        <button onclick='deleteCompraFront(\"${item.id}\")'>X</button>
                                    </div>
                                </div>
                            `;
                            cardListElem.appendChild(div);

                            if (item.pago !== 'Sim') {
                                totalCartao += parseFloat(item.valor);
                                allComprasPaid = false;
                            }
                        });
                    } else {
                        cardListElem.innerHTML = "<p>Nenhuma compra neste cartão.</p>";
                        allComprasPaid = false; // Se não há compras, não está "tudo pago"
                    }

                    cardBox.innerHTML = `
                        <h3>${cardNome}</h3>
                        ${cardListElem.outerHTML}
                        <div class="total-cartao">
                            <span>Total: R$ ${totalCartao.toFixed(2)}</span>
                            <input type="checkbox" class="checkbox-pago-total" ${allComprasPaid && comprasDoCartao.length > 0 ? 'checked' : ''} onchange="markAllComprasOfCardAsPaid('${cardNome}', this.checked)">
                        </div>
                    `;
                    cartoesGrid.appendChild(cardBox);
                });
            } else {
                cartoesGrid.innerHTML = "<p>Nenhum cartão com compras para este mês.</p>";
            }
            atualizarTotais();
        } catch (error) {
            console.error("Erro ao carregar compras por cartão:", error);
            cartoesGrid.innerHTML = "<p>Erro ao carregar compras de cartões.</p>";
        }
      }


      function submitCompraCartao() {
        const responsavel = document.getElementById("responsavelCompra").value;
        const cartao = document.getElementById("cartaoCompra").value;
        const nome = document.getElementById("nomeCompra").value;
        const valor = document.getElementById("valorCompra").value;
        const parcelas = document.getElementById("parcelasCompra").value;

        if (!responsavel || !cartao || !nome || !valor || isNaN(parseFloat(valor))) {
          alert("Por favor, preencha todos os campos da compra corretamente.");
          return;
        }

        const payload = {
          nome: nome,
          valor: parseFloat(valor),
          parcelas: parcelas || "1/1",
          responsavel: responsavel,
          cartao: cartao,
          mes: currentMonth + 1,
          ano: currentYear
        };

        fetchBackend("addCompra", payload)
          .then(data => {
            alert(data.message);
            document.getElementById("responsavelCompra").value = "";
            document.getElementById("cartaoCompra").value = "";
            document.getElementById("nomeCompra").value = "";
            document.getElementById("valorCompra").value = "";
            document.getElementById("parcelasCompra").value = "";
            atualizarCartoes();
            atualizarComprasPorResponsavel();
          })
          .catch(error => console.error("Erro ao adicionar compra:", error));
      }

      function editCompraFront(recordId) {
          fetchBackend("getCompra", {}, recordId)
              .then(data => {
                  const compra = data.data;
                  if (!compra) {
                      alert("Compra não encontrada.");
                      return;
                  }

                  const novoNome = prompt("Novo nome da Compra:", compra.nome);
                  if (novoNome === null) return;
                  const novoValor = prompt("Novo valor da Compra:", compra.valor);
                  if (novoValor === null || isNaN(parseFloat(novoValor))) {
                      alert("Valor inválido.");
                      return;
                  }
                  const novasParcelas = prompt("Novas parcelas (ex: 2/6):", compra.parcelaAtual + '/' + compra.parcelasTotais);
                  if (novasParcelas === null) return;
                  const novoResponsavel = prompt("Novo Responsável:", compra.responsavel);
                  if (novoResponsavel === null) return;
                  const novoCartao = prompt("Novo Cartão:", compra.cartao);
                  if (novoCartao === null) return;

                  const payload = {
                      nome: novoNome,
                      valor: parseFloat(novoValor),
                      parcelas: novasParcelas,
                      responsavel: novoResponsavel,
                      cartao: novoCartao,
                      mes: currentMonth + 1,
                      ano: currentYear
                  };
                  fetchBackend("updateCompra", payload, recordId)
                      .then(updateData => {
                          alert(updateData.message);
                          atualizarCartoes();
                          atualizarComprasPorResponsavel();
                      })
                      .catch(error => console.error("Erro ao atualizar compra:", error));
              })
              .catch(error => console.error("Erro ao buscar compra para edição:", error));
      }


      function deleteCompraFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta compra?")) return;
        fetchBackend("deleteCompra", {}, recordId)
          .then(data => {
            alert(data.message);
            atualizarCartoes(); // Atualiza a lista de cartões
            atualizarComprasPorResponsavel(); // Atualiza lista de responsáveis
            atualizarTotais(); // Atualiza os totais
          })
          .catch(error => console.error("Erro ao excluir compra:", error));
      }

      function markAllComprasOfCardAsPaid(cardNome, isChecked) {
          const pagoStatus = isChecked ? 'Sim' : 'Não';
          fetchBackend("markAllComprasOfCardAsPaid", { cartao: cardNome, pago: pagoStatus })
              .then(data => {
                  alert(data.message);
                  atualizarCartoes();
                  atualizarComprasPorResponsavel();
              })
              .catch(error => console.error(`Erro ao marcar todas as compras do cartão ${cardNome} como pagas:`, error));
      }


      function atualizarComprasPorResponsavel() {
        fetchBackend("getComprasPorResponsavel", {}, null)
          .then(data => {
            const responsaveisContainer = document.getElementById("responsaveisContainer");
            responsaveisContainer.innerHTML = "";
            if (data.data && Object.keys(data.data).length > 0) {
              const responsavelColors = {
                  'Liana': 'liana',
                  'Stefany': 'stefany',
                  'Marília': 'marilia',
                  'Nosso ❤️': 'nosso'
              };

              // Ordem fixa para exibição
              const responsavelOrder = ['Liana', 'Stefany', 'Marília', 'Nosso ❤️'];

              responsavelOrder.forEach(responsavelNome => {
                  const responsavelData = data.data[responsavelNome];
                  if (responsavelData) {
                      const div = document.createElement("div");
                      div.classList.add("responsavel-box", responsavelColors[responsavelNome] || ''); // Adiciona classe de cor
                      div.innerHTML = `
                          <h3>${responsavelNome}</h3>
                          <p>Total: R$ ${responsavelData.total.toFixed(2)}</p>
                      `;
                      responsaveisContainer.appendChild(div);
                  }
              });

            } else {
              responsaveisContainer.innerHTML = "<p>Nenhuma compra por responsável para este mês.</p>";
            }
            atualizarTotais();
          })
          .catch(error => {
            console.error("Erro ao carregar compras por responsável:", error);
            document.getElementById("responsaveisContainer").innerHTML = "<p>Erro ao carregar compras por responsável.</p>";
          });
      }

      async function atualizarTotais() {
        try {
          const receitasData = await fetchBackend("getReceitas", {}, null);
          const contasData = await fetchBackend("getContasFiltradas", {}, null);
          const comprasData = await fetchBackend("getComprasFiltradas", {}, null);

          let totalReceitas = receitasData.data.reduce((sum, r) => sum + parseFloat(r.valor), 0);
          let totalDespesas = 0;

          // Contas
          contasData.data.forEach(item => {
              if (item.pago !== 'Sim') { // Considerar apenas as contas não pagas no total de despesas
                  totalDespesas += parseFloat(item.valor);
              }
          });

          // Compras (cartões)
          comprasData.data.forEach(item => {
              if (item.pago !== 'Sim') { // Considerar apenas as compras não pagas no total de despesas
                  totalDespesas += parseFloat(item.valor);
              }
          });

          const saldo = totalReceitas - totalDespesas;

          document.querySelector(".totals-wrapper span:first-child").textContent = `Total de Receitas: R$ ${totalReceitas.toFixed(2)}`;
          document.querySelector(".totals-wrapper span:last-child").textContent = `Total de Despesas: R$ ${totalDespesas.toFixed(2)}`;
          document.querySelector(".saldo-label").textContent = `Saldo: R$ ${saldo.toFixed(2)}`;

          const saldoBar = document.querySelector(".saldo-bar");
          saldoBar.classList.remove("negative"); // Remove a classe negativa por padrão

          // Ajusta a barra de saldo
          if (saldo > 0) {
              const maxRange = Math.max(totalReceitas, totalDespesas); // Define a escala com base no maior valor
              let percentage = (saldo / maxRange) * 100;
              if (percentage > 100) percentage = 100; // Limita a 100%
              saldoBar.style.width = `${percentage}%`;
              saldoBar.style.backgroundColor = 'green';
          } else if (saldo < 0) {
              const maxRange = Math.max(totalReceitas, Math.abs(totalDespesas));
              let percentage = (Math.abs(saldo) / maxRange) * 100;
              if (percentage > 100) percentage = 100;
              saldoBar.style.width = `${percentage}%`;
              saldoBar.style.backgroundColor = 'red';
              saldoBar.classList.add("negative");
          } else {
              saldoBar.style.width = '0%';
              saldoBar.style.backgroundColor = 'grey'; // Ou qualquer cor para saldo zero
          }

        } catch (error) {
          console.error("Erro ao atualizar totais:", error);
        }
      }

      function fetchAllData() {
          atualizarReceitas();
          atualizarContas();
          atualizarCartoes();
          atualizarComprasPorResponsavel();
          atualizarTotais();
      }

      document.addEventListener("DOMContentLoaded", function(){
        updateMonthDisplay(); // Define o mês e ano iniciais
        fetchAllData(); // Carrega todos os dados iniciais

        // Event listeners para navegação de mês
        document.querySelector(".nav-buttons button:first-child").addEventListener("click", function(){
          changeMonth(-1);
        });
        document.querySelector(".nav-buttons button:last-child").addEventListener("click", function(){
          changeMonth(1);
        });

        // Event listener para o botão de "Salvar Receitas" (agora um prompt)
        document.querySelector(".categoria-box.receitas button").addEventListener("click", function(e){
            e.preventDefault(); // Evita o comportamento padrão do botão se estiver dentro de um form
            submitReceita();
        });

        // Event listeners para os formulários de Compra e Conta
        document.querySelector("#formAdicionarCompra button").addEventListener("click", function(e){
          e.preventDefault();
          submitCompraCartao();
        });
        document.querySelector("#formAdicionarConta button").addEventListener("click", function(e){
          e.preventDefault();
          submitConta();
        });
      });
    </script>
  </body>
</html>
