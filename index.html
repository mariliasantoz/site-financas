<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
    <style>
      /* CONFIGURAÇÃO GERAL */
      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        color: black; /* Texto padrão em preto */
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      .form-section,
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
      }
      /* BOTÕES */
      button {
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        padding: 8px 12px;
      }
      button:hover {
        background-color: #43a047;
      }
      /* Força inputs e selects a terem texto preto */
      input, select {
        color: black;
      }
      /* CENTRALIZAÇÃO DOS TÍTULOS */
      h1, h2, h3 {
        text-align: center;
      }
      /* CABEÇALHO E NAVEGAÇÃO */
      header {
        text-align: center;
        margin-bottom: 10px;
      }
      header h1 {
        margin: 0;
        font-size: 2.5em;
      }
      header h2 {
        margin: 5px 0 10px;
        font-size: 2em;
      }
      .nav-buttons {
        text-align: center;
        margin-bottom: 20px;
      }
      .nav-buttons button {
        padding: 10px 15px;
        margin: 0 10px;
      }
      /* TOTAIS – RESUMO DO MÊS */
      .totals-section {
        margin-bottom: 20px;
        padding: 15px;
      }
      .totals-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.2em;
      }
      .saldo-bar-container {
        position: relative;
        background-color: #ddd;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .saldo-bar {
        height: 100%;
        width: 40%;
        background-color: green;
        transition: width 0.5s;
      }
      .saldo-label {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        font-weight: bold;
        color: black;
      }
      /* CATEGORIAS – Receitas, Contas Fixas, Contas Variáveis */
      .categorias-section {
        margin-bottom: 20px;
        padding: 15px;
      }
      .categorias-section h2 {
        margin: 0 0 15px;
        font-size: 1.8em;
      }
      .categorias-columns {
        display: flex;
        justify-content: space-between;
        gap: 15px;
      }
      /* CAIXA RECEITAS */
      .categoria-box.receitas {
        width: 32%;
        padding: 10px;
      }
      .categoria-box.receitas h3 {
        margin: 0 0 10px;
        font-size: 1.2em;
        border-bottom: 1px solid #90caf9;
        padding-bottom: 5px;
        text-align: center;
      }
      .categoria-box.receitas .categoria-list .receita-item {
        margin-bottom: 8px;
        text-align: center;
      }
      .categoria-box.receitas .categoria-list .receita-item input {
        padding: 5px;
        margin: 5px;
        box-sizing: border-box;
      }
      /* CAIXA CONTAS FIXAS */
      .categoria-box.contas {
        width: 32%;
        padding: 10px;
      }
      .categoria-box.contas h3 {
        margin: 0 0 10px;
        font-size: 1.2em;
        border-bottom: 1px solid #90caf9;
        padding-bottom: 5px;
      }
      .categoria-box.contas .categoria-list .conta-item {
        padding: 5px;
        font-size: 0.9em;
        border-bottom: 1px dashed #90caf9;
        text-align: center;
      }
      .categoria-box.contas .categoria-list .conta-item:last-child {
        border-bottom: none;
      }
      .categoria-box.contas .conta-total {
        text-align: right;
        font-weight: bold;
        margin-top: 5px;
      }
      .categoria-box.receitas button {
        display: block;
        margin: 10px auto 0;
      }
      /* FORMULÁRIOS */
      .form-section {
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .form-section h2 {
        margin: 0 0 15px;
        font-size: 1.8em;
      }
      .form-section .row {
        width: 100%;
        text-align: center;
        margin: 10px 0;
      }
      .form-section select,
      .form-section input {
        width: 20%;
        padding: 8px;
        margin: 5px;
        box-sizing: border-box;
      }
      .form-section .nome-field {
        width: 40% !important;
      }
      .forms-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .forms-container > .form-section {
        width: 50%;
      }
      /* CARTÕES */
      .cartoes-section {
        margin-bottom: 20px;
        padding: 15px;
      }
      .cartoes-section h2 {
        margin-top: 0;
        font-size: 1.8em;
      }
      .cartoes-columns {
        display: flex;
        justify-content: space-between;
        gap: 15px;
      }
      .cartao-box {
        width: 23%;
        padding: 10px;
        text-align: center;
        border: 1px solid #90caf9;
        border-radius: 5px;
      }
      .cartao-box h3 {
        margin: 0 0 10px;
        font-size: 1.2em;
        border-bottom: 1px solid;
        padding-bottom: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .cartao-total {
        margin: 10px 0;
        font-weight: bold;
        color: black;
      }
      .cartao-list div {
        padding: 5px;
        font-size: 0.9em;
        border-bottom: 1px dashed;
        color: black;
      }
      .cartao-list div:last-child {
        border-bottom: none;
      }
      /* Cartões Personalizados */
      #nubankCard {
        background: linear-gradient(to bottom, #e8ccf5, #d1a9ea, #ba86e0, #8605b8);
        border: 1px solid #8605b8;
      }
      #santanderCard {
        background: linear-gradient(to bottom, #ffe6e6, #ffcccc, #ffb3b3, #e50000);
        border: 1px solid #e50000;
      }
      #mpagoCard {
        background: linear-gradient(to bottom, #d1e0f0, #a3c1e1, #75a2d2, #1c3d91);
        border: 1px solid #1c3d91;
      }
      #amazonCard {
        background: linear-gradient(to bottom, #ff9700, #d47c00, #aa6100, #222e3d);
        border: 1px solid #222e3d;
      }
      /* TOTAL DE COMPRAS POR RESPONSÁVEL - CENTRALIZADO */
      .compras-responsaveis {
        margin-bottom: 20px;
        padding: 15px;
        text-align: center;
      }
      .compras-responsaveis h2 {
        margin-bottom: 15px;
        font-size: 1.8em;
      }
      .responsaveis-container {
        display: flex;
        justify-content: space-around;
        gap: 15px;
        flex-wrap: wrap;
      }
      .responsavel-box {
        width: 22%;
        padding: 10px;
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
        text-align: center;
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em;
      }
      .responsavel-box p {
        margin: 5px 0;
        font-size: 0.9em;
      }
      /* Cores para Responsáveis (background) */
      .liana {
        background-color: #add8e6;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .stefany {
        background-color: #ffb347;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .marilia {
        background-color: #dda0dd;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .nosso {
        background-color: #ffc0cb;
        padding: 4px 8px;
        border-radius: 3px;
      }
      /* RODAPÉ */
      footer {
        text-align: center;
        margin-top: 20px;
      }
      footer p span {
        margin: 0 5px;
        font-weight: bold;
      }
      .list-item-controls {
          display: flex;
          justify-content: flex-end; /* Alinha botões à direita */
          gap: 5px;
          margin-top: 5px;
      }
      .list-item-controls button {
          padding: 3px 8px;
          font-size: 0.8em;
          margin-left: 5px;
      }
      .list-item-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
          width: 100%; /* Para que o flexbox distribua bem o conteúdo */
      }
      .checkbox-pago {
        margin-left: 10px;
        transform: scale(1.2); /* Aumenta o tamanho do checkbox */
      }
      /* Ajuste para itens de lista para que o checkbox não quebre a linha */
      .categoria-list .conta-item .list-item-content,
      .cartao-list .compra .list-item-content {
        flex-wrap: nowrap; /* Impede que os itens se quebrem em várias linhas */
      }
    </style>
    <script>
      // *** AQUI É ONDE A URL DO SEU CLOUDFLARE WORKER DEVE ENTRAR ***
      const webAppUrl = "https://painel-financas-proxy.mariliaedua.workers.dev/";
      // ***************************************************************
      
      // Mês atual é 0-Janeiro, 1-Fevereiro, etc. para Date()
      // Mas para o Apps Script, usamos 1-Janeiro, 2-Fevereiro, etc.
      let currentMonthIndex = new Date().getMonth(); // 0-11 para Date()
      let currentYear = new Date().getFullYear();

      const monthNames = [
        "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
      ];

      function updateMonthDisplay() {
        document.querySelector("header h2").textContent = `${monthNames[currentMonthIndex]} ${currentYear}`;
      }

      function changeMonth(delta) {
        currentMonthIndex += delta;
        if (currentMonthIndex < 0) {
          currentMonthIndex = 11;
          currentYear--;
        } else if (currentMonthIndex > 11) {
          currentMonthIndex = 0;
          currentYear++;
        }
        updateMonthDisplay();
        // Recarregar todos os dados para o novo mês/ano
        fetchAllDataForMonth();
      }

      function getPayload(action, data = {}, recordId = null) {
          const payload = {
              action: action,
              month: currentMonthIndex + 1, // Apps Script usa 1-12
              year: currentYear,
              data: data
          };
          if (recordId) {
              payload.recordId = recordId;
          }
          return payload;
      }

      // Função para buscar todos os dados após mudança de mês ou alteração
      function fetchAllDataForMonth() {
          atualizarReceitas();
          atualizarContas();
          atualizarCartoes();
          atualizarComprasPorResponsavel();
          atualizarTotais();
      }

      // RECEITAS
      function atualizarReceitas() {
        const payload = getPayload("getReceitas");
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          const container = document.getElementById("listaReceitas");
          container.innerHTML = "";
          if (data && data.length > 0) {
            data.forEach(item => {
              const div = document.createElement("div");
              div.classList.add("receita-item");
              div.innerHTML = `
                <div class="list-item-content">
                  <span>${item.nome} - R$ ${Number(item.valor).toFixed(2)}</span>
                  <div class="list-item-controls">
                    <button onclick='editReceitaFront("${item.id}")'>Edit</button>
                    <button onclick='deleteReceitaFront("${item.id}")'>X</button>
                  </div>
                </div>
              `;
              container.appendChild(div);
            });
          } else {
            container.innerHTML = "<p>Nenhuma receita cadastrada para este mês.</p>";
          }
        })
        .catch(error => {
          console.error("Erro ao carregar receitas:", error);
          document.getElementById("listaReceitas").innerHTML = "<p>Erro ao carregar receitas.</p>";
        });
      }
      
      function deleteReceitaFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta receita?")) return;
        const payload = getPayload("deleteReceita", {}, recordId);
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllDataForMonth(); // Recarrega tudo
        })
        .catch(error => {
          alert("Erro ao excluir receita: " + error.message);
        });
      }
      
      function editReceitaFront(recordId) {
        let novoNome = prompt("Digite o novo nome da receita:");
        if (novoNome === null) return;
        let novoValor = prompt("Digite o novo valor da receita:");
        if (novoValor === null) return;

        novoValor = parseFloat(novoValor.replace(',', '.'));
        if (isNaN(novoValor)) {
          alert("Valor inválido. Digite um número.");
          return;
        }

        const payload = getPayload("updateReceita", { nome: novoNome, valor: novoValor }, recordId);
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllDataForMonth(); // Recarrega tudo
        })
        .catch(error => {
          alert("Erro ao editar receita: " + error.message);
        });
      }

      function submitReceita() {
          const nome = prompt("Nome da Receita:");
          if (nome === null || nome.trim() === "") {
              alert("Nome da receita não pode ser vazio.");
              return;
          }
          const valor = prompt("Valor da Receita:");
          if (valor === null || valor.trim() === "") {
              alert("Valor da receita não pode ser vazio.");
              return;
          }
          const valorFloat = parseFloat(valor.replace(',', '.'));
          if (isNaN(valorFloat)) {
              alert("Valor inválido. Digite um número.");
              return;
          }

          const payload = getPayload("addReceita", { nome: nome, valor: valorFloat });

          fetch(webAppUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
          })
          .then(response => response.json())
          .then(data => {
              alert(data.message);
              fetchAllDataForMonth(); // Recarrega tudo
          })
          .catch(error => {
              alert("Erro ao adicionar receita: " + error.message);
          });
      }
      
      // TOTAIS (Resumo do Mês)
      function atualizarTotais() {
        const payload = getPayload("getTotais");
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          document.querySelector(".saldo-label").textContent = "Saldo: R$ " + (data.saldo || 0).toFixed(2);
          let widthPercent = Math.min(100, Math.max(0, ((data.saldo || 0) / 5000) * 100)); // Base para a barra, ajustar conforme necessário, min 0 max 100
          document.querySelector(".saldo-bar").style.width = widthPercent + "%";
          document.querySelector(".totals-wrapper").innerHTML = 
            `<span>Total de Receitas: R$ ${Number(data.receitas || 0).toFixed(2)}</span>` +
            `<span>Total de Despesas: R$ ${Number(data.despesas || 0).toFixed(2)}</span>`;
        })
        .catch(error => {
          console.error("Erro ao atualizar totais:", error);
          document.querySelector(".totals-wrapper").innerHTML = "<span>Erro ao carregar totais.</span>";
          document.querySelector(".saldo-label").textContent = "Saldo: R$ 0.00";
          document.querySelector(".saldo-bar").style.width = "0%";
        });
      }
      
      // CONTAS (Fixas e Variáveis)
      function atualizarContas() {
        const payload = getPayload("getContas");
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          const listaContasFixas = document.getElementById("listaContasFixas");
          const listaContasVariaveis = document.getElementById("listaContasVariaveis");
          const totalContasFixasElem = document.getElementById("totalContasFixas");
          const totalContasVariaveisElem = document.getElementById("totalContasVariaveis");

          listaContasFixas.innerHTML = "";
          listaContasVariaveis.innerHTML = "";

          let totalFixas = 0;
          let totalVariaveis = 0;

          if (data && data.length > 0) {
            data.forEach(item => {
              const valorParcela = parseFloat(item.valor || 0) / parseInt(String(item.parcelas || '1/1').split('/')[1] || 1);
              const div = document.createElement("div");
              div.classList.add("conta-item");
              div.innerHTML = `
                <div class="list-item-content">
                  <span>${item.nome}: R$ ${valorParcela.toFixed(2)} | ${item.parcelas || '1/1'}</span>
                  <input type="checkbox" class="checkbox-pago" ${item.pago === 'Sim' ? 'checked' : ''} onchange="markContaAsPaidFront('${item.id}', this.checked)">
                  <div class="list-item-controls">
                    <button onclick='editContaFront("${item.id}")'>Edit</button>
                    <button onclick='deleteContaFront("${item.id}")'>X</button>
                  </div>
                </div>
              `;
              if (item.tipo === 'Fixa') {
                listaContasFixas.appendChild(div);
                if (item.pago !== 'Sim') { // Somar apenas se não estiver pago
                  totalFixas += valorParcela;
                }
              } else if (item.tipo === 'Variável') { // Assegura que é variável
                listaContasVariaveis.appendChild(div);
                if (item.pago !== 'Sim') { // Somar apenas se não estiver pago
                  totalVariaveis += valorParcela;
                }
              }
            });
          } else {
            listaContasFixas.innerHTML = "<p>Nenhuma conta fixa cadastrada para este mês.</p>";
            listaContasVariaveis.innerHTML = "<p>Nenhuma conta variável cadastrada para este mês.</p>";
          }
          totalContasFixasElem.textContent = `Total: R$ ${totalFixas.toFixed(2)}`;
          totalContasVariaveisElem.textContent = `Total: R$ ${totalVariaveis.toFixed(2)}`;
        })
        .catch(error => {
          console.error("Erro ao carregar contas:", error);
          document.getElementById("listaContasFixas").innerHTML = "<p>Erro ao carregar contas.</p>";
          document.getElementById("listaContasVariaveis").innerHTML = "";
          totalContasFixasElem.textContent = `Total: R$ 0.00`;
          totalContasVariaveisElem.textContent = `Total: R$ 0.00`;
        });
      }
      
      function deleteContaFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta conta?")) return;
        const payload = getPayload("deleteConta", {}, recordId);
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllDataForMonth(); // Recarrega tudo
        })
        .catch(error => {
          alert("Erro ao excluir conta: " + error.message);
        });
      }
      
      function editContaFront(recordId) {
        let novoNome = prompt("Digite o novo nome da conta:");
        if (novoNome === null) return;
        let novoValor = prompt("Digite o novo valor da conta:");
        if (novoValor === null) return;
        let novasParcelas = prompt("Digite as novas parcelas (ex: 2/3) da conta:");
        if (novasParcelas === null) return;

        novoValor = parseFloat(novoValor.replace(',', '.'));
        if (isNaN(novoValor)) {
          alert("Valor inválido. Digite um número.");
          return;
        }

        const payload = getPayload("updateConta", { nome: novoNome, valor: novoValor, parcelas: novasParcelas }, recordId);
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllDataForMonth(); // Recarrega tudo
        })
        .catch(error => {
          alert("Erro ao editar conta: " + error.message);
        });
      }

      function markContaAsPaidFront(recordId, isChecked) {
        const payload = getPayload("markContaAsPaid", { 'pago': isChecked ? 'Sim' : 'Não' }, recordId);
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          // alert(data.message); // Opcional: exibir alert de sucesso
          fetchAllDataForMonth(); // Recarrega tudo
        })
        .catch(error => {
          alert("Erro ao marcar conta como paga: " + error.message);
          fetchAllDataForMonth(); // Recarrega para reverter o checkbox se houver erro
        });
      }
      
      // COMPRAS (Cartões)
      function atualizarCartoes() {
        const payload = getPayload("getComprasPorCartao");
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          const cartoes = ['Nubank', 'Santander', 'Mercado Pago', 'Amazon'];
          cartoes.forEach(cartaoNome => {
            const cardId = cartaoNome.toLowerCase().replace(/\s/g, '') + 'Card';
            const cardBox = document.getElementById(cardId);
            if (!cardBox) return; // Sai se o elemento não existir

            const cardTotalElem = cardBox.querySelector(".cartao-total");
            const cardListElem = cardBox.querySelector(".cartao-list");
            
            cardListElem.innerHTML = ""; // Limpa a lista existente
            let totalCartao = 0;

            const comprasDoCartao = data[cartaoNome] ? data[cartaoNome].compras : [];

            if (comprasDoCartao.length > 0) {
              comprasDoCartao.forEach(item => {
                const div = document.createElement("div");
                const responsavelClass = item.responsavel ? item.responsavel.toLowerCase().replace(/á/g, 'a').replace(/ /g, '') : '';
                div.classList.add("compra", responsavelClass); 

                div.innerHTML = `
                  <div class="list-item-content">
                    <span>${item.nome} | ${item.parcelas} | R$ ${item.valor.toFixed(2)} (${item.responsavel})</span>
                    <input type="checkbox" class="checkbox-pago" ${item.pago === 'Sim' ? 'checked' : ''} onchange="markCompraAsPaidFront('${item.id}', this.checked)">
                    <div class="list-item-controls">
                      <button onclick='editCompraFront("${item.id}")'>Edit</button>
                      <button onclick='deleteCompraFront("${item.id}")'>X</button>
                    </div>
                  </div>
                `;
                cardListElem.appendChild(div);
                if (item.pago !== 'Sim') { // Somar apenas se não estiver pago
                  totalCartao += item.valor;
                }
              });
            } else {
              cardListElem.innerHTML = "<p>Nenhuma compra neste cartão para este mês.</p>";
            }
            cardTotalElem.textContent = `Total: R$ ${totalCartao.toFixed(2)}`;
          });
        })
        .catch(error => {
          console.error("Erro ao carregar compras por cartão:", error);
          // Opcional: mostrar mensagem de erro nas seções dos cartões
          const cartoes = ['Nubank', 'Santander', 'Mercado Pago', 'Amazon'];
            cartoes.forEach(cartaoNome => {
                const cardId = cartaoNome.toLowerCase().replace(/\s/g, '') + 'Card';
                const cardBox = document.getElementById(cardId);
                if (cardBox) {
                    cardBox.querySelector(".cartao-list").innerHTML = "<p>Erro ao carregar compras.</p>";
                    cardBox.querySelector(".cartao-total").textContent = "Total: R$ 0.00";
                }
            });
        });
      }

      function deleteCompraFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta compra?")) return;
        const payload = getPayload("deleteCompra", {}, recordId);
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllDataForMonth(); // Recarrega tudo
        })
        .catch(error => {
          alert("Erro ao excluir compra: " + error.message);
        });
      }
      
      function editCompraFront(recordId) {
        let novoNome = prompt("Digite o novo nome da compra:");
        if (novoNome === null) return;
        let novoValor = prompt("Digite o novo valor:");
        if (novoValor === null) return;
        let novasParcelas = prompt("Digite as novas parcelas (ex: 1/6):");
        if (novasParcelas === null) return;
        
        novoValor = parseFloat(novoValor.replace(',', '.'));
        if (isNaN(novoValor)) {
          alert("Valor inválido. Digite um número.");
          return;
        }

        const payload = getPayload("updateCompra", { nome: novoNome, valor: novoValor, parcelas: novasParcelas }, recordId);
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          fetchAllDataForMonth(); // Recarrega tudo
        })
        .catch(error => {
          alert("Erro ao editar compra: " + error.message);
        });
      }

      function markCompraAsPaidFront(recordId, isChecked) {
        const payload = getPayload("markCompraAsPaid", { 'pago': isChecked ? 'Sim' : 'Não' }, recordId);
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          // alert(data.message); // Opcional: exibir alert de sucesso
          fetchAllDataForMonth(); // Recarrega tudo
        })
        .catch(error => {
          alert("Erro ao marcar compra como paga: " + error.message);
          fetchAllDataForMonth(); // Recarrega para reverter o checkbox se houver erro
        });
      }
      
      // Envio dos formulários de Compra e Conta
      function submitCompraCartao() {
        var form = document.getElementById("formAdicionarCompra");
        var responsavel = document.getElementById("respCompra").value;
        var cartao = document.getElementById("cartaoCompra").value;
        var nome = form.querySelector("input[placeholder='Nome da Compra']").value;
        var valor = form.querySelector("input[placeholder='Valor']").value;
        var parcelas = form.querySelector("input[placeholder='Parcelas (ex: 2/6)']").value;
        
        if (!nome || !valor || !parcelas || !responsavel || !cartao) {
            alert("Por favor, preencha todos os campos da compra.");
            return;
        }

        valor = parseFloat(valor.replace(',', '.'));
        if (isNaN(valor)) {
            alert("Valor da compra inválido. Digite um número.");
            return;
        }

        var payload = getPayload("addCompraCartao", {
            nome: nome,
            valor: valor,
            parcelas: parcelas,
            responsavel: responsavel,
            cartao: cartao
        });
        
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          // Limpa os campos do formulário
          form.querySelector("input[placeholder='Nome da Compra']").value = "";
          form.querySelector("input[placeholder='Valor']").value = "";
          form.querySelector("input[placeholder='Parcelas (ex: 2/6)']").value = "";

          fetchAllDataForMonth(); // Recarrega tudo
        })
        .catch(error => { alert("Erro ao adicionar compra no cartão: " + error.message); });
      }
      
      function submitConta() {
        var form = document.getElementById("formAdicionarConta");
        var tipo = document.getElementById("tipoConta").value;
        var nome = form.querySelector("input[placeholder='Nome da Conta']").value;
        var parcelas = form.querySelector("input[placeholder='Parcelas (ex: 2/3)']").value;
        var valor = form.querySelector("input[placeholder='Valor']").value;
        
        if (!nome || !valor || !parcelas || !tipo) {
            alert("Por favor, preencha todos os campos da conta.");
            return;
        }

        valor = parseFloat(valor.replace(',', '.'));
        if (isNaN(valor)) {
            alert("Valor da conta inválido. Digite um número.");
            return;
        }

        var payload = getPayload("addConta", {
            tipo: tipo,
            nome: nome,
            parcelas: parcelas,
            valor: valor
        });
        
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          // Limpa os campos do formulário
          form.querySelector("input[placeholder='Nome da Conta']").value = "";
          form.querySelector("input[placeholder='Parcelas (ex: 2/3)']").value = "";
          form.querySelector("input[placeholder='Valor']").value = "";

          fetchAllDataForMonth(); // Recarrega tudo
        })
        .catch(error => { alert("Erro ao adicionar conta: " + error.message); });
      }

      // TOTAL DE COMPRAS POR RESPONSÁVEL
      function atualizarComprasPorResponsavel() {
        const payload = getPayload("getComprasPorResponsavel");
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          const responsaveis = ['Liana', 'Stefany', 'Marília', 'Nosso ❤️'];
          const container = document.querySelector(".responsaveis-container");
          container.innerHTML = ""; // Limpa o conteúdo existente

          responsaveis.forEach(responsavelNome => {
            const responsavelKey = responsavelNome.toLowerCase().replace(/á/g, 'a').replace(/ /g, ''); // Para classes CSS
            // Tratamento especial para 'Nosso ❤️' para a classe CSS
            const finalResponsavelKey = responsavelKey === 'nosso❤️' ? 'nosso' : responsavelKey;

            const totalData = data[responsavelNome] || { total: 0, compras: [] };

            const box = document.createElement("div");
            box.classList.add("responsavel-box");
            box.innerHTML = `
              <h3><span class="${finalResponsavelKey}">${responsavelNome}</span></h3>
              <p>Compras: R$ ${totalData.total.toFixed(2)}</p>
              <p><strong>Total a Pagar: R$ ${totalData.total.toFixed(2)}</strong></p>
            `;
            container.appendChild(box);
          });
        })
        .catch(error => {
          console.error("Erro ao carregar compras por responsável:", error);
          document.querySelector(".responsaveis-container").innerHTML = "<p>Erro ao carregar totais por responsável.</p>";
        });
      }

      document.addEventListener("DOMContentLoaded", function(){
        updateMonthDisplay(); // Define o mês e ano iniciais
        fetchAllDataForMonth(); // Carrega todos os dados iniciais para o mês atual

        // Event listeners para navegação de mês
        document.querySelector(".nav-buttons button:first-child").addEventListener("click", function(){
          changeMonth(-1);
        });
        document.querySelector(".nav-buttons button:last-child").addEventListener("click", function(){
          changeMonth(1);
        });

        document.querySelector(".categoria-box.receitas button").addEventListener("click", function(e){
            e.preventDefault();
            submitReceita();
        });

        document.querySelector("#formAdicionarCompra button").addEventListener("click", function(e){
          e.preventDefault();
          submitCompraCartao();
        });
        document.querySelector("#formAdicionarConta button").addEventListener("click", function(e){
          e.preventDefault();
          submitConta();
        });
      });
    </script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Painel Financeiro</h1>
        <h2>Maio 2025</h2> <div class="nav-buttons">
          <button>&laquo; Mês Anterior</button>
          <button>Mês Seguinte &raquo;</button>
        </div>
      </header>
      
      <div class="totals-section">
        <div class="totals-wrapper">
          <span>Total de Receitas: R$ 0.00</span>
          <span>Total de Despesas: R$ 0.00</span>
        </div>
        <div class="saldo-bar-container">
          <div class="saldo-bar"></div>
          <div class="saldo-label">Saldo: R$ 0.00</div>
        </div>
      </div>
      
      <div class="categorias-section">
        <h2>Resumo do Mês</h2>
        <div class="categorias-columns">
          <div class="categoria-box receitas">
            <h3>Receitas</h3>
            <div class="categoria-list" id="listaReceitas">
              <p>Carregando receitas...</p>
            </div>
            <button>Adicionar Receita</button>
          </div>
          
          <div class="categoria-box contas">
            <h3>Contas Fixas</h3>
            <div class="categoria-list" id="listaContasFixas">
              <p>Carregando contas fixas...</p>
            </div>
            <div class="conta-total" id="totalContasFixas">Total: R$ 0.00</div>
          </div>
          
          <div class="categoria-box contas">
            <h3>Contas Variáveis</h3>
            <div class="categoria-list" id="listaContasVariaveis">
              <p>Carregando contas variáveis...</p>
            </div>
            <div class="conta-total" id="totalContasVariaveis">Total: R$ 0.00</div>
          </div>
        </div>
      </div>
      
      <div class="cartoes-section" id="cartoesSection">
        <h2>Cartões</h2>
        <div class="cartoes-columns">
          <div class="cartao-box" id="nubankCard">
            <h3>
              NUBANK
              </h3>
            <div class="cartao-total">Total: R$ 0.00</div>
            <div class="cartao-list">
              <p>Carregando compras...</p>
            </div>
          </div>
          <div class="cartao-box" id="santanderCard">
            <h3>
              SANTANDER
            </h3>
            <div class="cartao-total">Total: R$ 0.00</div>
            <div class="cartao-list">
              <p>Carregando compras...</p>
            </div>
          </div>
          <div class="cartao-box" id="mpagoCard">
            <h3>
              M.PAGO
            </h3>
            <div class="cartao-total">Total: R$ 0.00</div>
            <div class="cartao-list">
              <p>Carregando compras...</p>
            </div>
          </div>
          <div class="cartao-box" id="amazonCard">
            <h3>
              AMAZON
            </h3>
            <div class="cartao-total">Total: R$ 0.00</div>
            <div class="cartao-list">
              <p>Carregando compras...</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="forms-container">
        <div class="form-section" id="formAdicionarCompra">
          <h2>Adicionar Compra no Cartão</h2>
          <div class="row">
            <select id="respCompra">
              <option value="Liana">Liana</option>
              <option value="Stefany">Stefany</option>
              <option value="Marília">Marília</option>
              <option value="Nosso ❤️">Nosso ❤️</option>
            </select>
            <select id="cartaoCompra">
              <option value="Nubank">NUBANK</option>
              <option value="Santander">SANTANDER</option>
              <option value="Mercado Pago">M.PAGO</option>
              <option value="Amazon">AMAZON</option>
            </select>
          </div>
          <div class="row">
            <input type="text" placeholder="Nome da Compra" />
          </div>
          <div class="row">
            <input type="number" placeholder="Valor" />
            <input type="text" placeholder="Parcelas (ex: 2/6)" />
          </div>
          <button>Adicionar Compra no Cartão</button>
        </div>
        
        <div class="form-section" id="formAdicionarConta">
          <h2>Adicionar Conta</h2>
          <select id="tipoConta">
            <option value="Fixa">Fixa</option>
            <option value="Variável">Variável</option>
          </select>
          <input type="text" placeholder="Nome da Conta" />
          <input type="text" placeholder="Parcelas (ex: 2/3)" />
          <input type="number" placeholder="Valor" />
          <button>Adicionar Conta</button>
        </div>
      </div>
      
      <div class="compras-responsaveis">
        <h2>Total de Compras por Responsável</h2>
        <div class="responsaveis-container">
          <p>Carregando totais por responsável...</p>
        </div>
      </div>
      
      <footer>
        <p>
          <span class="liana">Liana</span>,
          <span class="stefany">Stefany</span>,
          <span class="marilia">Marília</span>,
          <span class="nosso">Nosso ❤️</span>
        </p>
      </footer>
    </div>
  </body>
</html>
