<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
        <link rel="icon" type="image/png" href="favicon.png">

    <style>
      /* CONFIGURAÇÃO GERAL */
      body {
        font-family: Arial, sans-serif; /* [116] */
        background-color: #f2f2f2; /* [116] */
        margin: 0;
        padding: 20px;
        color: black; /* Texto padrão em preto */
      }
      .container {
        max-width: 1200px; /* [117] */
        margin: auto; /* [117] */
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      /* .form-sections-wrapper, */ /* Removido daqui para não ser uma caixa azul */
      .form-section, /* Aplicar a cada form individual - AGORA SERÁ UMA CAIXA AZUL */ /* [118] */
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box,
      .cartao-box {
        background-color: #e3f2fd; /* [118] */
        border: 1px solid #90caf9; /* [118] */
        border-radius: 5px;
        margin-bottom: 20px; /* Espaçamento entre seções */ /* [118] */
        padding: 15px; /* [119] */
      }

      /* BOTÕES */
      button {
        background-color: #4caf50; /* [120] */
        color: #fff; /* [120] */
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease; /* [121] */
      }
      button:hover {
        background-color: #45a049; /* [122] */
      }
      button.delete-button {
        background-color: #f44336; /* [123] */
        margin-left: 5px; /* [123] */
      }
      button.delete-button:hover {
        background-color: #da190b; /* [124] */
      }
      button.edit-button {
        background-color: #ff9800; /* [125] */
        margin-left: 5px; /* [125] */
      }
      button.edit-button:hover {
        background-color: #e68a00; /* [126] */
      }

      /* CABEÇALHO */
      header {
        text-align: center; /* [127] */
        margin-bottom: 20px; /* [127] */
        position: relative;
      }
      header h1 {
        color: #333; /* [128] */
        margin-bottom: 10px; /* [128] */
      }
      header h2 {
        color: #555; /* [129] */
        margin-top: 0; /* [129] */
        display: inline-block; /* [130] */
        position: relative; /* [130] */
        padding: 0 120px; /* [130] */
      }
      .nav-buttons {
          position: absolute; /* [131] */
          top: 50%; /* [131] */
          transform: translateY(-50%); /* [131] */
          width: 100%;
          display: flex;
          justify-content: space-between;
          padding: 0 20px;
          box-sizing: border-box; /* [132] */
          left: 0; /* [133] */
      }
      .nav-buttons button {
          background-color: #007bff; /* [134] */
          color: white; /* [134] */
          padding: 5px 10px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 1em; /* [135] */
      }
      .nav-buttons button:hover {
          background-color: #0056b3; /* [136] */
      }

      /* SEÇÃO DE TOTAIS */
      .totals-section {
        /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .totals-wrapper {
        display: flex; /* [139] */
        justify-content: space-around; /* [139] */
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
      }
      .saldo-bar-container {
        background-color: #ddd; /* [140] */
        border-radius: 5px; /* [140] */
        height: 25px;
        margin-top: 10px;
        overflow: hidden; /* [141] */
        position: relative; /* [141] */
      }
      .saldo-bar {
        height: 100%;
        width: 0%; /* [142] */
        background-color: green; /* Cor padrão inicial, será ajustada via JS */ /* [143] */
        border-radius: 5px; /* [144] */
        transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; /* [144] */
      }
      .saldo-label {
        position: absolute; /* [146] */
        top: 0; /* [146] */
        left: 0; /* [146] */
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold; /* [147] */
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* [147] */
        font-size: 0.9em;
      }

      /* SEÇÃO DE CATEGORIAS (Receitas, Contas Fixas, Variáveis) */
      .categorias-section {
         /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .categorias-columns {
        display: grid; /* [150] */
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* [150] */
        gap: 20px;
      }
      .categoria-box {
        text-align: center;
        display: flex; /* [152] */
        flex-direction: column; /* [152] */
         /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .categoria-box h3 {
        margin-top: 0;
        color: #333; /* [153] */
      }
      .categoria-list {
        text-align: left;
        margin-bottom: 10px; /* [154] */
        flex-grow: 1; /* [154] */
        min-height: 50px; /* [155] */
      }
      .categoria-list p {
        margin: 5px 0; /* [156] */
        color: #555; /* [156] */
      }
      .list-item {
        display: flex; /* [157] */
        justify-content: space-between; /* [157] */
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px dashed #c0c0c0; /* [158] */
      }
      .list-item:last-child {
        border-bottom: none; /* [159] */
      }
      .list-item span {
        flex-grow: 1;
        text-align: left; /* [160] */
        margin-right: 10px; /* [160] */
      }
      .list-item-controls {
          display: flex; /* [161] */
          justify-content: flex-end; /* [161] */
          align-items: center;
          flex-shrink: 0;
      }
      .list-item-controls button {
          margin-left: 5px; /* [162] */
          padding: 4px 8px; /* [162] */
          font-size: 0.8em;
      }
      .list-item-controls input[type="checkbox"] {
          margin-left: 5px; /* [163] */
          width: 16px; /* [163] */
          height: 16px; /* [163] */
      }
      .categoria-box .total-categoria {
        font-weight: bold; /* [164] */
        margin-top: 10px; /* [164] */
        padding-top: 10px;
        border-top: 1px solid #c0c0c0;
        display: flex; /* [165] */
        justify-content: space-between; /* [165] */
        align-items: center; /* [165] */
      }
      .total-categoria .checkbox-pago-total {
          margin-left: 10px; /* [166] */
          width: 20px; /* [166] */
          height: 20px; /* [167] */
          cursor: pointer; /* [167] */
      }

      /* SEÇÃO DE CARTÕES */
      .cartoes-section {
        /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .cartoes-grid {
        display: grid; /* [170] */
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* [171] */
        gap: 20px; /* [171] */
      }
      .cartao-box {
        text-align: center;
        display: flex;
        flex-direction: column;
        /* Herda padding, margin-bottom, border e background da regra geral de caixas,
           mas cores específicas abaixo podem sobrescrever o background/border. */
      }
      .cartao-box.nubank { background-color: #f3e5f5; border: 1px solid #ce93d8; } /* [173] */
      .cartao-box.santander { background-color: #ffebee; border: 1px solid #ef9a9a; } /* [174] */
      .cartao-box.mercadopago { background-color: #e3f2fd; border: 1px solid #90caf9; } /* [175] */
      .cartao-box.amazon { background-color: #fff3e0; border: 1px solid #ffcc80; } /* [176] */
      .cartao-box h3 {
        margin-top: 0;
        color: #333; /* [177] */
      }
      .cartao-list {
        text-align: left;
        margin-bottom: 10px; /* [178] */
        flex-grow: 1; /* [178] */
        min-height: 50px;
      }
      .cartao-list p {
        margin: 5px 0; /* [179] */
        color: #555; /* [179] */
      }
      .cartao-box .total-cartao {
        font-weight: bold; /* [180] */
        margin-top: 10px; /* [180] */
        padding-top: 10px;
        border-top: 1px solid #a7d9f7;
        display: flex; /* [181] */
        justify-content: space-between; /* [181] */
        align-items: center; /* [181] */
      }
      .cartao-box .total-cartao .checkbox-pago-total {
          margin-left: 10px; /* [182] */
          width: 20px; /* [182] */
          height: 20px; /* [182] */
          cursor: pointer;
      }
      .compra {
        display: flex; /* [183] */
        justify-content: space-between; /* [183] */
        align-items: center;
        padding: 5px;
        border-bottom: 1px dashed #c0c0c0;
        border-radius: 3px; /* [184] */
        margin-bottom: 3px; /* [185] */
      }
      .compra:last-child {
        border-bottom: none; /* [186] */
      }
      .compra .list-item-content {
          flex-grow: 1; /* [187] */
          display: flex; /* [187] */
          justify-content: space-between;
          align-items: center;
          margin-right: 5px;
      }
      .compra .list-item-content span {
          flex-grow: 1; /* [188] */
          text-align: left; /* [188] */
          font-size: 0.9em;
      }
      .compra .list-item-controls {
          flex-shrink: 0; /* [189] */
      }

      /* SEÇÃO DE FORMULÁRIOS */
      .form-sections-wrapper { /* Agora é apenas um container flexível */
        display: flex; /* [190] */
        gap: 20px; /* [190] */
        margin-bottom: 20px; /* Para espaçar do próximo elemento */
      }
      .form-section { /* Cada form agora é uma caixa azul */
        flex: 1; /* [191] */
        text-align: center; /* [191] */
        /* background-color, border, padding, border-radius, margin-bottom
           são herdados da regra geral de caixas no início do <style> */
      }
      .form-section h2 {
        margin-top: 0;
        margin-bottom: 15px; /* [193] */
        color: #333; /* [193] */
      }
      .form-section label { 
        display: block; /* [194] */
        margin-bottom: 5px; /* [194] */
        text-align: left;
        font-weight: bold;
        font-size: 0.9em;
      }
      .form-section input[type="text"],
      .form-section input[type="number"],
      .form-section select {
        width: 100%; /* [195] */
        padding: 8px; /* [195] */
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box; /* [196] */
      }
      .form-section .row {
        display: flex;
        gap: 10px; /* [197] */
        margin-bottom: 10px; /* [197] */
        align-items: center; 
      }
      .form-section .row input,
      .form-section .row select {
        flex-grow: 1; /* [198] */
        margin-bottom: 0; /* [198] */
      }
      .form-section button {
        width: 100%; /* [199] */
        margin-top: 10px; /* [199] */
      }

      /* SEÇÃO DE COMPRAS POR RESPONSÁVEL */
      .compras-responsaveis {
        text-align: center; /* [200] */
         /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .compras-responsaveis h2 {
        margin-top: 0;
        color: #333; /* [201] */
      }
      .responsaveis-container {
        display: grid; /* [202] */
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* [202] */
        gap: 20px;
        margin-top: 15px;
      }
      .responsavel-box {
        text-align: center; /* [203] */
        /* Herda padding, margin-bottom, border e background da regra geral de caixas */
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em; /* [204] */
        padding: 5px; /* [204] */
        border-radius: 3px;
        display: inline-block; /* [204] */
      }
      .responsavel-box p.total-responsavel {
        margin: 10px 0 5px 0; /* [205] */
        font-size: 1em; /* [205] */
        font-weight: bold;
        border-top: 1px solid #ccc; /* [206] */
        padding-top: 10px; /* [206] */
      }
      .responsavel-list {
          text-align: left; /* [207] */
          font-size: 0.9em; /* [207] */
          max-height: 150px; /* [208] */
          overflow-y: auto; /* [208] */
          padding-right: 5px; /* [208] */
          margin-top: 10px; /* [208] */
      }
       .responsavel-list .compra-item {
          display: flex; /* [209] */
          justify-content: space-between; /* [209] */
          padding: 3px 0;
          border-bottom: 1px dotted #eee;
       }
       .responsavel-list .compra-item:last-child {
           border-bottom: none; /* [210] */
       }
       .responsavel-list .compra-nome {
           flex-grow: 1; /* [211] */
           margin-right: 10px; /* [211] */
           white-space: nowrap;
           overflow: hidden;
           text-overflow: ellipsis;
       }
       .responsavel-list .compra-detalhes {
           flex-shrink: 0; /* [212] */
           white-space: nowrap; /* [212] */
       }

      /* Cores para Responsáveis */
      .responsavel-liana { background-color: #add8e6; } /* [213] */
      .responsavel-stefany { background-color: #ffb347; } /* [214] */
      .responsavel-marilia { background-color: #dda0dd; }
      .responsavel-nosso { background-color: #ffc0cb; } /* [215] */

      /* Cores para background de itens de compra */
      .compra-bg-liana { background-color: rgba(173, 216, 230, 0.3); } /* [216] */
      .compra-bg-stefany { background-color: rgba(255, 179, 71, 0.3); } /* [217] */
      .compra-bg-marilia { background-color: rgba(221, 160, 221, 0.3); } /* [218] */
      .compra-bg-nosso { background-color: rgba(255, 192, 203, 0.3); } /* [219] */

      /* RODAPÉ */
      footer {
        text-align: center; /* [220] */
        margin-top: 20px; /* [220] */
        padding-top: 20px;
        border-top: 1px solid #ccc;
      }
      footer p span {
        margin: 0 5px; /* [221] */
        font-weight: bold; /* [221] */
        padding: 4px 8px;
        border-radius: 3px;
      }
      footer .liana { background-color: #add8e6; } /* [222] */
      footer .stefany { background-color: #ffb347; } /* [223] */
      footer .marilia { background-color: #dda0dd; } /* [224] */
      footer .nosso { background-color: #ffc0cb; } /* [225] */

      /* Estilo para item pago */
      .item-pago {
          text-decoration: line-through; /* [226] */
          color: grey; /* [226] */
          opacity: 0.7;
      }

      /* Modal Styles */
      .modal {
          display: none; /* [227] */
          position: fixed;  /* [227] */
          z-index: 1000; 
          left: 0;
          top: 0;
          width: 100%; 
          height: 100%; 
          overflow: auto; 
          background-color: rgba(0,0,0,0.4); /* [228] */
      }
      .modal-content {
          background-color: #fefefe; /* [229] */
          margin: 15% auto;  /* [229] */
          padding: 20px;
          border: 1px solid #888;
          width: 80%; 
          max-width: 500px;
          border-radius: 8px;
          position: relative; /* [230] */
      }
      .close-button {
          color: #aaa; /* [231] */
          position: absolute; /* [231] */
          top: 10px; /* [231] */
          right: 15px; /* [231] */
          font-size: 28px;
          font-weight: bold; /* [232] */
      }
      .close-button:hover,
      .close-button:focus {
          color: black; /* [233] */
          text-decoration: none; /* [233] */
          cursor: pointer;
      }
      .modal h2 {
          margin-top: 0; /* [234] */
      }
      .modal label {
          display: block; /* [235] */
          margin-bottom: 5px; /* [235] */
      }
      .modal input[type="text"],
      .modal input[type="number"],
      .modal select {
          width: 100%; /* [236] */
          padding: 8px; /* [236] */
          margin-bottom: 15px;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-sizing: border-box; /* [237] */
      }
      .modal button {
          width: 100%; /* [238] */
          padding: 10px; /* [238] */
      }

    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Painel Financeiro</h1>
        <h2>Carregando...</h2>
        <div class="nav-buttons">
          <button id="prevMonthBtn">&laquo; Mês Anterior</button> <button id="nextMonthBtn">Mês Seguinte &raquo;</button>
        </div>
      </header>

      <div class="totals-section">
        <div class="totals-wrapper">
          <span id="totalReceitas">Total de Receitas: R$ 0.00</span>
          <span id="totalDespesasMes">Total de Despesas: R$ 0.00</span> </div>
        <div class="saldo-bar-container">
          <div class="saldo-bar" id="saldoBar"></div>
          <div class="saldo-label" id="saldoLabel">Saldo: R$ 0.00</div>
        </div>
      </div>

      <div class="categorias-section">
        <h2>Resumo do Mês</h2> <div class="categorias-columns">
          <div class="categoria-box receitas">
            <h3>Receitas</h3>
            <div class="categoria-list" id="listaReceitas">
              <p>Carregando...</p>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ccc;"> <input type="text" id="nomeReceita" placeholder="Nome da Receita" style="width: calc(100% - 22px); margin-bottom: 5px;"> <input type="number" id="valorReceita" placeholder="Valor" style="width: calc(100% - 22px); margin-bottom: 5px;"> <button onclick="submitReceita()">Adicionar Receita</button>
            </div>
          </div>

          <div class="categoria-box contas-fixas">
            <h3>Contas Fixas</h3>
            <div class="categoria-list" id="listaContasFixas">
              <p>Carregando...</p> </div>
            <div class="total-categoria">
              <span id="totalContasFixas">Total Aberto: R$ 0.00</span>
              <input type="checkbox" class="checkbox-pago-total" id="checkAllContasFixas" title="Marcar/Desmarcar todas as contas fixas como pagas">
            </div>
          </div>

          <div class="categoria-box contas-variaveis"> <h3>Contas Variáveis</h3>
            <div class="categoria-list" id="listaContasVariaveis">
              <p>Carregando...</p>
            </div>
            <div class="total-categoria">
              <span id="totalContasVariaveis">Total Aberto: R$ 0.00</span> <input type="checkbox" class="checkbox-pago-total" id="checkAllContasVariaveis" title="Marcar/Desmarcar todas as contas variáveis como pagas">
            </div>
          </div>
        </div>
      </div>

      <div class="cartoes-section">
        <h2>Cartões</h2>
        <div class="cartoes-grid" id="cartoesGrid">
          <p>Carregando...</p> </div>
      </div>

      <div class="form-sections-wrapper">
        <div class="form-section add-compra">
          <h2>Adicionar Compra no Cartão</h2>
          <div class="row"> <select id="responsavelCompra">
              <option value="Liana">Liana</option>
              <option value="Stefany">Stefany</option>
              <option value="Marília">Marília</option>
              <option value="Nosso ❤️">Nosso ❤️</option>
            </select>
            <select id="cartaoCompra"> <option value="Nubank">Nubank</option>
              <option value="Santander">Santander</option>
              <option value="Mercado Pago">Mercado Pago</option>
              <option value="Amazon">Amazon</option>
            </select>
          </div>
          <input type="text" id="nomeCompra" placeholder="Nome da Compra"> <div class="row">
            <input type="number" id="valorCompra" placeholder="Valor da Parcela">
            <input type="number" id="parcelasCompra" placeholder="Parcelas (ex: 1)" value="1">
          </div>
          <button onclick="submitCompra()">Adicionar Compra</button>
        </div>

        <div class="form-section add-conta">
          <h2>Adicionar Conta</h2> <select id="tipoConta">
            <option value="Fixa">Fixa</option>
            <option value="Variável">Variável</option>
          </select>
          <input type="text" id="nomeConta" placeholder="Nome da Conta">
          <div class="row">
            <input type="number" id="valorConta" placeholder="Valor da Parcela">
            <input type="number" id="parcelasConta" placeholder="Parcelas (ex: 1)" value="1"> </div>
          <button onclick="submitConta()">Adicionar Conta</button>
        </div>
      </div>

      <div class="compras-responsaveis">
        <h2>Total de Compras por Responsável (Mês)</h2>
        <div class="responsaveis-container" id="responsaveisContainer">
          <p>Carregando...</p> </div>
      </div>

      <footer>
        <p>Legenda Responsáveis: 
          <span class="liana">Liana</span> 
          <span class="stefany">Stefany</span> 
          <span class="marilia">Marília</span> 
          <span class="nosso">Nosso ❤️</span> </p>
      </footer>
    </div>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Editar Item</h2>
        <input type="hidden" id="editItemId">
        <input type="hidden" id="editItemType">
        
        <label for="editNome">Nome:</label> <input type="text" id="editNome">
        
        <label for="editValor">Valor:</label>
        <input type="number" id="editValor">
        
        <div id="editCompraFields" style="display: none;">
          <label for="editParcelasCompra">Parcelas (ex: 1/12):</label>
          <input type="text" id="editParcelasCompra" disabled> <label for="editResponsavelCompra">Responsável:</label>
          <select id="editResponsavelCompra">
            <option value="Liana">Liana</option>
            <option value="Stefany">Stefany</option>
            <option value="Marília">Marília</option>
            <option value="Nosso ❤️">Nosso ❤️</option>
          </select> <label for="editCartaoCompra">Cartão:</label>
          <select id="editCartaoCompra">
            <option value="Nubank">Nubank</option>
            <option value="Santander">Santander</option>
            <option value="Mercado Pago">Mercado Pago</option>
            <option value="Amazon">Amazon</option>
          </select> </div>
        
        <div id="editContaFields" style="display: none;">
          <label for="editParcelasConta">Parcelas (ex: 1/12):</label>
          <input type="text" id="editParcelasConta" disabled>
          <label for="editTipoConta">Tipo:</label>
          <select id="editTipoConta"> <option value="Fixa">Fixa</option>
            <option value="Variável">Variável</option>
          </select>
        </div>
        <button onclick="submitEdit()">Salvar Alterações</button>
      </div>
    </div>

    <script>
      const API_URL = "https://painel-financas-proxy.mariliaedua.workers.dev/"; /* [261] */
      let currentMonth = new Date().getMonth(); /* [262] */
      let currentYear = new Date().getFullYear(); /* [263] */
      const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; /* [264] */
      const responsavelClasses = { "Liana": "responsavel-liana", "Stefany": "responsavel-stefany", "Marília": "responsavel-marilia", "Nosso ❤️": "responsavel-nosso" }; /* [265] */
      const compraBgClasses = { "Liana": "compra-bg-liana", "Stefany": "compra-bg-stefany", "Marília": "compra-bg-marilia", "Nosso ❤️": "compra-bg-nosso" }; /* [266] */
      
      function formatCurrency(value) {
        return `R$ ${Number(value).toFixed(2).replace(".", ",")}`; /* [267] */
      }

      async function fetchData(action, data = {}, recordId = null, method = "POST") {
        console.log(`Enviando payload:`, { action, data, recordId, month: currentMonth + 1, year: currentYear }); /* [268] */
        try {
          const payload = { action: action, data: data, recordId: recordId, month: currentMonth + 1, year: currentYear };
          const response = await fetch(API_URL, { /* [269] */
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }); /* [270] */
          if (!response.ok) {
            const errorText = await response.text(); /* [271] */
            console.error(`Erro HTTP (${response.status}) para ${action}:`, errorText); /* [271] */
            throw new Error(`Erro na requisição (${action}): ${response.status} ${response.statusText}`); /* [272] */
          }
          const result = await response.json();
          console.log(`Resposta recebida (${action}):`, result); /* [273] */
          if (result.status === "error") {
            console.error(`Erro retornado pela API (${action}):`, result.message); /* [274] */
            throw new Error(result.message); /* [274] */
          }
          return result.data !== undefined ? result.data : result; /* [275] */
        } catch (error) {
          console.error(`Falha na requisição (${action}):`, error); /* [276] */
          alert(`Erro ao comunicar com o servidor para a ação '${action}'. Verifique o console para detalhes.`); /* [276] */
          throw error; /* [277] */
        }
      }

      function updateMonthDisplay() {
        const headerTitle = document.querySelector("header h2"); /* [278] */
        headerTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`; /* [278] */
      }

      // >>> INÍCIO DA FUNÇÃO MODIFICADA: updateTotalsDisplay <<<
      function updateTotalsDisplay(data) {
        const totalReceitasEl = document.getElementById("totalReceitas"); /* [279] */
        const totalDespesasMesEl = document.getElementById("totalDespesasMes"); /* [279] */
        const saldoBarEl = document.getElementById("saldoBar"); /* [280] */
        const saldoLabelEl = document.getElementById("saldoLabel"); /* [280] */

        const totalReceitas = data.totalReceitas || 0;
        const totalDespesasMes = data.totalDespesasMes || 0; /* [281] */
        const totalPago = data.totalPago || 0; /* [281] */

        totalReceitasEl.textContent = `Total de Receitas: ${formatCurrency(totalReceitas)}`; /* [282] */
        totalDespesasMesEl.textContent = `Total de Despesas: ${formatCurrency(totalDespesasMes)}`; /* [282] */

        const saldoAtual = totalReceitas - totalPago; /* [283] */
        const faltaPagar = totalDespesasMes - totalPago;
        saldoLabelEl.textContent = `Saldo: ${formatCurrency(saldoAtual)} | Falta Pagar: ${formatCurrency(faltaPagar)}`;

        const percentPago = totalDespesasMes > 0 ? (totalPago / totalDespesasMes) * 100 : 0; /* [284] */
        saldoBarEl.style.width = `${Math.min(100, Math.max(0, percentPago))}%`; /* [285] */
        
        // Lógica de cor da barra ajustada: baseada no orçamento do mês
        const orcamentoDoMes = totalReceitas - totalDespesasMes;
        if (orcamentoDoMes < 0) { // Se despesas planejadas > receitas
          saldoBarEl.style.backgroundColor = "red"; // Orçamento estourado
        } else {
          saldoBarEl.style.backgroundColor = "green"; // Orçamento equilibrado ou com sobra
        }
      }
      // >>> FIM DA FUNÇÃO MODIFICADA: updateTotalsDisplay <<<

      function displayReceitas(receitas) {
        const listaReceitasEl = document.getElementById("listaReceitas"); /* [288] */
        listaReceitasEl.innerHTML = ""; /* [288] */
        if (!receitas || receitas.length === 0) {
          listaReceitasEl.innerHTML = "<p>Nenhuma receita para este mês.</p>"; /* [289] */
          return; /* [289] */
        }
        receitas.forEach((receita) => {
          const itemEl = document.createElement("div");
          itemEl.classList.add("list-item");
          itemEl.innerHTML = `
            <span>${receita.nome} - ${formatCurrency(receita.valor)}</span>
            <div class="list-item-controls">
              <button class="edit-button" onclick="openEditModal('receita', '${receita.id}')">Edit</button>
              <button class="delete-button" onclick="deleteItem('receita', '${receita.id}')">X</button> </div>`;
          listaReceitasEl.appendChild(itemEl); /* [291] */
        });
      }

      function displayContas(contas, tipo) {
        const listaElId = tipo === "Fixa" ? "listaContasFixas" : "listaContasVariaveis"; /* [292] */
        const totalElId = tipo === "Fixa" ? "totalContasFixas" : "totalContasVariaveis"; /* [292] */
        const checkAllElId = tipo === "Fixa" ? "checkAllContasFixas" : "checkAllContasVariaveis"; /* [293] */
        const listaEl = document.getElementById(listaElId);
        const totalEl = document.getElementById(totalElId);
        const checkAllEl = document.getElementById(checkAllElId);
        listaEl.innerHTML = ""; /* [294] */
        let totalAberto = 0;
        let todasPagas = true; /* [295] */
        const contasFiltradas = contas.filter(conta => conta.tipo === tipo); /* [295] */
        if (contasFiltradas.length === 0) {
          listaEl.innerHTML = `<p>Nenhuma conta ${tipo.toLowerCase()} para este mês.</p>`; /* [296] */
          totalEl.textContent = `Total Aberto: ${formatCurrency(0)}`; /* [296] */
          checkAllEl.checked = false;
          checkAllEl.disabled = true;
          return; /* [297] */
        }
        contasFiltradas.forEach((conta) => {
          const itemEl = document.createElement("div");
          itemEl.classList.add("list-item");
          const isPago = String(conta.pago).toLowerCase() === "sim";
          if (isPago) { itemEl.classList.add("item-pago"); }
          else { totalAberto += parseFloat(conta.valor || 0); todasPagas = false; } /* [298] */
          itemEl.innerHTML = `
            <span>${conta.nome} (${conta.parcelas}) - ${formatCurrency(conta.valor)}</span>
            <div class="list-item-controls">
              <button class="edit-button" onclick="openEditModal('conta', '${conta.originalId || conta.id}')">Edit</button>
              <button class="delete-button" onclick="deleteItem('conta', '${conta.originalId || conta.id}')">X</button> <input type="checkbox" ${isPago ? "checked" : ""} onchange="markAsPaid('conta', '${conta.originalId || conta.id}', this.checked)">
            </div>`; /* [300] */
          listaEl.appendChild(itemEl);
        });
        totalEl.textContent = `Total Aberto: ${formatCurrency(totalAberto)}`;
        checkAllEl.checked = todasPagas;
        checkAllEl.disabled = false; /* [301] */
        checkAllEl.onchange = () => markAllCategoriaAsPaid(tipo, checkAllEl.checked); /* [302] */
      }

      function displayCartoes(cartoesData) {
        const cartoesGridEl = document.getElementById("cartoesGrid"); /* [303] */
        cartoesGridEl.innerHTML = ""; /* [303] */
        const cartoesOrdenados = ["Nubank", "Santander", "Mercado Pago", "Amazon"]; /* [304] */
        cartoesOrdenados.forEach(nomeCartao => {
          const cartao = cartoesData[nomeCartao] || { total: 0, compras: [] };
          const cartaoBoxEl = document.createElement("div");
          const cartaoClass = nomeCartao.toLowerCase().replace(" ", "");
          cartaoBoxEl.classList.add("cartao-box", cartaoClass);
          const listaComprasEl = document.createElement("div");
          listaComprasEl.classList.add("cartao-list");
          let todasComprasPagas = true; /* [305] */
          if (cartao.compras.length === 0) {
            listaComprasEl.innerHTML = "<p>Nenhuma compra neste cartão para este mês.</p>";
            todasComprasPagas = false;
          } else {
            cartao.compras.forEach(compra => { /* [306] */
              const compraEl = document.createElement("div");
              compraEl.classList.add("compra"); /* [307] */
              const isPago = String(compra.pago).toLowerCase() === "sim"; /* [307] */
              if (isPago) { compraEl.classList.add("item-pago"); } /* [308] */
              else { todasComprasPagas = false; } /* [309] */
              const bgClass = compraBgClasses[compra.responsavel] || ""; /* [310] */
              compraEl.classList.add(bgClass); /* [310] */
              compraEl.innerHTML = `
                <div class="list-item-content">
                  <span>${compra.nome} (${compra.parcelas}) - ${formatCurrency(compra.valor)}</span>
                </div>
                <div class="list-item-controls">
                   <button class="edit-button" onclick="openEditModal('compra', '${compra.originalId || compra.id}')">Edit</button>
                   <button class="delete-button" onclick="deleteItem('compra', '${compra.originalId || compra.id}')">X</button> </div>`; /* [312] */
              listaComprasEl.appendChild(compraEl);
            });
          }
          cartaoBoxEl.innerHTML = `
            <h3>${nomeCartao.toUpperCase()}</h3>
            <div class="total-cartao">
              <span>Total Fatura: ${formatCurrency(cartao.total)}</span>
              <input type="checkbox" class="checkbox-pago-total" id="checkAll${cartaoClass}" title="Marcar/Desmarcar todas as compras do ${nomeCartao}" ${todasComprasPagas && cartao.compras.length > 0 ? "checked" : ""} ${cartao.compras.length === 0 ? "disabled" : ""}> </div>`; /* [314] */
          cartaoBoxEl.appendChild(listaComprasEl); /* [314] */
          cartoesGridEl.appendChild(cartaoBoxEl); /* [315] */
          const checkAllCartaoEl = document.getElementById(`checkAll${cartaoClass}`); /* [316] */
          if (checkAllCartaoEl) {
            checkAllCartaoEl.onchange = () => markAllCartaoAsPaidFront(nomeCartao, checkAllCartaoEl.checked); /* [317] */
          }
        });
      }

      // >>> INÍCIO DA FUNÇÃO MODIFICADA: displayComprasPorResponsavel <<<
      function displayComprasPorResponsavel(responsaveisData) {
        const containerEl = document.getElementById("responsaveisContainer"); /* [318] */
        containerEl.innerHTML = ""; // Limpa /* [318] */

        const responsaveisOrdenados = ["Liana", "Stefany", "Marília", "Nosso ❤️"]; /* [319] */
        responsaveisOrdenados.forEach(nomeResponsavel => {
          const responsavel = responsaveisData[nomeResponsavel] || { total: 0, compras: [] };
          const responsavelBoxEl = document.createElement("div");
          responsavelBoxEl.classList.add("responsavel-box"); // Esta classe já pega o estilo azul da regra geral

          let comprasHtml = "";
          if (responsavel.compras.length > 0) {
            responsavel.compras.forEach(compra => { /* [320] */
              comprasHtml += `
                <div class="compra-item">
                  <span class="compra-nome">${compra.nome}</span>
                  <span class="compra-detalhes">(${compra.parcelas}) - ${formatCurrency(compra.valor)}</span>
                </div>
              `; /* Inspirado em [320, 321] */
            });
          } else {
            comprasHtml = "<p>Nenhuma compra este mês.</p>"; /* [322] */
          }

          responsavelBoxEl.innerHTML = `
            <h3 class="${responsaveisClasses[nomeResponsavel] || ""}">${nomeResponsavel}</h3>
            <div class="responsavel-list">
              ${comprasHtml}
            </div>
            <p class="total-responsavel">Total (Mês): ${formatCurrency(responsavel.total)}</p>
          `; /* Inspirado em [323] */
          
          containerEl.appendChild(responsavelBoxEl); /* [324] */
        });
      }
      // >>> FIM DA FUNÇÃO MODIFICADA: displayComprasPorResponsavel <<<

      async function submitReceita() {
        const nome = document.getElementById("nomeReceita").value.trim(); /* [325] */
        const valor = document.getElementById("valorReceita").value; /* [325] */
        if (!nome || !valor || parseFloat(valor) <= 0) { alert("Por favor, preencha o nome e um valor válido para a receita."); return; } /* [326] */
        try {
          await fetchData("addReceita", { nome, valor: parseFloat(valor) }); /* [327] */
          document.getElementById("nomeReceita").value = ""; /* [327] */
          document.getElementById("valorReceita").value = "";
          fetchAllData();
        } catch (error) {}
      }

      async function submitCompra() {
        const nome = document.getElementById("nomeCompra").value.trim(); /* [328] */
        const valor = document.getElementById("valorCompra").value; /* [328] */
        const parcelas = document.getElementById("parcelasCompra").value || "1"; /* [328] */
        const responsavel = document.getElementById("responsavelCompra").value; /* [328] */
        const cartao = document.getElementById("cartaoCompra").value; /* [328] */
        if (!nome || !valor || parseFloat(valor) <= 0 || parseInt(parcelas) <= 0) { alert("Preencha nome, valor da parcela (>0) e número de parcelas (>0) válidos."); return; } /* [329, 330] */
        try {
          await fetchData("addCompraCartao", { nome, valor: parseFloat(valor), parcelas: parseInt(parcelas), responsavel, cartao }); /* [331] */
          document.getElementById("nomeCompra").value = ""; /* [331] */
          document.getElementById("valorCompra").value = ""; /* [332] */
          document.getElementById("parcelasCompra").value = "1"; /* [332] */
          fetchAllData();
        } catch (error) {}
      }

      async function submitConta() {
        const nome = document.getElementById("nomeConta").value.trim(); /* [333] */
        const valor = document.getElementById("valorConta").value; /* [333] */
        const parcelas = document.getElementById("parcelasConta").value || "1"; /* [333] */
        const tipo = document.getElementById("tipoConta").value; /* [333] */
        if (!nome || !valor || parseFloat(valor) <= 0 || parseInt(parcelas) <= 0) { alert("Preencha nome, valor da parcela (>0) e número de parcelas (>0) válidos."); return; } /* [334, 335] */
        try {
          await fetchData("addConta", { nome, valor: parseFloat(valor), parcelas: parseInt(parcelas), tipo }); /* [336] */
          document.getElementById("nomeConta").value = ""; /* [336] */
          document.getElementById("valorConta").value = ""; /* [337] */
          document.getElementById("parcelasConta").value = "1"; /* [337] */
          fetchAllData();
        } catch (error) {}
      }

      async function markAsPaid(type, id, isChecked) {
        const action = type === "conta" ? "markContaAsPaid" : "markCompraAsPaid"; /* [338] */
        const pagoStatus = isChecked ? "Sim" : "Não"; /* [339] */
        try { await fetchData(action, { pago: pagoStatus }, id); fetchAllData(); } catch (error) {} /* [339, 340] */
      }

      async function markAllCategoriaAsPaid(tipo, isChecked) {
        const pagoStatus = isChecked ? "Sim" : "Não"; /* [341] */
        try {
          const todasContas = await fetchData("getContas"); /* [342] */
          const contasDaCategoria = todasContas.filter(c => c.tipo === tipo); /* [342] */
          const updatePromises = contasDaCategoria.map(conta => fetchData("markContaAsPaid", { pago: pagoStatus }, conta.originalId || conta.id)); /* [343] */
          await Promise.all(updatePromises); /* [344] */
          fetchAllData(); /* [345] */
        } catch (error) { alert(`Erro ao marcar todas as contas ${tipo.toLowerCase()}s. Verifique o console.`); } /* [346] */
      }

      async function markAllCartaoAsPaidFront(nomeCartao, isChecked) {
          const pagoStatus = isChecked ? "Sim" : "Não"; /* [347] */
          try {
              const cartoesData = await fetchData("getComprasPorCartao"); /* [348] */
              const cartao = cartoesData[nomeCartao];
              if (!cartao || !cartao.compras || cartao.compras.length === 0) { console.log(`Nenhuma compra encontrada para o cartão ${nomeCartao} para marcar.`); return; } /* [349] */
              const updatePromises = cartao.compras.map(compra => fetchData("markCompraAsPaid", { pago: pagoStatus }, compra.originalId || compra.id)); /* [350] */
              await Promise.all(updatePromises); /* [351] */
              fetchAllData(); /* [352] */
          } catch (error) { alert(`Erro ao marcar todas as compras do cartão ${nomeCartao}. Verifique o console.`); } /* [353] */
      }

      async function openEditModal(type, id) {
        const modal = document.getElementById("editModal"); /* [354] */
        const titleEl = document.getElementById("modalTitle"); /* [354] */
        const idInput = document.getElementById("editItemId");
        const typeInput = document.getElementById("editItemType");
        const nomeInput = document.getElementById("editNome"); /* [355] */
        const valorInput = document.getElementById("editValor"); /* [355] */
        const compraFields = document.getElementById("editCompraFields"); /* [355] */
        const contaFields = document.getElementById("editContaFields"); /* [356] */
        compraFields.style.display = "none"; /* [356] */
        contaFields.style.display = "none"; /* [356] */
        idInput.value = id; typeInput.value = type;
        try {
          let itemData;
          if (type === "receita") { titleEl.textContent = "Editar Receita"; const todasReceitas = await fetchData("getReceitas"); itemData = todasReceitas.find(r => r.id === id); } /* [357, 358, 359] */
          else if (type === "compra") { titleEl.textContent = "Editar Compra"; compraFields.style.display = "block"; const todasCompras = await fetchData("getCompras"); itemData = todasCompras.find(c => (c.originalId || c.id) === id); } /* [360, 361] */
          else if (type === "conta") { titleEl.textContent = "Editar Conta"; contaFields.style.display = "block"; const todasContas = await fetchData("getContas"); itemData = todasContas.find(c => (c.originalId || c.id) === id); } /* [362, 363] */
          if (!itemData) { alert("Item não encontrado para edição."); return; } /* [364] */
          nomeInput.value = itemData.nome || ""; valorInput.value = itemData.valor || ""; /* [365] */
          if (type === "compra") { document.getElementById("editParcelasCompra").value = itemData.parcelas || "1/1"; document.getElementById("editResponsavelCompra").value = itemData.responsavel || "Liana"; document.getElementById("editCartaoCompra").value = itemData.cartao || "Nubank"; } /* [366, 367] */
          else if (type === "conta") { document.getElementById("editParcelasConta").value = itemData.parcelas || "1/1"; document.getElementById("editTipoConta").value = itemData.tipo || "Fixa"; } /* [368] */
          modal.style.display = "block"; /* [369] */
        } catch (error) { alert("Erro ao buscar dados para edição. Verifique o console."); } /* [370] */
      }

      function closeModal() { document.getElementById("editModal").style.display = "none"; } /* [371] */

      async function submitEdit() {
        const id = document.getElementById("editItemId").value; /* [372] */
        const type = document.getElementById("editItemType").value; /* [372] */
        const nome = document.getElementById("editNome").value.trim(); /* [372] */
        const valor = document.getElementById("editValor").value; /* [373] */
        if (!nome || !valor || parseFloat(valor) <= 0) { alert("Nome e valor válido são obrigatórios."); return; } /* [373, 374] */
        let action = ""; let dataToUpdate = { nome, valor: parseFloat(valor) }; /* [375] */
        if (type === "receita") { action = "updateReceita"; } /* [376] */
        else if (type === "compra") { action = "updateCompra"; dataToUpdate.responsavel = document.getElementById("editResponsavelCompra").value; dataToUpdate.cartao = document.getElementById("editCartaoCompra").value; } /* [377] */
        else if (type === "conta") { action = "updateConta"; dataToUpdate.tipo = document.getElementById("editTipoConta").value; } /* [378] */
        try { await fetchData(action, dataToUpdate, id); closeModal(); fetchAllData(); } catch (error) {} /* [379] */
      }

      async function deleteItem(type, id) {
        if (!confirm("Tem certeza que deseja excluir este item?")) { return; } /* [380] */
        let action = "";
        if (type === "receita") action = "deleteReceita"; /* [381] */
        else if (type === "compra") action = "deleteCompra"; /* [381] */
        else if (type === "conta") action = "deleteConta"; /* [382] */
        try { await fetchData(action, {}, id); fetchAllData(); } catch (error) {} /* [382, 383] */
      }

      async function fetchAllData() {
        console.log(`Atualizando dados para ${currentMonth + 1}/${currentYear}`); /* [384] */
        try {
          document.querySelector("header h2").textContent = "Carregando..."; /* [385] */
          document.getElementById("listaReceitas").innerHTML = "<p>Carregando...</p>"; /* [385] */
          document.getElementById("listaContasFixas").innerHTML = "<p>Carregando...</p>"; /* [385] */
          document.getElementById("listaContasVariaveis").innerHTML = "<p>Carregando...</p>"; /* [385] */
          document.getElementById("cartoesGrid").innerHTML = "<p>Carregando...</p>"; /* [385] */
          document.getElementById("responsaveisContainer").innerHTML = "<p>Carregando...</p>"; /* [386] */
          
          const [receitas, contas, comprasCartao, comprasResp, totais] = await Promise.all([
            fetchData("getReceitas"), fetchData("getContas"), fetchData("getComprasPorCartao"),
            fetchData("getComprasPorResponsavel"), fetchData("getTotais")
          ]); /* [387] */
          
          updateMonthDisplay();
          updateTotalsDisplay(totais); /* [388] */
          displayReceitas(receitas); /* [388] */
          displayContas(contas, "Fixa"); /* [388] */
          displayContas(contas, "Variável"); /* [389] */
          displayCartoes(comprasCartao); /* [389] */
          displayComprasPorResponsavel(comprasResp); /* [389] */
          console.log("Todos os dados atualizados com sucesso.");
        } catch (error) {
          console.error("Erro ao buscar todos os dados:", error); /* [390] */
          document.querySelector("header h2").textContent = "Erro ao carregar"; /* [391] */
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM carregado. Iniciando painel...");
        fetchAllData();
        document.getElementById("prevMonthBtn").addEventListener("click", () => { /* [392] */
          currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } fetchAllData();
        });
        document.getElementById("nextMonthBtn").addEventListener("click", () => {
          currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } fetchAllData(); /* [393] */
        });
        window.onclick = function(event) {
          const modal = document.getElementById("editModal"); /* [394] */
          if (event.target == modal) { closeModal(); } /* [395] */
        }
        console.log("Painel inicializado e listeners adicionados."); /* [396] */
      });
      function updateTotalsDisplay(data) {
  const totalReceitasEl = document.getElementById("totalReceitas");
  const totalDespesasMesEl = document.getElementById("totalDespesasMes");
  const saldoBarEl = document.getElementById("saldoBar");
  const saldoLabelEl = document.getElementById("saldoLabel");

  const totalReceitas = data.totalReceitas || 0;
  const totalDespesasMes = data.totalDespesasMes || 0;
  const totalPago = data.totalPago || 0;

  totalReceitasEl.textContent = `Total de Receitas: ${formatCurrency(totalReceitas)}`;
  totalDespesasMesEl.textContent = `Total de Despesas: ${formatCurrency(totalDespesasMes)}`;

  const saldoAtual = totalReceitas - totalPago;
  const faltaPagar = totalDespesasMes - totalPago;
  saldoLabelEl.innerHTML = `
    <span style="color: green">Saldo: ${formatCurrency(saldoAtual)}</span>
    | <span style="color: red">Falta Pagar: ${formatCurrency(faltaPagar)}</span>
  `;

  const percentPago = totalDespesasMes > 0 ? (totalPago / totalDespesasMes) * 100 : 0;
  saldoBarEl.style.width = `${Math.min(100, Math.max(0, percentPago))}%`;
  saldoBarEl.style.backgroundColor = "#ccc"; // cor fixa cinza claro
}

function updateMonthDisplay() {
  const headerTitle = document.querySelector("header h2");
  headerTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;
}

    </script>
  </body>
</html>
