<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
        <link rel="icon" type="image/png" href="favicon.png">

    <style>
      /* CONFIGURAÇÃO GERAL */
      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        color: black; /* Texto padrão em preto */
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      /* .form-sections-wrapper, */ /* Removido daqui para não ser uma caixa azul */
      .form-section, /* Aplicar a cada form individual - AGORA SERÁ UMA CAIXA AZUL */
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box,
      .cartao-box {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
        margin-bottom: 20px; /* Espaçamento entre seções */
        padding: 15px;
      }

      /* BOTÕES */
      button {
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #45a049;
      }
      button.delete-button {
        background-color: #f44336;
        margin-left: 5px;
      }
      button.delete-button:hover {
        background-color: #da190b;
      }
      button.edit-button {
        background-color: #ff9800;
        margin-left: 5px;
      }
      button.edit-button:hover {
        background-color: #e68a00;
      }

      /* CABEÇALHO */
      header {
        text-align: center;
        margin-bottom: 20px;
        position: relative;      }
      header h1 {
        color: #333;
        margin-bottom: 10px;
      }
      /* REMOVIDO: Estilos antigos do h2 que causavam o problema de alinhamento */
      /* header h2 {
        color: #555;
        margin-top: 0;
        display: block;
        position: relative;
        padding: 0;
        z-index: 10;
      } */
      .nav-buttons {
          /* REMOVIDO: Propriedades de posicionamento que não são mais necessárias */
          /* position: relative; */
          /* top: auto; */
          /* transform: none; */
          width: 100%;
          display: flex;
          justify-content: space-between;
          align-items: center; /* ADICIONADO: Centraliza verticalmente os itens */
          padding: 0 20px;
          box-sizing: border-box;
          /* left: 0; */
          /* z-index: 1; */
      }
      /* ADICIONADO: Novo estilo para o h2 dentro de nav-buttons para centralizá-lo */
      .nav-buttons h2 {
          color: #555;
          margin: 0; /* Remove margens padrão do h2 */
          flex-grow: 1; /* Permite que o h2 ocupe o espaço disponível */
          text-align: center; /* Centraliza o texto do h2 */
      }
      .nav-buttons button {
          background-color: #007bff;
          color: white;
          padding: 5px 10px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 1em;
      }
      .nav-buttons button:hover {
          background-color: #0056b3;
      }

      /* SEÇÃO DE TOTAIS */
      .totals-section {
        /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .totals-wrapper {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
      }
      .saldo-bar-container {
        background-color: white; /* Corrigido: termômetro branco */
        border-radius: 5px;
        height: 25px;
        margin-top: 10px;
        overflow: hidden;
        position: relative;
      }
      .saldo-bar {
        height: 100%;
        width: 0%;
        background-color: green; /* Cor padrão inicial, será ajustada via JS */
        border-radius: 5px;
        transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
      }
      .saldo-label {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: black; /* Corrigido: fonte preta */
        font-weight: bold;
        text-shadow: none; /* Corrigido: removido shadow para melhor contraste */
        font-size: 0.9em;
        border-radius: 5px;
        box-sizing: border-box;
      }

      /* SEÇÃO DE CATEGORIAS (Receitas, Contas Fixas, Variáveis) */
      .categorias-section {
         /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .categorias-columns {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
      .categoria-box {
        text-align: center;
        display: flex;
        flex-direction: column;
         /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .categoria-box h3 {
        margin-top: 0;
        color: #333;
      }
      .categoria-list {
        text-align: left;
        margin-bottom: 10px;
        flex-grow: 1;
        min-height: 50px;
      }
      .categoria-list p {
        margin: 5px 0;
        color: #555;
      }
      .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px dashed #c0c0c0;
      }
      .list-item:last-child {
        border-bottom: none;
      }
      .list-item span {
        flex-grow: 1;
        text-align: left;
        margin-right: 10px;
      }
      .list-item-controls {
          display: flex;
          justify-content: flex-end;
          align-items: center;
          flex-shrink: 0;
      }
      .list-item-controls button {
          margin-left: 5px;
          padding: 4px 8px;
          font-size: 0.8em;
      }
      .list-item-controls input[type="checkbox"] {
          margin-left: 5px;
          width: 16px;
          height: 16px;
      }
      .categoria-box .total-categoria {
        font-weight: bold;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #c0c0c0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .total-categoria .checkbox-pago-total {
          margin-left: 10px;
          width: 20px;
          height: 20px;
          cursor: pointer;
      }

      /* SEÇÃO DE CARTÕES */
      .cartoes-section {
        /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .cartoes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }
      .cartao-box {
        text-align: center;
        display: flex;
        flex-direction: column;
        /* Herda padding, margin-bottom, border e background da regra geral de caixas,
           mas cores específicas abaixo podem sobrescrever o background/border. */
      }
      .cartao-box.nubank { background-color: #f3e5f5; border: 1px solid #ce93d8; }
      .cartao-box.santander { background-color: #ffebee; border: 1px solid #ef9a9a; }
      .cartao-box.mercadopago { background-color: #e3f2fd; border: 1px solid #90caf9; }
      .cartao-box.amazon { background-color: #fff3e0; border: 1px solid #ffcc80; }
      .cartao-box h3 {
        margin-top: 0;
        color: #333;
      }
      .cartao-list {
        text-align: left;
        margin-bottom: 10px;
        flex-grow: 1;
        min-height: 50px;
        max-height: 400px; /* NOVO: Altura máxima para scroll */
        overflow-y: auto; /* NOVO: Scroll vertical */
        padding-right: 5px; /* NOVO: Espaço para a barra de scroll */
      }
      .cartao-list p {
        margin: 5px 0;
        color: #555;
      }
      .cartao-box .total-cartao {
        font-weight: bold;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #a7d9f7;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .cartao-box .total-cartao .checkbox-pago-total {
          margin-left: 10px;
          width: 20px;
          height: 20px;
          cursor: pointer;
      }
      .compra {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px;
        border-bottom: 1px dashed #c0c0c0;
        border-radius: 3px;
        margin-bottom: 3px;
      }
      .compra:last-child {
        border-bottom: none;
      }
      .compra .list-item-content {
          flex-grow: 1;
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-right: 5px;
      }
      .compra .list-item-content span {
          flex-grow: 1;
          text-align: left;
          font-size: 0.9em;
      }
      .compra .list-item-controls {
          flex-shrink: 0;
      }

      /* SEÇÃO DE FORMULÁRIOS */
      .form-sections-wrapper { /* Agora é apenas um container flexível */
        display: flex;
        gap: 20px;
        margin-bottom: 20px; /* Para espaçar do próximo elemento */
      }
      .form-section { /* Cada form agora é uma caixa azul */
        flex: 1;
        text-align: center;
        /* background-color, border, padding, border-radius, margin-bottom
           são herdados da regra geral de caixas no início do <style> */
      }
      .form-section h2 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
      }
      .form-section label {
        display: block;
        margin-bottom: 5px;
        text-align: left;
        font-weight: bold;
        font-size: 0.9em;
      }
      .form-section input[type="text"],
      .form-section input[type="number"],
      .form-section select {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .form-section .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
      }
      .form-section .row input,
      .form-section .row select {
        flex-grow: 1;
        margin-bottom: 0;
      }
      .form-section button {
        width: 100%;
        margin-top: 10px;
      }

      /* SEÇÃO DE COMPRAS POR RESPONSÁVEL */
      .compras-responsaveis {
        text-align: center;
         /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .compras-responsaveis h2 {
        margin-top: 0;
        color: #333;
      }
      .responsaveis-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-top: 15px;
      }
      .responsavel-box {
        text-align: center;
        /* Herda padding, margin-bottom, border e background da regra geral de caixas */
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em;
        padding: 5px;
        border-radius: 3px;
        display: inline-block;
      }
      .responsavel-box p.total-responsavel {
        margin: 10px 0 5px 0;
        font-size: 1em;
        font-weight: bold;
        border-top: 1px solid #ccc;
        padding-top: 10px;
      }
      .responsavel-list {
          text-align: left;
          font-size: 0.9em;
          max-height: 150px;
          overflow-y: auto;
          padding-right: 5px;
          margin-top: 10px;
      }
       .responsavel-list .compra-item {
          display: flex;
          justify-content: space-between;
          padding: 3px 0;
          border-bottom: 1px dotted #eee;
       }
       .responsavel-list .compra-item:last-child {
           border-bottom: none;
       }
       .responsavel-list .compra-nome {
           flex-grow: 1;
           margin-right: 10px;
           white-space: nowrap;
           overflow: hidden;
           text-overflow: ellipsis;
       }
       .responsavel-list .compra-detalhes {
           flex-shrink: 0;
           white-space: nowrap;
       }

      /* Cores para Responsáveis */
      .responsavel-liana { background-color: #add8e6; }
      .responsavel-stefany { background-color: #ffb347; }
      .responsavel-marilia { background-color: #dda0dd; }
      /* REMOVIDO: A classe responsavel-nosso-coracao não é mais necessária se o nome for "Compartilhado" */
      /* .responsavel-nosso-coracao { background-color: #ffc0cb; } */
      .responsavel-compartilhado { background-color: #ffc0cb; } /* Usar esta para Compartilhado */


      /* Cores para background de itens de compra */
      .compra-bg-liana { background-color: rgba(173, 216, 230, 0.3); }
      .compra-bg-stefany { background-color: rgba(255, 179, 71, 0.3); }
      .compra-bg-marilia { background-color: rgba(106, 90, 205, 0.4); }
      /* REMOVIDO: A classe compra-bg-nosso-coracao não é mais necessária */
      /* .compra-bg-nosso-coracao { background-color: rgba(255, 192, 203, 0.3); } */
      .compra-bg-compartilhado { background-color: rgba(255, 192, 203, 0.3); } /* Usar esta para Compartilhado */


      /* RODAPÉ */
      footer {
        text-align: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #ccc;
      }
      footer p span {
        margin: 0 5px;
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 3px;
      }
      footer .liana { background-color: #add8e6; }
      footer .stefany { background-color: #ffb347; }
      footer .marilia { background-color: #dda0dd; }
      /* REMOVIDO: A classe footer .nosso-coracao não é mais necessária */
      /* footer .nosso-coracao { background-color: #ffc0cb; } */
      footer .compartilhado { background-color: #ffc0cb; } /* Usar esta para Compartilhado */


      /* Estilo para item pago */
      .item-pago {
          text-decoration: line-through;
          color: grey;
          opacity: 0.7;
      }

      /* Modal Styles */
      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgba(0,0,0,0.4);
      }
      .modal-content {
          background-color: #fefefe;
          margin: 15% auto;
          padding: 20px;
          border: 1px solid #888;
          width: 80%;
          max-width: 500px;
          border-radius: 8px;
          position: relative;
      }
      .close-button {
          color: #aaa;
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 28px;
          font-weight: bold;
      }
      .close-button:hover,
      .close-button:focus {
          color: black;
          text-decoration: none;
          cursor: pointer;
      }
      .modal h2 {
          margin-top: 0;
      }
      .modal label {
          display: block;
          margin-bottom: 5px;
      }
      .modal input[type="text"],
      .modal input[type="number"],
      .modal select {
          width: 100%;
          padding: 8px;
          margin-bottom: 10px;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-sizing: border-box;
      }
      .modal button {
          width: 100%;
          margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Painel Financeiro Familiar</h1>
        <div class="nav-buttons">
          <!-- REMOVIDO: <br> desnecessários -->
            <button onclick="changeMonth(-1)">Mês Anterior</button>
            <h2 id="currentMonthYear"></h2>
            <button onclick="changeMonth(1)">Próximo Mês</button>
        </div>
      </header>

      <section class="totals-section">
        <div class="totals-wrapper">
          <div>Receitas: <span id="totalReceitas">R$ 0,00</span></div>
          <div>Despesas: <span id="totalDespesasMes">R$ 0,00</span></div>
          <div>Pago: <span id="totalPago">R$ 0,00</span></div>
          <div>A Pagar: <span id="totalAPagar">R$ 0,00</span></div>
        </div>
        <div class="saldo-bar-container">
          <div class="saldo-bar" id="saldoBar"></div>
          <div class="saldo-label" id="saldoLabel">Saldo: R$ 0,00</div>
        </div>
      </section>

      <section class="categorias-section">
        <h2>Resumo Mensal</h2>
        <div class="categorias-columns">
          <div class="categoria-box">
            <h3>Receitas</h3>
            <div id="receitasList" class="categoria-list"></div>
            <div class="total-categoria">
              <span>Total Receitas:</span>
              <span id="totalReceitasCategoria">R$ 0,00</span>
            </div>
          </div>
          <div class="categoria-box">
            <h3>Contas Fixas</h3>
            <div id="contasFixasList" class="categoria-list"></div>
            <div class="total-categoria">
              <span>Total Contas Fixas:</span>
              <span id="totalContasFixasCategoria">R$ 0,00</span>
              <input type="checkbox" id="markAllContasFixasPaid" class="checkbox-pago-total">
            </div>
          </div>
           <div class="categoria-box">
            <h3>Contas Variáveis</h3>
            <div id="contasVariaveisList" class="categoria-list"></div>
            <div class="total-categoria">
              <span>Total Contas Variáveis:</span>
              <span id="totalContasVariaveisCategoria">R$ 0,00</span>
              <input type="checkbox" id="markAllContasVariaveisPaid" class="checkbox-pago-total">
            </div>
          </div>
        </div>
      </section>

      <section class="cartoes-section">
        <h2>Compras por Cartão</h2>
        <div class="cartoes-grid" id="cartoesGrid"></div>
      </section>

      <section class="form-sections-wrapper">
        <div class="form-section">
          <h2>Adicionar Receita</h2>
          <form id="addReceitaForm">
            <label for="receitaNome">Nome:</label>
            <input type="text" id="receitaNome" required />
            <label for="receitaValor">Valor:</label>
            <input type="number" id="receitaValor" step="0.01" required />
            <button type="submit">Adicionar Receita</button>
          </form>
        </div>

        <div class="form-section">
          <h2>Adicionar Compra (Cartão)</h2>
          <form id="addCompraForm">
            <label for="compraNome">Nome:</label>
            <input type="text" id="compraNome" required />
            <label for="compraValor">Valor:</label>
            <input type="number" id="compraValor" step="0.01" required />
            <div class="row">
              <label for="compraParcelas">Parcelas:</label>
              <input type="number" id="compraParcelas" value="1" min="1" required />
              <label for="compraCartao">Cartão:</label>
              <select id="compraCartao" required>
                <option value="Nubank">Nubank</option>
                <option value="Santander">Santander</option>
                <option value="Mercado Pago">Mercado Pago</option>
                <option value="Amazon">Amazon</option>
                 <option value="Caixa">Caixa</option>
              </select>
            </div>
            <label for="compraResponsavel">Responsável:</label>
            <select id="compraResponsavel" required>
              <option value="Liana">Liana</option>
              <option value="Stefany">Stefany</option>
              <option value="Marília">Marília</option>
              <option value="Compartilhado">Compartilhado</option>
            </select>
            <button type="submit">Adicionar Compra</button>
          </form>
        </div>

        <div class="form-section">
          <h2>Adicionar Conta (Fixa/Variável)</h2>
          <form id="addContaForm">
            <label for="contaTipo">Tipo:</label>
            <select id="contaTipo" required>
              <option value="Fixa">Fixa</option>
              <option value="Variavel">Variável</option>
            </select>
            <label for="contaNome">Nome:</label>
            <input type="text" id="contaNome" required />
            <label for="contaValor">Valor:</label>
            <input type="number" id="contaValor" step="0.01" required />
            <label for="contaParcelas">Parcelas:</label>
            <input type="number" id="contaParcelas" value="1" min="1" required />
            <button type="submit">Adicionar Conta</button>
          </form>
        </div>
      </section>

      <section class="compras-responsaveis">
        <h2>Compras por Responsável</h2>
        <div class="responsaveis-container" id="responsaveisContainer"></div>
      </section>

      <footer>
        <p>Desenvolvido com ❤️ por <span class="marilia">Marília Santoz</span></p>
      </footer>
    </div>

    <div id="editReceitaModal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Editar Receita</h2>
        <form id="editReceitaForm">
          <input type="hidden" id="editReceitaId">
          <label for="editReceitaNome">Nome:</label>
          <input type="text" id="editReceitaNome" required>
          <label for="editReceitaValor">Valor:</label>
          <input type="number" id="editReceitaValor" step="0.01" required>
          <button type="submit">Salvar Alterações</button>
        </form>
      </div>
    </div>

    <div id="editCompraModal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Editar Compra</h2>
        <form id="editCompraForm">
           <input type="hidden" id="editCompraId">
          <label for="editCompraNome">Nome:</label>
          <input type="text" id="editCompraNome" required>
          <label for="editCompraValor">Valor:</label>
          <input type="number" id="editCompraValor" step="0.01" required>
          <label for="editCompraParcelas">Parcelas:</label>
          <input type="text" id="editCompraParcelas" required>
          <label for="editCompraCartao">Cartão:</label>
          <select id="editCompraCartao" required>
            <option value="Nubank">Nubank</option>
            <option value="Santander">Santander</option>
            <option value="Mercado Pago">Mercado Pago</option>
            <option value="Amazon">Amazon</option>
            <option value="Caixa">Caixa</option>
          </select>
          <label for="editCompraResponsavel">Responsável:</label>
          <select id="editCompraResponsavel" required>
            <option value="Liana">Liana</option>
            <option value="Stefany">Stefany</option>
            <option value="Marília">Marília</option>
            <option value="Compartilhado">Compartilhado</option>
          </select>
          <button type="submit">Salvar Alterações</button>
        </form>
      </div>
    </div>

    <div id="editContaModal" class="modal">
       <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Editar Conta</h2>
        <form id="editContaForm">
          <input type="hidden" id="editContaId">
          <label for="editContaTipo">Tipo:</label>
          <select id="editContaTipo" required>
            <option value="Fixa">Fixa</option>
            <option value="Variavel">Variável</option>
           </select>
          <label for="editContaNome">Nome:</label>
          <input type="text" id="editContaNome" required>
          <label for="editContaValor">Valor:</label>
          <input type="number" id="editContaValor" step="0.01" required>
          <label for="editContaParcelas">Parcelas:</label>
          <input type="number" id="editContaParcelas" required>
          <button type="submit">Salvar Alterações</button>
        </form>
       </div>
    </div>

    <script>
      // URL do seu Cloudflare Worker
      const WORKER_URL = 'https://painel-financas-proxy.mariliaedua.workers.dev/'; // Substitua pela URL do seu Worker

      let currentMonth, currentYear;

      document.addEventListener('DOMContentLoaded', ( ) => {
        // CORREÇÃO: Inicia o site sempre no mês seguinte ao mês vigente.
        const now = new Date();
        let nextMonth = now.getMonth() + 2; // getMonth() é 0-11, então +2 para o próximo mês
        let nextYear = now.getFullYear();
        
        // Ajusta ano se o próximo mês for janeiro (mês 13 vira 1 do próximo ano)
        if (nextMonth > 12) {
          nextMonth = 1;
          nextYear++;
        }
        
        currentMonth = nextMonth;
        currentYear = nextYear;
        
        updateMonthYearDisplay();
        fetchData();
      });
      
      async function sendRequest(action, data = {}, recordId = null) {
        // Garante que month e year sempre sejam enviados na requisição.
        const payload = { action, data, recordId, month: currentMonth, year: currentYear };
        console.log('Enviando payload:', payload);
        try {
          const response = await fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', },
            body: JSON.stringify(payload),
          });
          const result = await response.json();
          console.log('Resposta do Worker:', result);
          if (result.status === 'error') {
            alert('Erro: ' + result.message);
          }
          return result;
        } catch (error) {
          console.error('Erro ao enviar requisição:', error);
          alert('Erro de comunicação com o servidor. Verifique sua conexão ou tente novamente mais tarde.');
          return { status: 'error', message: error.message };
        }
      }

      function updateMonthYearDisplay() {
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        document.getElementById('currentMonthYear').textContent = `${monthNames[currentMonth - 1]} de ${currentYear}`;
      }

      function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth > 12) {
          currentMonth = 1;
          currentYear++;
        } else if (currentMonth < 
