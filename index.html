<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Painel Financeiro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-bottom: 30px;
        }
        h1, h2, h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .summary-box {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .summary-box h4 {
            color: #495057;
            margin-bottom: 10px;
        }
        .summary-box p {
            font-size: 1.8em;
            font-weight: 700;
            color: #007bff;
        }
        .saldo-positivo p {
            color: #28a745; /* Verde para saldo positivo */
        }
        .saldo-negativo p {
            color: #dc3545; /* Vermelho para saldo negativo */
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }
        .table-responsive {
            margin-top: 20px;
        }
        .table thead {
            background-color: #007bff;
            color: #ffffff;
        }
        .table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .form-label {
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #007bff;
            border-color: #007bff #007bff #fff;
        }
        .nav-tabs .nav-link {
            color: #6c757d;
        }
        /* Estilos para botões de ação na tabela */
        .action-btns .btn {
            padding: .25rem .5rem;
            font-size: .875rem;
            line-height: 1.5;
            border-radius: .2rem;
            margin-right: 5px;
        }
        .action-btns .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
        }
        .action-btns .btn-warning:hover {
            background-color: #e0a800;
            border-color: #d39e00;
        }
        .action-btns .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .action-btns .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Meu Painel Financeiro</h1>

        <div class="row text-center mb-4">
            <div class="col-md-4">
                <div class="summary-box">
                    <h4>Total de Receitas</h4>
                    <p id="totalReceitas">R$ 0,00</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-box">
                    <h4>Total de Despesas</h4>
                    <p id="totalCompras">R$ 0,00</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-box" id="saldoBox">
                    <h4>Saldo Total</h4>
                    <p id="saldoTotal">R$ 0,00</p>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="receitas-tab" data-bs-toggle="tab" data-bs-target="#receitas" type="button" role="tab" aria-controls="receitas" aria-selected="true">Receitas</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="compras-tab" data-bs-toggle="tab" data-bs-target="#compras" type="button" role="tab" aria-controls="compras" aria-selected="false">Compras</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="contas-tab" data-bs-toggle="tab" data-bs-target="#contas" type="button" role="tab" aria-controls="contas" aria-selected="false">Contas</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="receitas" role="tabpanel" aria-labelledby="receitas-tab">
                <h3 class="mt-4">Adicionar Nova Receita</h3>
                <form id="formReceita" class="mb-4">
                    <input type="hidden" id="receitaId">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="receitaDescricao" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="receitaDescricao" required>
                        </div>
                        <div class="col-md-4">
                            <label for="receitaValor" class="form-label">Valor</label>
                            <input type="number" step="0.01" class="form-control" id="receitaValor" required>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Adicionar/Atualizar Receita</button>
                        </div>
                    </div>
                </form>

                <h3 class="mt-4">Minhas Receitas</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaReceitas">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="compras" role="tabpanel" aria-labelledby="compras-tab">
                <h3 class="mt-4">Adicionar Nova Compra</h3>
                <form id="formCompra" class="mb-4">
                    <input type="hidden" id="compraId">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="compraDescricao" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="compraDescricao" required>
                        </div>
                        <div class="col-md-3">
                            <label for="compraValor" class="form-label">Valor</label>
                            <input type="number" step="0.01" class="form-control" id="compraValor" required>
                        </div>
                        <div class="col-md-3">
                            <label for="compraParcelas" class="form-label">Parcelas (Atual/Total)</label>
                            <input type="text" class="form-control" id="compraParcelas" placeholder="Ex: 1/3">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Adicionar/Atualizar Compra</button>
                        </div>
                    </div>
                </form>

                <h3 class="mt-4">Minhas Compras</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Parcelas</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCompras">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="contas" role="tabpanel" aria-labelledby="contas-tab">
                <h3 class="mt-4">Adicionar Nova Conta</h3>
                <form id="formConta" class="mb-4">
                    <input type="hidden" id="contaId">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="contaDescricao" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="contaDescricao" required>
                        </div>
                        <div class="col-md-3">
                            <label for="contaValor" class="form-label">Valor</label>
                            <input type="number" step="0.01" class="form-control" id="contaValor" required>
                        </div>
                        <div class="col-md-3">
                            <label for="contaParcelas" class="form-label">Parcelas (Atual/Total)</label>
                            <input type="text" class="form-control" id="contaParcelas" placeholder="Ex: 1/1">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Adicionar/Atualizar Conta</button>
                        </div>
                    </div>
                </form>

                <h3 class="mt-4">Minhas Contas</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Parcelas</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaContas">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // *** AQUI É ONDE A URL DO SEU CLOUDFLARE WORKER DEVE ENTRAR ***
        const webAppUrl = "https://painel-financas-proxy.mariliaedua.workers.dev/"; 
        // ***************************************************************

        // Função genérica para fazer requisições à API
        async function fetchData(action, data = {}, recordId = null) {
            const body = { action, data };
            if (recordId) {
                body.id = recordId; // Ou recordId, dependendo da sua necessidade
            }
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro na rede: ${response.status} - ${response.statusText}. Detalhes: ${errorText}`);
                }

                const result = await response.json();
                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                return result;
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                alert('Erro ao buscar dados: ' + error.message);
                throw error;
            }
        }

        // --- Funções de Receitas ---
        async function atualizarReceitas() {
            try {
                const receitas = await fetchData('getReceitas');
                const tabelaReceitas = document.getElementById('tabelaReceitas');
                tabelaReceitas.innerHTML = '';
                receitas.forEach(receita => {
                    const row = tabelaReceitas.insertRow();
                    row.insertCell(0).innerText = receita.id;
                    row.insertCell(1).innerText = receita.descricao;
                    row.insertCell(2).innerText = parseFloat(receita.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    const actionCell = row.insertCell(3);
                    actionCell.classList.add('action-btns');
                    actionCell.innerHTML = `
                        <button class="btn btn-warning btn-sm" onclick="editarRegistro('receitas', ${receita.id}, '${receita.descricao}', ${receita.valor})">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="excluirRegistro('receitas', ${receita.id})">Excluir</button>
                    `;
                });
                atualizarTotais();
            } catch (error) {
                console.error('Erro ao carregar receitas:', error);
                // alert('Erro ao carregar receitas: ' + error.message);
            }
        }

        document.getElementById('formReceita').addEventListener('submit', async function(event) {
            event.preventDefault();
            const id = document.getElementById('receitaId').value;
            const descricao = document.getElementById('receitaDescricao').value;
            const valor = parseFloat(document.getElementById('receitaValor').value);

            if (isNaN(valor)) {
                alert("Por favor, insira um valor numérico válido.");
                return;
            }

            const data = { descricao, valor };
            let result;
            if (id) {
                result = await fetchData('editReceita', data, id);
            } else {
                result = await fetchData('addReceita', data);
            }

            if (result && result.status === 'success') {
                alert(result.message);
                document.getElementById('formReceita').reset();
                document.getElementById('receitaId').value = ''; // Limpa o ID
                atualizarReceitas();
            }
        });

        // --- Funções de Compras ---
        async function atualizarCompras() {
            try {
                const compras = await fetchData('getCompras');
                const tabelaCompras = document.getElementById('tabelaCompras');
                tabelaCompras.innerHTML = '';
                compras.forEach(compra => {
                    const row = tabelaCompras.insertRow();
                    row.insertCell(0).innerText = compra.id;
                    row.insertCell(1).innerText = compra.descricao;
                    row.insertCell(2).innerText = parseFloat(compra.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    row.insertCell(3).innerText = compra.parcelas || '1/1';
                    const actionCell = row.insertCell(4);
                    actionCell.classList.add('action-btns');
                    actionCell.innerHTML = `
                        <button class="btn btn-warning btn-sm" onclick="editarRegistro('compras', ${compra.id}, '${compra.descricao}', ${compra.valor}, '${compra.parcelas}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="excluirRegistro('compras', ${compra.id})">Excluir</button>
                    `;
                });
                atualizarTotais();
            } catch (error) {
                console.error('Erro ao carregar compras:', error);
                // alert('Erro ao carregar compras: ' + error.message);
            }
        }

        document.getElementById('formCompra').addEventListener('submit', async function(event) {
            event.preventDefault();
            const id = document.getElementById('compraId').value;
            const descricao = document.getElementById('compraDescricao').value;
            const valor = parseFloat(document.getElementById('compraValor').value);
            const parcelas = document.getElementById('compraParcelas').value;

            if (isNaN(valor)) {
                alert("Por favor, insira um valor numérico válido.");
                return;
            }

            const data = { descricao, valor, parcelas };
            let result;
            if (id) {
                result = await fetchData('editCompra', data, id);
            } else {
                result = await fetchData('addCompra', data);
            }

            if (result && result.status === 'success') {
                alert(result.message);
                document.getElementById('formCompra').reset();
                document.getElementById('compraId').value = '';
                atualizarCompras();
            }
        });

        // --- Funções de Contas ---
        async function atualizarContas() {
            try {
                const contas = await fetchData('getContas');
                const tabelaContas = document.getElementById('tabelaContas');
                tabelaContas.innerHTML = '';
                contas.forEach(conta => {
                    const row = tabelaContas.insertRow();
                    row.insertCell(0).innerText = conta.id;
                    row.insertCell(1).innerText = conta.descricao;
                    row.insertCell(2).innerText = parseFloat(conta.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    row.insertCell(3).innerText = conta.parcelas || '1/1';
                    const actionCell = row.insertCell(4);
                    actionCell.classList.add('action-btns');
                    actionCell.innerHTML = `
                        <button class="btn btn-warning btn-sm" onclick="editarRegistro('contas', ${conta.id}, '${conta.descricao}', ${conta.valor}, '${conta.parcelas}')">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="excluirRegistro('contas', ${conta.id})">Excluir</button>
                    `;
                });
                atualizarTotais();
            } catch (error) {
                console.error('Erro ao carregar contas:', error);
                // alert('Erro ao carregar contas: ' + error.message);
            }
        }

        document.getElementById('formConta').addEventListener('submit', async function(event) {
            event.preventDefault();
            const id = document.getElementById('contaId').value;
            const descricao = document.getElementById('contaDescricao').value;
            const valor = parseFloat(document.getElementById('contaValor').value);
            const parcelas = document.getElementById('contaParcelas').value;

            if (isNaN(valor)) {
                alert("Por favor, insira um valor numérico válido.");
                return;
            }

            const data = { descricao, valor, parcelas };
            let result;
            if (id) {
                result = await fetchData('editConta', data, id);
            } else {
                result = await fetchData('addConta', data);
            }

            if (result && result.status === 'success') {
                alert(result.message);
                document.getElementById('formConta').reset();
                document.getElementById('contaId').value = '';
                atualizarContas();
            }
        });

        // --- Funções de Edição e Exclusão Genéricas ---
        function editarRegistro(tipo, id, descricao, valor, parcelas = '') {
            if (tipo === 'receitas') {
                document.getElementById('receitaId').value = id;
                document.getElementById('receitaDescricao').value = descricao;
                document.getElementById('receitaValor').value = valor;
                document.getElementById('receitas-tab').click(); // Troca para a aba de receitas
            } else if (tipo === 'compras') {
                document.getElementById('compraId').value = id;
                document.getElementById('compraDescricao').value = descricao;
                document.getElementById('compraValor').value = valor;
                document.getElementById('compraParcelas').value = parcelas;
                document.getElementById('compras-tab').click(); // Troca para a aba de compras
            } else if (tipo === 'contas') {
                document.getElementById('contaId').value = id;
                document.getElementById('contaDescricao').value = descricao;
                document.getElementById('contaValor').value = valor;
                document.getElementById('contaParcelas').value = parcelas;
                document.getElementById('contas-tab').click(); // Troca para a aba de contas
            }
        }

        async function excluirRegistro(tipo, id) {
            if (!confirm(`Tem certeza que deseja excluir o registro ${id} de ${tipo}?`)) {
                return;
            }
            let result;
            if (tipo === 'receitas') {
                result = await fetchData('deleteReceita', {}, id);
            } else if (tipo === 'compras') {
                result = await fetchData('deleteCompra', {}, id);
            } else if (tipo === 'contas') {
                result = await fetchData('deleteConta', {}, id);
            }

            if (result && result.status === 'success') {
                alert(result.message);
                if (tipo === 'receitas') atualizarReceitas();
                else if (tipo === 'compras') atualizarCompras();
                else if (tipo === 'contas') atualizarContas();
            }
        }

        // --- Funções de Totais ---
        async function atualizarTotais() {
            try {
                const totais = await fetchData('getTotais');
                document.getElementById('totalReceitas').innerText = parseFloat(totais.totalReceitas).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                document.getElementById('totalCompras').innerText = parseFloat(totais.totalCompras).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const saldoTotalElement = document.getElementById('saldoTotal');
                const saldoBoxElement = document.getElementById('saldoBox');

                saldoTotalElement.innerText = parseFloat(totais.saldoTotal).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                // Atualiza a cor do saldo
                saldoBoxElement.classList.remove('saldo-positivo', 'saldo-negativo');
                if (totais.saldoTotal >= 0) {
                    saldoBoxElement.classList.add('saldo-positivo');
                } else {
                    saldoBoxElement.classList.add('saldo-negativo');
                }

            } catch (error) {
                console.error('Erro ao atualizar totais:', error);
                // alert('Erro ao atualizar totais: ' + error.message);
            }
        }

        // Carregar dados iniciais ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            atualizarReceitas();
            atualizarCompras();
            atualizarContas();
            atualizarTotais();

             // Lidar com a troca de abas para recarregar os dados
            const tabButtons = document.querySelectorAll('.nav-tabs .nav-link');
            tabButtons.forEach(button => {
                button.addEventListener('shown.bs.tab', function (event) {
                    const activeTabId = event.target.id;
                    if (activeTabId === 'receitas-tab') {
                        atualizarReceitas();
                    } else if (activeTabId === 'compras-tab') {
                        atualizarCompras();
                    } else if (activeTabId === 'contas-tab') {
                        atualizarContas();
                    }
                    atualizarTotais(); // Atualiza os totais sempre que a aba é trocada
                });
            });
        });
    </script>
</body>
</html>
