<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
    <style>
      /* CONFIGURA√á√ÉO GERAL */
      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        color: black; /* Texto padr√£o em preto */
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      .form-section,
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
      }
      /* BOT√ïES */
      button {
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        padding: 8px 12px;
      }
      button:hover {
        background-color: #43a047;
      }
      /* For√ßa inputs e selects a terem texto preto */
      input, select {
        color: black;
      }
      /* CENTRALIZA√á√ÉO DOS T√çTULOS */
      h1, h2, h3 {
        text-align: center;
      }
      /* CABE√áALHO E NAVEGA√á√ÉO */
      header {
        text-align: center;
        margin-bottom: 10px;
      }
      header h1 {
        margin: 0;
        font-size: 2.5em;
      }
      header h2 {
        margin: 5px 0 10px;
        font-size: 2em;
      }
      .nav-buttons {
        text-align: center;
        margin-bottom: 20px;
      }
      .nav-buttons button {
        padding: 10px 15px;
        margin: 0 10px;
      }
      /* TOTAIS ‚Äì RESUMO DO M√äS */
      .totals-section {
        margin-bottom: 20px;
        padding: 15px;
      }
      .totals-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.2em;
      }
      .saldo-bar-container {
        position: relative;
        background-color: #ddd;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .saldo-bar {
        height: 100%;
        width: 40%;
        background-color: green;
        transition: width 0.5s;
      }
      .saldo-label {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        font-weight: bold;
        color: black;
      }
      /* CATEGORIAS ‚Äì Receitas, Contas Fixas, Contas Vari√°veis */
      .categorias-section {
        margin-bottom: 20px;
        padding: 15px;
      }
      .categorias-section h2 {
        margin: 0 0 15px;
        font-size: 1.8em;
      }
      .categorias-columns {
        display: flex;
        justify-content: space-between;
        gap: 15px;
      }
      /* CAIXA RECEITAS */
      .categoria-box.receitas {
        width: 32%;
        padding: 10px;
      }
      .categoria-box.receitas h3 {
        margin: 0 0 10px;
        font-size: 1.2em;
        border-bottom: 1px solid #90caf9;
        padding-bottom: 5px;
        text-align: center;
      }
      .categoria-box.receitas .categoria-list .receita-item {
        margin-bottom: 8px;
        text-align: center;
      }
      .categoria-box.receitas .categoria-list .receita-item input {
        padding: 5px;
        margin: 5px;
        box-sizing: border-box;
      }
      /* CAIXA CONTAS FIXAS */
      .categoria-box.contas {
        width: 32%;
        padding: 10px;
      }
      .categoria-box.contas h3 {
        margin: 0 0 10px;
        font-size: 1.2em;
        border-bottom: 1px solid #90caf9;
        padding-bottom: 5px;
      }
      .categoria-box.contas .categoria-list .conta-item {
        padding: 5px;
        font-size: 0.9em;
        border-bottom: 1px dashed #90caf9;
        text-align: center;
      }
      .categoria-box.contas .categoria-list .conta-item:last-child {
        border-bottom: none;
      }
      .categoria-box.contas .conta-total {
        text-align: right;
        font-weight: bold;
        margin-top: 5px;
      }
      .categoria-box.receitas button {
        display: block;
        margin: 10px auto 0;
      }
      /* FORMUL√ÅRIOS */
      .form-section {
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .form-section h2 {
        margin: 0 0 15px;
        font-size: 1.8em;
      }
      .form-section .row {
        width: 100%;
        text-align: center;
        margin: 10px 0;
      }
      .form-section select,
      .form-section input {
        width: 20%;
        padding: 8px;
        margin: 5px;
        box-sizing: border-box;
      }
      .form-section .nome-field {
        width: 40% !important;
      }
      .forms-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .forms-container > .form-section {
        width: 50%;
      }
      /* CART√ïES */
      .cartoes-section {
        margin-bottom: 20px;
        padding: 15px;
      }
      .cartoes-section h2 {
        margin-top: 0;
        font-size: 1.8em;
      }
      .cartoes-columns {
        display: flex;
        justify-content: space-between;
        gap: 15px;
      }
      .cartao-box {
        width: 23%;
        padding: 10px;
        text-align: center;
        border: 1px solid #90caf9;
        border-radius: 5px;
      }
      .cartao-box h3 {
        margin: 0 0 10px;
        font-size: 1.2em;
        border-bottom: 1px solid;
        padding-bottom: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .cartao-total {
        margin: 10px 0;
        font-weight: bold;
        color: black;
      }
      .cartao-list div {
        padding: 5px;
        font-size: 0.9em;
        border-bottom: 1px dashed;
        color: black;
      }
      .cartao-list div:last-child {
        border-bottom: none;
      }
      /* Cart√µes Personalizados */
      #nubankCard {
        background: linear-gradient(to bottom, #e8ccf5, #d1a9ea, #ba86e0, #8605b8);
        border: 1px solid #8605b8;
      }
      #santanderCard {
        background: linear-gradient(to bottom, #ffe6e6, #ffcccc, #ffb3b3, #e50000);
        border: 1px solid #e50000;
      }
      #mpagoCard {
        background: linear-gradient(to bottom, #d1e0f0, #a3c1e1, #75a2d2, #1c3d91);
        border: 1px solid #1c3d91;
      }
      #amazonCard {
        background: linear-gradient(to bottom, #ff9700, #d47c00, #aa6100, #222e3d);
        border: 1px solid #222e3d;
      }
      /* TOTAL DE COMPRAS POR RESPONS√ÅVEL - CENTRALIZADO */
      .compras-responsaveis {
        margin-bottom: 20px;
        padding: 15px;
        text-align: center;
      }
      .compras-responsaveis h2 {
        margin-bottom: 15px;
        font-size: 1.8em;
      }
      .responsaveis-container {
        display: flex;
        justify-content: space-around;
        gap: 15px;
        flex-wrap: wrap;
      }
      .responsavel-box {
        width: 22%;
        padding: 10px;
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
        text-align: center;
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em;
      }
      .responsavel-box p {
        margin: 5px 0;
        font-size: 0.9em;
      }
      /* Cores para Respons√°veis (background) */
      .liana {
        background-color: #add8e6;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .stefany {
        background-color: #ffb347;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .marilia {
        background-color: #dda0dd;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .nosso {
        background-color: #ffc0cb;
        padding: 4px 8px;
        border-radius: 3px;
      }
      /* RODAP√â */
      footer {
        text-align: center;
        margin-top: 20px;
      }
      footer p span {
        margin: 0 5px;
        font-weight: bold;
      }
      .list-item-controls {
          display: flex;
          justify-content: flex-end; /* Alinha bot√µes √† direita */
          gap: 5px;
          margin-top: 5px;
      }
      .list-item-controls button {
          padding: 3px 8px;
          font-size: 0.8em;
          margin-left: 5px;
      }
      .list-item-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .checkbox-pago {
        margin-left: 10px;
        transform: scale(1.2); /* Aumenta o tamanho do checkbox */
      }
    </style>
<script>

  // <script> tag starts here (substitua TODO o conte√∫do DENTRO desta tag)

const webAppUrl = 'https://painel-financas-proxy.mariliaedua.workers.dev/'; // <--- SUBSTITUA AQUI PELA URL DO SEU CLOUDFLARE WORKER
let currentMonth = new Date().getMonth(); // M√™s (0-11)
let currentYear = new Date().getFullYear();

document.addEventListener('DOMContentLoaded', () => {
  // Definir o m√™s e ano iniciais no cabe√ßalho
  updateHeaderMonthYear();

  // Carregar todos os dados iniciais para o m√™s atual
  fetchAndDisplayAllData();

  // Event listeners para os bot√µes de navega√ß√£o
  document.querySelector('.nav-buttons button:first-child').addEventListener('click', () => {
    changeMonth(-1);
  });
  document.querySelector('.nav-buttons button:last-child').addEventListener('click', () => {
    changeMonth(1);
  });

  // Event listener para o bot√£o "Adicionar Receita"
  document.querySelector('.receitas button').addEventListener('click', adicionarReceita);

  // Event listeners para o bot√£o "Adicionar Compra no Cart√£o"
  document.querySelector('#formAdicionarCompra button').addEventListener('click', adicionarCompraCartao);

  // Event listeners para o bot√£o "Adicionar Conta"
  document.querySelector('#formAdicionarConta button').addEventListener('click', adicionarConta);

  // Adiciona event listeners para os checkboxes "Marcar todas como pagas" dos cart√µes
  document.querySelectorAll('.cartao-paid').forEach(checkbox => {
    checkbox.addEventListener('change', async (event) => {
      const cardBox = event.target.closest('.cartao-box');
      const cardNameElement = cardBox.querySelector('h3').textContent.trim();
      const cardName = convertCardNameToSheetName(cardNameElement); // Converte para o nome usado na sheet

      const isChecked = event.target.checked;
      const statusPago = isChecked ? 'Sim' : 'N√£o'; // Define o status para o backend

      const confirmAction = isChecked
        ? confirm(`Tem certeza que deseja marcar TODAS as compras do cart√£o ${cardName} como PAGAS para ${getMonthName(currentMonth + 1)}/${currentYear}?`)
        : confirm(`Tem certeza que deseja marcar TODAS as compras do cart√£o ${cardName} como N√ÉO PAGAS para ${getMonthName(currentMonth + 1)}/${currentYear}?`);

      if (confirmAction) {
        // Obter as compras para este cart√£o e este m√™s/ano
        const compras = await getComprasDoCartaoParaMes(cardName, currentMonth + 1, currentYear);

        let successCount = 0;
        for (const compra of compras) {
          const payload = {
            action: 'markCompraAsPaid',
            recordId: compra.originalId, // Use originalId aqui para update/delete
            data: { pago: statusPago } // Envia o status atualizado
          };
          try {
            const response = await fetch(webAppUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.status === 'success') {
              successCount++;
            } else {
              console.error('Erro ao atualizar compra:', result.message);
            }
          } catch (error) {
            console.error('Erro na requisi√ß√£o de marcar compra:', error);
          }
        }
        if (successCount === compras.length && compras.length > 0) {
          alert(`Todas as ${successCount} compras do cart√£o ${cardName} marcadas como ${statusPago} com sucesso!`);
        } else if (compras.length > 0) {
          alert(`Algumas compras do cart√£o ${cardName} foram atualizadas como ${statusPago}. ${successCount} de ${compras.length} sucessos.`);
        } else {
          alert(`Nenhuma compra encontrada para o cart√£o ${cardName} em ${getMonthName(currentMonth + 1)}/${currentYear}.`);
        }
        fetchAndDisplayAllData(); // Recarrega os dados ap√≥s a atualiza√ß√£o em massa
      } else {
        // Se o usu√°rio cancelar, reverter o estado do checkbox
        event.target.checked = !isChecked;
      }
    });
  });
});

// Fun√ß√£o auxiliar para obter compras de um cart√£o espec√≠fico para um m√™s/ano
async function getComprasDoCartaoParaMes(cardName, month, year) {
  const payload = {
    action: 'getComprasPorCartao', // A√ß√£o que j√° retorna compras filtradas por cart√£o e m√™s
    month: month,
    year: year
  };
  try {
    const response = await fetch(webAppUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await response.json();
    if (result.status === 'success' || (typeof result === 'object' && result[cardName])) {
      return result[cardName].compras; // Retorna a lista de compras para o cart√£o espec√≠fico
    } else {
      console.error('Erro ao buscar compras por cart√£o:', result.message || result);
      return [];
    }
  } catch (error) {
    console.error('Erro na requisi√ß√£o para buscar compras por cart√£o:', error);
    return [];
  }
}

// Fun√ß√£o para converter o nome do cart√£o exibido para o nome na planilha
function convertCardNameToSheetName(displayCardName) {
  switch (displayCardName.toUpperCase()) {
    case 'NUBANK': return 'Nubank';
    case 'SANTANDER': return 'Santander';
    case 'M.PAGO': return 'Mercado Pago';
    case 'AMAZON': return 'Amazon';
    default: return displayCardName;
  }
}


function updateHeaderMonthYear() {
  const monthYearHeader = document.querySelector('header h2');
  if (monthYearHeader) {
    monthYearHeader.textContent = `${getMonthName(currentMonth + 1)} ${currentYear}`;
  }
}

function changeMonth(delta) {
  currentMonth += delta;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  } else if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  updateHeaderMonthYear();
  fetchAndDisplayAllData(); // Recarrega todos os dados para o novo m√™s/ano
}

async function fetchAndDisplayAllData() {
  await Promise.all([
    atualizarReceitas(),
    atualizarCompras(),
    atualizarContas(),
    atualizarTotais(),
    atualizarCartoes(),
    atualizarComprasPorResponsavel()
  ]);
}

async function sendRequest(action, data = {}, recordId = null) {
  const payload = {
    action: action,
    data: data,
    recordId: recordId,
    month: currentMonth + 1, // Envia o m√™s atual (1-12)
    year: currentYear        // Envia o ano atual
  };

  try {
    const response = await fetch(webAppUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    return await response.json();
  } catch (error) {
    console.error('Erro na requisi√ß√£o:', error);
    alert('Erro ao comunicar com o servidor: ' + error.message);
    return { status: 'error', message: 'Erro de rede.' };
  }
}

async function atualizarReceitas() {
  const result = await sendRequest('getReceitas');
  const lista = document.getElementById('listaReceitas');
  lista.innerHTML = '';
  if (result.status === 'error') {
    lista.innerHTML = `<p>${result.message}</p>`;
    return;
  }
  if (result.length === 0) {
    lista.innerHTML = '<p>Nenhuma receita cadastrada.</p>';
    return;
  }
  result.forEach(item => {
    const p = document.createElement('p');
    p.innerHTML = `${item.nome}: R$ ${parseFloat(item.valor).toFixed(2).replace('.', ',')}
                    <span class="edit-btn" onclick="editarReceita('${item.id}', '${item.nome}', '${item.valor}')">‚úèÔ∏è</span>
                    <span class="delete-btn" onclick="deletarReceita('${item.id}')">üóëÔ∏è</span>`;
    lista.appendChild(p);
  });
}

async function adicionarReceita() {
  const nome = prompt('Nome da Receita:');
  if (!nome) return;
  const valor = parseFloat(prompt('Valor da Receita:'));
  if (isNaN(valor) || valor <= 0) {
    alert('Valor inv√°lido.');
    return;
  }
  const result = await sendRequest('addReceita', { nome: nome, valor: valor });
  if (result.status === 'success') {
    alert(result.message);
    fetchAndDisplayAllData();
  } else {
    alert('Erro: ' + result.message);
  }
}

async function editarReceita(id, nomeAtual, valorAtual) {
  const novoNome = prompt('Novo nome da Receita:', nomeAtual);
  if (!novoNome) return;
  const novoValor = parseFloat(prompt('Novo valor da Receita:', valorAtual));
  if (isNaN(novoValor) || novoValor <= 0) {
    alert('Valor inv√°lido.');
    return;
  }
  const result = await sendRequest('updateReceita', { nome: novoNome, valor: novoValor }, id);
  if (result.status === 'success') {
    alert(result.message);
    fetchAndDisplayAllData();
  } else {
    alert('Erro: ' + result.message);
  }
}

async function deletarReceita(id) {
  if (!confirm('Tem certeza que deseja deletar esta receita?')) return;
  const result = await sendRequest('deleteReceita', {}, id);
  if (result.status === 'success') {
    alert(result.message);
    fetchAndDisplayAllData();
  } else {
    alert('Erro: ' + result.message);
  }
}

async function atualizarCompras() {
  const result = await sendRequest('getCompras');
  const listaContasVariaveis = document.getElementById('listaContasVariaveis');
  listaContasVariaveis.innerHTML = ''; // Limpa antes de preencher, para receber APENAS compras de cart√£o.

  if (result.status === 'error') {
    listaContasVariaveis.innerHTML = `<p>${result.message}</p>`;
    return;
  }
  if (result.length === 0) {
    listaContasVariaveis.innerHTML = '<p>Nenhuma compra cadastrada.</p>';
    return;
  }

  result.forEach(item => {
    // item.valor j√° √© o valor da parcela, e item.parcelas j√° √© "X/Y" do Apps Script
    const valorParcela = parseFloat(item.valor || 0).toFixed(2).replace('.', ',');
    const p = document.createElement('p');
    p.className = item.pago === 'Sim' ? 'item-pago' : '';
    p.innerHTML = `${item.nome} (${item.parcelas}) - R$ ${valorParcela} (${item.cartao})
                    <span class="edit-btn" onclick="editarCompra('${item.originalId}', '${item.nome}', '${item.valor}', '${item.parcelas}', '${item.responsavel}', '${item.cartao}')">‚úèÔ∏è</span>
                    <span class="delete-btn" onclick="deletarCompra('${item.originalId}')">üóëÔ∏è</span>
                    <input type="checkbox" class="item-paid-checkbox" data-id="${item.originalId}" data-type="compra" ${item.pago === 'Sim' ? 'checked' : ''} title="Marcar como pago"/>`;
    listaContasVariaveis.appendChild(p);
  });
  addCheckboxListeners();
}

async function adicionarCompraCartao() {
  const respCompra = document.querySelector('#respCompra').value;
  const cartaoCompra = document.querySelector('#cartaoCompra').value;
  const nomeCompra = document.querySelector('#formAdicionarCompra input[placeholder="Nome da Compra"]').value;
  const valorCompra = parseFloat(document.querySelector('#formAdicionarCompra input[placeholder="Valor"]').value);
  const parcelasCompra = document.querySelector('#formAdicionarCompra input[placeholder="Parcelas (ex: 2/6)"]').value;

  if (!nomeCompra || isNaN(valorCompra) || valorCompra <= 0 || !parcelasCompra) {
    alert('Por favor, preencha todos os campos corretamente.');
    return;
  }

  const data = {
    responsavel: respCompra,
    cartao: cartaoCompra,
    nome: nomeCompra,
    valor: valorCompra,
    parcelas: parcelasCompra
  };

  const result = await sendRequest('addCompraCartao', data);
  if (result.status === 'success') {
    alert(result.message);
    document.querySelector('#formAdicionarCompra input[placeholder="Nome da Compra"]').value = '';
    document.querySelector('#formAdicionarCompra input[placeholder="Valor"]').value = '';
    document.querySelector('#formAdicionarCompra input[placeholder="Parcelas (ex: 2/6)"]').value = '';
    fetchAndDisplayAllData();
  } else {
    alert('Erro: ' + result.message);
  }
}

async function editarCompra(id, nomeAtual, valorAtual, parcelasAtual, responsavelAtual, cartaoAtual) {
  const novoNome = prompt('Novo nome da Compra:', nomeAtual);
  if (!novoNome) return;
  const novoValor = parseFloat(prompt('Novo valor da Compra:', valorAtual));
  if (isNaN(novoValor) || novoValor <= 0) {
    alert('Valor inv√°lido.');
    return;
  }
  const novasParcelas = prompt('Novas Parcelas (ex: 2/6):', parcelasAtual);
  if (!novasParcelas) return;
  const novoResponsavel = prompt('Novo Respons√°vel:', responsavelAtual);
  if (!novoResponsavel) return;
  const novoCartao = prompt('Novo Cart√£o:', cartaoAtual);
  if (!novoCartao) return;

  const data = {
    nome: novoNome,
    valor: novoValor,
    parcelas: novasParcelas,
    responsavel: novoResponsavel,
    cartao: novoCartao
  };
  const result = await sendRequest('updateCompra', data, id);
  if (result.status === 'success') {
    alert(result.message);
    fetchAndDisplayAllData();
  } else {
    alert('Erro: ' + result.message);
  }
}

async function deletarCompra(id) {
  if (!confirm('Tem certeza que deseja deletar esta compra?')) return;
  const result = await sendRequest('deleteCompra', {}, id);
  if (result.status === 'success') {
    alert(result.message);
    fetchAndDisplayAllData();
  } else {
    alert('Erro: ' + result.message);
  }
}

async function atualizarContas() {
  const result = await sendRequest('getContas');
  const listaFixas = document.getElementById('listaContasFixas');
  const listaVariaveis = document.getElementById('listaContasVariaveis'); // Esta lista agora receber√° APENAS contas vari√°veis

  listaFixas.innerHTML = '';
  listaVariaveis.innerHTML = ''; // Limpa esta lista para preencher com contas vari√°veis

  if (result.status === 'error') {
    listaFixas.innerHTML = `<p>${result.message}</p>`;
    listaVariaveis.innerHTML = `<p>${result.message}</p>`; // Mostrar erro em ambos
    return;
  }

  let totalFixas = 0;
  let totalVariaveis = 0;

  if (result.length === 0) {
    listaFixas.innerHTML = '<p>Nenhuma conta cadastrada.</p>';
    listaVariaveis.innerHTML += '<p>Nenhuma conta vari√°vel cadastrada.</p>';
    return;
  }

  result.forEach(item => {
    // item.valor j√° √© o valor da parcela, e item.parcelas j√° √© "X/Y" do Apps Script
    const valorParcela = parseFloat(item.valor || 0).toFixed(2).replace('.', ',');
    const p = document.createElement('p');
    p.className = item.pago === 'Sim' ? 'item-pago' : '';
    p.innerHTML = `${item.nome} (${item.parcelas}) - R$ ${valorParcela}
                    <span class="edit-btn" onclick="editarConta('${item.originalId}', '${item.tipo}', '${item.nome}', '${item.valor}', '${item.parcelas}')">‚úèÔ∏è</span>
                    <span class="delete-btn" onclick="deletarConta('${item.originalId}')">üóëÔ∏è</span>
                    <input type="checkbox" class="item-paid-checkbox" data-id="${item.originalId}" data-type="conta" ${item.pago === 'Sim' ? 'checked' : ''} title="Marcar como pago"/>`;

    if (item.tipo === 'Fixa') {
      listaFixas.appendChild(p);
      totalFixas += parseFloat(valorParcela.replace(',', '.'));
    } else if (item.tipo === 'Vari√°vel') {
      listaVariaveis.appendChild(p);
      totalVariaveis += parseFloat(valorParcela.replace(',', '.'));
    }
  });

  document.getElementById('totalContasFixas').textContent = `Total: R$ ${totalFixas.toFixed(2).replace('.', ',')}`;
  // O total das contas vari√°veis ser√° somado ao total de compras no atualizarTotais
  // document.getElementById('totalContasVariaveis').textContent = `Total: R$ ${totalVariaveis.toFixed(2).replace('.', ',')}`; // N√£o exibe aqui para evitar confus√£o com compras.
  addCheckboxListeners();
}

async function adicionarConta() {
  const tipoConta = document.querySelector('#tipoConta').value;
  const nomeConta = document.querySelector('#formAdicionarConta input[placeholder="Nome da Conta"]').value;
  const parcelasConta = document.querySelector('#formAdicionarConta input[placeholder="Parcelas (ex: 2/3)"]').value;
  const valorConta = parseFloat(document.querySelector('#formAdicionarConta input[placeholder="Valor"]').value);

  if (!nomeConta || isNaN(valorConta) || valorConta <= 0 || !parcelasConta) {
    alert('Por favor, preencha todos os campos corretamente.');
    return;
  }

  const data = {
    tipo: tipoConta,
    nome: nomeConta,
    parcelas: parcelasConta,
    valor: valorConta
  };

  const result = await sendRequest('addConta', data);
  if (result.status === 'success') {
    alert(result.message);
    document.querySelector('#formAdicionarConta input[placeholder="Nome da Conta"]').value = '';
    document.querySelector('#formAdicionarConta input[placeholder="Parcelas (ex: 2/3)"]').value = '';
    document.querySelector('#formAdicionarConta input[placeholder="Valor"]').value = '';
    fetchAndDisplayAllData();
  } else {
    alert('Erro: ' + result.message);
  }
}

async function editarConta(id, tipoAtual, nomeAtual, valorAtual, parcelasAtual) {
  const novoTipo = prompt('Novo tipo de Conta (Fixa/Vari√°vel):', tipoAtual);
  if (!novoTipo) return;
  const novoNome = prompt('Novo nome da Conta:', nomeAtual);
  if (!novoNome) return;
  const novoValor = parseFloat(prompt('Novo valor da Conta:', valorAtual));
  if (isNaN(novoValor) || novoValor <= 0) {
    alert('Valor inv√°lido.');
    return;
  }
  const novasParcelas = prompt('Novas Parcelas (ex: 2/3):', parcelasAtual);
  if (!novasParcelas) return;

  const data = {
    tipo: novoTipo,
    nome: novoNome,
    valor: novoValor,
    parcelas: novasParcelas
  };
  const result = await sendRequest('updateConta', data, id);
  if (result.status === 'success') {
    alert(result.message);
    fetchAndDisplayAllData();
  } else {
    alert('Erro: ' + result.message);
  }
}

async function deletarConta(id) {
  if (!confirm('Tem certeza que deseja deletar esta conta?')) return;
  const result = await sendRequest('deleteConta', {}, id);
  if (result.status === 'success') {
    alert(result.message);
    fetchAndDisplayAllData();
  } else {
    alert('Erro: ' + result.message);
  }
}

async function atualizarTotais() {
  const result = await sendRequest('getTotais');
  if (result.status === 'error') {
    document.querySelector('.totals-section .totals-wrapper span:first-child').textContent = `Total de Receitas: Erro`;
    document.querySelector('.totals-section .totals-wrapper span:last-child').textContent = `Total de Despesas: Erro`;
    document.querySelector('.saldo-label').textContent = `Saldo: Erro`;
    document.querySelector('.saldo-bar').style.width = '0%';
    document.querySelector('.saldo-bar').style.backgroundColor = 'gray';
    return;
  }

  const totalReceitas = result.receitas || 0;
  const totalDespesas = result.despesas || 0;
  const saldo = result.saldo || 0;

  document.querySelector('.totals-section .totals-wrapper span:first-child').textContent = `Total de Receitas: R$ ${totalReceitas.toFixed(2).replace('.', ',')}`;
  document.querySelector('.totals-section .totals-wrapper span:last-child').textContent = `Total de Despesas: R$ ${totalDespesas.toFixed(2).replace('.', ',')}`;
  document.querySelector('.saldo-label').textContent = `Saldo: R$ ${saldo.toFixed(2).replace('.', ',')}`;

  // Atualiza a barra de saldo
  const saldoBar = document.querySelector('.saldo-bar');
  if (totalReceitas > 0) {
    let percentage = (saldo / totalReceitas) * 100;
    percentage = Math.max(0, Math.min(100, percentage));
    saldoBar.style.width = `${percentage}%`;
    if (saldo > 0) {
      saldoBar.style.backgroundColor = '#28a745'; // Verde
    } else {
      saldoBar.style.backgroundColor = '#dc3545'; // Vermelho
    }
  } else {
    saldoBar.style.width = '0%';
    saldoBar.style.backgroundColor = 'gray';
  }
}

async function atualizarCartoes() {
  const result = await sendRequest('getComprasPorCartao');
  if (result.status === 'error') {
    document.getElementById('nubankCard').querySelector('.cartao-list').innerHTML = `<p>${result.message}</p>`;
    document.getElementById('santanderCard').querySelector('.cartao-list').innerHTML = `<p>${result.message}</p>`;
    document.getElementById('mpagoCard').querySelector('.cartao-list').innerHTML = `<p>${result.message}</p>`;
    document.getElementById('amazonCard').querySelector('.cartao-list').innerHTML = `<p>${result.message}</p>`;
    return;
  }

  const cartoes = {
    'Nubank': 'nubankCard',
    'Santander': 'santanderCard',
    'Mercado Pago': 'mpagoCard',
    'Amazon': 'amazonCard'
  };

  for (const cartaoNome in cartoes) {
    const elementId = cartoes[cartaoNome];
    const cardBox = document.getElementById(elementId);
    if (cardBox) {
      const listElement = cardBox.querySelector('.cartao-list');
      const totalElement = cardBox.querySelector('.cartao-total');
      listElement.innerHTML = '';

      const data = result[cartaoNome];
      if (data && data.compras.length > 0) {
        let currentCardTotal = 0;
        data.compras.forEach(compra => {
          const p = document.createElement('p');
          p.className = compra.pago === 'Sim' ? 'item-pago' : '';
          // Usando compra.parcelas que j√° deve estar no formato "X/Y" do Apps Script
          p.innerHTML = `${compra.nome} (${compra.parcelas}) - R$ ${parseFloat(compra.valor).toFixed(2).replace('.', ',')}
                            <input type="checkbox" class="item-paid-checkbox" data-id="${compra.originalId}" data-type="compra" ${compra.pago === 'Sim' ? 'checked' : ''} title="Marcar como pago"/>`;
          listElement.appendChild(p);
          currentCardTotal += parseFloat(compra.valor);
        });
        totalElement.textContent = `Total: R$ ${currentCardTotal.toFixed(2).replace('.', ',')}`;
      } else {
        listElement.innerHTML = '<p>Nenhuma compra neste cart√£o.</p>';
        totalElement.textContent = `Total: R$ 0,00`;
      }
    }
  }
  addCheckboxListeners();
}

async function atualizarComprasPorResponsavel() {
  const result = await sendRequest('getComprasPorResponsavel');
  const responsaveisContainer = document.querySelector('.responsaveis-container');
  responsaveisContainer.innerHTML = '';

  if (result.status === 'error') {
    responsaveisContainer.innerHTML = `<p>${result.message}</p>`;
    return;
  }

  const responsaveis = ['Liana', 'Stefany', 'Mar√≠lia', 'Nosso ‚ù§Ô∏è'];

  responsaveis.forEach(responsavel => {
    const div = document.createElement('div');
    div.className = 'responsavel-item';

    const total = result[responsavel] ? parseFloat(result[responsavel].total).toFixed(2).replace('.', ',') : '0,00';
    div.innerHTML = `<h3>${responsavel}</h3><p>Total: R$ ${total}</p>`;

    const ul = document.createElement('ul');
    if (result[responsavel] && result[responsavel].compras.length > 0) {
      result[responsavel].compras.forEach(compra => {
        const li = document.createElement('li');
        li.className = compra.pago === 'Sim' ? 'item-pago' : '';
        // Usando compra.parcelas que j√° deve estar no formato "X/Y" do Apps Script
        li.innerHTML = `${compra.nome} (${compra.parcelas}) - R$ ${parseFloat(compra.valor).toFixed(2).replace('.', ',')} (${compra.cartao})
                            <input type="checkbox" class="item-paid-checkbox" data-id="${compra.originalId}" data-type="compra" ${compra.pago === 'Sim' ? 'checked' : ''} title="Marcar como pago"/>`;
        ul.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.textContent = 'Nenhuma compra.';
      ul.appendChild(li);
    }
    div.appendChild(ul);
    responsaveisContainer.appendChild(div);
  });
  addCheckboxListeners();
}

function addCheckboxListeners() {
  document.querySelectorAll('.item-paid-checkbox').forEach(checkbox => {
    checkbox.removeEventListener('change', handleItemPaidCheckboxChange);
    checkbox.addEventListener('change', handleItemPaidCheckboxChange);
  });
}

async function handleItemPaidCheckboxChange(event) {
  const checkbox = event.target;
  const itemId = checkbox.dataset.id;
  const itemType = checkbox.dataset.type;
  const isChecked = checkbox.checked;
  const statusPago = isChecked ? 'Sim' : 'N√£o';

  const action = itemType === 'compra' ? 'markCompraAsPaid' : 'markContaAsPaid';

  if (!confirm(`Tem certeza que deseja marcar este item como ${statusPago}?`)) {
    checkbox.checked = !isChecked;
    return;
  }

  const result = await sendRequest(action, { pago: statusPago }, itemId);
  if (result.status === 'success') {
    alert(`Item marcado como ${statusPago} com sucesso!`);
    fetchAndDisplayAllData();
  } else {
    alert('Erro ao atualizar item: ' + result.message);
    checkbox.checked = !isChecked;
  }
}

function getMonthName(monthNumber) {
  const date = new Date();
  date.setMonth(monthNumber - 1);
  return date.toLocaleString('pt-BR', { month: 'long' }).charAt(0).toUpperCase() + date.toLocaleString('pt-BR', { month: 'long' }).slice(1);
}
</script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Painel Financeiro</h1>
        <h2>Maio 2025</h2> <div class="nav-buttons">
          <button>&laquo; M√™s Anterior</button>
          <button>M√™s Seguinte &raquo;</button>
        </div>
      </header>
      
      <div class="totals-section">
        <div class="totals-wrapper">
          <span>Total de Receitas: R$ 0.00</span>
          <span>Total de Despesas: R$ 0.00</span>
        </div>
        <div class="saldo-bar-container">
          <div class="saldo-bar"></div>
          <div class="saldo-label">Saldo: R$ 0.00</div>
        </div>
      </div>
      
      <div class="categorias-section">
        <h2>Resumo do M√™s</h2>
        <div class="categorias-columns">
          <div class="categoria-box receitas">
            <h3>Receitas</h3>
            <div class="categoria-list" id="listaReceitas">
              <p>Carregando receitas...</p>
            </div>
            <button>Adicionar Receita</button>
          </div>
          
          <div class="categoria-box contas">
            <h3>Contas Fixas</h3>
            <div class="categoria-list" id="listaContasFixas">
              <p>Carregando contas fixas...</p>
            </div>
            <div class="conta-total" id="totalContasFixas">Total: R$ 0.00</div>
          </div>
          
          <div class="categoria-box contas">
            <h3>Contas Vari√°veis</h3>
            <div class="categoria-list" id="listaContasVariaveis">
              <p>Carregando contas vari√°veis...</p>
            </div>
            <div class="conta-total" id="totalContasVariaveis">Total: R$ 0.00</div>
          </div>
        </div>
      </div>
      
      <div class="cartoes-section" id="cartoesSection">
        <h2>Cart√µes</h2>
        <div class="cartoes-columns">
          <div class="cartao-box" id="nubankCard">
            <h3>
              NUBANK
              <input type="checkbox" class="cartao-paid" title="Marcar todas como pagas"/>
            </h3>
            <div class="cartao-total">Total: R$ 0.00</div>
            <div class="cartao-list">
              <p>Carregando compras...</p>
            </div>
          </div>
          <div class="cartao-box" id="santanderCard">
            <h3>
              SANTANDER
              <input type="checkbox" class="cartao-paid" title="Marcar todas como pagas"/>
            </h3>
            <div class="cartao-total">Total: R$ 0.00</div>
            <div class="cartao-list">
              <p>Carregando compras...</p>
            </div>
          </div>
          <div class="cartao-box" id="mpagoCard">
            <h3>
              M.PAGO
              <input type="checkbox" class="cartao-paid" title="Marcar todas como pagas"/>
            </h3>
            <div class="cartao-total">Total: R$ 0.00</div>
            <div class="cartao-list">
              <p>Carregando compras...</p>
            </div>
          </div>
          <div class="cartao-box" id="amazonCard">
            <h3>
              AMAZON
              <input type="checkbox" class="cartao-paid" title="Marcar todas como pagas"/>
            </h3>
            <div class="cartao-total">Total: R$ 0.00</div>
            <div class="cartao-list">
              <p>Carregando compras...</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="forms-container">
        <div class="form-section" id="formAdicionarCompra">
          <h2>Adicionar Compra no Cart√£o</h2>
          <div class="row">
            <select id="respCompra">
              <option value="Liana">Liana</option>
              <option value="Stefany">Stefany</option>
              <option value="Mar√≠lia">Mar√≠lia</option>
              <option value="Nosso ‚ù§Ô∏è">Nosso ‚ù§Ô∏è</option>
            </select>
            <select id="cartaoCompra">
              <option value="Nubank">NUBANK</option>
              <option value="Santander">SANTANDER</option>
              <option value="Mercado Pago">M.PAGO</option>
              <option value="Amazon">AMAZON</option>
            </select>
          </div>
          <div class="row">
            <input type="text" placeholder="Nome da Compra" />
          </div>
          <div class="row">
            <input type="number" placeholder="Valor" />
            <input type="text" placeholder="Parcelas (ex: 2/6)" />
          </div>
          <button>Adicionar Compra no Cart√£o</button>
          </div>
        
        <div class="form-section" id="formAdicionarConta">
          <h2>Adicionar Conta</h2>
          <select id="tipoConta">
            <option value="Fixa">Fixa</option>
            <option value="Vari√°vel">Vari√°vel</option>
          </select>
          <input type="text" placeholder="Nome da Conta" />
          <input type="text" placeholder="Parcelas (ex: 2/3)" />
          <input type="number" placeholder="Valor" />
          <button>Adicionar Conta</button>
          </div>
      </div>
      
      <div class="compras-responsaveis">
        <h2>Total de Compras por Respons√°vel</h2>
        <div class="responsaveis-container">
          <p>Carregando totais por respons√°vel...</p>
        </div>
      </div>
      
      <footer>
        <p>
          <span class="liana">Liana</span>,
          <span class="stefany">Stefany</span>,
          <span class="marilia">Mar√≠lia</span>,
          <span class="nosso">Nosso ‚ù§Ô∏è</span>
        </p>
      </footer>
    </div>
  </body>
</html>
