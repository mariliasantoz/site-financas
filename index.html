<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
        <link rel="icon" type="image/png" href="favicon.png">

    <style>
      /* CONFIGURAÇÃO GERAL */
      body {
        font-family: Arial, sans-serif; /* [116] */
        background-color: #f2f2f2; /* [116] */
        margin: 0;
        padding: 20px;
        color: black; /* Texto padrão em preto */
      }
      .container {
        max-width: 1200px; /* [117] */
        margin: auto; /* [117] */
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      /* .form-sections-wrapper, */ /* Removido daqui para não ser uma caixa azul */
      .form-section, /* Aplicar a cada form individual - AGORA SERÁ UMA CAIXA AZUL */ /* [118] */
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box,
      .cartao-box {
        background-color: #e3f2fd; /* [118] */
        border: 1px solid #90caf9; /* [118] */
        border-radius: 5px;
        margin-bottom: 20px; /* Espaçamento entre seções */ /* [118] */
        padding: 15px; /* [119] */
      }

      /* BOTÕES */
      button {
        background-color: #4caf50; /* [120] */
        color: #fff; /* [120] */
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease; /* [121] */
      }
      button:hover {
        background-color: #45a049; /* [122] */
      }
      button.delete-button {
        background-color: #f44336; /* [123] */
        margin-left: 5px; /* [123] */
      }
      button.delete-button:hover {
        background-color: #da190b; /* [124] */
      }
      button.edit-button {
        background-color: #ff9800; /* [125] */
        margin-left: 5px; /* [125] */
      }
      button.edit-button:hover {
        background-color: #e68a00; /* [126] */
      }

      /* CABEÇALHO */
      header {
        text-align: center; /* [127] */
        margin-bottom: 20px; /* [127] */
        position: relative;
      }
      header h1 {
        color: #333; /* [128] */
        margin-bottom: 10px; /* [128] */
      }
      header h2 {
        color: #555; /* [129] */
        margin-top: 0; /* [129] */
        display: block; /* Corrigido: para que o h2 ocupe sua própria linha */
        position: relative; /* [130] */
        padding: 0; /* Corrigido: remover padding horizontal */
        z-index: 10; /* Corrigido: garantir que o nome do mês fique acima dos botões */
      }
      .nav-buttons {
          position: relative; /* Corrigido: para que os botões fiquem abaixo do h2 */
          top: auto; /* Corrigido */
          transform: none; /* Corrigido */
          width: 100%;
          display: flex;
          justify-content: space-between;
          padding: 0 20px;
          box-sizing: border-box; /* [132] */
          left: 0; /* [133] */
          z-index: 1; /* Corrigido: garantir que os botões fiquem atrás do nome do mês */
      }
      .nav-buttons button {
          background-color: #007bff; /* [134] */
          color: white; /* [134] */
          padding: 5px 10px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 1em; /* [135] */
      }
      .nav-buttons button:hover {
          background-color: #0056b3; /* [136] */
      }

      /* SEÇÃO DE TOTAIS */
      .totals-section {
        /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .totals-wrapper {
        display: flex; /* [139] */
        justify-content: space-around; /* [139] */
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
      }
      .saldo-bar-container {
        background-color: white; /* Corrigido: termômetro branco */
        border: 1px solid #ddd; /* Corrigido: borda sutil */
        border-radius: 5px; /* [140] */
        height: 25px;
        margin-top: 10px;
        overflow: hidden; /* [141] */
        position: relative; /* [141] */
      }
      .saldo-bar {
        height: 100%;
        width: 0%; /* [142] */
        background-color: green; /* Cor padrão inicial, será ajustada via JS */ /* [143] */
        border-radius: 5px; /* [144] */
        transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; /* [144] */
      }
      .saldo-label {
        position: absolute; /* [146] */
        top: 0; /* [146] */
        left: 0; /* [146] */
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: red; /* Corrigido: fonte vermelha */
        font-weight: bold; /* [147] */
        text-shadow: none; /* Corrigido: removido shadow para melhor contraste */
        font-size: 0.9em;
        border: 1px solid red; /* Corrigido: borda vermelha */
        border-radius: 5px;
        box-sizing: border-box;
      }

      /* SEÇÃO DE CATEGORIAS (Receitas, Contas Fixas, Variáveis) */
      .categorias-section {
         /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .categorias-columns {
        display: grid; /* [150] */
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* [150] */
        gap: 20px;
      }
      .categoria-box {
        text-align: center;
        display: flex; /* [152] */
        flex-direction: column; /* [152] */
         /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .categoria-box h3 {
        margin-top: 0;
        color: #333; /* [153] */
      }
      .categoria-list {
        text-align: left;
        margin-bottom: 10px; /* [154] */
        flex-grow: 1; /* [154] */
        min-height: 50px; /* [155] */
      }
      .categoria-list p {
        margin: 5px 0; /* [156] */
        color: #555; /* [156] */
      }
      .list-item {
        display: flex; /* [157] */
        justify-content: space-between; /* [157] */
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px dashed #c0c0c0; /* [158] */
      }
      .list-item:last-child {
        border-bottom: none; /* [159] */
      }
      .list-item span {
        flex-grow: 1;
        text-align: left; /* [160] */
        margin-right: 10px; /* [160] */
      }
      .list-item-controls {
          display: flex; /* [161] */
          justify-content: flex-end; /* [161] */
          align-items: center;
          flex-shrink: 0;
      }
      .list-item-controls button {
          margin-left: 5px; /* [162] */
          padding: 4px 8px; /* [162] */
          font-size: 0.8em;
      }
      .list-item-controls input[type="checkbox"] {
          margin-left: 5px; /* [163] */
          width: 16px; /* [163] */
          height: 16px; /* [163] */
      }
      .categoria-box .total-categoria {
        font-weight: bold; /* [164] */
        margin-top: 10px; /* [164] */
        padding-top: 10px;
        border-top: 1px solid #c0c0c0;
        display: flex; /* [165] */
        justify-content: space-between; /* [165] */
        align-items: center; /* [165] */
      }
      .total-categoria .checkbox-pago-total {
          margin-left: 10px; /* [166] */
          width: 20px; /* [166] */
          height: 20px; /* [167] */
          cursor: pointer; /* [167] */
      }

      /* SEÇÃO DE CARTÕES */
      .cartoes-section {
        /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .cartoes-grid {
        display: grid; /* [170] */
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* [171] */
        gap: 20px; /* [171] */
      }
      .cartao-box {
        text-align: center;
        display: flex;
        flex-direction: column;
        /* Herda padding, margin-bottom, border e background da regra geral de caixas,
           mas cores específicas abaixo podem sobrescrever o background/border. */
      }
      .cartao-box.nubank { background-color: #f3e5f5; border: 1px solid #ce93d8; } /* [173] */
      .cartao-box.santander { background-color: #ffebee; border: 1px solid #ef9a9a; } /* [174] */
      .cartao-box.mercadopago { background-color: #e3f2fd; border: 1px solid #90caf9; } /* [175] */
      .cartao-box.amazon { background-color: #fff3e0; border: 1px solid #ffcc80; } /* [176] */
      .cartao-box h3 {
        margin-top: 0;
        color: #333; /* [177] */
      }
      .cartao-list {
        text-align: left;
        margin-bottom: 10px; /* [178] */
        flex-grow: 1; /* [178] */
        min-height: 50px;
      }
      .cartao-list p {
        margin: 5px 0; /* [179] */
        color: #555; /* [179] */
      }
      .cartao-box .total-cartao {
        font-weight: bold; /* [180] */
        margin-top: 10px; /* [180] */
        padding-top: 10px;
        border-top: 1px solid #a7d9f7;
        display: flex; /* [181] */
        justify-content: space-between; /* [181] */
        align-items: center; /* [181] */
      }
      .cartao-box .total-cartao .checkbox-pago-total {
          margin-left: 10px; /* [182] */
          width: 20px; /* [182] */
          height: 20px; /* [182] */
          cursor: pointer;
      }
      .compra {
        display: flex; /* [183] */
        justify-content: space-between; /* [183] */
        align-items: center;
        padding: 5px;
        border-bottom: 1px dashed #c0c0c0;
        border-radius: 3px; /* [184] */
        margin-bottom: 3px; /* [185] */
      }
      .compra:last-child {
        border-bottom: none; /* [186] */
      }
      .compra .list-item-content {
          flex-grow: 1; /* [187] */
          display: flex; /* [187] */
          justify-content: space-between;
          align-items: center;
          margin-right: 5px;
      }
      .compra .list-item-content span {
          flex-grow: 1; /* [188] */
          text-align: left; /* [188] */
          font-size: 0.9em;
      }
      .compra .list-item-controls {
          flex-shrink: 0; /* [189] */
      }

      /* SEÇÃO DE FORMULÁRIOS */
      .form-sections-wrapper { /* Agora é apenas um container flexível */
        display: flex; /* [190] */
        gap: 20px; /* [190] */
        margin-bottom: 20px; /* Para espaçar do próximo elemento */
      }
      .form-section { /* Cada form agora é uma caixa azul */
        flex: 1; /* [191] */
        text-align: center; /* [191] */
        /* background-color, border, padding, border-radius, margin-bottom
           são herdados da regra geral de caixas no início do <style> */
      }
      .form-section h2 {
        margin-top: 0;
        margin-bottom: 15px; /* [193] */
        color: #333; /* [193] */
      }
      .form-section label { 
        display: block; /* [194] */
        margin-bottom: 5px; /* [194] */
        text-align: left;
        font-weight: bold;
        font-size: 0.9em;
      }
      .form-section input[type="text"],
      .form-section input[type="number"],
      .form-section select {
        width: 100%; /* [195] */
        padding: 8px; /* [195] */
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box; /* [196] */
      }
      .form-section .row {
        display: flex;
        gap: 10px; /* [197] */
        margin-bottom: 10px; /* [197] */
        align-items: center; 
      }
      .form-section .row input,
      .form-section .row select {
        flex-grow: 1; /* [198] */
        margin-bottom: 0; /* [198] */
      }
      .form-section button {
        width: 100%; /* [199] */
        margin-top: 10px; /* [199] */
      }

      /* SEÇÃO DE COMPRAS POR RESPONSÁVEL */
      .compras-responsaveis {
        text-align: center; /* [200] */
         /* Herda padding e margin-bottom da regra geral de caixas */
      }
      .compras-responsaveis h2 {
        margin-top: 0;
        color: #333; /* [201] */
      }
      .responsaveis-container {
        display: grid; /* [202] */
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* [202] */
        gap: 20px;
        margin-top: 15px;
      }
      .responsavel-box {
        text-align: center; /* [203] */
        /* Herda padding, margin-bottom, border e background da regra geral de caixas */
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em; /* [204] */
        padding: 5px; /* [204] */
        border-radius: 3px;
        display: inline-block; /* [204] */
      }
      .responsavel-box p.total-responsavel {
        margin: 10px 0 5px 0; /* [205] */
        font-size: 1em; /* [205] */
        font-weight: bold;
        border-top: 1px solid #ccc; /* [206] */
        padding-top: 10px; /* [206] */
      }
      .responsavel-list {
          text-align: left; /* [207] */
          font-size: 0.9em; /* [207] */
          max-height: 150px; /* [208] */
          overflow-y: auto; /* [208] */
          padding-right: 5px; /* [208] */
          margin-top: 10px; /* [208] */
      }
       .responsavel-list .compra-item {
          display: flex; /* [209] */
          justify-content: space-between; /* [209] */
          padding: 3px 0;
          border-bottom: 1px dotted #eee;
       }
       .responsavel-list .compra-item:last-child {
           border-bottom: none; /* [210] */
       }
       .responsavel-list .compra-nome {
           flex-grow: 1; /* [211] */
           margin-right: 10px; /* [211] */
           white-space: nowrap;
           overflow: hidden;
           text-overflow: ellipsis;
       }
       .responsavel-list .compra-detalhes {
           flex-shrink: 0; /* [212] */
           white-space: nowrap; /* [212] */
       }

      /* Cores para Responsáveis */
      .responsavel-liana { background-color: #add8e6; } /* [213] */
      .responsavel-stefany { background-color: #ffb347; } /* [214] */
      .responsavel-marilia { background-color: #dda0dd; }
      .responsavel-nosso { background-color: #ffc0cb; } /* [215] */

      /* Cores para background de itens de compra */
      .compra-bg-liana { background-color: rgba(173, 216, 230, 0.3); } /* [216] */
      .compra-bg-stefany { background-color: rgba(255, 179, 71, 0.3); } /* [217] */
      .compra-bg-marilia { background-color: rgba(106, 90, 205, 0.4); } /* [218] */
      .compra-bg-nosso { background-color: rgba(255, 192, 203, 0.3); } /* [219] */

      /* RODAPÉ */
      footer {
        text-align: center; /* [220] */
        margin-top: 20px; /* [220] */
        padding-top: 20px;
        border-top: 1px solid #ccc;
      }
      footer p span {
        margin: 0 5px; /* [221] */
        font-weight: bold; /* [221] */
        padding: 4px 8px;
        border-radius: 3px;
      }
      footer .liana { background-color: #add8e6; } /* [222] */
      footer .stefany { background-color: #ffb347; } /* [223] */
      footer .marilia { background-color: #dda0dd; } /* [224] */
      footer .nosso { background-color: #ffc0cb; } /* [225] */

      /* Estilo para item pago */
      .item-pago {
          text-decoration: line-through; /* [226] */
          color: grey; /* [226] */
          opacity: 0.7;
      }

      /* Modal Styles */
      .modal {
          display: none; /* [227] */
          position: fixed;  /* [227] */
          z-index: 1000; 
          left: 0;
          top: 0;
          width: 100%; 
          height: 100%; 
          overflow: auto; 
          background-color: rgba(0,0,0,0.4); /* [228] */
      }
      .modal-content {
          background-color: #fefefe; /* [229] */
          margin: 15% auto;  /* [229] */
          padding: 20px;
          border: 1px solid #888;
          width: 80%; 
          max-width: 500px;
          border-radius: 8px;
          position: relative; /* [230] */
      }
      .close-button {
          color: #aaa; /* [231] */
          position: absolute; /* [231] */
          top: 10px;
          right: 10px;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
      }
      .close-button:hover,
      .close-button:focus {
          color: black;
          text-decoration: none;
          cursor: pointer;
      }
      .modal h2 {
          margin-top: 0;
          margin-bottom: 15px;
          color: #333;
      }
      .modal label {
          display: block; /* [235] */
          margin-bottom: 5px; /* [235] */
      }
      .modal input[type="text"],
      .modal input[type="number"],
      .modal select {
          width: 100%; /* [236] */
          padding: 8px; /* [236] */
          margin-bottom: 10px;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-sizing: border-box; /* [237] */
      }
      .modal button {
          width: 100%; /* [238] */
          margin-top: 10px; /* [238] */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Painel Financeiro Familiar</h1>
        <div class="nav-buttons">
          <br>
            <br>
            <button onclick="changeMonth(-1)">Mês Anterior</button>
            <h2 id="currentMonthYear"></h2>
            <button onclick="changeMonth(1)">Próximo Mês</button>
        </div>
      </header>

      <section class="totals-section">
        <div class="totals-wrapper">
          <div>Receitas: <span id="totalReceitas">R$ 0,00</span></div>
          <div>Despesas: <span id="totalDespesasMes">R$ 0,00</span></div>
          <div>Pago: <span id="totalPago">R$ 0,00</span></div>
          <div>A Pagar: <span id="totalAPagar">R$ 0,00</span></div>
        </div>
        <div class="saldo-bar-container">
          <div class="saldo-bar" id="saldoBar"></div>
          <div class="saldo-label" id="saldoLabel">Saldo: R$ 0,00</div>
        </div>
      </section>

      <section class="categorias-section">
        <h2>Resumo Mensal</h2>
        <div class="categorias-columns">
          <div class="categoria-box">
            <h3>Receitas</h3>
            <div id="receitasList" class="categoria-list"></div>
            <div class="total-categoria">
              <span>Total Receitas:</span>
              <span id="totalReceitasCategoria">R$ 0,00</span>
            </div>
          </div>
          <div class="categoria-box">
            <h3>Contas Fixas</h3>
            <div id="contasFixasList" class="categoria-list"></div>
            <div class="total-categoria">
              <span>Total Contas Fixas:</span>
              <span id="totalContasFixasCategoria">R$ 0,00</span>
              <input type="checkbox" id="markAllContasFixasPaid" class="checkbox-pago-total">
            </div>
          </div>
          <div class="categoria-box">
            <h3>Contas Variáveis</h3>
            <div id="contasVariaveisList" class="categoria-list"></div>
            <div class="total-categoria">
              <span>Total Contas Variáveis:</span>
              <span id="totalContasVariaveisCategoria">R$ 0,00</span>
              <input type="checkbox" id="markAllContasVariaveisPaid" class="checkbox-pago-total">
            </div>
          </div>
        </div>
      </section>

      <section class="cartoes-section">
        <h2>Compras por Cartão</h2>
        <div class="cartoes-grid" id="cartoesGrid"></div>
      </section>

      <section class="form-sections-wrapper">
        <div class="form-section">
          <h2>Adicionar Receita</h2>
          <form id="addReceitaForm">
            <label for="receitaNome">Nome:</label>
            <input type="text" id="receitaNome" required />
            <label for="receitaValor">Valor:</label>
            <input type="number" id="receitaValor" step="0.01" required />
            <button type="submit">Adicionar Receita</button>
          </form>
        </div>

        <div class="form-section">
          <h2>Adicionar Compra (Cartão)</h2>
          <form id="addCompraForm">
            <label for="compraNome">Nome:</label>
            <input type="text" id="compraNome" required />
            <label for="compraValor">Valor:</label>
            <input type="number" id="compraValor" step="0.01" required />
            <div class="row">
              <label for="compraParcelas">Parcelas:</label>
              <input type="number" id="compraParcelas" value="1" min="1" required />
              <label for="compraCartao">Cartão:</label>
              <select id="compraCartao" required>
                <option value="Nubank">Nubank</option>
                <option value="Santander">Santander</option>
                <option value="Mercado Pago">Mercado Pago</option>
                <option value="Amazon">Amazon</option>
                <option value="Outro">Outro</option>
              </select>
            </div>
            <label for="compraResponsavel">Responsável:</label>
            <select id="compraResponsavel" required>
              <option value="Liana">Liana</option>
              <option value="Stefany">Stefany</option>
              <option value="Marília">Marília</option>
              <option value="Nosso ❤️">Nosso ❤️</option>
            </select>
            <button type="submit">Adicionar Compra</button>
          </form>
        </div>

        <div class="form-section">
          <h2>Adicionar Conta (Fixa/Variável)</h2>
          <form id="addContaForm">
            <label for="contaTipo">Tipo:</label>
            <select id="contaTipo" required>
              <option value="Fixa">Fixa</option>
              <option value="Variável">Variável</option>
            </select>
            <label for="contaNome">Nome:</label>
            <input type="text" id="contaNome" required />
            <label for="contaValor">Valor:</label>
            <input type="number" id="contaValor" step="0.01" required />
            <label for="contaParcelas">Parcelas:</label>
            <input type="number" id="contaParcelas" value="1" min="1" required />
            <button type="submit">Adicionar Conta</button>
          </form>
        </div>
      </section>

      <section class="compras-responsaveis">
        <h2>Compras por Responsável</h2>
        <div class="responsaveis-container" id="responsaveisContainer"></div>
      </section>

      <footer>
        <p>Desenvolvido com ❤️ por <span class="liana">Liana</span>, <span class="stefany">Stefany</span>, <span class="marilia">Marília</span> e <span class="nosso">Nosso ❤️</span></p>
      </footer>
    </div>

    <!-- Modais de Edição -->
    <div id="editReceitaModal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Editar Receita</h2>
        <form id="editReceitaForm">
          <input type="hidden" id="editReceitaId">
          <label for="editReceitaNome">Nome:</label>
          <input type="text" id="editReceitaNome" required>
          <label for="editReceitaValor">Valor:</label>
          <input type="number" id="editReceitaValor" step="0.01" required>
          <button type="submit">Salvar Alterações</button>
        </form>
      </div>
    </div>

    <div id="editCompraModal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Editar Compra</h2>
        <form id="editCompraForm">
          <input type="hidden" id="editCompraId">
          <label for="editCompraNome">Nome:</label>
          <input type="text" id="editCompraNome" required>
          <label for="editCompraValor">Valor:</label>
          <input type="number" id="editCompraValor" step="0.01" required>
          <label for="editCompraParcelas">Parcelas:</label>
          <input type="text" id="editCompraParcelas" required>
          <label for="editCompraCartao">Cartão:</label>
          <select id="editCompraCartao" required>
            <option value="Nubank">Nubank</option>
            <option value="Santander">Santander</option>
            <option value="Mercado Pago">Mercado Pago</option>
            <option value="Amazon">Amazon</option>
            <option value="Outro">Outro</option>
          </select>
          <label for="editCompraResponsavel">Responsável:</label>
          <select id="editCompraResponsavel" required>
            <option value="Liana">Liana</option>
            <option value="Stefany">Stefany</option>
            <option value="Marília">Marília</option>
            <option value="Nosso ❤️">Nosso ❤️</option>
          </select>
          <button type="submit">Salvar Alterações</button>
        </form>
      </div>
    </div>

    <div id="editContaModal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Editar Conta</h2>
        <form id="editContaForm">
          <input type="hidden" id="editContaId">
          <label for="editContaTipo">Tipo:</label>
          <select id="editContaTipo" required>
            <option value="Fixa">Fixa</option>
            <option value="Variável">Variável</option>
          </select>
          <label for="editContaNome">Nome:</label>
          <input type="text" id="editContaNome" required>
          <label for="editContaValor">Valor:</label>
          <input type="number" id="editContaValor" step="0.01" required>
          <label for="editContaParcelas">Parcelas:</label>
          <input type="number" id="editContaParcelas" required>
          <button type="submit">Salvar Alterações</button>
        </form>
      </div>
    </div>

    <script>
      // URL do seu Cloudflare Worker
      const WORKER_URL = 'https://painel-financas-proxy.mariliaedua.workers.dev/'; // Substitua pela URL do seu Worker

      // Inicializa com o mês e ano atuais do calendário brasileiro.
      // Se o site estiver sempre mostrando Junho, verifi      // Inicializa com o mês e ano atuais do calendário brasileiro.
      // Se o site estiver sempre mostrando Junho, verifique o cache do navegador ou a data/hora do sistema.
      let currentMonth = new Date().getMonth() + 1; // Mês atual (1-12)
      let currentYear = new Date().getFullYear(); // Ano atual
      document.addEventListener('DOMContentLoaded', () => {
        console.log(`Site carregado. Mês inicial: ${currentMonth}, Ano inicial: ${currentYear}`);
        updateMonthYearDisplay();
        fetchData();
      });

      async function sendRequest(action, data = {}, recordId = null) {
        const payload = { action, data, recordId, month: currentMonth, year: currentYear };
        console.log('Enviando payload:', payload);
        try {
          const response = await fetch(WORKER_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          });
          const result = await response.json();
          console.log('Resposta do Worker:', result);
          if (result.status === 'error') {
            alert('Erro: ' + result.message);
          }
          return result;
        } catch (error) {
          console.error('Erro ao enviar requisição:', error);
          alert('Erro de comunicação com o servidor. Verifique sua conexão ou tente novamente mais tarde.');
          return { status: 'error', message: error.message };
        }
      }

      function updateMonthYearDisplay() {
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        document.getElementById('currentMonthYear').textContent = `${monthNames[currentMonth - 1]} de ${currentYear}`;
      }

      function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth > 12) {
          currentMonth = 1;
          currentYear++;
        } else if (currentMonth < 1) {
          currentMonth = 12;
          currentYear--;
        }
        updateMonthYearDisplay();
        fetchData();
      }

      async function fetchData() {
        console.log(`Buscando dados para ${currentMonth}/${currentYear}`);
        const [receitasRes, comprasRes, contasRes, totaisRes] = await Promise.all([
          sendRequest('getReceitas'),
          sendRequest('getCompras'),
          sendRequest('getContas'),
          sendRequest('getTotais')
        ]);

        displayReceitas(receitasRes.data || []);
        displayContas(contasRes.data || []);
        displayCompras(comprasRes.data || []);
        updateTotals(totaisRes.data || {});
        displayComprasPorResponsavel(comprasRes.data || []);
      }

      function formatCurrency(value) {
        return parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      function displayReceitas(receitas) {
        const receitasList = document.getElementById('receitasList');
        receitasList.innerHTML = '';
        let totalReceitas = 0;
        receitas.forEach(receita => {
          totalReceitas += parseFloat(receita.valor || 0);
          const listItem = document.createElement('div');
          listItem.classList.add('list-item');
          listItem.innerHTML = `
            <span>${receita.nome} - ${formatCurrency(receita.valor)}</span>
            <div class="list-item-controls">
              <button class="edit-button" onclick="openEditReceitaModal('${receita.id}', '${receita.nome}', ${receita.valor})">Editar</button>
              <button class="delete-button" onclick="deleteRecord('Receita', '${receita.id}')">Excluir</button>
            </div>
          `;
          receitasList.appendChild(listItem);
        });
        document.getElementById('totalReceitasCategoria').textContent = formatCurrency(totalReceitas);
      }

      function displayContas(contas) {
        const contasFixasList = document.getElementById('contasFixasList');
        const contasVariaveisList = document.getElementById('contasVariaveisList');
        contasFixasList.innerHTML = '';
        contasVariaveisList.innerHTML = '';
        let totalContasFixas = 0;
        let totalContasVariaveis = 0;
        let allFixasPaid = true;
        let allVariaveisPaid = true;

        contas.forEach(conta => {
          const isPaid = String(conta.pago).toLowerCase() === 'sim';
          const listItem = document.createElement('div');
          listItem.classList.add('list-item');
          if (isPaid) listItem.classList.add('item-pago');

          listItem.innerHTML = `
            <span>${conta.nome} (${conta.parcelas}) - ${formatCurrency(conta.valor)}</span>
            <div class="list-item-controls">
              <button class="edit-button" onclick="openEditContaModal('${conta.originalId || conta.id}', '${conta.tipo}', '${conta.nome}', ${conta.valor}, '${conta.parcelas}')">Editar</button>
              <button class="delete-button" onclick="deleteRecord('Conta', '${conta.originalId || conta.id}')">Excluir</button>
              <input type="checkbox" data-id="${conta.id}" data-original-id="${conta.originalId || conta.id}" data-sheet="Contas" ${isPaid ? 'checked' : ''} onchange="markAsPaid(this)">
            </div>
          `;

          if (conta.tipo === 'Fixa') {
            contasFixasList.appendChild(listItem);
            totalContasFixas += parseFloat(conta.valor || 0);
            if (!isPaid) allFixasPaid = false;
          } else {
            contasVariaveisList.appendChild(listItem);
            totalContasVariaveis += parseFloat(conta.valor || 0);
            if (!isPaid) allVariaveisPaid = false;
          }
        });

        document.getElementById('totalContasFixasCategoria').textContent = formatCurrency(totalContasFixas);
        document.getElementById('totalContasVariaveisCategoria').textContent = formatCurrency(totalContasVariaveis);
        document.getElementById('markAllContasFixasPaid').checked = allFixasPaid && contasFixasList.children.length > 0;
        document.getElementById('markAllContasVariaveisPaid').checked = allVariaveisPaid && contasVariaveisList.children.length > 0;

        // Adicionar event listeners para os checkboxes totais de Contas
        document.getElementById('markAllContasFixasPaid').onchange = function() {
          markAllContasAsPaid('Fixa', this.checked);
        };
        document.getElementById('markAllContasVariaveisPaid').onchange = function() {
          markAllContasAsPaid('Variável', this.checked);
        };
      }

      async function markAllContasAsPaid(tipoConta, isChecked) {
        const status = isChecked ? 'Sim' : 'Não';
        const contas = await sendRequest('getContas');
        if (!contas.data) return;
        
        const contasFiltradas = contas.data.filter(conta => conta.tipo === tipoConta);
        
        for (const conta of contasFiltradas) {
          if ((String(conta.pago).toLowerCase() === 'sim' && !isChecked) || (String(conta.pago).toLowerCase() === 'não' && isChecked)) {
            // Somente atualiza se o status for diferente
            const result = await sendRequest('markContaAsPaid', { pago: status }, conta.originalId || conta.id);
            if (result.status !== 'success') {
              alert(`Falha ao atualizar ${conta.nome}.`);
              // Se uma falha, reverter o checkbox mestre e parar
              if (tipoConta === 'Fixa') {
                document.getElementById('markAllContasFixasPaid').checked = !isChecked;
              } else {
                document.getElementById('markAllContasVariaveisPaid').checked = !isChecked;
              }
              fetchData(); // Re-fetch para sincronizar
              return;
            }
          }
        }
        fetchData(); // Re-fetch após todas as atualizações
      }

      function displayCompras(compras) {
        const cartoesGrid = document.getElementById('cartoesGrid');
        cartoesGrid.innerHTML = '';

        const comprasPorCartao = {};
        compras.forEach(compra => {
          const cartao = compra.cartao || 'Outro';
          if (!comprasPorCartao[cartao]) {
            comprasPorCartao[cartao] = { total: 0, compras: [] };
          }
          comprasPorCartao[cartao].total += parseFloat(compra.valor || 0);
          comprasPorCartao[cartao].compras.push(compra);
        });

        // Garantir que todos os cartões padrão apareçam, mesmo que sem compras
        const cartoesPadrao = ['Nubank', 'Santander', 'Mercado Pago', 'Amazon', 'Outro'];
        cartoesPadrao.forEach(cartao => {
          if (!comprasPorCartao[cartao]) {
            comprasPorCartao[cartao] = { total: 0, compras: [] };
          }
        });

        for (const cartao in comprasPorCartao) {
          const cartaoData = comprasPorCartao[cartao];
          const cartaoBox = document.createElement('div');
          cartaoBox.classList.add('cartao-box');
          cartaoBox.classList.add(cartao.toLowerCase().replace(/\s/g, '')); // Adiciona classe para estilo

          let allComprasPaid = true;
          if (cartaoData.compras.length === 0) {
            allComprasPaid = false; // Se não há compras, o checkbox mestre não deve ser marcado
          } else {
            for (const compra of cartaoData.compras) {
              if (String(compra.pago).toLowerCase() !== 'sim') {
                allComprasPaid = false;
                break;
              }
            }
          }

          const comprasListHtml = cartaoData.compras.map(compra => {
            const isPaid = String(compra.pago).toLowerCase() === 'sim';
            return `
              <div class="compra ${isPaid ? 'item-pago' : ''}">
                <div class="list-item-content">
                  <span>${compra.nome} (${compra.parcelas})</span>
                  <span>${formatCurrency(compra.valor)}</span>
                </div>
                <div class="list-item-controls">
                  <button class="edit-button" onclick="openEditCompraModal('${compra.originalId || compra.id}', '${compra.nome}', ${compra.valor}, '${compra.parcelas}', '${compra.cartao}', '${compra.responsavel}')">Editar</button>
                  <button class="delete-button" onclick="deleteRecord('Compra', '${compra.originalId || compra.id}')">Excluir</button>
                  <input type="checkbox" data-id="${compra.id}" data-original-id="${compra.originalId || compra.id}" data-sheet="Compras" ${isPaid ? 'checked' : ''} onchange="markAsPaid(this)">
                </div>
              </div>
            `;
          }).join('');

          cartaoBox.innerHTML = `
            <h3>${cartao}</h3>
            <div class="cartao-list">${comprasListHtml}</div>
            <div class="total-cartao">
              <span>Total ${cartao}:</span>
              <span>${formatCurrency(cartaoData.total)}</span>
              <input type="checkbox" id="markAll${cartao.replace(/\s/g, '')}Paid" class="checkbox-pago-total" ${allComprasPaid ? 'checked' : ''}>
            </div>
          `;
          cartoesGrid.appendChild(cartaoBox);

          // Adicionar event listener para o checkbox total do cartão
          document.getElementById(`markAll${cartao.replace(/\s/g, '')}Paid`).onchange = function() {
            markAllComprasAsPaid(cartao, this.checked);
          };
        }
      }

      async function markAllComprasAsPaid(cartao, isChecked) {
        const status = isChecked ? 'Sim' : 'Não';
        const result = await sendRequest('markCartaoAsPaid', { cartao: cartao, pago: status });
        if (result.status === 'success') {
          fetchData(); // Re-fetch para atualizar a UI
        } else {
          alert('Falha ao atualizar o status de pagamento do cartão.');
          // Reverter o checkbox mestre se a atualização falhar
          document.getElementById(`markAll${cartao.replace(/\s/g, '')}Paid`).checked = !isChecked;
        }
      }

      function displayComprasPorResponsavel(compras) {
        const responsaveisContainer = document.getElementById('responsaveisContainer');
        responsaveisContainer.innerHTML = '';

        const comprasPorResponsavel = {};
        const responsaveisPadrao = ['Liana', 'Stefany', 'Marília', 'Nosso ❤️'];

        // Inicializar com responsáveis padrão
        responsaveisPadrao.forEach(resp => {
          comprasPorResponsavel[resp] = { total: 0, compras: [] };
        });

        // Preencher com dados existentes
        compras.forEach(compra => {
          const responsavel = compra.responsavel || 'Outro';
          if (!comprasPorResponsavel[responsavel]) {
            comprasPorResponsavel[responsavel] = { total: 0, compras: [] };
          }
          comprasPorResponsavel[responsavel].total += parseFloat(compra.valor || 0);
          comprasPorResponsavel[responsavel].compras.push(compra);
        });

        for (const responsavel in comprasPorResponsavel) {
          const responsavelData = comprasPorResponsavel[responsavel];
          const responsavelBox = document.createElement('div');
          responsavelBox.classList.add('responsavel-box');
          responsavelBox.classList.add(`responsavel-${responsavel.toLowerCase().replace(/\s|❤️/g, '')}`);

          const comprasListHtml = responsavelData.compras.map(compra => {
            const isPaid = String(compra.pago).toLowerCase() === 'sim';
            return `
              <div class="compra-item ${isPaid ? 'item-pago' : ''} compra-bg-${responsavel.toLowerCase().replace(/\s|❤️/g, '')}">
                <span class="compra-nome">${compra.nome}</span>
                <span class="compra-detalhes">${formatCurrency(compra.valor)} (${compra.parcelas})</span>
              </div>
            `;
          }).join('');

          responsavelBox.innerHTML = `
            <h3 class="responsavel-${responsavel.toLowerCase().replace(/\s|❤️/g, '')}">${responsavel}</h3>
            <div class="responsavel-list">${comprasListHtml}</div>
            <p class="total-responsavel">Total: ${formatCurrency(responsavelData.total)}</p>
          `;
          responsaveisContainer.appendChild(responsavelBox);
        }
      }

      function updateTotals(totals) {
        document.getElementById('totalReceitas').textContent = formatCurrency(totals.totalReceitas);
        document.getElementById('totalDespesasMes').textContent = formatCurrency(totals.totalDespesasMes);
        document.getElementById('totalPago').textContent = formatCurrency(totals.totalPago);
        const totalAPagar = totals.totalDespesasMes - totals.totalPago;
        document.getElementById('totalAPagar').textContent = formatCurrency(totalAPagar);

        const saldo = totals.totalReceitas - totals.totalDespesasMes;
        const saldoBar = document.getElementById('saldoBar');
        const saldoLabel = document.getElementById('saldoLabel');

        saldoLabel.textContent = `Saldo: ${formatCurrency(saldo)}`;

        let percentage = 0;
        if (totals.totalDespesasMes > 0) {
          percentage = (totals.totalPago / totals.totalDespesasMes) * 100;
        }
        saldoBar.style.width = `${percentage}%`;

        if (saldo >= 0) {
          saldoBar.style.backgroundColor = 'green';
          saldoLabel.style.color = 'green';
          saldoLabel.style.borderColor = 'green';
        } else {
          saldoBar.style.backgroundColor = 'red';
          saldoLabel.style.color = 'red';
          saldoLabel.style.borderColor = 'red';
        }
      }

      // Funções para Modais de Edição
      let currentEditRecord = null;

      function openEditReceitaModal(id, nome, valor) {
        currentEditRecord = { id: id, sheet: 'Receitas' };
        document.getElementById('editReceitaId').value = id;
        document.getElementById('editReceitaNome').value = nome;
        document.getElementById('editReceitaValor').value = valor;
        document.getElementById('editReceitaModal').style.display = 'block';
      }

      function openEditCompraModal(id, nome, valor, parcelas, cartao, responsavel) {
        currentEditRecord = { id: id, sheet: 'Compras' };
        document.getElementById('editCompraId').value = id;
        document.getElementById('editCompraNome').value = nome;
        document.getElementById('editCompraValor').value = valor;
        document.getElementById('editCompraParcelas').value = parcelas;
        document.getElementById('editCompraCartao').value = cartao;
        document.getElementById('editCompraResponsavel').value = responsavel;
        document.getElementById('editCompraModal').style.display = 'block';
      }

      function openEditContaModal(id, tipo, nome, valor, parcelas) {
        currentEditRecord = { id: id, sheet: 'Contas' };
        document.getElementById('editContaId').value = id;
        document.getElementById('editContaTipo').value = tipo;
        document.getElementById('editContaNome').value = nome;
        document.getElementById('editContaValor').value = valor;
        document.getElementById('editContaParcelas').value = parcelas;
        document.getElementById('editContaModal').style.display = 'block';
      }

      document.querySelectorAll('.close-button').forEach(button => {
        button.onclick = function() {
          this.closest('.modal').style.display = 'none';
        };
      });

      window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
          event.target.style.display = 'none';
        }
      };

      // Funções de Submissão de Formulário
      document.getElementById('addReceitaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nome = document.getElementById('receitaNome').value;
        const valor = parseFloat(document.getElementById('receitaValor').value);
        await sendRequest('addReceita', { nome, valor });
        document.getElementById('addReceitaForm').reset();
        fetchData();
      });

      document.getElementById('addCompraForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nome = document.getElementById('compraNome').value;
        const valor = parseFloat(document.getElementById('compraValor').value);
        const parcelas = parseInt(document.getElementById('compraParcelas').value);
        const cartao = document.getElementById('compraCartao').value;
        const responsavel = document.getElementById('compraResponsavel').value;
        await sendRequest('addCompraCartao', { nome, valor, parcelas, cartao, responsavel });
        document.getElementById('addCompraForm').reset();
        fetchData();
      });

      document.getElementById('addContaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const tipo = document.getElementById('contaTipo').value;
        const nome = document.getElementById('contaNome').value;
        const valor = parseFloat(document.getElementById('contaValor').value);
        const parcelas = parseInt(document.getElementById('contaParcelas').value);
        await sendRequest('addConta', { tipo, nome, valor, parcelas });
        document.getElementById('addContaForm').reset();
        fetchData();
      });

      document.getElementById('editReceitaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editReceitaId').value;
        const nome = document.getElementById('editReceitaNome').value;
        const valor = parseFloat(document.getElementById('editReceitaValor').value);
        await sendRequest('updateReceita', { nome, valor }, id);
        document.getElementById('editReceitaModal').style.display = 'none';
        fetchData();
      });

      document.getElementById('editCompraForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editCompraId').value;
        const nome = document.getElementById('editCompraNome').value;
        const valor = parseFloat(document.getElementById('editCompraValor').value);
        const parcelas = document.getElementById('editCompraParcelas').value; // Manter como string para 'X/Y'
        const cartao = document.getElementById('editCompraCartao').value;
        const responsavel = document.getElementById('editCompraResponsavel').value;
        await sendRequest('updateCompra', { nome, valor, parcelas, cartao, responsavel }, id);
        document.getElementById('editCompraModal').style.display = 'none';
        fetchData();
      });

      document.getElementById('editContaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editContaId').value;
        const tipo = document.getElementById('editContaTipo').value;
        const nome = document.getElementById('editContaNome').value;
        const valor = parseFloat(document.getElementById('editContaValor').value);
        const parcelas = parseInt(document.getElementById('editContaParcelas').value);
        await sendRequest('updateConta', { tipo, nome, valor, parcelas }, id);
        document.getElementById('editContaModal').style.display = 'none';
        fetchData();
      });

      async function deleteRecord(sheetType, id) {
        if (confirm(`Tem certeza que deseja excluir este registro de ${sheetType}?`)) {
          let action;
          if (sheetType === 'Receita') action = 'deleteReceita';
          else if (sheetType === 'Compra') action = 'deleteCompra';
          else if (sheetType === 'Conta') action = 'deleteConta';
          else return;

          await sendRequest(action, {}, id);
          fetchData();
        }
      }

      async function markAsPaid(checkbox) {
        const id = checkbox.dataset.id;
        const originalId = checkbox.dataset.originalId; // Usar originalId para parcelas
        const sheetName = checkbox.dataset.sheet;
        const isChecked = checkbox.checked;
        const status = isChecked ? 'Sim' : 'Não';

        console.log(`Marcando ${sheetName} ID: ${id} (Original ID: ${originalId}) como ${status}`);

        let action;
        if (sheetName === 'Compras') {
          action = 'markCompraAsPaid';
        } else if (sheetName === 'Contas') {
          action = 'markContaAsPaid';
        } else {
          console.error('Tipo de sheet desconhecido para marcar como pago:', sheetName);
          return;
        }

        // Para parcelas, o ID que precisamos atualizar no backend é o originalId
        const recordToUpdateId = originalId || id;

        const result = await sendRequest(action, { pago: status }, recordToUpdateId);

        if (result.status === 'success') {
          // A UI será atualizada via fetchData() que é chamado após o sucesso
          // Não é necessário manipular a classe 'item-pago' diretamente aqui,
          // pois fetchData() irá redesenhar os itens com o status correto.
          fetchData();
        } else {
          // Se falhar, reverter o estado do checkbox na UI
          checkbox.checked = !isChecked;
          alert('Falha ao atualizar o status de pagamento.');
        }
      }

    </script>
  </body>
</html>

