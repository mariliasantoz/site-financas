<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
    <style>
      /* CONFIGURAÇÃO GERAL */
      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        color: black; /* Texto padrão em preto */
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      .form-section,
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
      }
      /* BOTÕES */
      button {
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 10px 15px;
        cursor: pointer;
        font-size: 1em;
        margin-top: 10px;
      }
      button:hover {
        background-color: #45a049;
      }
      /* HEADER */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ccc;
      }
      header h1 {
        margin: 0;
      }
      .nav-buttons button {
        margin: 0 5px;
        padding: 8px 12px;
        background-color: #007bff;
      }
      .nav-buttons button:hover {
        background-color: #0056b3;
      }
      /* SEÇÃO DE TOTAIS */
      .totals-section {
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
      }
      .totals-wrapper span {
        display: inline-block;
        margin: 0 15px;
        font-weight: bold;
      }
      .saldo-bar-container {
        width: 80%;
        background-color: #ddd;
        border-radius: 5px;
        overflow: hidden;
        margin: 10px auto;
        height: 20px;
        position: relative;
      }
      .saldo-bar {
        height: 100%;
        background-color: #28a745; /* Verde para saldo positivo */
        width: 0%; /* Será ajustado via JS */
      }
      .saldo-label {
        position: absolute;
        width: 100%;
        text-align: center;
        line-height: 20px;
        color: black;
      }
      /* SEÇÃO DE CATEGORIAS */
      .categorias-section {
        padding: 15px;
        margin-bottom: 20px;
      }
      .categorias-columns {
        display: flex;
        justify-content: space-around;
        gap: 20px;
        flex-wrap: wrap; /* Permite quebrar linha em telas menores */
      }
      .categoria-box {
        flex: 1;
        min-width: 280px; /* Largura mínima para cada caixa */
        padding: 15px;
        margin-bottom: 15px;
      }
      .categoria-box h3 {
        margin-top: 0;
        text-align: center;
      }
      .categoria-list {
        max-height: 200px; /* Altura máxima para rolagem */
        overflow-y: auto;
        margin-bottom: 10px;
      }
      .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .list-item:last-child {
        border-bottom: none;
      }
      .list-item-content {
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
        gap: 10px;
      }
      .list-item-controls {
          display: flex;
          gap: 5px;
      }
      .list-item-controls button {
          padding: 5px 8px;
          font-size: 0.8em;
          margin-top: 0;
      }
      .list-item-controls button:first-child {
          background-color: #ffc107; /* Amarelo para editar */
          color: #333;
      }
      .list-item-controls button:first-child:hover {
          background-color: #e0a800;
      }
      .list-item-controls button:last-child {
          background-color: #dc3545; /* Vermelho para excluir */
      }
      .list-item-controls button:last-child:hover {
          background-color: #c82333;
      }
      .checkbox-pago {
        margin-left: 10px;
      }
      /* SEÇÃO DE CARTÕES */
      .cartoes-section {
        padding: 15px;
        margin-bottom: 20px;
      }
      .cartoes-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }
      .cartao-box {
        background-color: #bbdefb;
        border: 1px solid #64b5f6;
        border-radius: 5px;
        padding: 15px;
      }
      .cartao-box h3 {
        margin-top: 0;
        text-align: center;
      }
      .cartao-list {
        max-height: 150px;
        overflow-y: auto;
      }
      .compra {
        padding: 5px 0;
        border-bottom: 1px solid #e3f2fd;
      }
      .compra:last-child {
        border-bottom: none;
      }
      .cartao-total {
        margin-top: 10px;
        font-weight: bold;
        text-align: right;
      }
      .cartao-paid-checkbox {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-top: 5px;
        font-size: 0.9em;
      }
      .cartao-paid-checkbox input {
        margin-left: 5px;
      }
      /* SEÇÃO DE FORMULÁRIOS */
      .forms-container {
        display: flex;
        justify-content: space-around;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }
      .form-section {
        flex: 1;
        min-width: 300px;
        padding: 15px;
      }
      .form-section h2 {
        margin-top: 0;
        text-align: center;
      }
      .form-section input[type="text"],
      .form-section input[type="number"],
      .form-section select {
        width: calc(100% - 20px);
        padding: 8px 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .form-section .row {
        display: flex;
        gap: 10px;
      }
      .form-section .row input {
        flex: 1;
        width: auto; /* Sobrescreve o 100% para inputs dentro de .row */
      }

      /* SEÇÃO DE COMPRAS POR RESPONSÁVEL */
      .compras-responsaveis {
        padding: 15px;
        margin-bottom: 20px;
      }
      .responsaveis-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }
      .responsavel-box {
        padding: 15px;
        text-align: center;
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em;
      }
      .responsavel-box p {
        margin: 5px 0;
        font-size: 0.9em;
      }
      /* Cores para Responsáveis (background) */
      .liana {
        background-color: #add8e6;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .stefany {
        background-color: #ffb347;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .marilia {
        background-color: #dda0dd;
        padding: 4px 8px;
        border-radius: 3px;
      }
      .nosso {
        background-color: #ffc0cb;
        padding: 4px 8px;
        border-radius: 3px;
      }
      /* RODAPÉ */
      footer {
        text-align: center;
        margin-top: 20px;
      }
      footer p span {
        margin: 0 5px;
        font-weight: bold;
      }
      /* Estilos para Modal de Edição (novo) */
      .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more responsive */
        max-width: 500px;
        border-radius: 8px;
        position: relative;
      }
      .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 20px;
      }
      .close-button:hover,
      .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      .modal-content input[type="text"],
      .modal-content input[type="number"],
      .modal-content select {
        width: calc(100% - 20px);
        padding: 8px 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .modal-content button {
        background-color: #007bff;
        margin-right: 10px;
      }
      .modal-content button:hover {
        background-color: #0056b3;
      }
      .modal-content button.cancel {
        background-color: #6c757d;
      }
      .modal-content button.cancel:hover {
        background-color: #5a6268;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Painel Financeiro</h1>
        <h2>Maio 2025</h2> <div class="nav-buttons">
          <button>&laquo; Mês Anterior</button>
          <button>Mês Seguinte &raquo;</button>
        </div>
      </header>
      
      <div class="totals-section">
        <div class="totals-wrapper">
          <span id="totalReceitasDisplay">Total de Receitas: R$ 0.00</span>
          <span id="totalDespesasDisplay">Total de Despesas: R$ 0.00</span>
        </div>
        <div class="saldo-bar-container">
          <div class="saldo-bar" id="saldoBar"></div>
          <div class="saldo-label" id="saldoLabel">Saldo: R$ 0.00</div>
        </div>
      </div>
      
      <div class="categorias-section">
        <h2>Resumo do Mês</h2>
        <div class="categorias-columns">
          <div class="categoria-box receitas">
            <h3>Receitas</h3>
            <div class="categoria-list" id="listaReceitas">
              <p>Carregando receitas...</p>
            </div>
            <button onclick="openReceitaModal()">Adicionar Receita</button>
          </div>
          
          <div class="categoria-box contas">
            <h3>Contas Fixas</h3>
            <div class="categoria-list" id="listaContasFixas">
              <p>Carregando contas fixas...</p>
            </div>
            <div class="conta-total" id="totalContasFixas">Total: R$ 0.00</div>
            <div class="cartao-paid-checkbox">
                Marcar todas fixas como pagas: <input type="checkbox" id="markAllFixasPaid" onchange="markAllContasAsPaidFront('Fixa', this.checked)">
            </div>
          </div>
          
          <div class="categoria-box contas">
            <h3>Contas Variáveis</h3>
            <div class="categoria-list" id="listaContasVariaveis">
              <p>Carregando contas variáveis...</p>
            </div>
            <div class="conta-total" id="totalContasVariaveis">Total: R$ 0.00</div>
            <div class="cartao-paid-checkbox">
                Marcar todas variáveis como pagas: <input type="checkbox" id="markAllVariaveisPaid" onchange="markAllContasAsPaidFront('Variável', this.checked)">
            </div>
          </div>
        </div>
      </div>

      <div class="cartoes-section">
        <h2>Compras por Cartão</h2>
        <div class="cartoes-container" id="listaCartoes">
          <p>Carregando compras por cartão...</p>
        </div>
      </div>

      <div class="forms-container">
        <div class="form-section" id="formAdicionarCompra">
          <h2>Adicionar Compra no Cartão</h2>
          <div class="row">
            <select id="responsavelCompra">
              <option value="">Responsável</option>
              <option value="Liana">Liana</option>
              <option value="Stefany">Stefany</option>
              <option value="Marília">Marília</option>
              <option value="Nosso ❤️">Nosso ❤️</option>
            </select>
            <select id="cartaoCompra">
              <option value="">Cartão</option>
              <option value="Nubank">NUBANK</option>
              <option value="Picpay">PICPAY</option>
              <option value="Itaucard">ITAUCARD</option>
              <option value="Inter">INTER</option>
              <option value="Mercado Pago">MERCADO PAGO</option>
              <option value="Amazon">AMAZON</option>
            </select>
          </div>
          <div class="row">
            <input type="text" id="nomeCompra" placeholder="Nome da Compra" />
          </div>
          <div class="row">
            <input type="number" id="valorCompra" placeholder="Valor" />
            <input type="text" id="parcelasCompra" placeholder="Parcelas (ex: 2/6)" />
          </div>
          <button onclick="submitCompraCartao()">Adicionar Compra no Cartão</button>
          </div>
        
        <div class="form-section" id="formAdicionarConta">
          <h2>Adicionar Conta</h2>
          <select id="tipoConta">
            <option value="Fixa">Fixa</option>
            <option value="Variável">Variável</option>
          </select>
          <input type="text" id="nomeConta" placeholder="Nome da Conta" />
          <input type="text" id="parcelasConta" placeholder="Parcelas (ex: 2/3)" />
          <input type="number" id="valorConta" placeholder="Valor" />
          <button onclick="submitConta()">Adicionar Conta</button>
          </div>
      </div>
      
      <div class="compras-responsaveis">
        <h2>Total de Compras por Responsável</h2>
        <div class="responsaveis-container" id="listaComprasResponsaveis">
          <p>Carregando totais por responsável...</p>
        </div>
      </div>
      
      <footer>
        <p>
          <span class="liana">Liana</span>,
          <span class="stefany">Stefany</span>,
          <span class="marilia">Marília</span>,
          <span class="nosso">Nosso ❤️</span>
        </p>
      </footer>
    </div>

    <div id="receitaModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeReceitaModal()">&times;</span>
            <h2>Editar Receita</h2>
            <input type="hidden" id="editReceitaId">
            <input type="text" id="editNomeReceita" placeholder="Nome da Receita">
            <input type="number" id="editValorReceita" placeholder="Valor">
            <button onclick="saveReceitaEdit()">Salvar</button>
            <button class="cancel" onclick="closeReceitaModal()">Cancelar</button>
        </div>
    </div>

    <div id="compraModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeCompraModal()">&times;</span>
            <h2>Editar Compra</h2>
            <input type="hidden" id="editCompraId">
            <input type="text" id="editNomeCompra" placeholder="Nome da Compra">
            <input type="number" id="editValorCompra" placeholder="Valor">
            <input type="text" id="editParcelasCompra" placeholder="Parcelas (ex: 1/3)">
            <select id="editResponsavelCompra">
                <option value="Liana">Liana</option>
                <option value="Stefany">Stefany</option>
                <option value="Marília">Marília</option>
                <option value="Nosso ❤️">Nosso ❤️</option>
            </select>
            <select id="editCartaoCompra">
                <option value="Nubank">NUBANK</option>
                <option value="Picpay">PICPAY</option>
                <option value="Itaucard">ITAUCARD</option>
                <option value="Inter">INTER</option>
                <option value="Mercado Pago">MERCADO PAGO</option>
                <option value="Amazon">AMAZON</option>
            </select>
            <button onclick="saveCompraEdit()">Salvar</button>
            <button class="cancel" onclick="closeCompraModal()">Cancelar</button>
        </div>
    </div>

    <div id="contaModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeContaModal()">&times;</span>
            <h2>Editar Conta</h2>
            <input type="hidden" id="editContaId">
            <input type="text" id="editNomeConta" placeholder="Nome da Conta">
            <input type="number" id="editValorConta" placeholder="Valor">
            <input type="text" id="editParcelasConta" placeholder="Parcelas (ex: 1/3)">
            <select id="editTipoConta">
                <option value="Fixa">Fixa</option>
                <option value="Variável">Variável</option>
            </select>
            <button onclick="saveContaEdit()">Salvar</button>
            <button class="cancel" onclick="closeContaModal()">Cancelar</button>
        </div>
    </div>


    <script>
      // *** AQUI É ONDE A URL DO SEU CLOUDFLARE WORKER DEVE ENTRAR ***
      const webAppUrl = "https://painel-financas-proxy.mariliaedua.workers.dev/";
      // ***************************************************************
      
      let currentMonth = new Date().getMonth(); // 0-Janeiro, 1-Fevereiro, etc.
      let currentYear = new Date().getFullYear();

      const monthNames = [
        "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
      ];

      function updateMonthDisplay() {
        document.querySelector("header h2").textContent = `${monthNames[currentMonth]} ${currentYear}`;
      }

      function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        } else if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        updateMonthDisplay();
        // Recarrega todos os dados para o novo mês/ano
        atualizarReceitas();
        atualizarContas();
        atualizarCartoes();
        atualizarComprasPorResponsavel();
        atualizarTotais(); // Atualiza os totais gerais
      }

      async function fetchData(action, payloadData = {}) {
        const payload = {
          action: action,
          month: currentMonth + 1, // Envia o mês como 1-indexed (1 a 12)
          year: currentYear,
          ...payloadData
        };

        try {
          const response = await fetch(webAppUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erro de rede ou servidor: ${response.status} - ${errorText}`);
          }
          const data = await response.json();
          if (data.error) {
            throw new Error(data.error);
          }
          return data;
        } catch (error) {
          console.error("Erro ao buscar dados:", error);
          alert("Erro ao carregar dados: " + error.message);
          return { data: null, message: error.message };
        }
      }

      // ======================= FUNÇÕES DE ATUALIZAÇÃO DA INTERFACE =======================

      async function atualizarReceitas() {
        const listaReceitasElem = document.getElementById("listaReceitas");
        listaReceitasElem.innerHTML = "<p>Carregando receitas...</p>";
        const data = await fetchData("getReceitas");
        listaReceitasElem.innerHTML = "";
        let totalReceitas = 0;

        if (data.data && data.data.length > 0) {
          data.data.forEach(item => {
            const div = document.createElement("div");
            div.classList.add("list-item");
            div.innerHTML = `
              <div class="list-item-content">
                <span>${item.nome} | R$ ${parseFloat(item.valor || 0).toFixed(2)}</span>
                <div class="list-item-controls">
                  <button onclick='editReceitaFront(\"${item.id}\")'>Edit</button>
                  <button onclick='deleteReceitaFront(\"${item.id}\")'>X</button>
                </div>
              </div>
            `;
            listaReceitasElem.appendChild(div);
            totalReceitas += parseFloat(item.valor || 0);
          });
        } else {
          listaReceitasElem.innerHTML = "<p>Nenhuma receita cadastrada.</p>";
        }
        document.getElementById("totalReceitasDisplay").textContent = `Total de Receitas: R$ ${totalReceitas.toFixed(2)}`;
        atualizarTotais();
      }

      async function atualizarContas() {
        const listaContasFixasElem = document.getElementById("listaContasFixas");
        const listaContasVariaveisElem = document.getElementById("listaContasVariaveis");
        const totalContasFixasElem = document.getElementById("totalContasFixas");
        const totalContasVariaveisElem = document.getElementById("totalContasVariaveis");

        listaContasFixasElem.innerHTML = "<p>Carregando contas fixas...</p>";
        listaContasVariaveisElem.innerHTML = "<p>Carregando contas variáveis...</p>";
        totalContasFixasElem.textContent = "Total: R$ 0.00";
        totalContasVariaveisElem.textContent = "Total: R$ 0.00";

        const data = await fetchData("getContas");
        
        listaContasFixasElem.innerHTML = "";
        listaContasVariaveisElem.innerHTML = "";

        let totalFixas = 0;
        let totalVariaveis = 0;
        let allFixasPaid = true;
        let allVariaveisPaid = true;
        let anyFixaFound = false;
        let anyVariavelFound = false;

        if (data.data && data.data.length > 0) {
          data.data.forEach(item => {
            const div = document.createElement("div");
            div.classList.add("list-item");
            const valorFormatado = parseFloat(item.valor || 0).toFixed(2);
            div.innerHTML = `
              <div class="list-item-content">
                <span>${item.nome} | ${item.parcelas} | R$ ${valorFormatado}</span>
                <input type="checkbox" class="checkbox-pago" ${item.pago === 'Sim' ? 'checked' : ''} onchange="markContaAsPaidFront('${item.id}', this.checked)">
                <div class="list-item-controls">
                  <button onclick='editContaFront(\"${item.id}\")'>Edit</button>
                  <button onclick='deleteContaFront(\"${item.id}\")'>X</button>
                </div>
              </div>
            `;
            
            if (item.tipo === 'Fixa') {
              listaContasFixasElem.appendChild(div);
              totalFixas += parseFloat(item.valor || 0);
              if (item.pago !== 'Sim') allFixasPaid = false;
              anyFixaFound = true;
            } else if (item.tipo === 'Variável') {
              listaContasVariaveisElem.appendChild(div);
              totalVariaveis += parseFloat(item.valor || 0);
              if (item.pago !== 'Sim') allVariaveisPaid = false;
              anyVariavelFound = true;
            }
          });
        } else {
          listaContasFixasElem.innerHTML = "<p>Nenhuma conta fixa cadastrada para este mês.</p>";
          listaContasVariaveisElem.innerHTML = "<p>Nenhuma conta variável cadastrada para este mês.</p>";
        }

        totalContasFixasElem.textContent = `Total: R$ ${totalFixas.toFixed(2)}`;
        totalContasVariaveisElem.textContent = `Total: R$ ${totalVariaveis.toFixed(2)}`;
        
        // Atualiza os checkboxes de marcar todas
        document.getElementById("markAllFixasPaid").checked = anyFixaFound && allFixasPaid;
        document.getElementById("markAllVariaveisPaid").checked = anyVariavelFound && allVariaveisPaid;

        atualizarTotais();
      }

      async function atualizarCartoes() {
        const listaCartoesElem = document.getElementById("listaCartoes");
        listaCartoesElem.innerHTML = "<p>Carregando compras por cartão...</p>";
        const data = await fetchData("getComprasPorCartao");
        listaCartoesElem.innerHTML = "";

        if (data.data && Object.keys(data.data).length > 0) {
          Object.keys(data.data).forEach(cardNome => {
            const cardBox = document.createElement("div");
            cardBox.classList.add("cartao-box");
            cardBox.innerHTML = `
              <h3>${cardNome}</h3>
              <div class="cartao-list" id="card-${cardNome.replace(/\s/g, '')}-list"></div>
              <div class="cartao-total" id="card-${cardNome.replace(/\s/g, '')}-total"></div>
              <div class="cartao-paid-checkbox">
                Marcar todas pagas: <input type="checkbox" class="cartao-paid" id="markAll${cardNome.replace(/\s/g, '')}Paid" onchange="markAllComprasOfCardAsPaid('${cardNome}', this.checked)">
              </div>
            `;
            listaCartoesElem.appendChild(cardBox);

            const cardListElem = document.getElementById(`card-${cardNome.replace(/\s/g, '')}-list`);
            const cardTotalElem = document.getElementById(`card-${cardNome.replace(/\s/g, '')}-total`);
            const comprasDoCartao = data.data[cardNome];
            let totalCartao = 0;
            let allCardPurchasesPaid = true;

            if (comprasDoCartao && comprasDoCartao.length > 0) {
              comprasDoCartao.forEach(item => {
                const div = document.createElement("div");
                // Adiciona a classe do responsável para estilização
                const responsavelClass = item.responsavel ? item.responsavel.toLowerCase().replace(/á/g, 'a').replace(/ /g, '') : '';
                div.classList.add("compra", responsavelClass); 

                div.innerHTML = `
                  <div class="list-item-content">
                    <span>${item.nome} | ${item.parcelaAtual}/${item.parcelasTotais} | R$ ${parseFloat(item.valor || 0).toFixed(2)} (${item.responsavel})</span>
                    <input type="checkbox" class="checkbox-pago" ${item.pago === 'Sim' ? 'checked' : ''} onchange="markCompraAsPaidFront('${item.id}', this.checked)">
                    <div class="list-item-controls">
                      <button onclick='editCompraFront(\"${item.id}\")'>Edit</button>
                      <button onclick='deleteCompraFront(\"${item.id}\")'>X</button>
                    </div>
                  </div>
                `;
                cardListElem.appendChild(div);
                
                if (item.pago !== 'Sim') { // Somar apenas se não estiver pago
                  totalCartao += parseFloat(item.valor || 0);
                  allCardPurchasesPaid = false;
                }
              });
            } else {
              cardListElem.innerHTML = "<p>Nenhuma compra neste cartão para este mês.</p>";
            }
            cardTotalElem.textContent = `Total: R$ ${totalCartao.toFixed(2)}`;
            document.getElementById(`markAll${cardNome.replace(/\s/g, '')}Paid`).checked = comprasDoCartao.length > 0 && allCardPurchasesPaid;
          });
        } else {
          listaCartoesElem.innerHTML = "<p>Nenhum cartão com compras para este mês.</p>";
        }
        atualizarTotais();
      }

      async function atualizarComprasPorResponsavel() {
        const listaComprasResponsaveisElem = document.getElementById("listaComprasResponsaveis");
        listaComprasResponsaveisElem.innerHTML = "<p>Carregando totais por responsável...</p>";
        const data = await fetchData("getComprasPorResponsavel");
        listaComprasResponsaveisElem.innerHTML = "";

        if (data.data) {
          Object.keys(data.data).forEach(responsavelNome => {
            const responsavelData = data.data[responsavelNome];
            const div = document.createElement("div");
            const responsavelClass = responsavelNome.toLowerCase().replace(/á/g, 'a').replace(/ /g, '');
            div.classList.add("responsavel-box", responsavelClass);
            div.innerHTML = `
              <h3>${responsavelNome}</h3>
              <p>Total: R$ ${parseFloat(responsavelData.total || 0).toFixed(2)}</p>
              <div class="compras-detalhe"></div>
            `;
            listaComprasResponsaveisElem.appendChild(div);

            const comprasDetalheElem = div.querySelector(".compras-detalhe");
            if (responsavelData.compras && responsavelData.compras.length > 0) {
                responsavelData.compras.forEach(compra => {
                    const compraDiv = document.createElement("p");
                    compraDiv.textContent = `${compra.nome} (${compra.parcelas}) - R$ ${parseFloat(compra.valor || 0).toFixed(2)}`;
                    comprasDetalheElem.appendChild(compraDiv);
                });
            } else {
                comprasDetalheElem.innerHTML = "<p>Nenhuma compra para este responsável no mês.</p>";
            }
          });
        } else {
            listaComprasResponsaveisElem.innerHTML = "<p>Nenhum dado de compras por responsável.</p>";
        }
        atualizarTotais();
      }

      function atualizarTotais() {
        const totalReceitas = parseFloat(document.getElementById("totalReceitasDisplay").textContent.replace('Total de Receitas: R$ ', '')) || 0;
        
        let totalDespesas = 0;
        document.querySelectorAll(".cartao-total").forEach(elem => {
          totalDespesas += parseFloat(elem.textContent.replace('Total: R$ ', '')) || 0;
        });
        totalDespesas += parseFloat(document.getElementById("totalContasFixas").textContent.replace('Total: R$ ', '')) || 0;
        totalDespesas += parseFloat(document.getElementById("totalContasVariaveis").textContent.replace('Total: R$ ', '')) || 0;

        document.getElementById("totalDespesasDisplay").textContent = `Total de Despesas: R$ ${totalDespesas.toFixed(2)}`;

        const saldo = totalReceitas - totalDespesas;
        const saldoLabel = document.getElementById("saldoLabel");
        const saldoBar = document.getElementById("saldoBar");

        saldoLabel.textContent = `Saldo: R$ ${saldo.toFixed(2)}`;

        // Atualizar barra de saldo
        const totalMax = Math.max(totalReceitas, totalDespesas, 1); // Evitar divisão por zero
        let percentage = (saldo / totalMax) * 100;
        
        // Ajustar a porcentagem para exibição visual
        if (saldo > 0) {
            saldoBar.style.backgroundColor = '#28a745'; // Verde
            saldoBar.style.width = `${Math.min(percentage, 100)}%`; // Limitar a 100%
        } else if (saldo < 0) {
            saldoBar.style.backgroundColor = '#dc3545'; // Vermelho
            saldoBar.style.width = `${Math.min(Math.abs(percentage), 100)}%`; // Usar valor absoluto para largura
        } else {
            saldoBar.style.backgroundColor = '#6c757d'; // Cinza
            saldoBar.style.width = '0%'; // Ou 0%
        }
      }

      // ======================= FUNÇÕES DE SUBMISSÃO DE FORMULÁRIOS =======================

      async function submitReceita() {
        const nome = prompt("Nome da Receita:");
        const valor = prompt("Valor da Receita:");

        if (nome && valor) {
          const payload = {
            action: "addReceita",
            data: { nome: nome, valor: parseFloat(valor).toFixed(2) }
          };
          const response = await fetchData(payload.action, payload.data);
          if (response.message) {
            alert(response.message);
            atualizarReceitas();
          }
        }
      }

      async function submitCompraCartao() {
        const responsavel = document.getElementById("responsavelCompra").value;
        const cartao = document.getElementById("cartaoCompra").value;
        const nome = document.getElementById("nomeCompra").value;
        const valor = document.getElementById("valorCompra").value;
        const parcelas = document.getElementById("parcelasCompra").value;

        if (responsavel && cartao && nome && valor && parcelas) {
          const payload = {
            action: "addCompra",
            data: {
              responsavel: responsavel,
              cartao: cartao,
              nome: nome,
              valor: parseFloat(valor).toFixed(2),
              parcelas: parcelas
            }
          };
          const response = await fetchData(payload.action, payload.data);
          if (response.message) {
            alert(response.message);
            // Limpa o formulário
            document.getElementById("responsavelCompra").value = "";
            document.getElementById("cartaoCompra").value = "";
            document.getElementById("nomeCompra").value = "";
            document.getElementById("valorCompra").value = "";
            document.getElementById("parcelasCompra").value = "";
            atualizarCartoes();
            atualizarComprasPorResponsavel();
          }
        } else {
          alert("Por favor, preencha todos os campos da compra.");
        }
      }

      async function submitConta() {
        const tipo = document.getElementById("tipoConta").value;
        const nome = document.getElementById("nomeConta").value;
        const parcelas = document.getElementById("parcelasConta").value;
        const valor = document.getElementById("valorConta").value;

        if (tipo && nome && valor && parcelas) {
          const payload = {
            action: "addConta",
            data: {
              tipo: tipo,
              nome: nome,
              valor: parseFloat(valor).toFixed(2),
              parcelas: parcelas
            }
          };
          const response = await fetchData(payload.action, payload.data);
          if (response.message) {
            alert(response.message);
            // Limpa o formulário
            document.getElementById("tipoConta").value = "Fixa";
            document.getElementById("nomeConta").value = "";
            document.getElementById("parcelasConta").value = "";
            document.getElementById("valorConta").value = "";
            atualizarContas();
          }
        } else {
          alert("Por favor, preencha todos os campos da conta.");
        }
      }


      // ======================= FUNÇÕES DE EDIÇÃO E EXCLUSÃO (CRUD) =======================

      // Receitas
      let currentReceitaId = null;
      async function openReceitaModal(id = null) {
          const modal = document.getElementById("receitaModal");
          currentReceitaId = id; // Store the ID
          
          if (id) {
              const data = await fetchData("getReceita", { recordId: id });
              if (data.data) {
                  document.getElementById("editReceitaId").value = id;
                  document.getElementById("editNomeReceita").value = data.data.nome;
                  document.getElementById("editValorReceita").value = parseFloat(data.data.valor || 0).toFixed(2);
                  modal.style.display = "flex"; // Show modal
              } else {
                  alert("Receita não encontrada.");
              }
          } else { // For adding new receita (prompt approach)
              submitReceita();
          }
      }

      function closeReceitaModal() {
          document.getElementById("receitaModal").style.display = "none";
          currentReceitaId = null; // Clear ID
      }

      async function saveReceitaEdit() {
          const id = document.getElementById("editReceitaId").value;
          const nome = document.getElementById("editNomeReceita").value;
          const valor = document.getElementById("editValorReceita").value;

          if (id && nome && valor) {
              const payload = {
                  action: "updateReceita",
                  recordId: id,
                  data: { nome: nome, valor: parseFloat(valor).toFixed(2) }
              };
              const response = await fetchData(payload.action, payload.data);
              if (response.message) {
                  alert(response.message);
                  closeReceitaModal();
                  atualizarReceitas();
              }
          } else {
              alert("Por favor, preencha todos os campos da receita.");
          }
      }

      async function deleteReceitaFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta receita?")) return;
        const payload = { action: "deleteReceita", recordId: recordId };
        const response = await fetchData(payload.action, {recordId: recordId}); // Passa recordId como parte do payloadData
        if (response.message) {
            alert(response.message);
            atualizarReceitas();
        }
      }

      // Compras (Cartão)
      let currentCompraId = null;
      async function editCompraFront(id) {
          const modal = document.getElementById("compraModal");
          currentCompraId = id;
          
          const data = await fetchData("getCompra", { recordId: id });
          if (data.data) {
              document.getElementById("editCompraId").value = id;
              document.getElementById("editNomeCompra").value = data.data.nome;
              document.getElementById("editValorCompra").value = parseFloat(data.data.valor || 0).toFixed(2);
              document.getElementById("editParcelasCompra").value = data.data.parcelas;
              document.getElementById("editResponsavelCompra").value = data.data.responsavel;
              document.getElementById("editCartaoCompra").value = data.data.cartao;
              modal.style.display = "flex";
          } else {
              alert("Compra não encontrada.");
          }
      }

      function closeCompraModal() {
          document.getElementById("compraModal").style.display = "none";
          currentCompraId = null;
      }

      async function saveCompraEdit() {
          const id = document.getElementById("editCompraId").value;
          const nome = document.getElementById("editNomeCompra").value;
          const valor = document.getElementById("editValorCompra").value;
          const parcelas = document.getElementById("editParcelasCompra").value;
          const responsavel = document.getElementById("editResponsavelCompra").value;
          const cartao = document.getElementById("editCartaoCompra").value;

          if (id && nome && valor && parcelas && responsavel && cartao) {
              const payload = {
                  action: "updateCompra",
                  recordId: id,
                  data: {
                      nome: nome,
                      valor: parseFloat(valor).toFixed(2),
                      parcelas: parcelas,
                      responsavel: responsavel,
                      cartao: cartao
                  }
              };
              const response = await fetchData(payload.action, payload.data);
              if (response.message) {
                  alert(response.message);
                  closeCompraModal();
                  atualizarCartoes();
                  atualizarComprasPorResponsavel();
              }
          } else {
              alert("Por favor, preencha todos os campos da compra.");
          }
      }

      async function deleteCompraFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta compra?")) return;
        const payload = { action: "deleteCompra", recordId: recordId };
        const response = await fetchData(payload.action, {recordId: recordId});
        if (response.message) {
          alert(response.message);
          atualizarCartoes();
          atualizarComprasPorResponsavel();
        }
      }

      // Contas
      let currentContaId = null;
      async function editContaFront(id) {
          const modal = document.getElementById("contaModal");
          currentContaId = id;
          
          const data = await fetchData("getConta", { recordId: id });
          if (data.data) {
              document.getElementById("editContaId").value = id;
              document.getElementById("editNomeConta").value = data.data.nome;
              document.getElementById("editValorConta").value = parseFloat(data.data.valor || 0).toFixed(2);
              document.getElementById("editParcelasConta").value = data.data.parcelas;
              document.getElementById("editTipoConta").value = data.data.tipo;
              modal.style.display = "flex";
          } else {
              alert("Conta não encontrada.");
          }
      }

      function closeContaModal() {
          document.getElementById("contaModal").style.display = "none";
          currentContaId = null;
      }

      async function saveContaEdit() {
          const id = document.getElementById("editContaId").value;
          const nome = document.getElementById("editNomeConta").value;
          const valor = document.getElementById("editValorConta").value;
          const parcelas = document.getElementById("editParcelasConta").value;
          const tipo = document.getElementById("editTipoConta").value;

          if (id && nome && valor && parcelas && tipo) {
              const payload = {
                  action: "updateConta",
                  recordId: id,
                  data: {
                      nome: nome,
                      valor: parseFloat(valor).toFixed(2),
                      parcelas: parcelas,
                      tipo: tipo
                  }
              };
              const response = await fetchData(payload.action, payload.data);
              if (response.message) {
                  alert(response.message);
                  closeContaModal();
                  atualizarContas();
              }
          } else {
              alert("Por favor, preencha todos os campos da conta.");
          }
      }

      async function deleteContaFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta conta?")) return;
        const payload = { action: "deleteConta", recordId: recordId };
        const response = await fetchData(payload.action, {recordId: recordId});
        if (response.message) {
            alert(response.message);
            atualizarContas();
        }
      }

      // Funções para marcar como pago
      async function markCompraAsPaidFront(recordId, isChecked) {
        const newPagoStatus = isChecked ? 'Sim' : 'Não';
        const payload = { action: "updateCompra", recordId: recordId, data: { pago: newPagoStatus } };
        const response = await fetchData(payload.action, payload.data);
        if (response.message) {
            // alert(response.message); // Opcional: mostrar alerta
            atualizarCartoes(); // Recarrega para atualizar totais e checkboxes
            atualizarComprasPorResponsavel();
        }
      }

      async function markContaAsPaidFront(recordId, isChecked) {
        const newPagoStatus = isChecked ? 'Sim' : 'Não';
        const payload = { action: "updateConta", recordId: recordId, data: { pago: newPagoStatus } };
        const response = await fetchData(payload.action, payload.data);
        if (response.message) {
            // alert(response.message); // Opcional: mostrar alerta
            atualizarContas(); // Recarrega para atualizar totais e checkboxes
        }
      }

      async function markAllComprasOfCardAsPaid(cardName, isChecked) {
          const newPagoStatus = isChecked ? 'Sim' : 'Não';
          const payload = { 
              action: "markComprasByCardAsPaid", 
              cardName: cardName, 
              pago: newPagoStatus 
          };
          const response = await fetchData(payload.action, payload); // Envia o payload completo
          if (response.message) {
              alert(response.message);
              atualizarCartoes();
              atualizarComprasPorResponsavel();
          }
      }

      async function markAllContasAsPaidFront(tipoConta, isChecked) {
          const newPagoStatus = isChecked ? 'Sim' : 'Não';
          const payload = { 
              action: "markContasAsPaid", 
              tipo: tipoConta, 
              pago: newPagoStatus 
          };
          const response = await fetchData(payload.action, payload); // Envia o payload completo
          if (response.message) {
              alert(response.message);
              atualizarContas();
          }
      }


      // Inicialização
      document.addEventListener("DOMContentLoaded", function(){
        updateMonthDisplay(); // Define o mês e ano iniciais
        atualizarReceitas();
        atualizarContas(); 
        atualizarCartoes(); 
        atualizarComprasPorResponsavel();
        atualizarTotais(); // Atualiza os totais gerais

        // Event listeners para navegação de mês
        document.querySelector(".nav-buttons button:first-child").addEventListener("click", function(){
          changeMonth(-1);
        });
        document.querySelector(".nav-buttons button:last-child").addEventListener("click", function(){
          changeMonth(1);
        });

        // Modais Close buttons
        document.querySelectorAll('.modal .close-button').forEach(button => {
            button.onclick = function() {
                this.closest('.modal').style.display = 'none';
            };
        });

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        };

      });
    </script>
  </body>
</html>
