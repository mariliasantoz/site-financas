<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Financeiro</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            position: relative;
        }

        header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            margin-bottom: 5px;
        }

        header h2 {
            color: #555;
            font-size: 1.6em;
            font-weight: 400;
        }

        .nav-buttons {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
            padding: 0 20px;
        }

        .nav-buttons button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-buttons button:hover {
            background-color: #0056b3;
        }

        .totals-section {
            background-color: #e9ecef;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .totals-wrapper {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: bold;
            color: #495057;
        }

        .totals-wrapper span:first-child {
            color: #28a745; /* Cor verde para Receitas */
        }

        .totals-wrapper span:last-child {
            color: #dc3545; /* Cor vermelha para Despesas */
        }

        .saldo-bar-container {
            width: 100%;
            background-color: #dee2e6;
            border-radius: 5px;
            height: 30px;
            position: relative;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        .saldo-bar {
            height: 100%;
            width: 0%;
            background-color: #28a745; /* Default green */
            border-radius: 5px;
            transition: width 0.5s ease-in-out, background-color 0.5s ease;
        }

        .saldo-label {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.7);
        }

        .categorias-section, .cartoes-section, .forms-container, .compras-responsaveis {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 10px;
            background-color: #fdfdfd;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        h2 {
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 1px dashed #eee;
            padding-bottom: 10px;
        }

        .categorias-columns, .cartoes-columns, .forms-container {
            display: grid;
            gap: 25px;
        }

        .categorias-columns {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .cartoes-columns {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .form-section {
            grid-column: span 1;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fefefe;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .form-section h2 {
            font-size: 1.6em;
            margin-top: 0;
            margin-bottom: 15px;
            color: #34495e;
            border-bottom: none;
        }

        .form-section .row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-section input[type="text"],
        .form-section input[type="number"],
        .form-section select {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }

        .form-section button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-section button:hover {
            background-color: #218838;
        }

        .categoria-box, .cartao-box {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }

        .categoria-box h3, .cartao-box h3 {
            font-size: 1.5em;
            margin-top: 0;
            margin-bottom: 15px;
            color: #34495e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .categoria-list, .cartao-list {
            flex-grow: 1; /* Permite que a lista ocupe o espaço disponível */
            margin-bottom: 15px;
            max-height: 250px; /* Limita a altura para scroll */
            overflow-y: auto; /* Adiciona scroll se o conteúdo for muito grande */
            padding-right: 5px; /* Espaçamento para a barra de rolagem */
        }

        .categoria-list::-webkit-scrollbar, .cartao-list::-webkit-scrollbar {
            width: 8px;
        }
        .categoria-list::-webkit-scrollbar-thumb, .cartao-list::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }
        .categoria-list::-webkit-scrollbar-track, .cartao-list::-webkit-scrollbar-track {
            background-color: #f1f1f1;
        }


        .categoria-list p, .cartao-list p, .compras-responsaveis li {
            background-color: #f9f9f9;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            color: #444;
            border: 1px solid #eee;
            transition: background-color 0.2s ease;
        }

        .categoria-list p:last-child, .cartao-list p:last-child, .compras-responsaveis li:last-child {
            margin-bottom: 0;
        }

        .categoria-list p:hover, .cartao-list p:hover, .compras-responsaveis li:hover {
            background-color: #f0f0f0;
        }

        .item-pago {
            text-decoration: line-through;
            color: #888;
            opacity: 0.7;
        }

        .edit-btn, .delete-btn {
            margin-left: 10px;
            cursor: pointer;
            font-size: 0.9em;
            color: #007bff;
            transition: color 0.2s ease;
        }

        .delete-btn {
            color: #dc3545;
        }

        .edit-btn:hover {
            color: #0056b3;
        }

        .delete-btn:hover {
            color: #c82333;
        }

        .item-paid-checkbox {
            margin-left: auto; /* Empurra o checkbox para a direita */
            transform: scale(1.2); /* Aumenta um pouco o tamanho */
            cursor: pointer;
        }

        .categoria-box.receitas button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            align-self: flex-start; /* Alinha o botão à esquerda no container flex */
            margin-top: 15px;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .categoria-box.receitas button:hover {
            background-color: #218838;
        }

        .categoria-box.contas .conta-total {
            font-weight: bold;
            text-align: right;
            padding-top: 10px;
            border-top: 1px solid #eee;
            margin-top: 10px;
            color: #495057;
        }

        .cartao-total {
            font-weight: bold;
            text-align: right;
            padding-top: 10px;
            border-top: 1px solid #eee;
            margin-top: 10px;
            color: #495057;
        }

        .cartao-paid {
            margin-left: 10px;
            transform: scale(1.2);
            cursor: pointer;
        }

        .compras-responsaveis .responsaveis-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            text-align: center;
        }

        .responsaveis-container .responsavel-item {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .responsaveis-container .responsavel-item h3 {
            margin-top: 0;
            color: #34495e;
            font-size: 1.4em;
        }

        .responsaveis-container .responsavel-item p {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .responsaveis-container .responsavel-item ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }

        .responsaveis-container .responsavel-item ul::-webkit-scrollbar {
            width: 8px;
        }
        .responsaveis-container .responsavel-item ul::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }
        .responsaveis-container .responsavel-item ul::-webkit-scrollbar-track {
            background-color: #f1f1f1;
        }

        .responsaveis-container .responsavel-item li {
            background-color: #f9f9f9;
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 6px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eee;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 0.9em;
        }

        footer span {
            font-weight: bold;
            margin: 0 5px;
        }

        /* Cores dos Responsáveis no rodapé */
        .liana { color: #e62e6e; } /* Roxo do Nubank, adaptado para Liana */
        .stefany { color: #007bff; } /* Azul Santander */
        .marilia { color: #1e90ff; } /* Azul Mercado Pago */
        .nosso { color: #ff9900; } /* Laranja Amazon */

        /* CORES DE FUNDO PARA COMPRAS POR RESPONSÁVEL - ADICIONADO */
        .bg-liana { background-color: #ffe0e9; /* Um rosa claro */ }
        .bg-stefany { background-color: #e0f2fe; /* Um azul bebê claro */ }
        .bg-marilia { background-color: #e6e6ff; /* Um lavanda claro */ }
        .bg-nosso { background-color: #fffacd; /* Um creme claro */ }

        @media (max-width: 768px) {
            .nav-buttons {
                position: static;
                transform: none;
                margin-top: 20px;
                padding: 0;
            }
            .totals-wrapper {
                flex-direction: column;
                gap: 10px;
            }
            .categorias-columns, .cartoes-columns, .forms-container, .compras-responsaveis .responsaveis-container {
                grid-template-columns: 1fr;
            }
            .form-section .row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Painel Financeiro</h1>
            <h2>Maio 2025</h2>
            <div class="nav-buttons">
                <button>&laquo; Mês Anterior</button>
                <button>Mês Seguinte &raquo;</button>
            </div>
        </header>

        <div class="totals-section">
            <div class="totals-wrapper">
                <span>Total de Receitas: R$ 0.00</span>
                <span>Total de Despesas: R$ 0.00</span>
            </div>
            <div class="saldo-bar-container">
                <div class="saldo-bar"></div>
                <div class="saldo-label">Saldo: R$ 0.00</div>
            </div>
        </div>

        <div class="categorias-section">
            <h2>Resumo do Mês</h2>
            <div class="categorias-columns">
                <div class="categoria-box receitas">
                    <h3>Receitas</h3>
                    <div class="categoria-list" id="listaReceitas">
                        <p>Carregando receitas...</p>
                    </div>
                    <button>Adicionar Receita</button>
                </div>

                <div class="categoria-box contas">
                    <h3>Contas Fixas</h3>
                    <div class="categoria-list" id="listaContasFixas">
                        <p>Carregando contas fixas...</p>
                    </div>
                    <div class="conta-total" id="totalContasFixas">Total: R$ 0.00</div>
                </div>

                <div class="categoria-box contas">
                    <h3>Contas Variáveis</h3>
                    <div class="categoria-list" id="listaContasVariaveis">
                        <p>Carregando contas variáveis...</p>
                    </div>
                    <div class="conta-total" id="totalContasVariaveis">Total: R$ 0.00</div>
                </div>
            </div>
        </div>

        <div class="cartoes-section" id="cartoesSection">
            <h2>Cartões</h2>
            <div class="cartoes-columns">
                <div class="cartao-box" id="nubankCard">
                    <h3>
                        NUBANK
                        <input type="checkbox" class="cartao-paid" title="Marcar todas como pagas"/>
                    </h3>
                    <div class="cartao-total">Total: R$ 0.00</div>
                    <div class="cartao-list">
                        <p>Carregando compras...</p>
                    </div>
                </div>
                <div class="cartao-box" id="santanderCard">
                    <h3>
                        SANTANDER
                        <input type="checkbox" class="cartao-paid" title="Marcar todas como pagas"/>
                    </h3>
                    <div class="cartao-total">Total: R$ 0.00</div>
                    <div class="cartao-list">
                        <p>Carregando compras...</p>
                    </div>
                </div>
                <div class="cartao-box" id="mpagoCard">
                    <h3>
                        M.PAGO
                        <input type="checkbox" class="cartao-paid" title="Marcar todas como pagas"/>
                    </h3>
                    <div class="cartao-total">Total: R$ 0.00</div>
                    <div class="cartao-list">
                        <p>Carregando compras...</p>
                    </div>
                </div>
                <div class="cartao-box" id="amazonCard">
                    <h3>
                        AMAZON
                        <input type="checkbox" class="cartao-paid" title="Marcar todas como pagas"/>
                    </h3>
                    <div class="cartao-total">Total: R$ 0.00</div>
                    <div class="cartao-list">
                        <p>Carregando compras...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="forms-container">
            <div class="form-section" id="formAdicionarCompra">
                <h2>Adicionar Compra no Cartão</h2>
                <div class="row">
                    <select id="respCompra">
                        <option value="Liana">Liana</option>
                        <option value="Stefany">Stefany</option>
                        <option value="Marília">Marília</option>
                        <option value="Nosso ❤️">Nosso ❤️</option>
                    </select>
                    <select id="cartaoCompra">
                        <option value="Nubank">NUBANK</option>
                        <option value="Santander">SANTANDER</option>
                        <option value="Mercado Pago">M.PAGO</option>
                        <option value="Amazon">AMAZON</option>
                    </select>
                </div>
                <div class="row">
                    <input type="text" placeholder="Nome da Compra" />
                </div>
                <div class="row">
                    <input type="number" placeholder="Valor" />
                    <input type="text" placeholder="Parcelas (ex: 2/6)" />
                </div>
                <button>Adicionar Compra no Cartão</button>
            </div>

            <div class="form-section" id="formAdicionarConta">
                <h2>Adicionar Conta</h2>
                <select id="tipoConta">
                    <option value="Fixa">Fixa</option>
                    <option value="Variável">Variável</option>
                </select>
                <input type="text" placeholder="Nome da Conta" />
                <input type="text" placeholder="Parcelas (ex: 2/3)" />
                <input type="number" placeholder="Valor" />
                <button>Adicionar Conta</button>
            </div>
        </div>

        <div class="compras-responsaveis">
            <h2>Total de Compras por Responsável</h2>
            <div class="responsaveis-container">
                <p>Carregando totais por responsável...</p>
            </div>
        </div>

        <footer>
            <p>
                <span class="liana">Liana</span>,
                <span class="stefany">Stefany</span>,
                <span class="marilia">Marília</span>,
                <span class="nosso">Nosso ❤️</span>
            </p>
        </footer>
    </div>

    <script>
        const webAppUrl = 'https://painel-financas-proxy.mariliaedua.workers.dev/'; // <--- SUBSTITUA AQUI PELA URL DO SEU CLOUDFLARE WORKER
        let currentMonth = new Date().getMonth(); // Mês (0-11)
        let currentYear = new Date().getFullYear();

        document.addEventListener('DOMContentLoaded', () => {
            // Definir o mês e ano iniciais no cabeçalho
            updateHeaderMonthYear();

            // Carregar todos os dados iniciais para o mês atual
            fetchAndDisplayAllData();

            // Event listeners para os botões de navegação
            document.querySelector('.nav-buttons button:first-child').addEventListener('click', () => {
                changeMonth(-1);
            });
            document.querySelector('.nav-buttons button:last-child').addEventListener('click', () => {
                changeMonth(1);
            });

            // Event listener para o botão "Adicionar Receita"
            document.querySelector('.receitas button').addEventListener('click', adicionarReceita);

            // Event listeners para o botão "Adicionar Compra no Cartão"
            document.querySelector('#formAdicionarCompra button').addEventListener('click', adicionarCompraCartao);

            // Event listeners para o botão "Adicionar Conta"
            document.querySelector('#formAdicionarConta button').addEventListener('click', adicionarConta);

            // Adiciona event listeners para os checkboxes "Marcar todas como pagas" dos cartões
            document.querySelectorAll('.cartao-paid').forEach(checkbox => {
                checkbox.addEventListener('change', async (event) => {
                    const cardBox = event.target.closest('.cartao-box');
                    const cardNameElement = cardBox.querySelector('h3').textContent.trim();
                    const cardName = convertCardNameToSheetName(cardNameElement); // Converte para o nome usado na sheet

                    const isChecked = event.target.checked;
                    const statusPago = isChecked ? 'Sim' : 'Não'; // Define o status para o backend

                    const confirmAction = isChecked
                        ? confirm(`Tem certeza que deseja marcar TODAS as compras do cartão ${cardName} como PAGAS para ${getMonthName(currentMonth + 1)}/${currentYear}?`)
                        : confirm(`Tem certeza que deseja marcar TODAS as compras do cartão ${cardName} como NÃO PAGAS para ${getMonthName(currentMonth + 1)}/${currentYear}?`);

                    if (confirmAction) {
                        // Obter as compras para este cartão e este mês/ano
                        const compras = await getComprasDoCartaoParaMes(cardName, currentMonth + 1, currentYear);

                        let successCount = 0;
                        for (const compra of compras) {
                            const payload = {
                                action: 'markCompraAsPaid',
                                recordId: compra.originalId, // Use originalId aqui para update/delete
                                data: { pago: statusPago } // Envia o status atualizado
                            };
                            try {
                                const response = await fetch(webAppUrl, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload)
                                });
                                const result = await response.json();
                                if (result.status === 'success') {
                                    successCount++;
                                } else {
                                    console.error('Erro ao atualizar compra:', result.message);
                                }
                            } catch (error) {
                                console.error('Erro na requisição de marcar compra:', error);
                            }
                        }
                        if (successCount === compras.length && compras.length > 0) {
                            alert(`Todas as ${successCount} compras do cartão ${cardName} marcadas como ${statusPago} com sucesso!`);
                        } else if (compras.length > 0) {
                            alert(`Algumas compras do cartão ${cardName} foram atualizadas como ${statusPago}. ${successCount} de ${compras.length} sucessos.`);
                        } else {
                            alert(`Nenhuma compra encontrada para o cartão ${cardName} em ${getMonthName(currentMonth + 1)}/${currentYear}.`);
                        }
                        fetchAndDisplayAllData(); // Recarrega os dados após a atualização em massa
                    } else {
                        // Se o usuário cancelar, reverter o estado do checkbox
                        event.target.checked = !isChecked;
                    }
                });
            });
        });

        // Função auxiliar para obter compras de um cartão específico para um mês/ano
        async function getComprasDoCartaoParaMes(cardName, month, year) {
            const payload = {
                action: 'getComprasPorCartao', // Ação que já retorna compras filtradas por cartão e mês
                month: month,
                year: year
            };
            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success' || (typeof result === 'object' && result[cardName])) {
                    return result[cardName].compras; // Retorna a lista de compras para o cartão específico
                } else {
                    console.error('Erro ao buscar compras por cartão:', result.message || result);
                    return [];
                }
            } catch (error) {
                console.error('Erro na requisição para buscar compras por cartão:', error);
                return [];
            }
        }

        // Função para converter o nome do cartão exibido para o nome na planilha
        function convertCardNameToSheetName(displayCardName) {
            switch (displayCardName.toUpperCase()) {
                case 'NUBANK': return 'Nubank';
                case 'SANTANDER': return 'Santander';
                case 'M.PAGO': return 'Mercado Pago';
                case 'AMAZON': return 'Amazon';
                default: return displayCardName;
            }
        }

        function updateHeaderMonthYear() {
            const monthYearHeader = document.querySelector('header h2');
            if (monthYearHeader) {
                monthYearHeader.textContent = `${getMonthName(currentMonth + 1)} ${currentYear}`;
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateHeaderMonthYear();
            fetchAndDisplayAllData(); // Recarrega todos os dados para o novo mês/ano
        }

        async function fetchAndDisplayAllData() {
            await Promise.all([
                atualizarReceitas(),
                atualizarCompras(),
                atualizarContas(),
                atualizarTotais(),
                atualizarCartoes(),
                atualizarComprasPorResponsavel()
            ]);
        }

        async function sendRequest(action, data = {}, recordId = null) {
            const payload = {
                action: action,
                data: data,
                recordId: recordId,
                month: currentMonth + 1, // Envia o mês atual (1-12)
                year: currentYear        // Envia o ano atual
            };

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                return await response.json();
            } catch (error) {
                console.error('Erro na requisição:', error);
                alert('Erro ao comunicar com o servidor: ' + error.message);
                return { status: 'error', message: 'Erro de rede.' };
            }
        }

        async function atualizarReceitas() {
            const result = await sendRequest('getReceitas');
            const lista = document.getElementById('listaReceitas');
            lista.innerHTML = '';
            if (result.status === 'error') {
                lista.innerHTML = `<p>${result.message}</p>`;
                return;
            }
            if (result.length === 0) {
                lista.innerHTML = '<p>Nenhuma receita cadastrada.</p>';
                return;
            }
            result.forEach(item => {
                const p = document.createElement('p');
                p.innerHTML = `${item.nome}: R$ ${parseFloat(item.valor).toFixed(2).replace('.', ',')}
                                <span class="edit-btn" onclick="editarReceita('${item.id}', '${item.nome}', '${item.valor}')">✏️</span>
                                <span class="delete-btn" onclick="deletarReceita('${item.id}')">🗑️</span>`;
                lista.appendChild(p);
            });
        }

        async function adicionarReceita() {
            const nome = prompt('Nome da Receita:');
            if (!nome) return;
            const valor = parseFloat(prompt('Valor da Receita:'));
            if (isNaN(valor) || valor <= 0) {
                alert('Valor inválido.');
                return;
            }
            const result = await sendRequest('addReceita', { nome: nome, valor: valor });
            if (result.status === 'success') {
                alert(result.message);
                fetchAndDisplayAllData();
            } else {
                alert('Erro: ' + result.message);
            }
        }

        async function editarReceita(id, nomeAtual, valorAtual) {
            const novoNome = prompt('Novo nome da Receita:', nomeAtual);
            if (!novoNome) return;
            const novoValor = parseFloat(prompt('Novo valor da Receita:', valorAtual));
            if (isNaN(novoValor) || novoValor <= 0) {
                alert('Valor inválido.');
                return;
            }
            const result = await sendRequest('updateReceita', { nome: novoNome, valor: novoValor }, id);
            if (result.status === 'success') {
                alert(result.message);
                fetchAndDisplayAllData();
            } else {
                alert('Erro: ' + result.message);
            }
        }

        async function deletarReceita(id) {
            if (!confirm('Tem certeza que deseja deletar esta receita?')) return;
            const result = await sendRequest('deleteReceita', {}, id);
            if (result.status === 'success') {
                alert(result.message);
                fetchAndDisplayAllData();
            } else {
                alert('Erro: ' + result.message);
            }
        }

        async function atualizarCompras() {
            const result = await sendRequest('getCompras');
            const listaContasVariaveis = document.getElementById('listaContasVariaveis');
            listaContasVariaveis.innerHTML = ''; // Limpa antes de preencher, para receber APENAS compras de cartão.

            if (result.status === 'error') {
                listaContasVariaveis.innerHTML = `<p>${result.message}</p>`;
                return;
            }
            if (result.length === 0) {
                listaContasVariaveis.innerHTML = '<p>Nenhuma compra cadastrada.</p>';
                return;
            }

            result.forEach(item => {
                // item.valor já é o valor da parcela, e item.parcelas já é "X/Y" do Apps Script
                const valorParcela = parseFloat(item.valor || 0).toFixed(2).replace('.', ',');
                const p = document.createElement('p');
                p.className = item.pago === 'Sim' ? 'item-pago' : '';
                p.innerHTML = `${item.nome} (${item.parcelas}) - R$ ${valorParcela} (${item.cartao})
                                <span class="edit-btn" onclick="editarCompra('${item.originalId}', '${item.nome}', '${item.valor}', '${item.parcelas}', '${item.responsavel}', '${item.cartao}')">✏️</span>
                                <span class="delete-btn" onclick="deletarCompra('${item.originalId}')">🗑️</span>
                                <input type="checkbox" class="item-paid-checkbox" data-id="${item.originalId}" data-type="compra" ${item.pago === 'Sim' ? 'checked' : ''} title="Marcar como pago"/>`;
                listaContasVariaveis.appendChild(p);
            });
            addCheckboxListeners();
        }

        async function adicionarCompraCartao() {
            const respCompra = document.querySelector('#respCompra').value;
            const cartaoCompra = document.querySelector('#cartaoCompra').value;
            const nomeCompra = document.querySelector('#formAdicionarCompra input[placeholder="Nome da Compra"]').value;
            const valorCompra = parseFloat(document.querySelector('#formAdicionarCompra input[placeholder="Valor"]').value);
            const parcelasCompra = document.querySelector('#formAdicionarCompra input[placeholder="Parcelas (ex: 2/6)"]').value;

            if (!nomeCompra || isNaN(valorCompra) || valorCompra <= 0 || !parcelasCompra) {
                alert('Por favor, preencha todos os campos corretamente.');
                return;
            }

            const data = {
                responsavel: respCompra,
                cartao: cartaoCompra,
                nome: nomeCompra,
                valor: valorCompra,
                parcelas: parcelasCompra
            };

            const result = await sendRequest('addCompraCartao', data);
            if (result.status === 'success') {
                alert(result.message);
                document.querySelector('#formAdicionarCompra input[placeholder="Nome da Compra"]').value = '';
                document.querySelector('#formAdicionarCompra input[placeholder="Valor"]').value = '';
                document.querySelector('#formAdicionarCompra input[placeholder="Parcelas (ex: 2/6)"]').value = '';
                fetchAndDisplayAllData();
            } else {
                alert('Erro: ' + result.message);
            }
        }

        async function editarCompra(id, nomeAtual, valorAtual, parcelasAtual, responsavelAtual, cartaoAtual) {
            const novoNome = prompt('Novo nome da Compra:', nomeAtual);
            if (!novoNome) return;
            const novoValor = parseFloat(prompt('Novo valor da Compra:', valorAtual));
            if (isNaN(novoValor) || novoValor <= 0) {
                alert('Valor inválido.');
                return;
            }
            const novasParcelas = prompt('Novas Parcelas (ex: 2/6):', parcelasAtual);
            if (!novasParcelas) return;
            const novoResponsavel = prompt('Novo Responsável:', responsavelAtual);
            if (!novoResponsavel) return;
            const novoCartao = prompt('Novo Cartão:', cartaoAtual);
            if (!novoCartao) return;

            const data = {
                nome: novoNome,
                valor: novoValor,
                parcelas: novasParcelas,
                responsavel: novoResponsavel,
                cartao: novoCartao
            };
            const result = await sendRequest('updateCompra', data, id);
            if (result.status === 'success') {
                alert(result.message);
                fetchAndDisplayAllData();
            } else {
                alert('Erro: ' + result.message);
            }
        }

        async function deletarCompra(id) {
            if (!confirm('Tem certeza que deseja deletar esta compra?')) return;
            const result = await sendRequest('deleteCompra', {}, id);
            if (result.status === 'success') {
                alert(result.message);
                fetchAndDisplayAllData();
            } else {
                alert('Erro: ' + result.message);
            }
        }

        async function atualizarContas() {
            const result = await sendRequest('getContas');
            const listaFixas = document.getElementById('listaContasFixas');
            const listaVariaveis = document.getElementById('listaContasVariaveis'); // Esta lista agora receberá APENAS contas variáveis

            listaFixas.innerHTML = '';
            listaVariaveis.innerHTML = ''; // Limpa esta lista para preencher com contas variáveis

            if (result.status === 'error') {
                listaFixas.innerHTML = `<p>${result.message}</p>`;
                listaVariaveis.innerHTML = `<p>${result.message}</p>`; // Mostrar erro em ambos
                return;
            }

            let totalFixas = 0;
            let totalVariaveis = 0;

            if (result.length === 0) {
                listaFixas.innerHTML = '<p>Nenhuma conta cadastrada.</p>';
                listaVariaveis.innerHTML += '<p>Nenhuma conta variável cadastrada.</p>';
                return;
            }

            result.forEach(item => {
                // item.valor já é o valor da parcela, e item.parcelas já é "X/Y" do Apps Script
                const valorParcela = parseFloat(item.valor || 0).toFixed(2).replace('.', ',');
                const p = document.createElement('p');
                p.className = item.pago === 'Sim' ? 'item-pago' : '';
                p.innerHTML = `${item.nome} (${item.parcelas}) - R$ ${valorParcela}
                                <span class="edit-btn" onclick="editarConta('${item.originalId}', '${item.tipo}', '${item.nome}', '${item.valor}', '${item.parcelas}')">✏️</span>
                                <span class="delete-btn" onclick="deletarConta('${item.originalId}')">🗑️</span>
                                <input type="checkbox" class="item-paid-checkbox" data-id="${item.originalId}" data-type="conta" ${item.pago === 'Sim' ? 'checked' : ''} title="Marcar como pago"/>`;

                if (item.tipo === 'Fixa') {
                    listaFixas.appendChild(p);
                    totalFixas += parseFloat(valorParcela.replace(',', '.'));
                } else if (item.tipo === 'Variável') {
                    listaVariaveis.appendChild(p);
                    totalVariaveis += parseFloat(valorParcela.replace(',', '.'));
                }
            });

            document.getElementById('totalContasFixas').textContent = `Total: R$ ${totalFixas.toFixed(2).replace('.', ',')}`;
            // O total das contas variáveis será somado ao total de compras no atualizarTotais
            // document.getElementById('totalContasVariaveis').textContent = `Total: R$ ${totalVariaveis.toFixed(2).replace('.', ',')}`; // Não exibe aqui para evitar confusão com compras.
            addCheckboxListeners();
        }

        async function adicionarConta() {
            const tipoConta = document.querySelector('#tipoConta').value;
            const nomeConta = document.querySelector('#formAdicionarConta input[placeholder="Nome da Conta"]').value;
            const parcelasConta = document.querySelector('#formAdicionarConta input[placeholder="Parcelas (ex: 2/3)"]').value;
            const valorConta = parseFloat(document.querySelector('#formAdicionarConta input[placeholder="Valor"]').value);

            if (!nomeConta || isNaN(valorConta) || valorConta <= 0 || !parcelasConta) {
                alert('Por favor, preencha todos os campos corretamente.');
                return;
            }

            const data = {
                tipo: tipoConta,
                nome: nomeConta,
                parcelas: parcelasConta,
                valor: valorConta
            };

            const result = await sendRequest('addConta', data);
            if (result.status === 'success') {
                alert(result.message);
                document.querySelector('#formAdicionarConta input[placeholder="Nome da Conta"]').value = '';
                document.querySelector('#formAdicionarConta input[placeholder="Parcelas (ex: 2/3)"]').value = '';
                document.querySelector('#formAdicionarConta input[placeholder="Valor"]').value = '';
                fetchAndDisplayAllData();
            } else {
                alert('Erro: ' + result.message);
            }
        }

        async function editarConta(id, tipoAtual, nomeAtual, valorAtual, parcelasAtual) {
            const novoTipo = prompt('Novo tipo de Conta (Fixa/Variável):', tipoAtual);
            if (!novoTipo) return;
            const novoNome = prompt('Novo nome da Conta:', nomeAtual);
            if (!novoNome) return;
            const novoValor = parseFloat(prompt('Novo valor da Conta:', valorAtual));
            if (isNaN(novoValor) || novoValor <= 0) {
                alert('Valor inválido.');
                return;
            }
            const novasParcelas = prompt('Novas Parcelas (ex: 2/3):', parcelasAtual);
            if (!novasParcelas) return;

            const data = {
                tipo: novoTipo,
                nome: novoNome,
                valor: novoValor,
                parcelas: novasParcelas
            };
            const result = await sendRequest('updateConta', data, id);
            if (result.status === 'success') {
                alert(result.message);
                fetchAndDisplayAllData();
            } else {
                alert('Erro: ' + result.message);
            }
        }

        async function deletarConta(id) {
            if (!confirm('Tem certeza que deseja deletar esta conta?')) return;
            const result = await sendRequest('deleteConta', {}, id);
            if (result.status === 'success') {
                alert(result.message);
                fetchAndDisplayAllData();
            } else {
                alert('Erro: ' + result.message);
            }
        }

        async function atualizarTotais() {
            const result = await sendRequest('getTotais');
            if (result.status === 'error') {
                document.querySelector('.totals-section .totals-wrapper span:first-child').textContent = `Total de Receitas: Erro`;
                document.querySelector('.totals-section .totals-wrapper span:last-child').textContent = `Total de Despesas: Erro`;
                document.querySelector('.saldo-label').textContent = `Saldo: Erro`;
                document.querySelector('.saldo-bar').style.width = '0%';
                document.querySelector('.saldo-bar').style.backgroundColor = 'gray';
                return;
            }

            const totalReceitas = result.receitas || 0;
            const totalDespesas = result.despesas || 0;
            const saldo = result.saldo || 0;

            document.querySelector('.totals-section .totals-wrapper span:first-child').textContent = `Total de Receitas: R$ ${totalReceitas.toFixed(2).replace('.', ',')}`;
            document.querySelector('.totals-section .totals-wrapper span:last-child').textContent = `Total de Despesas: R$ ${totalDespesas.toFixed(2).replace('.', ',')}`;
            document.querySelector('.saldo-label').textContent = `Saldo: R$ ${saldo.toFixed(2).replace('.', ',')}`;

            // Atualiza a barra de saldo
            const saldoBar = document.querySelector('.saldo-bar');
            if (totalReceitas > 0) {
                let percentage = (saldo / totalReceitas) * 100;
                percentage = Math.max(0, Math.min(100, percentage));
                saldoBar.style.width = `${percentage}%`;
                if (saldo > 0) {
                    saldoBar.style.backgroundColor = '#28a745'; // Verde
                } else {
                    saldoBar.style.backgroundColor = '#dc3545'; // Vermelho
                }
            } else {
                saldoBar.style.width = '0%';
                saldoBar.style.backgroundColor = 'gray';
            }
        }

        async function atualizarCartoes() {
            const result = await sendRequest('getComprasPorCartao');
            if (result.status === 'error') {
                document.getElementById('nubankCard').querySelector('.cartao-list').innerHTML = `<p>${result.message}</p>`;
                document.getElementById('santanderCard').querySelector('.cartao-list').innerHTML = `<p>${result.message}</p>`;
                document.getElementById('mpagoCard').querySelector('.cartao-list').innerHTML = `<p>${result.message}</p>`;
                document.getElementById('amazonCard').querySelector('.cartao-list').innerHTML = `<p>${result.message}</p>`;
                return;
            }

            const cartoes = {
                'Nubank': 'nubankCard',
                'Santander': 'santanderCard',
                'Mercado Pago': 'mpagoCard',
                'Amazon': 'amazonCard'
            };

            for (const cartaoNome in cartoes) {
                const elementId = cartoes[cartaoNome];
                const cardBox = document.getElementById(elementId);
                if (cardBox) {
                    const listElement = cardBox.querySelector('.cartao-list');
                    const totalElement = cardBox.querySelector('.cartao-total');
                    listElement.innerHTML = '';

                    const data = result[cartaoNome];
                    if (data && data.compras.length > 0) {
                        let currentCardTotal = 0;
                        data.compras.forEach(compra => {
                            const p = document.createElement('p');
                            p.className = compra.pago === 'Sim' ? 'item-pago' : '';
                            // ADICIONADO: Aplica a cor de fundo do responsável
                            p.classList.add(getResponsavelClass(compra.responsavel));

                            // Usando compra.parcelas que já deve estar no formato "X/Y" do Apps Script
                            p.innerHTML = `${compra.nome} (${compra.parcelas}) - R$ ${parseFloat(compra.valor).toFixed(2).replace('.', ',')}
                                            <input type="checkbox" class="item-paid-checkbox" data-id="${compra.originalId}" data-type="compra" ${compra.pago === 'Sim' ? 'checked' : ''} title="Marcar como pago"/>`;
                            listElement.appendChild(p);
                            currentCardTotal += parseFloat(compra.valor);
                        });
                        totalElement.textContent = `Total: R$ ${currentCardTotal.toFixed(2).replace('.', ',')}`;
                    } else {
                        listElement.innerHTML = '<p>Nenhuma compra neste cartão.</p>';
                        totalElement.textContent = `Total: R$ 0,00`;
                    }
                }
            }
            addCheckboxListeners();
        }

        async function atualizarComprasPorResponsavel() {
            const result = await sendRequest('getComprasPorResponsavel');
            const responsaveisContainer = document.querySelector('.responsaveis-container');
            responsaveisContainer.innerHTML = '';

            if (result.status === 'error') {
                responsaveisContainer.innerHTML = `<p>${result.message}</p>`;
                return;
            }

            const responsaveis = ['Liana', 'Stefany', 'Marília', 'Nosso ❤️'];

            responsaveis.forEach(responsavel => {
                const div = document.createElement('div');
                div.className = 'responsavel-item';

                const total = result[responsavel] ? parseFloat(result[responsavel].total).toFixed(2).replace('.', ',') : '0,00';
                div.innerHTML = `<h3>${responsavel}</h3><p>Total: R$ ${total}</p>`;

                const ul = document.createElement('ul');
                if (result[responsavel] && result[responsavel].compras.length > 0) {
                    result[responsavel].compras.forEach(compra => {
                        const li = document.createElement('li');
                        li.className = compra.pago === 'Sim' ? 'item-pago' : '';
                        // ADICIONADO: Aplica a cor de fundo do responsável
                        li.classList.add(getResponsavelClass(compra.responsavel));

                        // Usando compra.parcelas que já deve estar no formato "X/Y" do Apps Script
                        li.innerHTML = `${compra.nome} (${compra.parcelas}) - R$ ${parseFloat(compra.valor).toFixed(2).replace('.', ',')} (${compra.cartao})
                                            <input type="checkbox" class="item-paid-checkbox" data-id="${compra.originalId}" data-type="compra" ${compra.pago === 'Sim' ? 'checked' : ''} title="Marcar como pago"/>`;
                        ul.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'Nenhuma compra.';
                    ul.appendChild(li);
                }
                div.appendChild(ul);
                responsaveisContainer.appendChild(div);
            });
            addCheckboxListeners();
        }

        function addCheckboxListeners() {
            document.querySelectorAll('.item-paid-checkbox').forEach(checkbox => {
                checkbox.removeEventListener('change', handleItemPaidCheckboxChange);
                checkbox.addEventListener('change', handleItemPaidCheckboxChange);
            });
        }

        async function handleItemPaidCheckboxChange(event) {
            const checkbox = event.target;
            const itemId = checkbox.dataset.id;
            const itemType = checkbox.dataset.type;
            const isChecked = checkbox.checked;
            const statusPago = isChecked ? 'Sim' : 'Não';

            const action = itemType === 'compra' ? 'markCompraAsPaid' : 'markContaAsPaid';

            if (!confirm(`Tem certeza que deseja marcar este item como ${statusPago}?`)) {
                checkbox.checked = !isChecked;
                return;
            }

            const result = await sendRequest(action, { pago: statusPago }, itemId);
            if (result.status === 'success') {
                alert(`Item marcado como ${statusPago} com sucesso!`);
                fetchAndDisplayAllData();
            } else {
                alert('Erro ao atualizar item: ' + result.message);
                checkbox.checked = !isChecked;
            }
        }

        function getMonthName(monthNumber) {
            const date = new Date();
            date.setMonth(monthNumber - 1);
            return date.toLocaleString('pt-BR', { month: 'long' }).charAt(0).toUpperCase() + date.toLocaleString('pt-BR', { month: 'long' }).slice(1);
        }

        // FUNÇÃO ADICIONADA: Retorna a classe CSS para a cor de fundo do responsável
        function getResponsavelClass(responsavel) {
            switch (responsavel) {
                case 'Liana':
                    return 'bg-liana';
                case 'Stefany':
                    return 'bg-stefany';
                case 'Marília':
                    return 'bg-marilia';
                case 'Nosso ❤️':
                    return 'bg-nosso';
                default:
                    return ''; // Retorna vazio se não encontrar correspondência
            }
        }
    </script>
</body>
</html>
