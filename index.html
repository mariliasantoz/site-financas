<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
    <style>
      /* CONFIGURAÇÃO GERAL */
      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        color: black; /* Texto padrão em preto */
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      .form-section,
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
      }
      /* BOTÕES */
      button {
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        padding: 8px 12px;
      }
      button:hover {
        background-color: #43a047;
      }
      /* Força inputs e selects a terem texto preto */
      input, select {
        color: black;
      }
      /* CENTRALIZAÇÃO DOS TÍTULOS */
      h1, h2, h3 {
        text-align: center;
      }
      /* CABEÇALHO E NAVEGAÇÃO */
      header {
        text-align: center;
        margin-bottom: 10px;
      }
      header h1 {
        margin: 0;
        font-size: 2.5em;
      }
      header h2 {
        margin: 5px 0 10px;
        font-size: 2em;
      }
      .nav-buttons {
        text-align: center;
        margin-bottom: 20px;
      }
      .nav-buttons button {
        padding: 10px 15px;
        margin: 0 10px;
      }
      /* TOTAIS – RESUMO DO MÊS */
      .totals-section {
        margin-bottom: 20px;
        padding: 15px;
      }
      .totals-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.2em;
      }
      .saldo-bar-container {
        position: relative;
        background-color: #ddd;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .saldo-bar {
        height: 100%;
        width: 0%; /* Start at 0, JS will update */
        background-color: green; /* Default to green, JS will update */
        transition: width 0.5s, background-color 0.5s;
      }
      .saldo-label {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        font-weight: bold;
        color: black;
        line-height: 20px; /* Match bar height */
      }
      /* CATEGORIAS – Receitas, Contas Fixas, Contas Variáveis */
      .categorias-section {
        margin-bottom: 20px;
        padding: 15px;
      }
      .categorias-section h2 {
        margin: 0 0 15px;
        font-size: 1.8em;
      }
      .categorias-columns {
        display: flex;
        justify-content: space-between;
        gap: 15px;
      }
      /* CAIXA RECEITAS */
      .categoria-box.receitas {
        width: 32%;
        padding: 10px;
      }
      .categoria-box.receitas h3 {
        margin: 0 0 10px;
        font-size: 1.2em;
        border-bottom: 1px solid #90caf9;
        padding-bottom: 5px;
        text-align: center;
      }
      .categoria-box.receitas .categoria-list .receita-item {
        margin-bottom: 8px;
        text-align: center;
      }
      .categoria-box.receitas .categoria-list .receita-item input {
        padding: 5px;
        margin: 5px;
        box-sizing: border-box;
      }
      /* CAIXA CONTAS FIXAS/VARIÁVEIS */
      .categoria-box.contas {
        width: 32%;
        padding: 10px;
      }
      .categoria-box.contas h3 {
        margin: 0 0 10px;
        font-size: 1.2em;
        border-bottom: 1px solid #90caf9;
        padding-bottom: 5px;
      }
      .categoria-box.contas .categoria-list .conta-item {
        padding: 5px;
        font-size: 0.9em;
        border-bottom: 1px dashed #90caf9;
        text-align: center;
      }
      .categoria-box.contas .categoria-list .conta-item:last-child {
        border-bottom: none;
      }
      .categoria-box.contas .conta-total {
        text-align: right;
        font-weight: bold;
        margin-top: 5px;
      }
      .categoria-box.receitas button {
        display: block;
        margin: 10px auto 0;
      }
      /* FORMULÁRIOS */
      .form-section {
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .form-section h2 {
        margin: 0 0 15px;
        font-size: 1.8em;
      }
      .form-section .row {
        width: 100%;
        text-align: center;
        margin: 10px 0;
      }
      .form-section select,
      .form-section input {
        width: 20%;
        padding: 8px;
        margin: 5px;
        box-sizing: border-box;
      }
      .form-section .nome-field {
        width: 40% !important;
      }
      .forms-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .forms-container > .form-section {
        width: 50%;
      }
      /* CARTÕES */
      .cartoes-section {
        margin-bottom: 20px;
        padding: 15px;
      }
      .cartoes-section h2 {
        margin-top: 0;
        font-size: 1.8em;
      }
      .cartoes-columns {
        display: flex;
        justify-content: space-between;
        gap: 15px;
      }
      .cartao-box {
        width: 23%;
        padding: 10px;
        text-align: center;
        border: 1px solid #90caf9;
        border-radius: 5px;
      }
      .cartao-box h3 {
        margin: 0 0 10px;
        font-size: 1.2em;
        border-bottom: 1px solid;
        padding-bottom: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .cartao-total {
        margin: 10px 0;
        font-weight: bold;
        color: black;
      }
      .cartao-list div.compra {
        padding: 5px;
        font-size: 0.9em;
        border-bottom: 1px dashed;
        color: black;
        text-align: left; /* Align compra details left */
      }
      .cartao-list div.compra:last-child {
        border-bottom: none;
      }
      /* Cartões Personalizados */
      #nubankCard {
        background: linear-gradient(to bottom, #e8ccf5, #d1a9ea, #ba86e0, #8605b8);
        border: 1px solid #8605b8;
      }
      #santanderCard {
        background: linear-gradient(to bottom, #ffe6e6, #ffcccc, #ffb3b3, #e50000);
        border: 1px solid #e50000;
      }
      #mpagoCard {
        background: linear-gradient(to bottom, #d1e0f0, #a3c1e1, #75a2d2, #1c3d91);
        border: 1px solid #1c3d91;
      }
      #amazonCard {
        background: linear-gradient(to bottom, #ff9700, #d47c00, #aa6100, #222e3d);
        border: 1px solid #222e3d;
      }
      /* TOTAL DE COMPRAS POR RESPONSÁVEL - CENTRALIZADO */
      .compras-responsaveis {
        margin-bottom: 20px;
        padding: 15px;
        text-align: center;
      }
      .compras-responsaveis h2 {
        margin-bottom: 15px;
        font-size: 1.8em;
      }
      .responsaveis-container {
        display: flex;
        justify-content: space-around;
        gap: 15px;
        flex-wrap: wrap;
      }
      .responsavel-box {
        width: 22%;
        padding: 10px;
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
        text-align: center;
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em;
      }
      .responsavel-box p {
        margin: 5px 0;
        font-size: 0.9em;
      }
      /* Cores para Responsáveis (background on list items) */
      .liana {
        background-color: #add8e6 !important; /* Use !important if needed to override card background */
        padding: 4px 8px;
        border-radius: 3px;
        display: inline-block; /* Ensure background applies correctly */
      }
      .stefany {
        background-color: #ffb347 !important;
        padding: 4px 8px;
        border-radius: 3px;
        display: inline-block;
      }
      .marilia {
        background-color: #dda0dd !important;
        padding: 4px 8px;
        border-radius: 3px;
        display: inline-block;
      }
      .nosso {
        background-color: #ffc0cb !important;
        padding: 4px 8px;
        border-radius: 3px;
        display: inline-block;
      }
      /* Cores para Responsáveis (footer legend) */
      footer p span.liana-legend { background-color: #add8e6; padding: 2px 5px; border-radius: 3px; }
      footer p span.stefany-legend { background-color: #ffb347; padding: 2px 5px; border-radius: 3px; }
      footer p span.marilia-legend { background-color: #dda0dd; padding: 2px 5px; border-radius: 3px; }
      footer p span.nosso-legend { background-color: #ffc0cb; padding: 2px 5px; border-radius: 3px; }

      /* RODAPÉ */
      footer {
        text-align: center;
        margin-top: 20px;
      }
      footer p span {
        margin: 0 5px;
        font-weight: bold;
      }
      .list-item-controls {
          display: flex;
          justify-content: flex-end; /* Alinha botões à direita */
          gap: 5px;
          margin-top: 5px;
      }
      .list-item-controls button {
          padding: 3px 8px;
          font-size: 0.8em;
          margin-left: 5px;
      }
      .list-item-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .checkbox-pago {
        margin-left: 10px;
        transform: scale(1.2); /* Aumenta o tamanho do checkbox */
      }
      .cartao-paid {
        margin-left: 10px; /* Space between title and checkbox */
        transform: scale(1.2);
      }
    </style>
    <script>
      // *** AQUI É ONDE A URL DO SEU CLOUDFLARE WORKER DEVE ENTRAR ***
      const webAppUrl = "https://painel-financas-proxy.mariliaedua.workers.dev/";
      // ***************************************************************
      
      let currentMonth = new Date().getMonth(); // 0-Janeiro, 1-Fevereiro, etc.
      let currentYear = new Date().getFullYear();

      const monthNames = [
        "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
      ];

      function updateMonthDisplay() {
        document.querySelector("header h2").textContent = `${monthNames[currentMonth]} ${currentYear}`;
      }

      function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        } else if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        updateMonthDisplay();
        // Recarrega todos os dados para o novo mês/ano
        // Passando month e year para as funções de atualização
        atualizarTodosOsDados();
      }

      function atualizarTodosOsDados() {
          const month = currentMonth + 1; // Apps Script usa mês 1-12
          const year = currentYear;
          console.log(`Atualizando dados para ${month}/${year}`);
          atualizarReceitas(month, year);
          atualizarContas(month, year);
          atualizarCartoes(month, year);
          atualizarComprasPorResponsavel(month, year);
          atualizarTotais(month, year);
      }

      // RECEITAS
      function atualizarReceitas(month, year) {
        // Nota: A função getReceitas no Apps Script atual não filtra por mês/ano.
        // Se for necessário filtrar, o Apps Script precisará ser modificado.
        const payload = { action: "getReceitas" }; 
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          const container = document.getElementById("listaReceitas");
          container.innerHTML = "";
          if (data && Array.isArray(data) && data.length > 0) {
            data.forEach(item => {
              const div = document.createElement("div");
              div.classList.add("receita-item");
              div.innerHTML = `
                <div class="list-item-content">
                  <span>${item.nome} - R$ ${Number(item.valor).toFixed(2)}</span>
                  <div class="list-item-controls">
                    <button onclick='editReceitaFront("${item.id}")'>Edit</button>
                    <button onclick='deleteReceitaFront("${item.id}")'>X</button>
                  </div>
                </div>
              `;
              container.appendChild(div);
            });
          } else {
            container.innerHTML = "<p>Nenhuma receita cadastrada.</p>";
          }
        })
        .catch(error => {
          console.error("Erro ao carregar receitas:", error);
          document.getElementById("listaReceitas").innerHTML = "<p>Erro ao carregar receitas.</p>";
        });
      }
      
      function deleteReceitaFront(recordId) {
        if (!confirm("Tem certeza que deseja excluir esta receita?")) return;
        const payload = { action: "deleteReceita", recordId: recordId };
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          atualizarTodosOsDados(); // Recarrega tudo
        })
        .catch(error => {
          alert("Erro ao excluir receita: " + error.message);
        });
      }
      
      function editReceitaFront(recordId) {
        let novoNome = prompt("Digite o novo nome da receita:");
        if (novoNome === null) return; // Usuário cancelou
        let novoValor = prompt("Digite o novo valor da receita:");
        if (novoValor === null) return; // Usuário cancelou

        novoValor = parseFloat(novoValor.replace(',', '.'));
        if (isNaN(novoValor)) {
          alert("Valor inválido. Digite um número.");
          return;
        }

        const payload = {
          action: "updateReceita",
          recordId: recordId,
          data: { nome: novoNome, valor: novoValor }
        };
        fetch(webAppUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          atualizarTodosOsDados(); // Recarrega tudo
        })
        .catch(error => {
          alert("Erro ao editar receita: " + error.message);
        });
      }

      function submitReceita() {
          const nome = prompt("Nome da Receita:");
          if (nome === null || nome.trim() === "") {
              alert("Nome da receita não pode ser vazio.");
              return;
          }
          const valor = prompt("Valor da Receita:");
          if (valor === null || valor.trim() === "") {
              alert("Valor da receita não pode ser vazio.");
              return;
          }
          const valorFloat = parseFloat(valor.replace(',', '.'));
          if (isNaN(valorFloat)) {
              alert("Valor inválido. Digite um número.");
              return;
          }

          const payload = {
              action: "addReceita",
              data: { nome: nome, valor: valorFloat }
          };

          fetch(webAppUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
          })
          .then(response => response.json())
          .then(data => {
              alert(data.message);
              atualizarTodosOsDados(); // Recarrega tudo
          })
          .catch(error => {
              alert("Erro
(Content truncated due to size limit. Use line ranges to read in chunks)
