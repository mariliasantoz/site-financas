<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Painel Financeiro</title>
    <style>
      /* CONFIGURAÇÃO GERAL */
      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 20px;
        color: black; /* Texto padrão em preto */
      }
      .container {
        max-width: 1200px;
        margin: auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
      }
      /* Caixas (exceto o container principal) */
      .totals-section,
      .categorias-section,
      .form-sections-wrapper, /* Aplicar ao wrapper dos forms */
      .form-section, /* Aplicar a cada form individual */
      .cartoes-section,
      .compras-responsaveis,
      .categoria-box,
      .responsavel-box,
      .cartao-box {
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 5px;
        margin-bottom: 20px; /* Espaçamento entre seções */
        padding: 15px;
      }

      /* BOTÕES */
      button {
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #45a049;
      }
      button.delete-button {
        background-color: #f44336;
        margin-left: 5px;
      }
      button.delete-button:hover {
        background-color: #da190b;
      }
      button.edit-button {
        background-color: #ff9800;
        margin-left: 5px;
      }
      button.edit-button:hover {
        background-color: #e68a00;
      }

      /* CABEÇALHO */
      header {
        text-align: center;
        margin-bottom: 20px;
        position: relative;
      }
      header h1 {
        color: #333;
        margin-bottom: 10px;
      }
      header h2 {
        color: #555;
        margin-top: 0;
        /* Adicionado para centralizar melhor com botões */
        display: inline-block;
        position: relative;
        padding: 0 120px; /* Espaço para os botões não sobreporem */
      }
      .nav-buttons {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          width: 100%;
          display: flex;
          justify-content: space-between;
          padding: 0 20px;
          box-sizing: border-box;
          /* Ajuste para alinhar com o H2 */
          left: 0;
      }
      .nav-buttons button {
          background-color: #007bff;
          color: white;
          padding: 5px 10px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 1em;
      }
      .nav-buttons button:hover {
          background-color: #0056b3;
      }

      /* SEÇÃO DE TOTAIS */
      .totals-section {
        /* padding: 15px; */ /* Removido pois já está na regra geral */
        /* margin-bottom: 20px; */ /* Removido pois já está na regra geral */
      }
      .totals-wrapper {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        font-weight: bold;
        color: #333;
      }
      .saldo-bar-container {
        background-color: #ddd;
        border-radius: 5px;
        height: 25px;
        margin-top: 10px;
        overflow: hidden; /* Garante que a barra não vaze */
        position: relative;
      }
      .saldo-bar {
        height: 100%;
        width: 0%; /* Inicia em 0, será ajustada via JS */
        background-color: green; /* Cor para saldo positivo */
        border-radius: 5px;
        transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
      }
      .saldo-bar.negative {
        background-color: red; /* Cor para saldo negativo */
      }
      .saldo-label {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      }

      /* SEÇÃO DE CATEGORIAS (Receitas, Contas Fixas, Variáveis) */
      .categorias-section {
        /* padding: 15px; */
        /* margin-bottom: 20px; */
      }
      .categorias-columns {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
      .categoria-box {
        /* padding: 15px; */
        text-align: center;
        display: flex;
        flex-direction: column;
      }
      .categoria-box h3 {
        margin-top: 0;
        color: #333;
      }
      .categoria-list {
        text-align: left;
        margin-bottom: 10px;
        flex-grow: 1; /* Permite que a lista ocupe o espaço disponível */
        min-height: 50px; /* Altura mínima para evitar colapso */
      }
      .categoria-list p {
        margin: 5px 0;
        color: #555;
      }
      .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px dashed #c0c0c0;
      }
      .list-item:last-child {
        border-bottom: none;
      }
      .list-item span {
        flex-grow: 1;
        text-align: left;
        margin-right: 10px; /* Espaço antes dos botões */
      }
      .list-item-controls {
          display: flex;
          justify-content: flex-end;
          align-items: center;
          flex-shrink: 0; /* Impede que os controles encolham */
      }
      .list-item-controls button {
          margin-left: 5px;
          padding: 4px 8px;
          font-size: 0.8em;
      }
      .list-item-controls input[type="checkbox"] {
          margin-left: 5px;
          width: 16px;
          height: 16px;
      }
      .categoria-box .total-categoria {
        font-weight: bold;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #c0c0c0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* Checkbox de pago para o total da categoria */
      .total-categoria .checkbox-pago-total {
          margin-left: 10px;
          width: 20px; /* Ajuste o tamanho conforme necessário */
          height: 20px;
          cursor: pointer;
      }

      /* SEÇÃO DE CARTÕES */
      .cartoes-section {
        /* padding: 15px; */
        /* margin-bottom: 20px; */
      }
      .cartoes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }
      .cartao-box {
        /* background-color: #f0f8ff; */ /* Cor base será definida por cartão */
        /* border: 1px solid #a7d9f7; */ /* Cor base será definida por cartão */
        border-radius: 5px;
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
      }
      /* Cores específicas por cartão */
      .cartao-box.nubank { background-color: #f3e5f5; border: 1px solid #ce93d8; }
      .cartao-box.santander { background-color: #ffebee; border: 1px solid #ef9a9a; }
      .cartao-box.mercadopago { background-color: #e3f2fd; border: 1px solid #90caf9; } /* M.Pago */
      .cartao-box.amazon { background-color: #fff3e0; border: 1px solid #ffcc80; }
      .cartao-box.c6 { background-color: #e0e0e0; border: 1px solid #bdbdbd; } /* Cinza para C6 */
      .cartao-box.itaú { background-color: #fff3e0; border: 1px solid #ffb74d; } /* Laranja para Itaú */
      .cartao-box.bradesco { background-color: #ffebee; border: 1px solid #e57373; } /* Vermelho claro Bradesco */
      .cartao-box.inter { background-color: #ffecb3; border: 1px solid #ffca28; } /* Laranja Inter */

      .cartao-box h3 {
        margin-top: 0;
        color: #333;
      }
      .cartao-list {
        text-align: left;
        margin-bottom: 10px;
        flex-grow: 1;
        min-height: 50px; /* Altura mínima */
      }
      .cartao-list p {
        margin: 5px 0;
        color: #555;
      }
      .cartao-box .total-cartao {
        font-weight: bold;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #a7d9f7; /* Manter uma cor neutra para a linha */
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .cartao-box .total-cartao .checkbox-pago-total {
          margin-left: 10px;
          width: 20px;
          height: 20px;
          cursor: pointer;
      }
      .compra {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px;
        border-bottom: 1px dashed #c0c0c0;
        border-radius: 3px; /* Leve arredondamento */
        margin-bottom: 3px; /* Pequeno espaço entre compras */
      }
      .compra:last-child {
        border-bottom: none;
      }
      .compra .list-item-content {
          flex-grow: 1;
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-right: 5px; /* Espaço antes dos controles */
      }
      .compra .list-item-content span {
          flex-grow: 1;
          text-align: left;
          font-size: 0.9em;
      }
      .compra .list-item-controls {
          flex-shrink: 0;
      }

      /* SEÇÃO DE FORMULÁRIOS */
      .form-sections-wrapper {
        display: flex;
        gap: 20px;
        /* margin-bottom: 20px; */ /* Removido, já na regra geral */
        /* background-color e border já na regra geral */
        /* padding: 15px; */ /* Removido, já na regra geral */
      }
      .form-section {
        flex: 1;
        text-align: center;
        /* Remover padding e margin-bottom individuais */
        padding: 0; 
        margin-bottom: 0;
        border: none; /* Remover borda individual */
        background-color: transparent; /* Fundo transparente */
      }
      .form-section h2 {
        margin-top: 0;
        margin-bottom: 15px; /* Espaço abaixo do título */
        color: #333;
      }
      .form-section label { /* Estilo para labels se adicionados */
        display: block;
        margin-bottom: 5px;
        text-align: left;
        font-weight: bold;
        font-size: 0.9em;
      }
      .form-section input[type="text"],
      .form-section input[type="number"],
      .form-section select {
        width: 100%; /* Ocupar largura total do container pai */
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .form-section .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center; /* Alinha itens na linha */
      }
      .form-section .row input,
      .form-section .row select {
        flex-grow: 1;
        margin-bottom: 0; /* Remove margem inferior dentro da linha */
      }
      .form-section button {
        width: 100%; /* Botão ocupa largura total */
        margin-top: 10px; /* Espaço acima do botão */
      }

      /* SEÇÃO DE COMPRAS POR RESPONSÁVEL */
      .compras-responsaveis {
        /* padding: 15px; */
        /* margin-bottom: 20px; */
        text-align: center;
      }
      .compras-responsaveis h2 {
        margin-top: 0;
        color: #333;
      }
      .responsaveis-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Aumentar minmax */
        gap: 20px;
        margin-top: 15px;
      }
      .responsavel-box {
        /* padding: 15px; */
        text-align: center;
      }
      .responsavel-box h3 {
        margin-bottom: 10px;
        font-size: 1.2em;
        padding: 5px;
        border-radius: 3px;
        display: inline-block; /* Para aplicar cor de fundo apenas ao texto */
      }
      .responsavel-box p.total-responsavel {
        margin: 10px 0 5px 0;
        font-size: 1em;
        font-weight: bold;
        border-top: 1px solid #ccc;
        padding-top: 10px;
      }
      .responsavel-list {
          text-align: left;
          font-size: 0.9em;
          max-height: 150px; /* Limita altura da lista */
          overflow-y: auto; /* Adiciona scroll se necessário */
          padding-right: 5px; /* Espaço para scrollbar */
          margin-top: 10px; /* Espaço acima da lista */
      }
       .responsavel-list .compra-item {
          display: flex;
          justify-content: space-between;
          padding: 3px 0;
          border-bottom: 1px dotted #eee;
       }
       .responsavel-list .compra-item:last-child {
           border-bottom: none;
       }
       .responsavel-list .compra-nome {
           flex-grow: 1;
           margin-right: 10px;
           white-space: nowrap;
           overflow: hidden;
           text-overflow: ellipsis;
       }
       .responsavel-list .compra-detalhes {
           flex-shrink: 0;
           white-space: nowrap;
       }

      /* Cores para Responsáveis (usadas no JS para background de compras/títulos) */
      .responsavel-liana { background-color: #add8e6; } /* Classe para H3 */
      .responsavel-stefany { background-color: #ffb347; }
      .responsavel-marilia { background-color: #dda0dd; }
      .responsavel-nosso { background-color: #ffc0cb; }

      /* Cores para background de itens de compra (usadas no JS) */
      .compra-bg-liana { background-color: rgba(173, 216, 230, 0.3); } /* Light blue com alpha */
      .compra-bg-stefany { background-color: rgba(255, 179, 71, 0.3); } /* Orange com alpha */
      .compra-bg-marilia { background-color: rgba(221, 160, 221, 0.3); } /* Plum com alpha */
      .compra-bg-nosso { background-color: rgba(255, 192, 203, 0.3); } /* Pink com alpha */

      /* RODAPÉ */
      footer {
        text-align: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #ccc;
      }
      footer p span {
        margin: 0 5px;
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 3px;
      }
      /* Aplicar cores da legenda diretamente */
      footer .liana { background-color: #add8e6; }
      footer .stefany { background-color: #ffb347; }
      footer .marilia { background-color: #dda0dd; }
      footer .nosso { background-color: #ffc0cb; }

      /* Estilo para item pago */
      .item-pago {
          text-decoration: line-through;
          color: grey;
          opacity: 0.7;
      }

      /* Modal Styles */
      .modal {
          display: none; /* Hidden by default */
          position: fixed; /* Stay in place */
          z-index: 1000; /* Sit on top */
          left: 0;
          top: 0;
          width: 100%; /* Full width */
          height: 100%; /* Full height */
          overflow: auto; /* Enable scroll if needed */
          background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      }
      .modal-content {
          background-color: #fefefe;
          margin: 15% auto; /* 15% from the top and centered */
          padding: 20px;
          border: 1px solid #888;
          width: 80%; /* Could be more or less, depending on screen size */
          max-width: 500px;
          border-radius: 8px;
          position: relative;
      }
      .close-button {
          color: #aaa;
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 28px;
          font-weight: bold;
      }
      .close-button:hover,
      .close-button:focus {
          color: black;
          text-decoration: none;
          cursor: pointer;
      }
      .modal h2 {
          margin-top: 0;
      }
      .modal label {
          display: block;
          margin-bottom: 5px;
      }
      .modal input[type="text"],
      .modal input[type="number"],
      .modal select {
          width: 100%;
          padding: 8px;
          margin-bottom: 15px;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-sizing: border-box;
      }
      .modal button {
          width: 100%;
          padding: 10px;
      }

    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Painel Financeiro</h1>
        <!-- Mês/Ano será atualizado pelo JS -->
        <h2>Carregando...</h2>
        <div class="nav-buttons">
          <!-- Botões de navegação -->
          <button id="prevMonthBtn">&laquo; Mês Anterior</button>
          <button id="nextMonthBtn">Mês Seguinte &raquo;</button>
        </div>
      </header>

      <!-- Seção de Totais e Saldo -->
      <div class="totals-section">
        <div class="totals-wrapper">
          <span id="totalReceitas">Total de Receitas: R$ 0.00</span>
          <span id="totalDespesasAbertas">Total de Despesas (Abertas): R$ 0.00</span>
        </div>
        <div class="saldo-bar-container">
          <div class="saldo-bar" id="saldoBar"></div>
          <div class="saldo-label" id="saldoLabel">Saldo: R$ 0.00</div>
        </div>
      </div>

      <!-- Seção de Resumo do Mês (Receitas, Contas Fixas, Variáveis) -->
      <div class="categorias-section">
        <h2>Resumo do Mês</h2>
        <div class="categorias-columns">
          <!-- Receitas -->
          <div class="categoria-box receitas">
            <h3>Receitas</h3>
            <div class="categoria-list" id="listaReceitas">
              <p>Carregando...</p>
            </div>
            <!-- Formulário de Adicionar Receita (inline) -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ccc;">
              <input type="text" id="nomeReceita" placeholder="Nome da Receita" style="width: calc(100% - 22px); margin-bottom: 5px;">
              <input type="number" id="valorReceita" placeholder="Valor" style="width: calc(100% - 22px); margin-bottom: 10px;">
              <button id="addReceitaBtn">Adicionar Receita</button>
            </div>
          </div>

          <!-- Contas Fixas -->
          <div class="categoria-box contas">
            <h3>Contas Fixas</h3>
            <div class="categoria-list" id="listaContasFixas">
              <p>Carregando...</p>
            </div>
            <div class="total-categoria">
              <span id="totalContasFixas">Total Aberto: R$ 0.00</span>
              <input type="checkbox" class="checkbox-pago-total" id="checkAllContasFixas" title="Marcar/Desmarcar Todas como Pagas">
            </div>
          </div>

          <!-- Contas Variáveis -->
          <div class="categoria-box contas">
            <h3>Contas Variáveis</h3>
            <div class="categoria-list" id="listaContasVariaveis">
              <p>Carregando...</p>
            </div>
            <div class="total-categoria">
              <span id="totalContasVariaveis">Total Aberto: R$ 0.00</span>
              <input type="checkbox" class="checkbox-pago-total" id="checkAllContasVariaveis" title="Marcar/Desmarcar Todas como Pagas">
            </div>
          </div>
        </div>
      </div>

      <!-- Seção de Cartões -->
      <div class="cartoes-section">
        <h2>Cartões</h2>
        <div class="cartoes-grid" id="cartoesGrid">
          <p>Carregando...</p>
        </div>
      </div>

      <!-- Seção de Formulários (Adicionar Compra / Adicionar Conta) -->
      <div class="form-sections-wrapper">
        <!-- Adicionar Compra no Cartão -->
        <div class="form-section" id="formAdicionarCompra">
          <h2>Adicionar Compra no Cartão</h2>
          <div class="row">
            <select id="responsavelCompra">
              <option value="">Responsável</option>
              <option value="Liana">Liana</option>
              <option value="Stefany">Stefany</option>
              <option value="Marília">Marília</option>
              <option value="Nosso ❤️">Nosso ❤️</option>
            </select>
            <select id="cartaoCompra">
              <option value="">Cartão</option>
              <option value="Nubank">Nubank</option>
              <option value="Santander">Santander</option>
              <option value="Mercado Pago">Mercado Pago</option> <!-- Nome consistente -->
              <option value="Amazon">Amazon</option>
              <option value="C6">C6</option>
              <option value="Itaú">Itaú</option>
              <option value="Bradesco">Bradesco</option>
              <option value="Inter">Inter</option>
            </select>
          </div>
          <input type="text" id="nomeCompra" placeholder="Nome da Compra" />
          <div class="row">
            <input type="number" id="valorCompra" placeholder="Valor Total" />
            <input type="number" id="parcelasCompra" placeholder="Nº Parcelas (1 = à vista)" value="1" min="1"/>
          </div>
          <button id="addCompraBtn">Adicionar Compra</button>
        </div>

        <!-- Adicionar Conta -->
        <div class="form-section" id="formAdicionarConta">
          <h2>Adicionar Conta</h2>
          <select id="tipoConta">
            <option value="Fixa">Fixa</option>
            <option value="Variável">Variável</option>
          </select>
          <input type="text" id="nomeConta" placeholder="Nome da Conta" />
          <div class="row">
             <input type="number" id="valorConta" placeholder="Valor Total" />
             <input type="number" id="parcelasConta" placeholder="Nº Parcelas (1 = única)" value="1" min="1"/>
          </div>
          <button id="addContaBtn">Adicionar Conta</button>
        </div>
      </div>

      <!-- Seção de Compras por Responsável -->
      <div class="compras-responsaveis">
        <h2>Total de Compras por Responsável (Mês)</h2>
        <div class="responsaveis-container" id="responsaveisContainer">
          <p>Carregando...</p>
        </div>
      </div>

      <!-- Rodapé com Legenda -->
      <footer>
        <p>
          Legenda Responsáveis:
          <span class="liana">Liana</span>,
          <span class="stefany">Stefany</span>,
          <span class="marilia">Marília</span>,
          <span class="nosso">Nosso ❤️</span>
        </p>
      </footer>
    </div>

    <!-- Modal de Edição (Genérico) -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Editar Item</h2>
        <input type="hidden" id="editItemId">
        <input type="hidden" id="editItemType"> <!-- 'receita', 'conta', 'compra' -->
        
        <div id="editFormFields">
          <!-- Campos serão preenchidos dinamicamente pelo JS -->
        </div>
        
        <button id="saveEditBtn">Salvar Alterações</button>
      </div>
    </div>

    <script>
      // --- Configurações e Variáveis Globais ---
      const webAppUrl = "https://painel-financas-proxy.mariliaedua.workers.dev/"; // URL do Cloudflare Worker
      let currentMonth = new Date().getMonth(); // 0-Janeiro, 11-Dezembro
      let currentYear = new Date().getFullYear();
      const monthNames = [
        "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
      ];
      // Mapeamento de responsáveis para classes CSS (para cores)
      const responsavelClasses = {
          "Liana": "liana",
          "Stefany": "stefany",
          "Marília": "marilia",
          "Nosso ❤️": "nosso"
      };
      const responsavelBgClasses = {
          "Liana": "compra-bg-liana",
          "Stefany": "compra-bg-stefany",
          "Marília": "compra-bg-marilia",
          "Nosso ❤️": "compra-bg-nosso"
      };
      // Mapeamento de nomes de cartão para classes CSS (para cores)
      const cartaoClasses = {
          "Nubank": "nubank",
          "Santander": "santander",
          "Mercado Pago": "mercadopago", // Nome consistente
          "Amazon": "amazon",
          "C6": "c6",
          "Itaú": "itaú",
          "Bradesco": "bradesco",
          "Inter": "inter"
      };

      // --- Funções de Formatação ---
      function formatCurrency(value) {
        const number = Number(value);
        return isNaN(number) ? "R$ 0.00" : number.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
      }

      // --- Funções de Comunicação com Backend ---
      async function fetchBackend(action, data = {}, recordId = null) {
        console.log(`Enviando payload:`, { action, data, recordId, month: currentMonth + 1, year: currentYear });
        const payload = {
            action: action,
            data: data,
            recordId: recordId,
            month: currentMonth + 1, // Envia mês 1-12 para o backend
            year: currentYear
        };
        try {
            const response = await fetch(webAppUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
                mode: "cors" // Necessário para interagir com Cloudflare Worker de outro domínio
            });
            
            // Log da resposta crua para depuração
            // const rawResponseText = await response.text();
            // console.log(`Resposta crua (${action}):`, rawResponseText);
            // const result = JSON.parse(rawResponseText); // Tenta parsear

            if (!response.ok) {
                const errorText = await response.text();
                console.error(`Erro HTTP (${action}): ${response.status}`, errorText);
                throw new Error(`Erro ${response.status}: ${errorText || response.statusText}`);
            }

            const result = await response.json();
            console.log(`Resposta recebida (${action}):`, result);

            // Verifica se a resposta contém um erro do Apps Script
            if (result && result.status === 'error') {
                console.error(`Erro do Backend (${action}):`, result.message);
                throw new Error(`Erro no backend: ${result.message}`);
            }
            
            // Retorna APENAS o conteúdo dentro de 'data', se existir, caso contrário, a resposta inteira
            return result && result.hasOwnProperty('data') ? result.data : result;

        } catch (error) {
            console.error(`Falha na requisição (${action}):`, error);
            alert(`Erro ao comunicar com o servidor para a ação '${action}'. Verifique o console para detalhes.`);
            // Retorna um estado de erro consistente para quem chamou
            if (action.startsWith("get")) return action.includes("Por") || action === 'getTotais' ? {} : []; // Retorna objeto ou array vazio para GETs
            return { status: 'error', message: error.message }; // Retorna erro para ações CUD
        }
      }

      // --- Funções de Atualização da Interface (Display) ---

      function updateMonthDisplay() {
        document.querySelector("header h2").textContent = `${monthNames[currentMonth]} ${currentYear}`;
      }

      function displayLoading(elementId) {
          const element = document.getElementById(elementId);
          if (element) {
              element.innerHTML = "<p>Carregando...</p>";
          }
      }

      function displayError(elementId, message) {
          const element = document.getElementById(elementId);
          if (element) {
              element.innerHTML = `<p style="color: red;">Erro: ${message}</p>`;
          }
      }

      function displayEmpty(elementId, message = "Nenhum item encontrado.") {
          const element = document.getElementById(elementId);
          if (element) {
              element.innerHTML = `<p>${message}</p>`;
          }
      }

      // Atualiza a barra de saldo e os totais
      function updateTotalsDisplay(totals) {
          const totalReceitas = totals.receitas || 0;
          const totalDespesasAbertas = totals.despesasAbertas || 0;
          const saldoReal = totals.saldoReal || 0;

          document.getElementById("totalReceitas").textContent = `Total de Receitas: ${formatCurrency(totalReceitas)}`;
          document.getElementById("totalDespesasAbertas").textContent = `Total de Despesas (Abertas): ${formatCurrency(totalDespesasAbertas)}`;
          document.getElementById("saldoLabel").textContent = `Saldo: ${formatCurrency(saldoReal)}`;

          const saldoBar = document.getElementById("saldoBar");
          let percentage = 0;
          if (totalReceitas > 0) {
              // Calcula percentual do saldo em relação às receitas
              percentage = Math.max(0, Math.min(100, (saldoReal / totalReceitas) * 100));
          } else if (saldoReal < 0) {
              // Se não há receita mas há despesa, barra fica 100% vermelha
              percentage = 100;
          }
          
          saldoBar.style.width = `${percentage}%`;
          if (saldoReal < 0) {
              saldoBar.classList.add("negative");
              // Se negativo, a barra representa o "excesso" de despesa em relação à receita (ou 100% se não houver receita)
              const deficitPercentage = totalReceitas > 0 ? Math.min(100, (Math.abs(saldoReal) / totalReceitas) * 100) : 100;
              saldoBar.style.width = `${deficitPercentage}%`; 
          } else {
              saldoBar.classList.remove("negative");
          }
      }

      // Exibe a lista de receitas
      function displayReceitas(receitas) {
          const listaElement = document.getElementById("listaReceitas");
          if (!Array.isArray(receitas)) {
              displayError("listaReceitas", "Formato de dados inválido.");
              return;
          }
          if (receitas.length === 0) {
              displayEmpty("listaReceitas", "Nenhuma receita para este mês.");
              return;
          }

          listaElement.innerHTML = ""; // Limpa lista
          receitas.forEach(item => {
              const div = document.createElement("div");
              div.className = "list-item";
              div.innerHTML = `
                  <span>${item.nome || 'Receita sem nome'} - ${formatCurrency(item.valor)}</span>
                  <div class="list-item-controls">
                      <button class="edit-button" onclick="openEditModal('receita', '${item.id}')">Edit</button>
                      <button class="delete-button" onclick="deleteItem('receita', '${item.id}')">X</button>
                  </div>
              `;
              listaElement.appendChild(div);
          });
      }

      // Exibe contas (Fixas e Variáveis)
      function displayContas(contas) {
          const listaFixas = document.getElementById("listaContasFixas");
          const listaVariaveis = document.getElementById("listaContasVariaveis");
          
          if (!Array.isArray(contas)) {
              displayError("listaContasFixas", "Formato inválido.");
              displayError("listaContasVariaveis", "Formato inválido.");
              return;
          }

          listaFixas.innerHTML = "";
          listaVariaveis.innerHTML = "";
          let totalFixasAberto = 0;
          let totalVariaveisAberto = 0;
          const contasFixasDoMes = contas.filter(c => c.tipo === 'Fixa');
          const contasVariaveisDoMes = contas.filter(c => c.tipo === 'Variável');
          let allFixasPaid = contasFixasDoMes.length > 0;
          let allVariaveisPaid = contasVariaveisDoMes.length > 0;

          contas.forEach(item => {
              const isPago = String(item.pago).toLowerCase() === 'sim';
              const valor = parseFloat(item.valor || 0);
              const div = document.createElement("div");
              div.className = `list-item ${isPago ? 'item-pago' : ''}`;
              // Usa originalId se existir (vem de getAllInstallmentsForMonth), senão usa id
              const itemId = item.originalId || item.id;
              div.innerHTML = `
                  <span>${item.nome || 'Conta sem nome'} (${item.parcelas || '1/1'}) - ${formatCurrency(valor)}</span>
                  <div class="list-item-controls">
                      <input type="checkbox" ${isPago ? 'checked' : ''} onchange="markAsPaid('conta', '${itemId}', this.checked)" title="Marcar como Paga">
                      <button class="edit-button" onclick="openEditModal('conta', '${itemId}')">Edit</button>
                      <button class="delete-button" onclick="deleteItem('conta', '${itemId}')">X</button>
                  </div>
              `;

              if (item.tipo === "Fixa") {
                  listaFixas.appendChild(div);
                  if (!isPago) {
                      totalFixasAberto += valor;
                      allFixasPaid = false;
                  }
              } else if (item.tipo === "Variável") {
                  listaVariaveis.appendChild(div);
                  if (!isPago) {
                      totalVariaveisAberto += valor;
                      allVariaveisPaid = false;
                  }
              }
          });

          // Atualiza totais e checkboxes "Marcar Todos"
          document.getElementById("totalContasFixas").textContent = `Total Aberto: ${formatCurrency(totalFixasAberto)}`;
          document.getElementById("totalContasVariaveis").textContent = `Total Aberto: ${formatCurrency(totalVariaveisAberto)}`;
          document.getElementById("checkAllContasFixas").checked = allFixasPaid;
          document.getElementById("checkAllContasVariaveis").checked = allVariaveisPaid;

          if (listaFixas.children.length === 0) displayEmpty("listaContasFixas", "Nenhuma conta fixa para este mês.");
          if (listaVariaveis.children.length === 0) displayEmpty("listaContasVariaveis", "Nenhuma conta variável para este mês.");
      }

      // Exibe compras por cartão
      function displayComprasPorCartao(cartoesData) {
          const gridElement = document.getElementById("cartoesGrid");
          if (typeof cartoesData !== 'object' || cartoesData === null) {
              displayError("cartoesGrid", "Formato de dados inválido.");
              return;
          }

          gridElement.innerHTML = ""; // Limpa grid
          const cartaoNames = Object.keys(cartoesData);

          if (cartaoNames.length === 0) {
              displayEmpty("cartoesGrid", "Nenhum cartão com compras neste mês.");
              return;
          }

          cartaoNames.forEach(nomeCartao => {
              const cartao = cartoesData[nomeCartao];
              // Pula se não houver dados ou se for um cartão sem compras (total 0 e array vazio)
              if (!cartao || typeof cartao !== 'object' || (cartao.total === 0 && cartao.compras.length === 0)) return; 

              const cartaoDiv = document.createElement("div");
              const cartaoClass = cartaoClasses[nomeCartao] || 'default'; // Pega classe CSS do cartão
              cartaoDiv.className = `cartao-box ${cartaoClass}`;

              const listaCompras = document.createElement("div");
              listaCompras.className = "cartao-list";
              let totalCartaoAberto = 0;
              let allComprasPaid = cartao.compras.length > 0;

              if (cartao.compras && cartao.compras.length > 0) {
                  cartao.compras.forEach(compra => {
                      const isPago = String(compra.pago).toLowerCase() === 'sim';
                      const valor = parseFloat(compra.valor || 0);
                      const responsavel = compra.responsavel || '';
                      const bgClass = responsavelBgClasses[responsavel] || ''; // Classe de fundo por responsável
                      const itemId = compra.originalId || compra.id; // Usa originalId se existir

                      const compraDiv = document.createElement("div");
                      compraDiv.className = `compra ${isPago ? 'item-pago' : ''} ${bgClass}`;
                      compraDiv.innerHTML = `
                          <div class="list-item-content">
                              <!-- ALTERAÇÃO: Exibe Nome (Parcela) - Valor -->
                              <span>${compra.nome || 'Compra sem nome'} (${compra.parcelas || '1/1'}) - ${formatCurrency(valor)}</span>
                          </div>
                          <div class="list-item-controls">
                              <input type="checkbox" ${isPago ? 'checked' : ''} onchange="markAsPaid('compra', '${itemId}', this.checked)" title="Marcar como Paga">
                              <button class="edit-button" onclick="openEditModal('compra', '${itemId}')">Edit</button>
                              <button class="delete-button" onclick="deleteItem('compra', '${itemId}')">X</button>
                          </div>
                      `;
                      listaCompras.appendChild(compraDiv);
                      if (!isPago) {
                          totalCartaoAberto += valor;
                          allComprasPaid = false;
                      }
                  });
              } else {
                  listaCompras.innerHTML = "<p>Nenhuma compra neste cartão para este mês.</p>";
                  allComprasPaid = false; // Se não há compras, não estão todas pagas
              }

              cartaoDiv.innerHTML = `
                  <h3>${nomeCartao}</h3>
              `;
              cartaoDiv.appendChild(listaCompras);
              cartaoDiv.innerHTML += `
                  <div class="total-cartao">
                      <span>Total Aberto: ${formatCurrency(totalCartaoAberto)}</span>
                      <input type="checkbox" class="checkbox-pago-total" id="checkAll_${cartaoClass}" ${allComprasPaid ? 'checked' : ''} onchange="markAllCartaoAsPaidFront('${nomeCartao}', this.checked)" title="Marcar/Desmarcar Todas como Pagas">
                  </div>
              `;
              gridElement.appendChild(cartaoDiv);
          });
      }

      // Exibe totais e detalhes por responsável
      function displayComprasPorResponsavel(responsaveisData) {
          const containerElement = document.getElementById("responsaveisContainer");
           if (typeof responsaveisData !== 'object' || responsaveisData === null) {
              displayError("responsaveisContainer", "Formato de dados inválido.");
              return;
          }
          containerElement.innerHTML = ""; // Limpa container
          const responsavelNames = Object.keys(responsaveisData);
          if (responsavelNames.length === 0) {
              displayEmpty("responsaveisContainer", "Nenhuma compra encontrada.");
              return;
          }

          responsavelNames.forEach(nomeResponsavel => {
              const responsavel = responsaveisData[nomeResponsavel];
              // Pula se não houver dados ou se for um responsável sem compras
              if (!responsavel || typeof responsavel !== 'object' || (responsavel.total === 0 && responsavel.compras.length === 0)) return; 

              const responsavelDiv = document.createElement("div");
              responsavelDiv.className = "responsavel-box";
              const h3Class = responsavelClasses[nomeResponsavel] || ''; // Classe para cor do H3

              // Cria o título H3
              const tituloH3 = document.createElement("h3");
              tituloH3.className = h3Class;
              tituloH3.textContent = nomeResponsavel;
              responsavelDiv.appendChild(tituloH3);

              // Cria a div para a lista de compras
              const listaDetalhes = document.createElement("div");
              listaDetalhes.className = "responsavel-list";

              if (responsavel.compras && responsavel.compras.length > 0) {
                  responsavel.compras.forEach(compra => {
                      const isPago = String(compra.pago).toLowerCase() === 'sim';
                      const valor = parseFloat(compra.valor || 0);
                      const itemDiv = document.createElement("div");
                      itemDiv.className = `compra-item ${isPago ? 'item-pago' : ''}`;
                      // ALTERAÇÃO: Exibe Nome (Parcela) - Valor
                      itemDiv.innerHTML = `
                          <span class="compra-nome" title="${compra.nome || 'Compra s/ nome'}">${compra.nome || 'Compra s/ nome'}</span>
                          <span class="compra-detalhes">(${compra.parcelas || '1/1'}) - ${formatCurrency(valor)}</span>
                      `;
                      listaDetalhes.appendChild(itemDiv);
                  });
              } else {
                  listaDetalhes.innerHTML = "<p>Nenhuma compra neste mês.</p>";
              }
              // Adiciona a lista ao div do responsável
              responsavelDiv.appendChild(listaDetalhes);

              // Cria e adiciona o parágrafo do total
              const totalP = document.createElement("p");
              totalP.className = "total-responsavel";
              totalP.textContent = `Total (Mês): ${formatCurrency(responsavel.total || 0)}`;
              responsavelDiv.appendChild(totalP);

              // Adiciona o div completo do responsável ao container
              containerElement.appendChild(responsavelDiv);
          });
      }

      // --- Funções de Ação (Adicionar, Editar, Excluir, Marcar Pago) ---

      async function addReceita() {
          const nome = document.getElementById("nomeReceita").value.trim();
          const valor = document.getElementById("valorReceita").value.trim();
          if (!nome || !valor || isNaN(parseFloat(valor))) {
              alert("Por favor, preencha o nome e um valor válido para a receita.");
              return;
          }
          const result = await fetchBackend("addReceita", { nome, valor });
          if (result && result.status === 'success') {
              document.getElementById("nomeReceita").value = '';
              document.getElementById("valorReceita").value = '';
              fetchAllData(); // Recarrega tudo
          } else {
              alert("Erro ao adicionar receita: " + (result.message || "Erro desconhecido"));
          }
      }

      async function addConta() {
          const tipo = document.getElementById("tipoConta").value;
          const nome = document.getElementById("nomeConta").value.trim();
          const valor = document.getElementById("valorConta").value.trim();
          const parcelasInput = document.getElementById("parcelasConta").value.trim();
          
          if (!nome || !valor || isNaN(parseFloat(valor)) || !parcelasInput || isNaN(parseInt(parcelasInput)) || parseInt(parcelasInput) < 1) {
              alert("Preencha nome, valor total válido e número de parcelas (pelo menos 1).");
              return;
          }
          const parcelas = parseInt(parcelasInput);
          // O backend espera 'parcelas' como string '1/N' ou apenas 'N'
          // Vamos enviar apenas N, o backend calculará a data da primeira parcela
          const dataToSend = {
              tipo,
              nome,
              valor: parseFloat(valor),
              parcelas: parcelas // Envia apenas o número total de parcelas
          };

          const result = await fetchBackend("addConta", dataToSend);
          if (result && result.status === 'success') {
              document.getElementById("nomeConta").value = '';
              document.getElementById("valorConta").value = '';
              document.getElementById("parcelasConta").value = '1';
              fetchAllData();
          } else {
              alert("Erro ao adicionar conta: " + (result.message || "Erro desconhecido"));
          }
      }

      async function addCompraCartao() {
          const responsavel = document.getElementById("responsavelCompra").value;
          const cartao = document.getElementById("cartaoCompra").value;
          const nome = document.getElementById("nomeCompra").value.trim();
          const valor = document.getElementById("valorCompra").value.trim();
          const parcelasInput = document.getElementById("parcelasCompra").value.trim();

          if (!responsavel || !cartao || !nome || !valor || isNaN(parseFloat(valor)) || !parcelasInput || isNaN(parseInt(parcelasInput)) || parseInt(parcelasInput) < 1) {
              alert("Preencha todos os campos da compra com valores válidos (parcelas >= 1).");
              return;
          }
          const parcelas = parseInt(parcelasInput);
          const dataToSend = {
              responsavel,
              cartao,
              nome,
              valor: parseFloat(valor),
              parcelas: parcelas // Envia apenas o número total de parcelas
          };

          const result = await fetchBackend("addCompraCartao", dataToSend);
          if (result && result.status === 'success') {
              document.getElementById("responsavelCompra").value = '';
              document.getElementById("cartaoCompra").value = '';
              document.getElementById("nomeCompra").value = '';
              document.getElementById("valorCompra").value = '';
              document.getElementById("parcelasCompra").value = '1';
              fetchAllData();
          } else {
              alert("Erro ao adicionar compra: " + (result.message || "Erro desconhecido"));
          }
      }

      async function deleteItem(type, id) {
          if (!confirm(`Tem certeza que deseja excluir este item (${type})?`)) return;
          
          let action = '';
          if (type === 'receita') action = 'deleteReceita';
          else if (type === 'conta') action = 'deleteConta';
          else if (type === 'compra') action = 'deleteCompra';
          else return;

          const result = await fetchBackend(action, {}, id);
          if (result && result.status === 'success') {
              fetchAllData();
          } else {
              alert(`Erro ao excluir ${type}: ` + (result.message || "Erro desconhecido"));
          }
      }

      async function markAsPaid(type, id, isPaid) {
          let action = '';
          if (type === 'conta') action = 'markContaAsPaid';
          else if (type === 'compra') action = 'markCompraAsPaid';
          else return;

          const result = await fetchBackend(action, { pago: isPaid ? 'Sim' : 'Não' }, id);
          if (result && result.status === 'success') {
              fetchAllData(); // Recarrega para atualizar totais e estilo
          } else {
              alert(`Erro ao marcar ${type} como ${isPaid ? 'pago' : 'não pago'}: ` + (result.message || "Erro desconhecido"));
              // Reverter o checkbox visualmente em caso de erro?
              fetchAllData(); // Recarregar mesmo em erro para sincronizar com estado real
          }
      }

      // Função para marcar/desmarcar todas as contas de um tipo (Fixa/Variável)
      async function markAllContasAsPaidFront(tipoConta, isPaid) {
          const listId = tipoConta === 'Fixa' ? 'listaContasFixas' : 'listaContasVariaveis';
          const listElement = document.getElementById(listId);
          const checkboxes = listElement.querySelectorAll('input[type="checkbox"]');
          const promises = [];

          checkboxes.forEach(checkbox => {
              // Extrai o ID do atributo onchange
              const onchangeAttr = checkbox.getAttribute('onchange');
              const match = onchangeAttr.match(/markAsPaid\('conta',\s*'([^']*)',/);
              if (match && match[1]) {
                  const itemId = match[1];
                  // Só envia requisição se o estado for diferente
                  if (checkbox.checked !== isPaid) {
                     promises.push(fetchBackend('markContaAsPaid', { pago: isPaid ? 'Sim' : 'Não' }, itemId));
                  }
              }
          });

          try {
              await Promise.all(promises);
              fetchAllData(); // Recarrega tudo após todas as operações
          } catch (error) {
              alert(`Erro ao marcar todas as contas ${tipoConta} como ${isPaid ? 'pagas' : 'não pagas'}. Verifique o console.`);
              fetchAllData(); // Recarrega para garantir sincronia
          }
      }
       // Função para marcar/desmarcar todas as compras de um cartão
      async function markAllCartaoAsPaidFront(nomeCartao, isPaid) {
          // Encontra a classe CSS correta para o cartão
          const cartaoClass = cartaoClasses[nomeCartao];
          if (!cartaoClass) {
              console.error("Classe não encontrada para o cartão:", nomeCartao);
              return;
          }
          const cartaoBox = document.querySelector(`.cartao-box.${cartaoClass}`);
          if (!cartaoBox) {
              console.error("Div do cartão não encontrado para:", nomeCartao);
              return;
          }

          const checkboxes = cartaoBox.querySelectorAll('.cartao-list input[type="checkbox"]');
          const promises = [];

          checkboxes.forEach(checkbox => {
              const onchangeAttr = checkbox.getAttribute('onchange');
              const match = onchangeAttr.match(/markAsPaid\('compra',\s*'([^']*)',/);
              if (match && match[1]) {
                  const itemId = match[1];
                  if (checkbox.checked !== isPaid) {
                      promises.push(fetchBackend('markCompraAsPaid', { pago: isPaid ? 'Sim' : 'Não' }, itemId));
                  }
              }
          });

          try {
              await Promise.all(promises);
              fetchAllData();
          } catch (error) {
              alert(`Erro ao marcar todas as compras do cartão ${nomeCartao} como ${isPaid ? 'pagas' : 'não pagas'}. Verifique o console.`);
              fetchAllData();
          }
      }

      // --- Funções do Modal de Edição ---
      let currentEditData = null; // Armazena os dados do item sendo editado

      async function openEditModal(type, id) {
          console.log(`Abrindo modal para ${type} ID: ${id}`);
          const modal = document.getElementById('editModal');
          const fieldsDiv = document.getElementById('editFormFields');
          const title = document.getElementById('modalTitle');
          fieldsDiv.innerHTML = '<p>Carregando dados...</p>';
          modal.style.display = 'block';

          document.getElementById('editItemId').value = id;
          document.getElementById('editItemType').value = type;

          // Buscar os dados completos do item original no backend
          // Idealmente, o backend teria uma ação getById(id)
          // Vamos usar as funções existentes que buscam TUDO e filtrar
          let itemData = null;
          try {
              let allItems = [];
              if (type === 'receita') {
                  allItems = await fetchBackend('getReceitas');
                  title.textContent = "Editar Receita";
              } else if (type === 'conta') {
                  // Busca TODAS as contas (sem filtro de mês) para encontrar a original
                  // Precisamos de uma ação no backend para isso, ou ajustar getContas
                  // Temporariamente, vamos assumir que o ID é único e buscar no mês atual
                  // ISSO PODE FALHAR SE A CONTA NÃO ESTIVER NO MÊS ATUAL
                  allItems = await fetchBackend('getContas'); 
                  title.textContent = "Editar Conta";
              } else if (type === 'compra') {
                  // Mesma limitação das contas
                  allItems = await fetchBackend('getComprasPorCartao'); // Retorna objeto, precisamos processar
                  let allComprasFlat = [];
                  Object.values(allItems).forEach(cartao => allComprasFlat.push(...cartao.compras));
                  allItems = allComprasFlat;
                  title.textContent = "Editar Compra";
              }
              
              // Encontra o item pelo ID (ou originalId)
              itemData = allItems.find(item => (item.originalId || item.id) === id);

              if (!itemData) {
                  // Tentar buscar sem filtro de mês se falhou (solução paliativa)
                  console.warn("Item não encontrado no mês atual, tentando buscar todos...");
                  if (type === 'conta') {
                      const allContasRaw = await fetchBackend('getContas', {}, null); // Força busca sem mês
                      itemData = allContasRaw.find(item => item.id === id);
                  } else if (type === 'compra') {
                      const allComprasRaw = await fetchBackend('getCompras', {}, null); // Força busca sem mês
                      itemData = allComprasRaw.find(item => item.id === id);
                  }
                  if (!itemData) throw new Error("Item não encontrado para edição.");
              }
              
              currentEditData = itemData; // Guarda os dados atuais
              populateEditForm(type, itemData);

          } catch (error) {
              console.error("Erro ao buscar dados para edição:", error);
              fieldsDiv.innerHTML = `<p style="color: red;">Erro ao carregar dados: ${error.message}</p>`;
              // Opcional: Fechar modal ou permitir fechar manualmente
              // closeModal(); 
          }
      }

      function populateEditForm(type, data) {
          const fieldsDiv = document.getElementById('editFormFields');
          fieldsDiv.innerHTML = ''; // Limpa

          if (type === 'receita') {
              fieldsDiv.innerHTML = `
                  <label for="editNome">Nome:</label>
                  <input type="text" id="editNome" value="${data.nome || ''}">
                  <label for="editValor">Valor:</label>
                  <input type="number" id="editValor" value="${data.valor || ''}">
              `;
          } else if (type === 'conta') {
              // Extrai número total de parcelas do formato X/Y ou N
              let totalParcelas = 1;
              if (data.parcelas) {
                  const parcelasStr = String(data.parcelas);
                  const parcelasMatch = parcelasStr.match(/\/(\d+)$/);
                  if (parcelasMatch) {
                      totalParcelas = parseInt(parcelasMatch[1], 10) || 1;
                  } else if (!parcelasStr.includes('/') && !isNaN(parseInt(parcelasStr, 10))) {
                      totalParcelas = parseInt(parcelasStr, 10) || 1;
                  }
              }
              // O valor no modal deve ser o VALOR TOTAL ORIGINAL, não o da parcela
              // Precisamos buscar o valor total original se 'data' for uma parcela
              // Assumindo que 'data.valor' já é o valor total (precisa corrigir busca no openEditModal)
              const valorTotalOriginal = data.valor * totalParcelas; // Estimativa se data.valor for da parcela
              // Ideal: buscar o registro original completo no backend

              fieldsDiv.innerHTML = `
                  <label for="editTipo">Tipo:</label>
                  <select id="editTipo">
                      <option value="Fixa" ${data.tipo === 'Fixa' ? 'selected' : ''}>Fixa</option>
                      <option value="Variável" ${data.tipo === 'Variável' ? 'selected' : ''}>Variável</option>
                  </select>
                  <label for="editNome">Nome:</label>
                  <input type="text" id="editNome" value="${data.nome || ''}">
                  <label for="editValor">Valor Total:</label>
                  <input type="number" id="editValor" value="${data.valor || ''}"> <!-- CORRIGIR: Precisa ser o valor total original -->
                  <label for="editParcelas">Nº Total Parcelas:</label>
                  <input type="number" id="editParcelas" value="${totalParcelas}" min="1">
                  <label for="editPago">Pago:</label>
                  <select id="editPago">
                      <option value="Sim" ${String(data.pago).toLowerCase() === 'sim' ? 'selected' : ''}>Sim</option>
                      <option value="Não" ${String(data.pago).toLowerCase() !== 'sim' ? 'selected' : ''}>Não</option>
                  </select>
              `;
          } else if (type === 'compra') {
              let totalParcelas = 1;
              if (data.parcelas) {
                  const parcelasStr = String(data.parcelas);
                  const parcelasMatch = parcelasStr.match(/\/(\d+)$/);
                  if (parcelasMatch) {
                      totalParcelas = parseInt(parcelasMatch[1], 10) || 1;
                  } else if (!parcelasStr.includes('/') && !isNaN(parseInt(parcelasStr, 10))) {
                      totalParcelas = parseInt(parcelasStr, 10) || 1;
                  }
              }
              // Mesma questão do valor total para compras
              const valorTotalOriginal = data.valor * totalParcelas; // Estimativa

              fieldsDiv.innerHTML = `
                  <label for="editResponsavel">Responsável:</label>
                  <select id="editResponsavel">
                      <option value="Liana" ${data.responsavel === 'Liana' ? 'selected' : ''}>Liana</option>
                      <option value="Stefany" ${data.responsavel === 'Stefany' ? 'selected' : ''}>Stefany</option>
                      <option value="Marília" ${data.responsavel === 'Marília' ? 'selected' : ''}>Marília</option>
                      <option value="Nosso ❤️" ${data.responsavel === 'Nosso ❤️' ? 'selected' : ''}>Nosso ❤️</option>
                  </select>
                  <label for="editCartao">Cartão:</label>
                  <select id="editCartao">
                      <option value="Nubank" ${data.cartao === 'Nubank' ? 'selected' : ''}>Nubank</option>
                      <option value="Santander" ${data.cartao === 'Santander' ? 'selected' : ''}>Santander</option>
                      <option value="Mercado Pago" ${data.cartao === 'Mercado Pago' ? 'selected' : ''}>Mercado Pago</option>
                      <option value="Amazon" ${data.cartao === 'Amazon' ? 'selected' : ''}>Amazon</option>
                      <option value="C6" ${data.cartao === 'C6' ? 'selected' : ''}>C6</option>
                      <option value="Itaú" ${data.cartao === 'Itaú' ? 'selected' : ''}>Itaú</option>
                      <option value="Bradesco" ${data.cartao === 'Bradesco' ? 'selected' : ''}>Bradesco</option>
                      <option value="Inter" ${data.cartao === 'Inter' ? 'selected' : ''}>Inter</option>
                  </select>
                  <label for="editNome">Nome:</label>
                  <input type="text" id="editNome" value="${data.nome || ''}">
                  <label for="editValor">Valor Total:</label>
                  <input type="number" id="editValor" value="${data.valor || ''}"> <!-- CORRIGIR: Precisa ser o valor total original -->
                  <label for="editParcelas">Nº Total Parcelas:</label>
                  <input type="number" id="editParcelas" value="${totalParcelas}" min="1">
                   <label for="editPago">Pago:</label>
                  <select id="editPago">
                      <option value="Sim" ${String(data.pago).toLowerCase() === 'sim' ? 'selected' : ''}>Sim</option>
                      <option value="Não" ${String(data.pago).toLowerCase() !== 'sim' ? 'selected' : ''}>Não</option>
                  </select>
              `;
          }
      }

      function closeModal() {
          document.getElementById('editModal').style.display = 'none';
          currentEditData = null; // Limpa dados ao fechar
      }

      async function saveEdit() {
          const id = document.getElementById('editItemId').value;
          const type = document.getElementById('editItemType').value;
          let updatedData = {};
          let action = '';

          try {
              if (type === 'receita') {
                  action = 'updateReceita';
                  updatedData = {
                      nome: document.getElementById('editNome').value.trim(),
                      valor: parseFloat(document.getElementById('editValor').value)
                  };
                  if (!updatedData.nome || isNaN(updatedData.valor)) throw new Error("Nome e valor da receita são obrigatórios.");
              } else if (type === 'conta') {
                  action = 'updateConta';
                  const newTotalParcelas = parseInt(document.getElementById('editParcelas').value);
                  if (isNaN(newTotalParcelas) || newTotalParcelas < 1) throw new Error("Número total de parcelas inválido.");
                  updatedData = {
                      tipo: document.getElementById('editTipo').value,
                      nome: document.getElementById('editNome').value.trim(),
                      valor: parseFloat(document.getElementById('editValor').value), // Envia o valor total digitado
                      parcelas: newTotalParcelas, // Envia apenas o número total
                      pago: document.getElementById('editPago').value
                  };
                  if (!updatedData.nome || isNaN(updatedData.valor)) throw new Error("Nome e valor da conta são obrigatórios.");
              } else if (type === 'compra') {
                  action = 'updateCompra';
                  const newTotalParcelas = parseInt(document.getElementById('editParcelas').value);
                  if (isNaN(newTotalParcelas) || newTotalParcelas < 1) throw new Error("Número total de parcelas inválido.");
                  updatedData = {
                      responsavel: document.getElementById('editResponsavel').value,
                      cartao: document.getElementById('editCartao').value,
                      nome: document.getElementById('editNome').value.trim(),
                      valor: parseFloat(document.getElementById('editValor').value), // Envia o valor total digitado
                      parcelas: newTotalParcelas, // Envia apenas o número total
                      pago: document.getElementById('editPago').value
                  };
                   if (!updatedData.responsavel || !updatedData.cartao || !updatedData.nome || isNaN(updatedData.valor)) throw new Error("Todos os campos da compra são obrigatórios.");
              }

              const result = await fetchBackend(action, updatedData, id);
              if (result && result.status === 'success') {
                  closeModal();
                  fetchAllData();
              } else {
                  alert(`Erro ao salvar alterações: ${result.message || 'Erro desconhecido'}`);
              }
          } catch (error) {
              alert(`Erro ao preparar dados para salvar: ${error.message}`);
          }
      }

      // --- Função Principal de Carregamento e Inicialização ---

      function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        } else if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        updateMonthDisplay();
        fetchAllData(); // Recarrega todos os dados
      }

      async function fetchAllData() {
        console.log(`Atualizando dados para ${currentMonth + 1}/${currentYear}`);
        // Mostra loading inicial
        displayLoading("listaReceitas");
        displayLoading("listaContasFixas");
        displayLoading("listaContasVariaveis");
        displayLoading("cartoesGrid");
        displayLoading("responsaveisContainer");
        // Reseta totais enquanto carrega
        updateTotalsDisplay({ receitas: 0, despesasAbertas: 0, saldoReal: 0 });

        try {
            // Executa todas as buscas em paralelo
            const [receitas, contas, cartoesData, responsaveisData, totais] = await Promise.all([
                fetchBackend('getReceitas'), // Assumindo que receitas não filtram por mês/ano
                fetchBackend('getContas'),
                fetchBackend('getComprasPorCartao'),
                fetchBackend('getComprasPorResponsavel'),
                fetchBackend('getTotais')
            ]);

            // Atualiza a interface com os dados recebidos
            displayReceitas(receitas);
            displayContas(contas);
            displayComprasPorCartao(cartoesData);
            displayComprasPorResponsavel(responsaveisData);
            updateTotalsDisplay(totais);

            console.log("Todos os dados atualizados com sucesso.");

        } catch (error) {
            console.error("Erro ao buscar todos os dados:", error);
            // Exibe erro em todas as seções relevantes
            displayError("listaReceitas", error.message);
            displayError("listaContasFixas", error.message);
            displayError("listaContasVariaveis", error.message);
            displayError("cartoesGrid", error.message);
            displayError("responsaveisContainer", error.message);
            alert("Ocorreu um erro geral ao carregar os dados do painel. Verifique o console.");
        }
      }

      // --- Inicialização e Event Listeners ---
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM carregado. Iniciando painel...");
        updateMonthDisplay();
        fetchAllData();

        // Listeners dos botões de navegação
        document.getElementById("prevMonthBtn").addEventListener("click", () => changeMonth(-1));
        document.getElementById("nextMonthBtn").addEventListener("click", () => changeMonth(1));

        // Listeners dos botões de adicionar
        document.getElementById("addReceitaBtn").addEventListener("click", addReceita);
        document.getElementById("addContaBtn").addEventListener("click", addConta);
        document.getElementById("addCompraBtn").addEventListener("click", addCompraCartao);

        // Listeners dos checkboxes "Marcar Todos"
        document.getElementById("checkAllContasFixas").addEventListener("change", (e) => markAllContasAsPaidFront('Fixa', e.target.checked));
        document.getElementById("checkAllContasVariaveis").addEventListener("change", (e) => markAllContasAsPaidFront('Variável', e.target.checked));
        // Listener para marcar todos os cartões é adicionado dinamicamente em displayComprasPorCartao

        // Listener do botão Salvar do Modal
        document.getElementById('saveEditBtn').addEventListener('click', saveEdit);

        // Fechar modal clicando fora
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        // Fechar modal com tecla Esc
        window.onkeydown = function(event) {
            const modal = document.getElementById('editModal');
            if (event.key === "Escape" && modal.style.display === "block") {
                closeModal();
            }
        }

        console.log("Painel inicializado e listeners adicionados.");
      });

    </script>
  </body>
</html>

